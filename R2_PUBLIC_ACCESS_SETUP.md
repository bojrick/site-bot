# Cloudflare R2 Public Access Setup Guide

## Problem
The image URLs generated by the R2 service are not publicly accessible because **R2 buckets are private by default**. You need to enable public access to make the URLs work.

## Solution Overview

According to [Cloudflare R2 Documentation](https://developers.cloudflare.com/r2/buckets/public-buckets/), there are **two ways** to enable public access:

1. **Custom Domain** (Recommended for Production)
2. **Public Development URL** (r2.dev subdomain - for development/testing)

## Option 1: Enable Public Development URL (Quick Setup)

### Step 1: Enable Public Access in Cloudflare Dashboard

1. Go to **Cloudflare Dashboard** ‚Üí **R2** ‚Üí **Your Bucket** (`reeva-erp`)
2. Click on **Settings** tab
3. Under **Public Development URL**, click **Enable**
4. Type 'allow' to confirm and click **Allow**
5. You'll get a URL like: `https://pub-{hash}.r2.dev`

### Step 2: Update Environment Variables

Add this to your `.env` file:

```bash
# Existing R2 Configuration
CLOUDFLARE_R2_ACCESS_KEY="37d92a0cc181b5cada8805126ecf0cc1"
CLOUDFLARE_R2_SECRET_KEY="813cdf431e0a5cbe1b98a103b522ffaae10b82319941518cf0e5d02bf98fff39"
CLOUDFLARE_R2_BUCKET="reeva-erp"
CLOUDFLARE_R2_REGION="auto"
CLOUDFLARE_R2_ENDPOINT="https://c924773969fa9cd80ba2bf5bae7cfb00.r2.cloudflarestorage.com"

# NEW: Add your public development URL
CLOUDFLARE_R2_DEV_URL="https://pub-YOUR-HASH.r2.dev"
```

**‚ö†Ô∏è Important:** Replace `YOUR-HASH` with the actual hash from your Cloudflare dashboard.

## Option 2: Custom Domain (Production Setup)

### Step 1: Add Domain to Cloudflare

1. Add your domain to Cloudflare (if not already added)
2. Set up DNS properly

### Step 2: Connect Custom Domain to R2 Bucket

1. Go to **R2** ‚Üí **Your Bucket** ‚Üí **Settings**
2. Under **Custom Domains**, click **Add**
3. Enter your domain (e.g., `cdn.yourcompany.com`)
4. Follow the DNS setup instructions

### Step 3: Update Environment Variables

```bash
# Use custom domain
CLOUDFLARE_R2_PUBLIC_URL="https://cdn.yourcompany.com"
```

## Verification Steps

### 1. Test R2 Service

```bash
cd site-bot
npm run test-r2
```

### 2. Check Generated URLs

The service will now generate URLs in this format:
- **Development URL**: `https://pub-{hash}.r2.dev/activities/{file-id}.jpg`
- **Custom Domain**: `https://cdn.yourcompany.com/activities/{file-id}.jpg`

### 3. Test Image Upload via WhatsApp

1. Start your bot: `npm run dev`
2. Send a WhatsApp message to trigger activity logging
3. Upload an image when prompted
4. Check the generated URL in your database

## Updated R2 Service Features

The updated `CloudflareR2Service` now:

‚úÖ **Supports Multiple URL Types**
- Custom domain URLs
- R2 development URLs (r2.dev)
- Fallback to private URLs

‚úÖ **Improved Logging**
- Shows bucket name and public URL on initialization
- Logs successful uploads with generated URLs

‚úÖ **Removed Invalid ACL**
- R2 doesn't support S3 ACL parameters
- Public access is controlled at bucket level

## Environment Variable Priority

The service checks for public URLs in this order:

1. `CLOUDFLARE_R2_PUBLIC_URL` (custom domain)
2. `CLOUDFLARE_R2_DEV_URL` (r2.dev subdomain)
3. `CLOUDFLARE_R2_ENDPOINT` (fallback to private)

## Security Considerations

### Development URL (r2.dev)
- ‚úÖ **Pros**: Quick setup, no domain required
- ‚ö†Ô∏è **Cons**: Rate limited, not for production
- üìù **Use Case**: Development and testing

### Custom Domain
- ‚úÖ **Pros**: Production-ready, full Cloudflare features
- ‚úÖ **Features**: Caching, WAF, bot protection
- üìù **Use Case**: Production deployment

## Testing Your Setup

### 1. Manual URL Test

Once you enable public access, test a URL directly:

```bash
# Replace with your actual public URL
curl -I "https://pub-YOUR-HASH.r2.dev/test-file.jpg"

# Should return 200 OK (if file exists) or 404 (if file doesn't exist)
# Should NOT return 403 Forbidden
```

### 2. Upload Test

```bash
# Run the R2 test script
npm run test-r2

# Look for output like:
# ‚úÖ File uploaded successfully:
# üîë Key: test-uploads/uuid.txt
# üåê Public URL: https://pub-YOUR-HASH.r2.dev/test-uploads/uuid.txt
```

### 3. WhatsApp Integration Test

1. Start bot: `npm run dev`
2. Send message to trigger activity logging
3. Upload image when prompted
4. Check database for public URL
5. Test URL accessibility in browser

## Troubleshooting

### URLs Still Return 403 Forbidden

**Problem**: Bucket is still private
**Solution**: 
1. Double-check public access is enabled in Cloudflare dashboard
2. Wait a few minutes for changes to propagate
3. Verify the correct public URL format

### Getting Wrong URL Format

**Problem**: Environment variables not set correctly
**Solution**:
1. Check `.env` file has correct `CLOUDFLARE_R2_DEV_URL`
2. Restart your application after updating `.env`
3. Check console logs for "R2 Service initialized" message

### Upload Works But URLs Not Accessible

**Problem**: Using private endpoint instead of public URL
**Solution**:
1. Ensure `CLOUDFLARE_R2_DEV_URL` is set in environment
2. Check service initialization logs
3. Verify URL format matches: `https://pub-{hash}.r2.dev/...`

## Quick Fix Commands

```bash
# 1. Navigate to project
cd site-bot

# 2. Check current environment (should show R2 config)
node -e "console.log('R2 Bucket:', process.env.CLOUDFLARE_R2_BUCKET)"
node -e "console.log('R2 Dev URL:', process.env.CLOUDFLARE_R2_DEV_URL)"

# 3. Test R2 integration
npm run test-r2

# 4. Start development server
npm run dev
```

## Next Steps

1. **Enable public development URL** in Cloudflare dashboard
2. **Add CLOUDFLARE_R2_DEV_URL** to your `.env` file
3. **Restart your application**
4. **Test image upload** via WhatsApp
5. **Verify URLs** are publicly accessible

## Cost Implications

### R2 Pricing (as of 2024):
- **Storage**: ~$0.015/GB/month
- **Class A Operations** (writes): ~$4.50/million
- **Class B Operations** (reads): ~$0.36/million
- **Data Transfer**: Free within Cloudflare network

### Public Access Impact:
- **Development URL**: Rate limited, suitable for testing
- **Custom Domain**: Full production capabilities, recommended for live systems

Remember: The development URL is **rate limited** and should only be used for development and testing purposes. 