nohup: ignoring input
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 dev
> ts-node src/index.ts

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 683782988142735
🔐 Token exists: true
🔐 Token length: 239
🔐 Token first 20 chars: EAAXbuPuiqWsBO6dZCtC...
✅ Database connection successful
🚀 Server running on port 3010
📱 WhatsApp webhook endpoint: http://localhost:3010/webhook
🔍 Health check: http://localhost:3010/health
2025-05-30T06:34:08.395Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:10.493Z - POST /webhook
📨 Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNGQTQyRkVGMDhCOEIwODc1MwA=',
  timestamp: '1748586849'
}
Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNGQTQyRkVGMDhCOEIwODc1MwA=",
  "timestamp": "1748586849",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
👤 User: customer, Phone: +19088483575
💬 Message: "Hi"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMTU1REQ2MjJCNkFFNzdBNDYA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-05-30T06:34:13.686Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:14.071Z - POST /webhook
📭 No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NUM0ODYxODVFQkMwODFBOUMA'
    }
  ]
}
2025-05-30T06:34:14.462Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:15.227Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:15.756Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:15.895Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:15.939Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:37.743Z - POST /webhook
📨 Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURDRDEzOENFMUJEQ0QzMzE3OQA=',
  timestamp: '1748586876'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMTU1REQ2MjJCNkFFNzdBNDYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURDRDEzOENFMUJEQ0QzMzE3OQA=",
  "timestamp": "1748586876",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "book_visit",
      "title": "📅 Book Site Visit"
    }
  }
}
👤 User: customer, Phone: +19088483575
💬 Message: "book_visit"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📅 *Book a Site Visit*\n\nLet's schedule your site visit! \n\nPlease share your full name:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1RjRCRDQ0MEI5NTY4MzAzRTcA'
    }
  ]
}
2025-05-30T06:34:40.430Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:41.149Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:41.196Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:41.287Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:51.366Z - POST /webhook
📨 Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUI3NDIwMDc5MEY4Q0JFRjg3QQA=',
  timestamp: '1748586890'
}
Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUI3NDIwMDc5MEY4Q0JFRjg3QQA=",
  "timestamp": "1748586890",
  "text": {
    "body": "Yash Patel"
  },
  "type": "text"
}
👤 User: customer, Phone: +19088483575
💬 Message: "Yash Patel"
🎯 Session: booking, Step: collect_name
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select your preferred date:"
    },
    "action": {
      "button": "Choose Date",
      "sections": [
        {
          "title": "Available Dates",
          "rows": [
            {
              "id": "2025-05-31",
              "title": "Sat, 31 May",
              "description": "Tomorrow"
            },
            {
              "id": "2025-06-01",
              "title": "Sun, 1 Jun",
              "description": ""
            },
            {
              "id": "2025-06-02",
              "title": "Mon, 2 Jun",
              "description": ""
            },
            {
              "id": "2025-06-03",
              "title": "Tue, 3 Jun",
              "description": ""
            },
            {
              "id": "2025-06-04",
              "title": "Wed, 4 Jun",
              "description": ""
            },
            {
              "id": "2025-06-05",
              "title": "Thu, 5 Jun",
              "description": ""
            },
            {
              "id": "2025-06-06",
              "title": "Fri, 6 Jun",
              "description": ""
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0NjlEQUVGNkNCMzExOUY2REIA'
    }
  ]
}
2025-05-30T06:34:54.282Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:54.778Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:54.825Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:34:54.857Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:35:01.627Z - POST /webhook
📨 Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM3NUY4REMyNEJFODAzMUIxQQA=',
  timestamp: '1748586900'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0NjlEQUVGNkNCMzExOUY2REIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM3NUY4REMyNEJFODAzMUIxQQA=",
  "timestamp": "1748586900",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "2025-05-31",
      "title": "Sat, 31 May",
      "description": "Tomorrow"
    }
  }
}
👤 User: customer, Phone: +19088483575
💬 Message: "2025-05-31"
🎯 Session: booking, Step: collect_date
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select your preferred time:"
    },
    "action": {
      "button": "Choose Time",
      "sections": [
        {
          "title": "Available Time Slots",
          "rows": [
            {
              "id": "09:00",
              "title": "9:00 AM",
              "description": "Morning slot"
            },
            {
              "id": "11:00",
              "title": "11:00 AM",
              "description": "Late morning"
            },
            {
              "id": "14:00",
              "title": "2:00 PM",
              "description": "Afternoon"
            },
            {
              "id": "16:00",
              "title": "4:00 PM",
              "description": "Evening"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBOUE4Q0QyQ0EzQ0VBRDlEQzgA'
    }
  ]
}
2025-05-30T06:35:04.226Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:35:04.698Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:35:04.802Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:35:04.819Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:35:09.105Z - POST /webhook
📨 Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM2RjQxMzU2MEFGMkVDNzQ4MQA=',
  timestamp: '1748586908'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBOUE4Q0QyQ0EzQ0VBRDlEQzgA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM2RjQxMzU2MEFGMkVDNzQ4MQA=",
  "timestamp": "1748586908",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "11:00",
      "title": "11:00 AM",
      "description": "Late morning"
    }
  }
}
👤 User: customer, Phone: +19088483575
💬 Message: "11:00"
🎯 Session: booking, Step: collect_time
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ *Booking Confirmed!*\n\n📋 *Details:*\n• Name: Yash Patel\n• Date: Friday 30 May, 2025\n• Time: 11:00 AM\n\n📍 Our team will contact you 1 day before your visit with location details.\n\n*Booking ID:* 4a82e472\n\nType *menu* to go back to main menu."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQTEwMDc5MUI1RkREQUY2RTUA'
    }
  ]
}
2025-05-30T06:35:11.641Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:35:12.215Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:35:12.221Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:35:12.294Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:35:41.971Z - POST /webhook
📨 Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUNDM0QwMzdERTRDODQ0RUIwMwA=',
  timestamp: '1748586940'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMTU1REQ2MjJCNkFFNzdBNDYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUNDM0QwMzdERTRDODQ0RUIwMwA=",
  "timestamp": "1748586940",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "pricing",
      "title": "💰 Pricing & Plans"
    }
  }
}
👤 User: customer, Phone: +19088483575
💬 Message: "pricing"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "💰 *Our Pricing & Plans*\n\n🏠 *Residential Projects:*\n• Studio Apartments: ₹25-35 Lakhs\n• 1 BHK: ₹35-50 Lakhs  \n• 2 BHK: ₹50-75 Lakhs\n• 3 BHK: ₹75 Lakhs+\n\n🏢 *Commercial Projects:*\n• Office Spaces: ₹8,000-12,000/sq ft\n• Retail Spaces: ₹10,000-15,000/sq ft\n\n📋 *What's Included:*\n• Premium location\n• Modern amenities\n• 24/7 security\n• Power backup\n• Parking facilities\n\n*🎯 Special Offers:*\n• Early bird discount: 5%\n• Referral bonus: ₹50,000\n\nWant to know more? Type *talk_to_sales* to connect with our sales team!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5MDlCREQ3QzAyRTEwQzlCMEMA'
    }
  ]
}
2025-05-30T06:35:45.056Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:35:45.555Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:35:45.556Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:35:45.601Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:36:26.534Z - POST /webhook
📨 Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJDNEE2QTEyMTIyRkY0MTY1MwA=',
  timestamp: '1748586985'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMTU1REQ2MjJCNkFFNzdBNDYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJDNEE2QTEyMTIyRkY0MTY1MwA=",
  "timestamp": "1748586985",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "check_availability",
      "title": "🕐 Check Availability"
    }
  }
}
👤 User: customer, Phone: +19088483575
💬 Message: "check_availability"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📅 *Site Visit Availability*\n\n*This Week:*\n• Monday - Friday: 9:00 AM - 5:00 PM\n• Saturday: 10:00 AM - 4:00 PM\n• Sunday: Closed\n\n*Next Available Slots:*\n• Tomorrow: 11:00 AM, 2:00 PM, 4:00 PM\n• Day after: 9:00 AM, 11:00 AM, 2:00 PM\n\nEach visit takes approximately 1-2 hours.\n\nWould you like to book a slot? Type *book* to start booking process."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBODE5MjVDNDc0QTFBMEQ5RDUA'
    }
  ]
}
2025-05-30T06:36:29.454Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:36:29.889Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:36:29.998Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T06:36:30.206Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:36:14.688Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQzFFRDNENDFDRjE3NjVCNDkxRjRBQjIyODcwMzA2QkYA',
  timestamp: '1748590572'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQzFFRDNENDFDRjE3NjVCNDkxRjRBQjIyODcwMzA2QkYA",
  "timestamp": "1748590572",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
✅ Created new customer: +917383489516
👤 User: customer, Phone: +917383489516
💬 Message: "Hi"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNEZBNEVGMUU1RDRCMEY2NDg4AA=='
    }
  ]
}
2025-05-30T07:36:17.948Z - POST /webhook
📭 No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-05-30T07:36:18.782Z - POST /webhook
📭 No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRjlGM0E0QTg5MTRGNDE2NDdBAA=='
    }
  ]
}
2025-05-30T07:36:19.708Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:36:20.009Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:36:20.394Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:36:58.356Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMjVEM0I2NEI5MjVFQTEwNDU4OUJGOEExRjA4QkU4OEEA',
  timestamp: '1748590617'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMjVEM0I2NEI5MjVFQTEwNDU4OUJGOEExRjA4QkU4OEEA",
  "timestamp": "1748590617",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "Hi"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "🔐 Your verification code is: 554548\n\nThis code will expire in 10 minutes. Please enter this code to verify your employee account."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQzc5OEI4NjVEQ0I4OUU3MkEwAA=='
    }
  ]
}
📲 OTP sent to +917383489516
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "👋 Welcome to the Employee Portal!\n\n🔐 For security, please verify your account. I've sent you a 6-digit verification code.\n\nPlease enter the code to continue:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMkZGNThGMjQ4NkI3ODJENzJGAA=='
    }
  ]
}
2025-05-30T07:37:01.365Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:01.719Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:02.101Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:02.107Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:02.501Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:02.503Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:15.615Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNDk3RkZCMTY2OTA3ODY2MzhBM0Y2QjJDMjcyM0FBNjAA',
  timestamp: '1748590634'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNDk3RkZCMTY2OTA3ODY2MzhBM0Y2QjJDMjcyM0FBNjAA",
  "timestamp": "1748590634",
  "text": {
    "body": "554548"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "554548"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Successfully verified! Welcome to the employee portal."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSREQ5NzgzN0M3NEZDQ0I1QTY3AA=='
    }
  ]
}
2025-05-30T07:37:18.444Z - POST /webhook
📭 No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "🎉 *Welcome to Employee Portal!*\n\nYou're now verified and ready to use our employee services.\n\nWhat would you like to do today?"
  }
}
2025-05-30T07:37:18.684Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:18.756Z - POST /webhook
📭 No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQzkxREY3ODBENDhBRDVFOTczAA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *Employee Portal*\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 Log Activity"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 Request Materials"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "view_dashboard",
            "title": "📊 View Dashboard"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNzc1MjA4Njc2MkVDNjJGMjNDAA=='
    }
  ]
}
2025-05-30T07:37:20.228Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:20.505Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:20.694Z - POST /webhook
📭 No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Support",
          "rows": [
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            },
            {
              "id": "contact_admin",
              "title": "📞 Contact Admin",
              "description": "Reach out to administration"
            }
          ]
        }
      ]
    }
  }
}
2025-05-30T07:37:21.115Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:21.225Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:21.276Z - POST /webhook
📭 No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMzBGRjQ4NURGNDE2RjAwQjY4AA=='
    }
  ]
}
2025-05-30T07:37:22.780Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:22.974Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:23.196Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:23.289Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRjJFNTg2QzgyQTlBNzNCRUMwRTA4MENGQTNCRkFCODcA',
  timestamp: '1748590642'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNzc1MjA4Njc2MkVDNjJGMjNDAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRjJFNTg2QzgyQTlBNzNCRUMwRTA4MENGQTNCRkFCODcA",
  "timestamp": "1748590642",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 Log Activity"
    }
  }
}
👤 User: employee, Phone: +917383489516
💬 Message: "log_activity"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select the site where you worked:"
    },
    "action": {
      "button": "Choose Site",
      "sections": [
        {
          "title": "Active Sites",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Site A - Residential",
              "description": "Main residential project"
            },
            {
              "id": "site_2",
              "title": "🏢 Site B - Commercial",
              "description": "Office complex project"
            },
            {
              "id": "site_3",
              "title": "🏬 Site C - Retail",
              "description": "Shopping center project"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQkE4OEZBRjEzRUE4MTcxMUVDAA=='
    }
  ]
}
2025-05-30T07:37:25.956Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:26.009Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:26.099Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:30.736Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRkRCMDUyRkEyNjQ3NUEzMjBGNzM2OEIwNDg5MTQ2QkQA',
  timestamp: '1748590649'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQkE4OEZBRjEzRUE4MTcxMUVDAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRkRCMDUyRkEyNjQ3NUEzMjBGNzM2OEIwNDg5MTQ2QkQA",
  "timestamp": "1748590649",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Site A - Residential",
      "description": "Main residential project"
    }
  }
}
👤 User: employee, Phone: +917383489516
💬 Message: "site_1"
🎯 Session: log_activity, Step: select_site
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "What type of activity did you perform?"
    },
    "action": {
      "button": "Select Activity",
      "sections": [
        {
          "title": "Activity Types",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 Construction Work",
              "description": "Building and construction tasks"
            },
            {
              "id": "inspection",
              "title": "🔍 Inspection",
              "description": "Quality checks and inspections"
            },
            {
              "id": "maintenance",
              "title": "🔧 Maintenance",
              "description": "Equipment and site maintenance"
            },
            {
              "id": "planning",
              "title": "📋 Planning",
              "description": "Project planning and coordination"
            },
            {
              "id": "other",
              "title": "📝 Other",
              "description": "Other work activities"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNDUyOTJDNkI5NDVCNTMwNjI3AA=='
    }
  ]
}
2025-05-30T07:37:33.069Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:33.401Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:33.612Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:38.510Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNkRBOTBGM0EwOEJFRUUyQUQ1OEMxMzlDRTE0QjI5RTUA',
  timestamp: '1748590657'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNDUyOTJDNkI5NDVCNTMwNjI3AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNkRBOTBGM0EwOEJFRUUyQUQ1OEMxMzlDRTE0QjI5RTUA",
  "timestamp": "1748590657",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "construction",
      "title": "🔨 Construction Work",
      "description": "Building and construction tasks"
    }
  }
}
👤 User: employee, Phone: +917383489516
💬 Message: "construction"
🎯 Session: log_activity, Step: select_activity_type
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "How many hours did you work? (Enter a number):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRTQxRkIyQUU3NUUxRDlCOUU2AA=='
    }
  ]
}
2025-05-30T07:37:40.746Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:40.972Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:41.306Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:45.618Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNzZDMDczMUI5MUQ3Q0FBOEUxMzZENzE5NzVGNEQ5NkQA',
  timestamp: '1748590664'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNzZDMDczMUI5MUQ3Q0FBOEUxMzZENzE5NzVGNEQ5NkQA",
  "timestamp": "1748590664",
  "text": {
    "body": "1"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "1"
🎯 Session: log_activity, Step: enter_hours
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Please describe what you did (optional - type 'skip' to skip):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQ0JDQ0QxMkIwMUM1NjVBQTBGAA=='
    }
  ]
}
2025-05-30T07:37:47.973Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:48.238Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:48.465Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:37:57.602Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggODREMTM3ODYxNDNENjlEQ0JGMzZEMUIwREJFNTQxNUEA',
  timestamp: '1748590676'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggODREMTM3ODYxNDNENjlEQ0JGMzZEMUIwREJFNTQxNUEA",
  "timestamp": "1748590676",
  "text": {
    "body": "Skip"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "Skip"
🎯 Session: log_activity, Step: enter_description
Error logging activity: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/src/node-postgres/session.ts:65:19
    at async EmployeeFlow.completeActivityLog (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:337:24)
    at async EmployeeFlow.handleActivityLogging (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:303:9)
    at async EmployeeFlow.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:244:7)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:30:7)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/messageHandler.ts:64:9)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/routes/webhook.ts:61:5 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $2 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Sorry, there was an error logging your activity. Please try again."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSODI0QTc2MTg4M0U3Q0IzNEUxAA=='
    }
  ]
}
2025-05-30T07:38:00.191Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:00.504Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:00.690Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:05.595Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQ0MwRUU1Qjk5REQzNERFM0VDNkNGMzFBNTg0NUIzNEUA',
  timestamp: '1748590684'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQ0MwRUU1Qjk5REQzNERFM0VDNkNGMzFBNTg0NUIzNEUA",
  "timestamp": "1748590684",
  "text": {
    "body": "skip"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "skip"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *Employee Portal*\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 Log Activity"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 Request Materials"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "view_dashboard",
            "title": "📊 View Dashboard"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOEI4RkQxM0UwNzFBRjc5MzE0AA=='
    }
  ]
}
2025-05-30T07:38:08.177Z - POST /webhook
📭 No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Support",
          "rows": [
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            },
            {
              "id": "contact_admin",
              "title": "📞 Contact Admin",
              "description": "Reach out to administration"
            }
          ]
        }
      ]
    }
  }
}
2025-05-30T07:38:08.567Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:08.617Z - POST /webhook
📭 No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNTA3OUE0QzQxRkYyM0E0QTJDAA=='
    }
  ]
}
2025-05-30T07:38:09.999Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:10.503Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:10.510Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:14.802Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNDk5NEFCRDM5OURBMzI2OTQwNjA1OUUxMzc5NEU2N0UA',
  timestamp: '1748590693'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOEI4RkQxM0UwNzFBRjc5MzE0AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNDk5NEFCRDM5OURBMzI2OTQwNjA1OUUxMzc5NEU2N0UA",
  "timestamp": "1748590693",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 Log Activity"
    }
  }
}
👤 User: employee, Phone: +917383489516
💬 Message: "log_activity"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select the site where you worked:"
    },
    "action": {
      "button": "Choose Site",
      "sections": [
        {
          "title": "Active Sites",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Site A - Residential",
              "description": "Main residential project"
            },
            {
              "id": "site_2",
              "title": "🏢 Site B - Commercial",
              "description": "Office complex project"
            },
            {
              "id": "site_3",
              "title": "🏬 Site C - Retail",
              "description": "Shopping center project"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRTMyNDlBOEQ5RkIzM0RDM0ZBAA=='
    }
  ]
}
2025-05-30T07:38:17.464Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:17.543Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:17.623Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:21.661Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRjI3MkUzRDFCOUU1RTkzMzUwMkY3MDg5MzFDQ0UwMDEA',
  timestamp: '1748590700'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRTMyNDlBOEQ5RkIzM0RDM0ZBAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRjI3MkUzRDFCOUU1RTkzMzUwMkY3MDg5MzFDQ0UwMDEA",
  "timestamp": "1748590700",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Site A - Residential",
      "description": "Main residential project"
    }
  }
}
👤 User: employee, Phone: +917383489516
💬 Message: "site_1"
🎯 Session: log_activity, Step: select_site
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "What type of activity did you perform?"
    },
    "action": {
      "button": "Select Activity",
      "sections": [
        {
          "title": "Activity Types",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 Construction Work",
              "description": "Building and construction tasks"
            },
            {
              "id": "inspection",
              "title": "🔍 Inspection",
              "description": "Quality checks and inspections"
            },
            {
              "id": "maintenance",
              "title": "🔧 Maintenance",
              "description": "Equipment and site maintenance"
            },
            {
              "id": "planning",
              "title": "📋 Planning",
              "description": "Project planning and coordination"
            },
            {
              "id": "other",
              "title": "📝 Other",
              "description": "Other work activities"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQzcwMUY4MkZDNTEyRTM4RDlFAA=='
    }
  ]
}
2025-05-30T07:38:23.886Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:24.233Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:24.734Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:31.625Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggODNEMjU3NDc5QjM0MTQyQkM3RUU1M0VFQTAxQjQ3NDgA',
  timestamp: '1748590710'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQzcwMUY4MkZDNTEyRTM4RDlFAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggODNEMjU3NDc5QjM0MTQyQkM3RUU1M0VFQTAxQjQ3NDgA",
  "timestamp": "1748590710",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "construction",
      "title": "🔨 Construction Work",
      "description": "Building and construction tasks"
    }
  }
}
👤 User: employee, Phone: +917383489516
💬 Message: "construction"
🎯 Session: log_activity, Step: select_activity_type
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "How many hours did you work? (Enter a number):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRDJCMDMwNEI0NEFDRTc1OUJFAA=='
    }
  ]
}
2025-05-30T07:38:34.172Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:34.374Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:34.799Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:38.048Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNEFFNjAzOUJCQkEwNjhCNTEyNUI0QUY2QTBFMjQ4ODgA',
  timestamp: '1748590717'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNEFFNjAzOUJCQkEwNjhCNTEyNUI0QUY2QTBFMjQ4ODgA",
  "timestamp": "1748590717",
  "text": {
    "body": "1"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "1"
🎯 Session: log_activity, Step: enter_hours
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Please describe what you did (optional - type 'skip' to skip):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMjYzNEI5ODE0QjcyM0Y2M0YzAA=='
    }
  ]
}
2025-05-30T07:38:40.403Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:40.710Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:38:41.137Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:05.473Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQzQ3NTVBOUZDMDBCOTlDOEFCNkY2MDJERkM0NzI4MEIA',
  timestamp: '1748591644'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQzQ3NTVBOUZDMDBCOTlDOEFCNkY2MDJERkM0NzI4MEIA",
  "timestamp": "1748591644",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "Hi"
🎯 Session: log_activity, Step: enter_description
Error logging activity: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/src/node-postgres/session.ts:65:19
    at async EmployeeFlow.completeActivityLog (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:337:24)
    at async EmployeeFlow.handleActivityLogging (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:303:9)
    at async EmployeeFlow.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:244:7)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:30:7)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/messageHandler.ts:64:9)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/routes/webhook.ts:61:5 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $2 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Sorry, there was an error logging your activity. Please try again."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQUZFNUEyMEZDM0E2MjZDRTFEAA=='
    }
  ]
}
2025-05-30T07:54:08.346Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:08.484Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:08.594Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:22.821Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggN0JCMUFBNURBNTI5OEFCQzlCRkE4OTI4NzQ3OTk2RkMA',
  timestamp: '1748591661'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggN0JCMUFBNURBNTI5OEFCQzlCRkE4OTI4NzQ3OTk2RkMA",
  "timestamp": "1748591661",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "Hi"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *Employee Portal*\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 Log Activity"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 Request Materials"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "view_dashboard",
            "title": "📊 View Dashboard"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOTZDRTlGRUExMjFEMUQxNjNCAA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Support",
          "rows": [
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            },
            {
              "id": "contact_admin",
              "title": "📞 Contact Admin",
              "description": "Reach out to administration"
            }
          ]
        }
      ]
    }
  }
}
2025-05-30T07:54:25.637Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:25.739Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:25.739Z - POST /webhook
📭 No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRjdCRjNDQUQ1MjI2OTFFQkZBAA=='
    }
  ]
}
2025-05-30T07:54:27.285Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:27.364Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:27.700Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:34.459Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggODg2NjY5RUNEM0JFQTI5NDdENkM0QTNFMkE3OTJCODQA',
  timestamp: '1748591673'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOTZDRTlGRUExMjFEMUQxNjNCAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggODg2NjY5RUNEM0JFQTI5NDdENkM0QTNFMkE3OTJCODQA",
  "timestamp": "1748591673",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 Log Activity"
    }
  }
}
👤 User: employee, Phone: +917383489516
💬 Message: "log_activity"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select the site where you worked:"
    },
    "action": {
      "button": "Choose Site",
      "sections": [
        {
          "title": "Active Sites",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Site A - Residential",
              "description": "Main residential project"
            },
            {
              "id": "site_2",
              "title": "🏢 Site B - Commercial",
              "description": "Office complex project"
            },
            {
              "id": "site_3",
              "title": "🏬 Site C - Retail",
              "description": "Shopping center project"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOUVCRUNEMjM2QjlCRUIxNjM4AA=='
    }
  ]
}
2025-05-30T07:54:37.529Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:37.645Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:37.802Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:43.568Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQTAzNzRGNDI5OTJDOTI0MTZEMjlGNDBEQUQ4Q0M4QTIA',
  timestamp: '1748591682'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOUVCRUNEMjM2QjlCRUIxNjM4AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQTAzNzRGNDI5OTJDOTI0MTZEMjlGNDBEQUQ4Q0M4QTIA",
  "timestamp": "1748591682",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Site A - Residential",
      "description": "Main residential project"
    }
  }
}
👤 User: employee, Phone: +917383489516
💬 Message: "site_1"
🎯 Session: log_activity, Step: select_site
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "What type of activity did you perform?"
    },
    "action": {
      "button": "Select Activity",
      "sections": [
        {
          "title": "Activity Types",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 Construction Work",
              "description": "Building and construction tasks"
            },
            {
              "id": "inspection",
              "title": "🔍 Inspection",
              "description": "Quality checks and inspections"
            },
            {
              "id": "maintenance",
              "title": "🔧 Maintenance",
              "description": "Equipment and site maintenance"
            },
            {
              "id": "planning",
              "title": "📋 Planning",
              "description": "Project planning and coordination"
            },
            {
              "id": "other",
              "title": "📝 Other",
              "description": "Other work activities"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQTFEQ0MzNTY5MDkzQThCREJEAA=='
    }
  ]
}
2025-05-30T07:54:45.800Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:46.066Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:46.644Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:56.374Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggOUVCRjQ2OEQwQzlEQjg4NEIwMzBGQUREQzI3OUZFOUUA',
  timestamp: '1748591695'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQTFEQ0MzNTY5MDkzQThCREJEAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggOUVCRjQ2OEQwQzlEQjg4NEIwMzBGQUREQzI3OUZFOUUA",
  "timestamp": "1748591695",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 Inspection",
      "description": "Quality checks and inspections"
    }
  }
}
👤 User: employee, Phone: +917383489516
💬 Message: "inspection"
🎯 Session: log_activity, Step: select_activity_type
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "How many hours did you work? (Enter a number):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNDVDQTE3M0Q3RDY2QzMyODVEAA=='
    }
  ]
}
2025-05-30T07:54:59.005Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:59.485Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:54:59.539Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:55:03.350Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggODdDQkRGRUJGQUEwNDBEQ0UyODdCNUU4MkYyRTFCODgA',
  timestamp: '1748591702'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggODdDQkRGRUJGQUEwNDBEQ0UyODdCNUU4MkYyRTFCODgA",
  "timestamp": "1748591702",
  "text": {
    "body": "2"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "2"
🎯 Session: log_activity, Step: enter_hours
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Please describe what you did (optional - type 'skip' to skip):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRjk4NUQ0NDJERkE2M0E3OURCAA=='
    }
  ]
}
2025-05-30T07:55:05.538Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:55:05.884Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:55:06.049Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:55:11.263Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNUNCMjRENzBEM0Q0RkVFMEY2RDhFQjlDODVBQ0E5MkQA',
  timestamp: '1748591710'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNUNCMjRENzBEM0Q0RkVFMEY2RDhFQjlDODVBQ0E5MkQA",
  "timestamp": "1748591710",
  "text": {
    "body": "Test"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "Test"
🎯 Session: log_activity, Step: enter_description
Error logging activity: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/src/node-postgres/session.ts:65:19
    at async EmployeeFlow.completeActivityLog (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:337:24)
    at async EmployeeFlow.handleActivityLogging (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:303:9)
    at async EmployeeFlow.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:244:7)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:30:7)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/messageHandler.ts:64:9)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/routes/webhook.ts:61:5 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $2 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Sorry, there was an error logging your activity. Please try again."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRkYwRkEzOUFGODA5RkY2RjUwAA=='
    }
  ]
}
2025-05-30T07:55:14.379Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:55:14.391Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:55:14.400Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:56:54.443Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRENBN0YzMDdGNkY0NjAwMjA5MEIzNEYwOUZCNEQ2Q0IA',
  timestamp: '1748591813'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRENBN0YzMDdGNkY0NjAwMjA5MEIzNEYwOUZCNEQ2Q0IA",
  "timestamp": "1748591813",
  "text": {
    "body": "Hello"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "Hello"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *Employee Portal*\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 Log Activity"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 Request Materials"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "view_dashboard",
            "title": "📊 View Dashboard"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQ0I5M0EyQTUzQ0NGQkJDNTE1AA=='
    }
  ]
}
2025-05-30T07:56:57.407Z - POST /webhook
📭 No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Support",
          "rows": [
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            },
            {
              "id": "contact_admin",
              "title": "📞 Contact Admin",
              "description": "Reach out to administration"
            }
          ]
        }
      ]
    }
  }
}
2025-05-30T07:56:57.618Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:56:57.924Z - POST /webhook
📭 No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSODdBRTNFQzBDMkM0NjY1NzQxAA=='
    }
  ]
}
2025-05-30T07:56:58.937Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:56:59.139Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:56:59.388Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:57:03.604Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggODVEMDU3MDE2NUYwMUU0NkM4MjU3ODZFRTJBQkJBN0MA',
  timestamp: '1748591822'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQ0I5M0EyQTUzQ0NGQkJDNTE1AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggODVEMDU3MDE2NUYwMUU0NkM4MjU3ODZFRTJBQkJBN0MA",
  "timestamp": "1748591822",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 Log Activity"
    }
  }
}
👤 User: employee, Phone: +917383489516
💬 Message: "log_activity"
🎯 Session: none, Step: none
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select the site where you worked:"
    },
    "action": {
      "button": "Choose Site",
      "sections": [
        {
          "title": "Active Sites",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Site A - Residential",
              "description": "Main residential project"
            },
            {
              "id": "site_2",
              "title": "🏢 Site B - Commercial",
              "description": "Office complex project"
            },
            {
              "id": "site_3",
              "title": "🏬 Site C - Retail",
              "description": "Shopping center project"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMzg3NjlDQjUxODMxMjMyMUI4AA=='
    }
  ]
}
2025-05-30T07:57:06.426Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:57:06.629Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T07:57:06.759Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:00:02.253Z - GET /webhook
🔐 Webhook verification request: { mode: 'subscribe', token: 'qsefthuko' }
✅ Webhook verified successfully
2025-05-30T08:00:08.952Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMTA2RUI0NEJDRUY5NTFBODE4NDU3NUVCRjY1ODk1QjIA',
  timestamp: '1748592008'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMTA2RUI0NEJDRUY5NTFBODE4NDU3NUVCRjY1ODk1QjIA",
  "timestamp": "1748592008",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "Hi"
🎯 Session: log_activity, Step: select_site
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Please select a valid site from the list:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQzI0NTU1NEYxNUI5NDVCNzU0AA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select the site where you worked:"
    },
    "action": {
      "button": "Choose Site",
      "sections": [
        {
          "title": "Active Sites",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Site A - Residential",
              "description": "Main residential project"
            },
            {
              "id": "site_2",
              "title": "🏢 Site B - Commercial",
              "description": "Office complex project"
            },
            {
              "id": "site_3",
              "title": "🏬 Site C - Retail",
              "description": "Shopping center project"
            }
          ]
        }
      ]
    }
  }
}
2025-05-30T08:00:11.876Z - POST /webhook
📭 No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRDA0MUEzMkQ5RjlFQkEwMzY2AA=='
    }
  ]
}
2025-05-30T08:00:12.315Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:00:12.503Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:00:13.078Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:00:13.112Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:00:13.223Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:00:16.948Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMjQyNjdFMTlENjczQ0RCODY1OTA2OEE2OEE1OUIzRDEA',
  timestamp: '1748592016'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRDA0MUEzMkQ5RjlFQkEwMzY2AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMjQyNjdFMTlENjczQ0RCODY1OTA2OEE2OEE1OUIzRDEA",
  "timestamp": "1748592016",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Site A - Residential",
      "description": "Main residential project"
    }
  }
}
👤 User: employee, Phone: +917383489516
💬 Message: "site_1"
🎯 Session: log_activity, Step: select_site
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "What type of activity did you perform?"
    },
    "action": {
      "button": "Select Activity",
      "sections": [
        {
          "title": "Activity Types",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 Construction Work",
              "description": "Building and construction tasks"
            },
            {
              "id": "inspection",
              "title": "🔍 Inspection",
              "description": "Quality checks and inspections"
            },
            {
              "id": "maintenance",
              "title": "🔧 Maintenance",
              "description": "Equipment and site maintenance"
            },
            {
              "id": "planning",
              "title": "📋 Planning",
              "description": "Project planning and coordination"
            },
            {
              "id": "other",
              "title": "📝 Other",
              "description": "Other work activities"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMTVGQUY1MkNCODBEMEFBMTYzAA=='
    }
  ]
}
2025-05-30T08:00:19.458Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:00:19.501Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:00:19.787Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:00:23.452Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggN0RGNjBGRDk0OTZDRDNGMkYxMTlBMEQxMEM1NjYzMzcA',
  timestamp: '1748592022'
}
Message content: {
  "context": {
    "from": "15556573937",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMTVGQUY1MkNCODBEMEFBMTYzAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggN0RGNjBGRDk0OTZDRDNGMkYxMTlBMEQxMEM1NjYzMzcA",
  "timestamp": "1748592022",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "construction",
      "title": "🔨 Construction Work",
      "description": "Building and construction tasks"
    }
  }
}
👤 User: employee, Phone: +917383489516
💬 Message: "construction"
🎯 Session: log_activity, Step: select_activity_type
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "How many hours did you work? (Enter a number):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSODg2MDc0REIxNzM0MTM2MTQzAA=='
    }
  ]
}
2025-05-30T08:00:25.702Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:00:26.002Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:00:26.204Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:01:15.266Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQURCQzg3MTkyNTg0REJGNDkzMTM1QUY0OEMzNTZGOTcA',
  timestamp: '1748592074'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQURCQzg3MTkyNTg0REJGNDkzMTM1QUY0OEMzNTZGOTcA",
  "timestamp": "1748592074",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "Hi"
🎯 Session: log_activity, Step: enter_hours
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Please enter a valid number of hours (1-24):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOEY1MzBBMzI4NDdDNTZEQkRFAA=='
    }
  ]
}
2025-05-30T08:01:17.926Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:01:18.114Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:01:18.335Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:01:27.383Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRDE1RjU0NjVGRjlBNjIxOUU0M0RDMDE1OTFCQURDQjQA',
  timestamp: '1748592086'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRDE1RjU0NjVGRjlBNjIxOUU0M0RDMDE1OTFCQURDQjQA",
  "timestamp": "1748592086",
  "text": {
    "body": "12"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "12"
🎯 Session: log_activity, Step: enter_hours
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Please describe what you did (optional - type 'skip' to skip):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNEVCRTgwQTFDQ0RDMTlENkQ1AA=='
    }
  ]
}
2025-05-30T08:01:30.253Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:01:30.726Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:01:31.036Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:01:35.737Z - POST /webhook
📨 Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQzdCRTE3NkNFQzMxNzk5NUQ2MEQ3RjIwN0Q1Q0I4NjkA',
  timestamp: '1748592094'
}
Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQzdCRTE3NkNFQzMxNzk5NUQ2MEQ3RjIwN0Q1Q0I4NjkA",
  "timestamp": "1748592094",
  "text": {
    "body": "Test"
  },
  "type": "text"
}
👤 User: employee, Phone: +917383489516
💬 Message: "Test"
🎯 Session: log_activity, Step: enter_description
Error logging activity: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/src/node-postgres/session.ts:65:19
    at async EmployeeFlow.completeActivityLog (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:337:24)
    at async EmployeeFlow.handleActivityLogging (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:303:9)
    at async EmployeeFlow.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:244:7)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/flows/employeeFlow.ts:30:7)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/services/messageHandler.ts:64:9)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/src/routes/webhook.ts:61:5 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $2 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Sorry, there was an error logging your activity. Please try again."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOTc2MEQ3QTI0RUMxQzZEMDhBAA=='
    }
  ]
}
2025-05-30T08:01:38.334Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:01:38.604Z - POST /webhook
📭 No messages in webhook payload
2025-05-30T08:01:38.787Z - POST /webhook
📭 No messages in webhook payload
Terminated
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
node:internal/modules/cjs/loader:1219
  const err = new Error(message);
              ^

Error: Cannot find module 'semver'
Require stack:
- /usr/share/nodejs/npm/lib/utils/unsupported.js
- /usr/share/nodejs/npm/lib/cli.js
- /usr/share/nodejs/npm/bin/npm-cli.js
    at Module._resolveFilename (node:internal/modules/cjs/loader:1219:15)
    at Module._load (node:internal/modules/cjs/loader:1045:27)
    at TracingChannel.traceSync (node:diagnostics_channel:315:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:215:24)
    at Module.require (node:internal/modules/cjs/loader:1304:12)
    at require (node:internal/modules/helpers:123:16)
    at Object.<anonymous> (/usr/share/nodejs/npm/lib/utils/unsupported.js:2:16)
    at Module._compile (node:internal/modules/cjs/loader:1504:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1588:10)
    at Module.load (node:internal/modules/cjs/loader:1282:32) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    '/usr/share/nodejs/npm/lib/utils/unsupported.js',
    '/usr/share/nodejs/npm/lib/cli.js',
    '/usr/share/nodejs/npm/bin/npm-cli.js'
  ]
}

Node.js v22.5.1
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 683782988142735
🔐 Token exists: true
🔐 Token length: 239
🔐 Token first 20 chars: EAAXbuPuiqWsBO6dZCtC...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ Database connection successful
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
Killed
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 683782988142735
🔐 Token exists: true
🔐 Token length: 239
🔐 Token first 20 chars: EAAXbuPuiqWsBO6dZCtC...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ Database connection successful
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 683782988142735
🔐 Token exists: true
🔐 Token length: 239
🔐 Token first 20 chars: EAAXbuPuiqWsBO6dZCtC...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ Database connection successful
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-05-30T13:04:09.201Z - GET /favicon.ico
2025-05-30T13:05:13.664Z - GET /health
2025-05-30T13:05:35.571Z - GET /
2025-05-30T13:06:06.959Z - GET /webhook
🔐 Webhook verification request: { mode: 'subscribe', token: 'qsefthuko' }
✅ Webhook verified successfully
2025-05-30T13:06:15.774Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ3RTk0QjhFNDlFQ0Q2MzQ1OQA=',
  timestamp: '1748610374'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ3RTk0QjhFNDlFQ0Q2MzQ1OQA=",
  "timestamp": "1748610374",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +19088483575
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMzUwQzE4QUVEMDIxNDZCMjAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-05-30T13:06:18.946Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-05-30T13:06:18.948Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxMjMyNUREMUE3NTdFQUI3QkQA'
    }
  ]
}
2025-05-30T13:06:19.512Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-05-30T13:06:20.109Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-05-30T13:06:20.788Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-05-30T13:06:21.030Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-05-31T02:05:35.803Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY1M0M3NTM2OTU1MTkxRTc3RgA=',
  timestamp: '1748657133'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY1M0M3NTM2OTU1MTkxRTc3RgA=",
  "timestamp": "1748657133",
  "text": {
    "body": "Hey"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +19088483575
💬 [HANDLER] Message: "Hey"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCMUFFRkVDQkQ3M0RCMjFBMDUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-05-31T02:05:38.820Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/683782988142735/messages
📱 Phone Number ID: 683782988142735
🔐 Token (first 20): EAAXbuPuiqWsBO6dZCtC...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-05-31T02:05:39.592Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGN0U4OTc2MUE0QTk5MTg4NEQA'
    }
  ]
}
2025-05-31T02:05:39.830Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-05-31T02:05:40.765Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-05-31T02:05:41.127Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-05-31T02:11:21.399Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date in 3s

40 packages are looking for funding
  run `npm fund` for details
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 683782988142735
🔐 Token exists: true
🔐 Token length: 239
🔐 Token first 20 chars: EAAXbuPuiqWsBO6dZCtC...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ Database connection successful
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

removed 16 packages, and audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 230
🔐 Token first 20 chars: EAASY8LmFhiYBO3u3ukW...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ Database connection successful
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T06:54:41.922Z - GET /
2025-06-10T06:54:43.061Z - GET /favicon.ico
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 5s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 230
🔐 Token first 20 chars: EAASY8LmFhiYBO3u3ukW...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ Database connection successful
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T07:39:38.582Z - GET /
2025-06-10T07:39:39.192Z - GET /favicon.ico
2025-06-10T07:39:52.066Z - GET /webhook
🔐 Webhook verification request: { mode: 'subscribe', token: 'qsefthuko' }
✅ Webhook verified successfully
2025-06-10T08:03:29.972Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUNBRjk0OTY5RUNDOTY1RkJEQgA=',
  timestamp: '1749542608'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUNBRjk0OTY5RUNDOTY1RkJEQgA=",
  "timestamp": "1749542608",
  "text": {
    "body": "Hello"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
Error marking message as read: AxiosError: Request failed with status code 401
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.markAsRead (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:202:13)
    at async withTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:21:24)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:56:13)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBO3u3ukWTZAIqOidoZBhOUhE3s0bgLGKDBgg1bRUVwqzhOR4xWFySmZBcUec8L7celRy8nzRBSzHujM5ZBvp5O53abSG7B71ZBLVCdqOC9S3QJLJpHqjZBdkrURpBIdtABCMG0meY8pS4bh0bbzFNZAM2ttZCSjzEvUYGh3AeFiYfvYLwQH63iPyKa1M7yX9mpOceJ1Xlx6CaBzLEtosECP8ZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '126',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: '{"messaging_product":"whatsapp","status":"read","message_id":"wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUNBRjk0OTY5RUNDOTY1RkJEQgA="}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '126',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 1453769,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 149,
        [Symbol(triggerId)]: 147
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBO3u3ukWTZAIqOidoZBhOUhE3s0bgLGKDBgg1bRUVwqzhOR4xWFySmZBcUec8L7celRy8nzRBSzHujM5ZBvp5O53abSG7B71ZBLVCdqOC9S3QJLJpHqjZBdkrURpBIdtABCMG0meY8pS4bh0bbzFNZAM2ttZCSjzEvUYGh3AeFiYfvYLwQH63iPyKa1M7yX9mpOceJ1Xlx6CaBzLEtosECP8ZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 126\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 401,
      statusMessage: 'Unauthorized',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 46,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: false,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 126,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 401,
    statusText: 'Unauthorized',
    headers: Object [AxiosHeaders] {
      'error-mid': '3b61b1893bdda23cc09efe288a53acdf',
      vary: 'Origin, Accept-Encoding',
      'access-control-allow-origin': '*',
      'cross-origin-resource-policy': 'cross-origin',
      'x-app-usage': '{"call_count":0,"total_cputime":0,"total_time":0}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_token" "Error validating access token: Session has expired on Tuesday, 10-Jun-25 01:00:00 PDT. The current time is Tuesday, 10-Jun-25 01:03:30 PDT."',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'ADYsAKa6oFe6btyloB6O-4k',
      'x-fb-trace-id': 'G0cjO0VZCdz',
      'x-fb-rev': '1023667566',
      'x-fb-debug': 'i+qyjrMecgUNpwXHsMB+GDUDgKoavZcl9BDTYX6ihLvv5ViZ4M+NlrLlVmEkYdtPkDO3ssEe5BmYTt2UDnSa/Q==',
      date: 'Tue, 10 Jun 2025 08:03:30 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcMUtBInFqHMrhndHstNNz9IJwR_d4DpoTTxUYWxVGNUjk9zvD1bf3CkNL8CFVSHm9dHhpTK1SVZ2sp7Cs9v-vrKr5ZoBPZB6A"; e_clientaddr="AcMWQsalC_KND0_OxTtd4pfCw7Ded77U8tr_LZ9WC5wPAP0rqKzviGfE7LZ9NoG6VHMDXdw5VnETGLdzuY3DPXKVuDlV_a8Nplg77BOhdSkrtJGTHA"; e_upip="AcOHjFWGnhH2nEIrvdDHdXmm0miMxTacebHBOHAg-wdqqgtBFqHcSCG_c1Mv9vZKoJX8cBb6YOjJ-O4wEZa9Aln6wDtFUFteqIufv0Y"; e_fb_zone="AcPtIZ0FGs1ZZjrgu6dgYg_J7IWWH2mxh5ernLZ6zQkfsl-HX7owf0OXuq3hHpDt"; e_fb_twtaskhandle="AcMiJ2KO1yvWp3X6QeWP8fvlohd_AwvgavNPoRsLq3JGzGFc2WyG8CfXuEl8X7JHaTbuSRcrY92VastVUDXYkjTWSCpI6rlQYbNFoxh1iKQzJOg"; e_proxy="AcMQ16GwoeDHLPZFuiEwzHpE776IcVGqYuvyH6TgpHr0Qwo3lCGJ8blyGAwmW-nbdZYT0PZeqQNy9jqXXFNC", http_request_error; e_fb_vipaddr="AcOG8pxsZeJVk6tyXKnQJB8VR8NEHKD0QBzdMB2MiqTTMgra-ul0KzhEdpR1rb1CvO4h6-VoOjgfklIJ_J0F0PdyGfadvRJP"; e_clientaddr="AcM9atJiSetzVldt7NrNnKIJK-FeZ8_hyWNlP4VzuQNFR3mWGSEwg28nDhsvrtNxC4qJeo29-rl2m0pCwv8wl7CT8yPsNRHOYcMfi0RJBBn-ybNpbJCMUw"; e_upip="AcO3bFdJVR9ped-5VyBNe0zI6JwchFtlqesCZUWa_jXgExB3HeNNnik4nNSHeEb8Pq3hVdNtodxVb16tfOeShraT2i3suhhfNA"; e_fb_zone="AcMuIUWpDfrSJyE6vKDruBqEx3gd5VOu6ukFdRVYnHpVH1r0PWFjLVpoHmKfUQ"; e_fb_twtaskhandle="AcNDgHCj4Mbw1vk4LNYhsuIsSS1SZ7wfFBEmkQ2dYfYMBQWsM0n0FLJeIRrOas1IDvPp19-JIh2aHrvspAqlLopSemCCfv0qevCL"; e_proxy="AcPhy16G7vabyTU78cfJT9Jzp_cNK-JkBcfogAirV4aA6Ese_uCxOzPU_MqjpSoR4q7X6ir_H_el9Z8"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=35, rtx=0, c=10, mss=1380, tbw=3405, tp=-1, tpl=-1, uplat=371, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '192'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: '{"messaging_product":"whatsapp","status":"read","message_id":"wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUNBRjk0OTY5RUNDOTY1RkJEQgA="}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '126',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBO3u3ukWTZAIqOidoZBhOUhE3s0bgLGKDBgg1bRUVwqzhOR4xWFySmZBcUec8L7celRy8nzRBSzHujM5ZBvp5O53abSG7B71ZBLVCdqOC9S3QJLJpHqjZBdkrURpBIdtABCMG0meY8pS4bh0bbzFNZAM2ttZCSjzEvUYGh3AeFiYfvYLwQH63iPyKa1M7yX9mpOceJ1Xlx6CaBzLEtosECP8ZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 126\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: false,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 401
}
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +19088483575
💬 [HANDLER] Message: "Hello"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: booking, Step: collect_date
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBO3u3ukW...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Please select a valid date from the options or enter in DD/MM/YYYY format:"
  }
}
❌ Failed to send message:
Status: 401
Error data: {
  error: {
    message: 'Error validating access token: Session has expired on Tuesday, 10-Jun-25 01:00:00 PDT. The current time is Tuesday, 10-Jun-25 01:03:30 PDT.',
    type: 'OAuthException',
    code: 190,
    error_subcode: 463,
    fbtrace_id: 'A8JEwKnaCdgtfgF4kus3np1'
  }
}
Error message: Request failed with status code 401
Error sending text message: AxiosError: Request failed with status code 401
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendTextMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:32:13)
    at async CustomerFlow.handleBookingFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:152:21)
    at async CustomerFlow.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:133:13)
    at async CustomerFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:34:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:112:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBO3u3ukWTZAIqOidoZBhOUhE3s0bgLGKDBgg1bRUVwqzhOR4xWFySmZBcUec8L7celRy8nzRBSzHujM5ZBvp5O53abSG7B71ZBLVCdqOC9S3QJLJpHqjZBdkrURpBIdtABCMG0meY8pS4bh0bbzFNZAM2ttZCSjzEvUYGh3AeFiYfvYLwQH63iPyKa1M7yX9mpOceJ1Xlx6CaBzLEtosECP8ZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '159',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"text","text":{"body":"Please select a valid date from the options or enter in DD/MM/YYYY format:"}}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '159',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 1454179,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 185,
        [Symbol(triggerId)]: 183
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBO3u3ukWTZAIqOidoZBhOUhE3s0bgLGKDBgg1bRUVwqzhOR4xWFySmZBcUec8L7celRy8nzRBSzHujM5ZBvp5O53abSG7B71ZBLVCdqOC9S3QJLJpHqjZBdkrURpBIdtABCMG0meY8pS4bh0bbzFNZAM2ttZCSjzEvUYGh3AeFiYfvYLwQH63iPyKa1M7yX9mpOceJ1Xlx6CaBzLEtosECP8ZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 159\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 401,
      statusMessage: 'Unauthorized',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 46,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 159,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 401,
    statusText: 'Unauthorized',
    headers: Object [AxiosHeaders] {
      'error-mid': '3b61b1893bdda23cc09efe288a53acdf',
      vary: 'Origin, Accept-Encoding',
      'access-control-allow-origin': '*',
      'cross-origin-resource-policy': 'cross-origin',
      'x-app-usage': '{"call_count":0,"total_cputime":0,"total_time":0}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_token" "Error validating access token: Session has expired on Tuesday, 10-Jun-25 01:00:00 PDT. The current time is Tuesday, 10-Jun-25 01:03:30 PDT."',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'A8JEwKnaCdgtfgF4kus3np1',
      'x-fb-trace-id': 'Aj+U1Epg9YE',
      'x-fb-rev': '1023667566',
      'x-fb-debug': '3vYXfA39inNGziAdenP6QndOlppb7HR1xMRFB4lPbTNg92NBOomZsxrdf1iGz3ICVKh+Nrf0n02NO0UWAD82/g==',
      date: 'Tue, 10 Jun 2025 08:03:30 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcMcmc_pxfBMbxO8c87Rz2P5sjkC7tQLdZQxjz07KMZm9jgrzuyylFsTblZbne5i3C62E6uQH-LRrC6KoxkjxTqBGksUby3WwA"; e_clientaddr="AcO0AWD2xN0te6H0P07ZY5EJCPEEgSl89UVch6reQUDIy6TqPVjdSsUdvA47rYY6BIJr2VQmZS9siIMU0lRFy5ayzh_mN7ZYjj5JMRlyNWg1-uOpOg"; e_upip="AcOzBa82RxvgFFyNZet-Et2N-pzl_JzPG30RzoK8KlBXA0wJpJFLZhbyH81xALYxWfw9B3hPvGyMMCIqBnqKUGhYG_j-k0ZHwiB2gg"; e_fb_zone="AcP7T7TqXQsbI8eAKKnAb9V4m-KmB8f6ZYD3wl9BvRQgWGAFCkEKLvAjVCgEv46Y"; e_fb_twtaskhandle="AcN6eW2xHkH2_hgjjqgWfjJLpjL_jdFHK_4QZeS2bVZ637nBMBzZ-nxkFf32SIjVvzgMs45H8X0zbOtoBfwWHdhjF9oydyrDiWmJue0jn2ly2f0"; e_proxy="AcPKE1difNtX3FUiqaTwK0oXDnXbkybPuijCKMzRvJeerVCzSyUrMH4rs5R-QjbihHxJWoUU9qX5wAn9J2Gl", http_request_error; e_fb_vipaddr="AcPMjNx_lr_iHXwkhKJLYLdte4_PMxZ_4_kEkWJgJnu_fi44RrNsmyqIRB9xUJhbS_aksgY7-y1h2pN-s0MdoAaoc2ojbiGb"; e_clientaddr="AcOuPZx61IF-aj3Tl-UZAToosjOba9pFjnFG0t-cL54hFnK7IQwQgNmYzmlBhKkVDX86CTjMGRNqV_b0n5oGvbHHGgeoNJWR7oz6xlxhp9g5wphV3ZaK1w"; e_upip="AcOsufM7gHXbmCCV43Nng8XG2iweLYHmNe8zSDTgqtnGaFBvXkSb8_OVDHSB_kPPtEYeMT-2Tw-W5bYJqMOG9vW4o_o5fX7dqg"; e_fb_zone="AcNJ4ec4677JT0V-_Ie8X4RmQI9R0ZvO-y3hqCcnl6ftjJhfy8ZytxyFFZQ43A"; e_fb_twtaskhandle="AcOCsAC3USYyVTiYtgvWO46i38mOL-ehJ1wpthoP8g2sYnYMEkOUmInVQf_kE_KANJ51AFtBsrLhtqjMXrf5GZ8WB1ZkppqZRcxT"; e_proxy="AcP5RLRGjrz514TNmY34X5h70FBdzwuKPP5Fk3w5O7ZlfolsWjNPDi86HIyldDssouU-qfwhADoGZwk"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=33, rtx=0, c=10, mss=1380, tbw=6078, tp=-1, tpl=-1, uplat=248, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '190'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"text","text":{"body":"Please select a valid date from the options or enter in DD/MM/YYYY format:"}}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '159',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBO3u3ukWTZAIqOidoZBhOUhE3s0bgLGKDBgg1bRUVwqzhOR4xWFySmZBcUec8L7celRy8nzRBSzHujM5ZBvp5O53abSG7B71ZBLVCdqOC9S3QJLJpHqjZBdkrURpBIdtABCMG0meY8pS4bh0bbzFNZAM2ttZCSjzEvUYGh3AeFiYfvYLwQH63iPyKa1M7yX9mpOceJ1Xlx6CaBzLEtosECP8ZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 159\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 401
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBO3u3ukW...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select your preferred date:"
    },
    "action": {
      "button": "Choose Date",
      "sections": [
        {
          "title": "Available Dates",
          "rows": [
            {
              "id": "2025-06-11",
              "title": "Wed, 11 Jun",
              "description": "Tomorrow"
            },
            {
              "id": "2025-06-12",
              "title": "Thu, 12 Jun",
              "description": ""
            },
            {
              "id": "2025-06-13",
              "title": "Fri, 13 Jun",
              "description": ""
            },
            {
              "id": "2025-06-14",
              "title": "Sat, 14 Jun",
              "description": ""
            },
            {
              "id": "2025-06-15",
              "title": "Sun, 15 Jun",
              "description": ""
            },
            {
              "id": "2025-06-16",
              "title": "Mon, 16 Jun",
              "description": ""
            },
            {
              "id": "2025-06-17",
              "title": "Tue, 17 Jun",
              "description": ""
            }
          ]
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 401
Error data: {
  error: {
    message: 'Error validating access token: Session has expired on Tuesday, 10-Jun-25 01:00:00 PDT. The current time is Tuesday, 10-Jun-25 01:03:31 PDT.',
    type: 'OAuthException',
    code: 190,
    error_subcode: 463,
    fbtrace_id: 'Atk3OZTF5apLfVhsuuJ97Mt'
  }
}
Error message: Request failed with status code 401
Error sending list message: AxiosError: Request failed with status code 401
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendListMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:82:13)
    at async CustomerFlow.showDateOptions (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:193:9)
    at async CustomerFlow.handleBookingFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:153:21)
    at async CustomerFlow.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:133:13)
    at async CustomerFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:34:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:112:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBO3u3ukWTZAIqOidoZBhOUhE3s0bgLGKDBgg1bRUVwqzhOR4xWFySmZBcUec8L7celRy8nzRBSzHujM5ZBvp5O53abSG7B71ZBLVCdqOC9S3QJLJpHqjZBdkrURpBIdtABCMG0meY8pS4bh0bbzFNZAM2ttZCSjzEvUYGh3AeFiYfvYLwQH63iPyKa1M7yX9mpOceJ1Xlx6CaBzLEtosECP8ZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '654',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Select your preferred date:"},"action":{"button":"Choose Date","sections":[{"title":"Available Dates","rows":[{"id":"2025-06-11","title":"Wed, 11 Jun","description":"Tomorrow"},{"id":"2025-06-12","title":"Thu, 12 Jun","description":""},{"id":"2025-06-13","title":"Fri, 13 Jun","description":""},{"id":"2025-06-14","title":"Sat, 14 Jun","description":""},{"id":"2025-06-15","title":"Sun, 15 Jun","description":""},{"id":"2025-06-16","title":"Mon, 16 Jun","description":""},{"id":"2025-06-17","title":"Tue, 17 Jun","description":""}]}]}}}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '654',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 1454491,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 211,
        [Symbol(triggerId)]: 209
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBO3u3ukWTZAIqOidoZBhOUhE3s0bgLGKDBgg1bRUVwqzhOR4xWFySmZBcUec8L7celRy8nzRBSzHujM5ZBvp5O53abSG7B71ZBLVCdqOC9S3QJLJpHqjZBdkrURpBIdtABCMG0meY8pS4bh0bbzFNZAM2ttZCSjzEvUYGh3AeFiYfvYLwQH63iPyKa1M7yX9mpOceJ1Xlx6CaBzLEtosECP8ZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 654\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 401,
      statusMessage: 'Unauthorized',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 46,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 654,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 401,
    statusText: 'Unauthorized',
    headers: Object [AxiosHeaders] {
      'error-mid': '3b61b1893bdda23cc09efe288a53acdf',
      vary: 'Origin, Accept-Encoding',
      'access-control-allow-origin': '*',
      'cross-origin-resource-policy': 'cross-origin',
      'x-app-usage': '{"call_count":0,"total_cputime":0,"total_time":0}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_token" "Error validating access token: Session has expired on Tuesday, 10-Jun-25 01:00:00 PDT. The current time is Tuesday, 10-Jun-25 01:03:31 PDT."',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'Atk3OZTF5apLfVhsuuJ97Mt',
      'x-fb-trace-id': 'EBpKTtQ8yqO',
      'x-fb-rev': '1023667566',
      'x-fb-debug': 'eCDhimSmOndKo96xzda/G2pIn9M6GlEyg2pdWrOHQHsqWYsQx97iaw+BAetBT6jKOydjE6aSqkwwXcEd5ECz3g==',
      date: 'Tue, 10 Jun 2025 08:03:31 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcNPQQGrg3FgSAABpT5Fs6mLgz4uMrCdA0ChZS4jNp1aVSzCLYRebN-v5et9n7KVwYqCoso8efxewGkpUi6G5iWuKQ_ioUpzkA"; e_clientaddr="AcOqgPoM0RGpd0laDSPNH_e08wyb_PH8a5TQMgBftGtMJ8N8YYvpquDvWccKs35jz5dl2eR4w6sA3pRBpGUUQ509b5r_2hrFJ6MP02JAmyvtlJShdw"; e_upip="AcNVmPvlad-uWKeHOZXu1pqKXUlL5alk8x-bgJ7Tk5BAS7p9MqBjXtwejmGo9bTEWgKvgFmm8NDLfyUItFxi5OPQU3n_rT8_HI5l1dc"; e_fb_zone="AcN5gnUfU1P-erucivRocfuXZjhF8CiAFXNBTLrZT49tmhiTZPGRkDZ9vAbNs_n7"; e_fb_twtaskhandle="AcMMTRrRHMWGc2ievaxJs03Fu5nVTkMAPEOYgxbRkguRIiXJeXZoYKV1VzEqAFml3CH3aYsxO-SbMQIiW883sgRIMq3mtPxoHu76rbGVgU2Na8w"; e_proxy="AcMUgot_RoTJ5LaPgvUnD7kTJDdjRznTVHXYwBF_O2zyAX2Tc0AwWH5JS2lkgmxdFzYfqPrlA4aH8cgxHe0M", http_request_error; e_fb_vipaddr="AcMyVCtQZebdUgobjh_dvWBlfTKtLnyQF4yIqyxOq3uR3IY733Oxn6nkuH5WkWu5jhHCBYpu8nzpRlIivjxkaN2b8B7anLTO"; e_clientaddr="AcOCoiCAXyGltgHBXxy2cD_H39bavhAlCjAjgqFWrKM01dhabmgE6tmYDRE9nAcjBQq4Vm12d5S5QvUysxgU-j-M4pM5Hn0hgWxAbXeUe7QsPOKYrXvdBA"; e_upip="AcMQyqneE59H3GEsvQebh48vHacNYmglkwT7stWtSv5E-8tk93k1_VfEFrJ5rUsOUoixm_zqjVwke47J_POSHaoxIPTGIWjs8Q"; e_fb_zone="AcNU6u0ROctbBUAsck563RR-XSO4o0W4WTQNqL9L4p9VX3jaIxUhEuuJ3sMzng"; e_fb_twtaskhandle="AcPrFcVgHtGFOW3oUAlgy4U3uUtpUoMEKUNQSn_Rd3uJ4m62IPAz1njha2PDwSox3feG_LwrHenLdCRlTfm6OqBEjHbQDlMoS7Yl"; e_proxy="AcM9flN0jMEjo18LAwQjBXoQGcZ32gD5byjGIsZqVkV91iz1I4GP3DexjY6O8NR1KgfP1w8eFADBD8w"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=36, rtx=0, c=10, mss=1380, tbw=8748, tp=-1, tpl=-1, uplat=250, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '192'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Select your preferred date:"},"action":{"button":"Choose Date","sections":[{"title":"Available Dates","rows":[{"id":"2025-06-11","title":"Wed, 11 Jun","description":"Tomorrow"},{"id":"2025-06-12","title":"Thu, 12 Jun","description":""},{"id":"2025-06-13","title":"Fri, 13 Jun","description":""},{"id":"2025-06-14","title":"Sat, 14 Jun","description":""},{"id":"2025-06-15","title":"Sun, 15 Jun","description":""},{"id":"2025-06-16","title":"Mon, 16 Jun","description":""},{"id":"2025-06-17","title":"Tue, 17 Jun","description":""}]}]}}}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '654',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBO3u3ukWTZAIqOidoZBhOUhE3s0bgLGKDBgg1bRUVwqzhOR4xWFySmZBcUec8L7celRy8nzRBSzHujM5ZBvp5O53abSG7B71ZBLVCdqOC9S3QJLJpHqjZBdkrURpBIdtABCMG0meY8pS4bh0bbzFNZAM2ttZCSjzEvUYGh3AeFiYfvYLwQH63iPyKa1M7yX9mpOceJ1Xlx6CaBzLEtosECP8ZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 654\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 401
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ Database connection successful
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'site-bot@1.0.0',
npm warn EBADENGINE   required: { node: '18.x' },
npm warn EBADENGINE   current: { node: 'v20.16.0', npm: '11.1.0' }
npm warn EBADENGINE }

up to date, audited 388 packages in 1s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
Terminated
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js:53:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js:53:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js:53:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js:53:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js:53:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js:53:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 1s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js:53:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js:53:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js:53:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js:53:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T08:57:35.128Z - GET /health
Terminated
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T09:01:29.218Z - GET /webhook
🔐 Webhook verification request: { mode: 'subscribe', token: 'qsefthuko' }
✅ Webhook verified successfully
2025-06-10T09:01:38.161Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTk4NEYyNDQwMTY3NDdGNkZDOQA=',
  timestamp: '1749546096'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTk4NEYyNDQwMTY3NDdGNkZDOQA=",
  "timestamp": "1749546096",
  "text": {
    "body": "hello"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +19088483575
💬 [HANDLER] Message: "hello"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: booking, Step: collect_date
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Please select a valid date from the options or enter in DD/MM/YYYY format:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3QzhCODUwNzg2OEUzQUU1MzMA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select your preferred date:"
    },
    "action": {
      "button": "Choose Date",
      "sections": [
        {
          "title": "Available Dates",
          "rows": [
            {
              "id": "2025-06-11",
              "title": "Wed, 11 Jun",
              "description": "Tomorrow"
            },
            {
              "id": "2025-06-12",
              "title": "Thu, 12 Jun",
              "description": ""
            },
            {
              "id": "2025-06-13",
              "title": "Fri, 13 Jun",
              "description": ""
            },
            {
              "id": "2025-06-14",
              "title": "Sat, 14 Jun",
              "description": ""
            },
            {
              "id": "2025-06-15",
              "title": "Sun, 15 Jun",
              "description": ""
            },
            {
              "id": "2025-06-16",
              "title": "Mon, 16 Jun",
              "description": ""
            },
            {
              "id": "2025-06-17",
              "title": "Tue, 17 Jun",
              "description": ""
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2ODI4QjI1NTEzRUVCNjJDNUEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T09:01:42.452Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:01:42.638Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:01:42.939Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:01:43.274Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:01:44.569Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:01:44.813Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:01:50.508Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJDMzE4NUFFMDQ2QzA0Qjg3RQA=',
  timestamp: '1749546109'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2ODI4QjI1NTEzRUVCNjJDNUEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJDMzE4NUFFMDQ2QzA0Qjg3RQA=",
  "timestamp": "1749546109",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "2025-06-11",
      "title": "Wed, 11 Jun",
      "description": "Tomorrow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +19088483575
💬 [HANDLER] Message: "2025-06-11"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: booking, Step: collect_date
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select your preferred time:"
    },
    "action": {
      "button": "Choose Time",
      "sections": [
        {
          "title": "Available Time Slots",
          "rows": [
            {
              "id": "09:00",
              "title": "9:00 AM",
              "description": "Morning slot"
            },
            {
              "id": "11:00",
              "title": "11:00 AM",
              "description": "Late morning"
            },
            {
              "id": "14:00",
              "title": "2:00 PM",
              "description": "Afternoon"
            },
            {
              "id": "16:00",
              "title": "4:00 PM",
              "description": "Evening"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MkE1MTRCRTlDOEZFOUZEMTIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T09:01:53.170Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:01:53.620Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:01:53.636Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:01:59.866Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUyN0I0QTJBRDYzREYzQUI0QgA=',
  timestamp: '1749546118'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MkE1MTRCRTlDOEZFOUZEMTIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUyN0I0QTJBRDYzREYzQUI0QgA=",
  "timestamp": "1749546118",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "11:00",
      "title": "11:00 AM",
      "description": "Late morning"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +19088483575
💬 [HANDLER] Message: "11:00"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: booking, Step: collect_time
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ *Booking Confirmed!*\n\n📋 *Details:*\n• Name: hello\n• Date: Tuesday 10 June, 2025\n• Time: 11:00 AM\n\n📍 Our team will contact you 1 day before your visit with location details.\n\n*Booking ID:* fdff5943\n\nType *menu* to go back to main menu."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQjgyMDc0NzM1RUY4QUVEMzEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T09:02:03.179Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:02:03.552Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:02:03.672Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:04:10.760Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQzQTg3M0ZCQzQ3ODVGREE5MwA=',
  timestamp: '1749545829'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQzQTg3M0ZCQzQ3ODVGREE5MwA=",
  "timestamp": "1749545829",
  "text": {
    "body": "hello"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +19088483575
💬 [HANDLER] Message: "hello"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGRjFDOUIwMDkzODdBNDQyMTYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T09:04:13.870Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T09:04:14.582Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzQTk4MDE5OTA0QkM0QzE1MEYA'
    }
  ]
}
2025-06-10T09:04:15.431Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:04:15.988Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:06:38.450Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:06:38.451Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T09:16:38.585Z - GET /
2025-06-10T09:16:39.079Z - GET /favicon.ico
2025-06-10T09:20:03.503Z - GET /health
2025-06-10T09:26:41.201Z - GET /
2025-06-10T09:29:43.260Z - GET /
2025-06-10T09:29:50.785Z - GET /health
2025-06-10T09:36:37.456Z - GET /
2025-06-10T09:36:59.950Z - GET /webhook
🔐 Webhook verification request: { mode: 'subscribe', token: 'qsefthuko' }
✅ Webhook verified successfully
2025-06-10T09:37:09.684Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUI5RDE5OEIwMzEyMDMyRkE5NAA=',
  timestamp: '1749548228'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUI5RDE5OEIwMzEyMDMyRkE5NAA=",
  "timestamp": "1749548228",
  "text": {
    "body": "hello"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +19088483575
💬 [HANDLER] Message: "hello"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwODYxOTY0RTFGMzMyOUVEREMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T09:37:13.487Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:37:13.613Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:37:13.702Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0RDJBRUE2OUQwNzNFNzUzMzQA'
    }
  ]
}
2025-06-10T09:37:15.165Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:37:15.261Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T09:37:15.351Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:33:11.333Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919880036079: {
  type: 'unsupported',
  id: 'wamid.HBgMOTE5ODgwMDM2MDc5FQIAEhgSM0NDRjAzOTJCMURGOUI1RTQzAA==',
  timestamp: '1749551590'
}
[WEBHOOK] Message content: {
  "from": "919880036079",
  "id": "wamid.HBgMOTE5ODgwMDM2MDc5FQIAEhgSM0NDRjAzOTJCMURGOUI1RTQzAA==",
  "timestamp": "1749551590",
  "errors": [
    {
      "code": 131051,
      "title": "Message type unknown",
      "message": "Message type unknown",
      "error_data": {
        "details": "Message type is currently not supported."
      }
    }
  ],
  "type": "unsupported"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919880036079
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
Error marking message as read: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.markAsRead (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:202:13)
    at async withTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:21:24)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:56:13)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '126',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: '{"messaging_product":"whatsapp","status":"read","message_id":"wamid.HBgMOTE5ODgwMDM2MDc5FQIAEhgSM0NDRjAzOTJCMURGOUI1RTQzAA=="}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '126',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 4923362,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 470,
        [Symbol(triggerId)]: 468
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 126\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: false,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 126,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': 'd83ab97ca0ceb208dd48e18aad7e5c14',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#100) Invalid parameter"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AG8x5Y50gOV0LS0uBjQYqf9',
      'x-fb-trace-id': 'Egb4GCr0IWw',
      'x-fb-rev': '1023673470',
      'x-fb-debug': '8jUk3Uq6jXrzoaxh8SigRv43q6W3Ska2JVsmj4i9oLP2TE/56cFc1q9Yn5biD9nlUf166z+iE2BfIQ3pDwaFqw==',
      date: 'Tue, 10 Jun 2025 10:33:12 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcNMqmFT9GVHgfxWO4rUj8uHwcH-zK2Knb1ncSDvefkdryK5-L0oB5V3BrAOKB5hgmkeWUZme5YgCFlr0nuzL-3hkceHo_6Tyg"; e_clientaddr="AcOUFIMiJvbohThzpCg9M6R7x6E4-zH7zmFDHhLqbZeltzUkySjZvO43Le0LiDNd98ShyuthFHMoy8aAWPveBiFyrj08FWJbNs7JjcKmYh4zLw5ZNw"; e_upip="AcO9j9oZoIOsaCa-VlvTRjKnGQqqw53C3fMTWT7QpKFxCu3JscHwk4C2-DGtxYyRe6oOn7NcVTlyAWV0Vwg7uhhaKMYXl-IWtx49ko0"; e_fb_zone="AcMD4Kn2RqfZj4s2vLqmDABnELT5IFDRHmiz0J0f2gsJfEqthD3WfLamDJELS2WH"; e_fb_twtaskhandle="AcMgfBG5MNpn3_2EjEVqmDs8ggni-M-27_uyPI90ZWr_VWyQljJUNtBWXk5O3TfcuzecWJn6r98Wye0yCfwOIqI2WNKIq2IIv193juF3oLiaQHo"; e_proxy="AcMnX5OR5ZhQzhcy2dGLMgWUaFXY1_yWSWfZ_dr4iWsdWNynSqorrOHTa0uzeYA3J1wQtomio9Epjj6hhvk", http_request_error; e_fb_vipaddr="AcNEdeVpNrlMHJdFPmwxCrH2Y_ky1JHHScZataAWrcPEI4LbXkHJ9_yRYwc4LxiyPyibOX5sZr0FgzHpsLCj20Inxprmw_m5"; e_clientaddr="AcPckrkK9tw0fC45Zr4U_KAicwYkeC2_MvzeEZZlUihx1Q3ZrL6AUGBjnyOZa4xvupy1_QhtM9WF9HQuzkLvLZlhcggUge1ZjPbJlfalLK5OQdQttvdUrw"; e_upip="AcMh_dloVGUrBvUwJ8H_4G8QQiYZcsPlnmngV8C-QepQrIdRce8BNsa-iNNiPAtaiYlXz3SPBn9KPDtXqea0IVSy45Ropu-xLA"; e_fb_zone="AcMfW-wbP4Lpnbovf6AAbQi_4PAMZEV0VnfcChKRe9WbbhG9ExsYC7lu6OPAzw"; e_fb_twtaskhandle="AcMwczmAljQhNQ9vzHOELeDxW2ygbq3qCfgANBYj2M3fEboTrYkKMtXYIVPzjdxQQ01Zf6iwD-_coDhT7lOe7AyyT_MrE5iZBUQ"; e_proxy="AcPIDUNT6EXot5cWASY552nzcasXx6fUUmczrAEMKvEaBqVI2O-G9Vr-Iehn-rQWfByBYiYTiO6bSu4"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=38, rtx=0, c=10, mss=1380, tbw=372, tp=-1, tpl=-1, uplat=571, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '238'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: '{"messaging_product":"whatsapp","status":"read","message_id":"wamid.HBgMOTE5ODgwMDM2MDc5FQIAEhgSM0NDRjAzOTJCMURGOUI1RTQzAA=="}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '126',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 126\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: false,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
👤 [HANDLER] Getting/creating user...
✅ Created new customer: +919880036079
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
🆕 [HANDLER] Creating new session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +919880036079
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919880036079",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919880036079', wa_id: '919880036079' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5ODgwMDM2MDc5FQIAERgSRjRERjJBNDFCM0ZFOUYxQ0U3AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919880036079",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:33:14.906Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919880036079', wa_id: '919880036079' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5ODgwMDM2MDc5FQIAERgSNEE5RUM0RjlGNDdFNzY1MjRGAA=='
    }
  ]
}
2025-06-10T10:33:16.284Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:40:30.282Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQwOEY2OTYzMjc1Rjk0Q0EwNQA=',
  timestamp: '1749545486'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQwOEY2OTYzMjc1Rjk0Q0EwNQA=",
  "timestamp": "1749545486",
  "text": {
    "body": "hello"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +19088483575
💬 [HANDLER] Message: "hello"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MTJFMjYzMzlEQzNDNzc5QTkA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:40:34.223Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:40:34.925Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFRkEwM0QwOUYzRUNEMEM2NEUA'
    }
  ]
}
2025-06-10T10:40:35.884Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:40:36.445Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:40:44.031Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:40:44.292Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:47:30.413Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUyNjdCOUNFNjcyRTA1NTdFMQA=',
  timestamp: '1749552449'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUyNjdCOUNFNjcyRTA1NTdFMQA=",
  "timestamp": "1749552449",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxODg3RkQ5MEQ0MTZBM0I4M0MA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:47:33.675Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:47:34.311Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:47:34.313Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:47:34.521Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMDE4QTMyOTk3RTNFRUMzRjMA'
    }
  ]
}
2025-06-10T10:47:35.978Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:47:36.285Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:47:36.287Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:47:36.305Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:47:56.963Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg2NUU4RDgxMUE4MDFBQzNEOAA=',
  timestamp: '1749552475'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg2NUU4RDgxMUE4MDFBQzNEOAA=",
  "timestamp": "1749552475",
  "text": {
    "body": "admin"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "admin"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDRjk2RTNBRjZFMzdFQTdFQjYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:47:59.531Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:47:59.966Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:48:00.076Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:48:00.219Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4OUFDMjVGNEM4QzkwQjE1RUMA'
    }
  ]
}
2025-06-10T10:48:01.518Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:48:01.710Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:48:01.779Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:48:02.314Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T10:51:38.999Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU1ODc4QUU4MDc1NDc2MTg1NwA=',
  timestamp: '1749552697'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU1ODc4QUU4MDc1NDc2MTg1NwA=",
  "timestamp": "1749552697",
  "text": {
    "body": "Hello"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-10T10:51:39.963Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJFQUJEMjM1Q0M3NjdEOEQzOAA=',
  timestamp: '1749552673'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJFQUJEMjM1Q0M3NjdEOEQzOAA=",
  "timestamp": "1749552673",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hello"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFNzVCMTcwQTVEMjM3Q0MyNzcA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMDkxRTEyNzM2NDlFRDE1OTAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:51:42.405Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:42.672Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:42.922Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:42.978Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwNjg4RENGNDZGNkE0NzE3MTMA'
    }
  ]
}
2025-06-10T10:51:43.222Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:43.231Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:43.348Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:43.451Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJERkJCODBEMDUyNzZGNkVDMUIA'
    }
  ]
}
2025-06-10T10:51:43.893Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:44.880Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:44.882Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:44.883Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:45.350Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:45.351Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:45.358Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:45.391Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:51.407Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUIyM0IxQTMzOEQ1RDg4NzYxQwA=',
  timestamp: '1749552710'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMDkxRTEyNzM2NDlFRDE1OTAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUIyM0IxQTMzOEQ1RDg4NzYxQwA=",
  "timestamp": "1749552710",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "test_customer",
      "title": "👥 Test Customer Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "test_customer"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧪 *Testing Customer Flow*\n\nYou are now in customer flow test mode. All customer features are available:\n• Site visit booking\n• Availability checking  \n• Pricing information\n• Sales connection\n\nType *exit* anytime to return to admin menu.\n\n---"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBRjMyQzE2NDdBOEYwNzE1OEUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:51:54.194Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
2025-06-10T10:51:54.541Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:54.556Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:54.586Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBMjQ0MjJCOERFNzJCRDVERDAA'
    }
  ]
}
2025-06-10T10:51:55.952Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:51:56.388Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:56.443Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:56.637Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0ODYxQTFBNjY3NzI4RUM5NTEA'
    }
  ]
}
2025-06-10T10:51:57.652Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:58.325Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:58.327Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:51:58.381Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:04.064Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc1RDA3QkYzNzYyNzMyQTJGQwA=',
  timestamp: '1749552723'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBMjQ0MjJCOERFNzJCRDVERDAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc1RDA3QkYzNzYyNzMyQTJGQwA=",
  "timestamp": "1749552723",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "book_visit",
      "title": "📅 Book Site Visit"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "book_visit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📅 *Book a Site Visit*\n\nLet's schedule your site visit! \n\nPlease share your full name:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFN0QzODQyQThCRTZEQTZGODkA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:52:06.903Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:07.437Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:07.442Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:07.957Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:20.417Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg4MDE5RjU1QjQ1N0IzQkIzOAA=',
  timestamp: '1749552739'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg4MDE5RjU1QjQ1N0IzQkIzOAA=",
  "timestamp": "1749552739",
  "text": {
    "body": "Yash Patel"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Yash Patel"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCN0UxRUE0MEE2RTI2OUU2MEUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:52:23.409Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:52:23.888Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:24.047Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0RjQzQTcwQjNBNkY3NTEwQTEA'
    }
  ]
}
2025-06-10T10:52:25.591Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:25.721Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:25.727Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:25.840Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:30.007Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU3MUQ1RkY0MDM2MDRBRTZENAA=',
  timestamp: '1749552749'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCN0UxRUE0MEE2RTI2OUU2MEUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU3MUQ1RkY0MDM2MDRBRTZENAA=",
  "timestamp": "1749552749",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "book_visit",
      "title": "📅 Book Site Visit"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "book_visit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📅 *Book a Site Visit*\n\nLet's schedule your site visit! \n\nPlease share your full name:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGNzdFNjU0N0FGNDhCMzkxMzMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:52:32.834Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:33.177Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:33.191Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:33.263Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:38.161Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFCQzk4MjBCMDlGRjdGODdGMwA=',
  timestamp: '1749552757'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFCQzk4MjBCMDlGRjdGODdGMwA=",
  "timestamp": "1749552757",
  "text": {
    "body": "Yash Patel"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Yash Patel"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEMEY2NzBFRkRCRkFGNTY2NzAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:52:40.822Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:52:41.278Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:41.371Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:41.569Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyMTFENTNGRTA2RjI4MzA4NUIA'
    }
  ]
}
2025-06-10T10:52:42.570Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:42.958Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:43.030Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:43.053Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:44.674Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJENTk0MDI3MTY2MTAyMjg3MAA=',
  timestamp: '1749552763'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEMEY2NzBFRkRCRkFGNTY2NzAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJENTk0MDI3MTY2MTAyMjg3MAA=",
  "timestamp": "1749552763",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "check_availability",
      "title": "🕐 Check Availability"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "check_availability"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📅 *Site Visit Availability*\n\n*This Week:*\n• Monday - Friday: 9:00 AM - 5:00 PM\n• Saturday: 10:00 AM - 4:00 PM\n• Sunday: Closed\n\n*Next Available Slots:*\n• Tomorrow: 11:00 AM, 2:00 PM, 4:00 PM\n• Day after: 9:00 AM, 11:00 AM, 2:00 PM\n\nEach visit takes approximately 1-2 hours.\n\nWould you like to book a slot? Type *book* to start booking process."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEQTk5MTJFMThBNDhGODY5M0EA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:52:47.070Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:47.412Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:47.423Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:47.702Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:55.852Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTA3NUMzQUMyNDE3NjQ4MUNEMgA=',
  timestamp: '1749552775'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTA3NUMzQUMyNDE3NjQ4MUNEMgA=",
  "timestamp": "1749552775",
  "text": {
    "body": "book"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "book"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QjI0OTA5OUI1MUJCMEZDRUEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:52:59.137Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:59.171Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:59.430Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:52:59.431Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEMTE4RTdFRThDN0UxMDY0QjcA'
    }
  ]
}
2025-06-10T10:53:00.608Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:00.966Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:00.982Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:01.143Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:01.256Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJCQjk5RDAzOUVENEYxRkExMwA=',
  timestamp: '1749552780'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QjI0OTA5OUI1MUJCMEZDRUEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJCQjk5RDAzOUVENEYxRkExMwA=",
  "timestamp": "1749552780",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "pricing",
      "title": "💰 Pricing & Plans"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "pricing"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "💰 *Our Pricing & Plans*\n\n🏠 *Residential Projects:*\n• Studio Apartments: ₹25-35 Lakhs\n• 1 BHK: ₹35-50 Lakhs  \n• 2 BHK: ₹50-75 Lakhs\n• 3 BHK: ₹75 Lakhs+\n\n🏢 *Commercial Projects:*\n• Office Spaces: ₹8,000-12,000/sq ft\n• Retail Spaces: ₹10,000-15,000/sq ft\n\n📋 *What's Included:*\n• Premium location\n• Modern amenities\n• 24/7 security\n• Power backup\n• Parking facilities\n\n*🎯 Special Offers:*\n• Early bird discount: 5%\n• Referral bonus: ₹50,000\n\nWant to know more? Type *talk_to_sales* to connect with our sales team!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFRUZGQTdEMzJCQTQ4RDg3MzQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:53:03.604Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:04.194Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:04.218Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:04.225Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:11.032Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ2MjdFNTFDQUE4MjBGMzExOQA=',
  timestamp: '1749552790'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ2MjdFNTFDQUE4MjBGMzExOQA=",
  "timestamp": "1749552790",
  "text": {
    "body": "admin"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "admin"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting test mode. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5QzAwQzcyNjU5NkU3RjkzOEEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:53:13.819Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
2025-06-10T10:53:14.218Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:14.285Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:14.416Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwNEIwNDQ3MjY0RERFNjk4NDUA'
    }
  ]
}
2025-06-10T10:53:15.348Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:53:15.841Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:15.851Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:15.930Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2RjYzRTIxRDg1RDE0REYwMzcA'
    }
  ]
}
2025-06-10T10:53:17.611Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:17.966Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:17.974Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUFDMjk2QTUxRTgzQ0QwQjRFQgA=',
  timestamp: '1749552796'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwNEIwNDQ3MjY0RERFNjk4NDUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUFDMjk2QTUxRTgzQ0QwQjRFQgA=",
  "timestamp": "1749552796",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "test_employee",
      "title": "👷‍♂️ Test Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-10T10:53:18.112Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:18.258Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "test_employee"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧪 *Testing Employee Flow*\n\nYou are now in employee flow test mode. All employee features are available:\n• Activity logging with photo upload\n• Material requests\n• Dashboard viewing\n• Gujarati language support\n\n⚠️ *Note:* Employee flow includes OTP verification. As admin, you'll be auto-verified.\n\nType *exit* anytime to return to admin menu.\n\n---"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJERDA1RUJFNkExQkRBMTg2Q0EA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:53:20.824Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "view_dashboard",
            "title": "📊 ડેશબોર્ડ જુઓ"
          }
        }
      ]
    }
  }
}
2025-06-10T10:53:21.725Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:21.734Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:21.744Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMUJFNkNDQTEyQkQyN0I4MEIA'
    }
  ]
}
2025-06-10T10:53:22.659Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "સહાય",
          "rows": [
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:53:23.461Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:23.469Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQzlBRDdBRDlCREZCMkMxRDgA'
    }
  ]
}
2025-06-10T10:53:24.664Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:24.689Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:24.919Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:24.925Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:25.042Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:29.468Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTU2ODI1MjFCN0E0RTMzMjUwQQA=',
  timestamp: '1749552808'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMUJFNkNDQTEyQkQyN0I4MEIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTU2ODI1MjFCN0E0RTMzMjUwQQA=",
  "timestamp": "1749552808",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGRTUxQzI4RjZENkYwMDQxMEYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:53:31.767Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:32.339Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:32.451Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:32.528Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:36.015Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY1RDc4RTg3N0E1NzcyN0Y5MgA=',
  timestamp: '1749552815'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGRTUxQzI4RjZENkYwMDQxMEYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY1RDc4RTg3N0E1NzcyN0Y5MgA=",
  "timestamp": "1749552815",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "view_dashboard",
            "title": "📊 ડેશબોર્ડ જુઓ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJERjI3M0FDNkNFOTI3QTc3N0MA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:53:38.576Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "સહાય",
          "rows": [
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:53:39.094Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:39.163Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0QTY5MEQ4QzdBQTdFRTkwMjAA'
    }
  ]
}
2025-06-10T10:53:39.710Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:40.359Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:40.710Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:40.771Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:53:40.879Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:02.251Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQTQ3NTdDODZEMkFCRDQ5NUE1RUI4NkRERkY5NzEwQzcA',
  timestamp: '1749553020'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQTQ3NTdDODZEMkFCRDQ5NUE1RUI4NkRERkY5NzEwQzcA",
  "timestamp": "1749553020",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNjk5M0JCQkMzMkI0NDEyQUEwAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQjU3QkFCNTFDNDE4MzQ3OTVFAA=='
    }
  ]
}
2025-06-10T10:57:07.152Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:07.469Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:07.725Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:07.946Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:07.971Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:08.080Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:15.767Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggOUZBQjE4MEY3MTc3QzVEQjc5NTdCNzdCQjVGQTc5ODcA',
  timestamp: '1749553034'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNjk5M0JCQkMzMkI0NDEyQUEwAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggOUZBQjE4MEY3MTc3QzVEQjc5NTdCNzdCQjVGQTc5ODcA",
  "timestamp": "1749553034",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "test_customer",
      "title": "👥 Test Customer Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "test_customer"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "🧪 *Testing Customer Flow*\n\nYou are now in customer flow test mode. All customer features are available:\n• Site visit booking\n• Availability checking  \n• Pricing information\n• Sales connection\n\nType *exit* anytime to return to admin menu.\n\n---"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNTQxQzMwMkY4Njc1QUI4NjZFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
2025-06-10T10:57:18.714Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:18.819Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:19.111Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQzRDMTlFRkM3QTE2MTk1ODVEAA=='
    }
  ]
}
2025-06-10T10:57:20.394Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:57:20.651Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:20.843Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRUVGQUJDQUI0OTE5QzhDQUM0AA=='
    }
  ]
}
2025-06-10T10:57:22.116Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:22.296Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:22.428Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:29.226Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQzdBQkQ0RUZCMjczNTE2QjgwQjBDODRBQTZDRjg2MTcA',
  timestamp: '1749553048'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQzRDMTlFRkM3QTE2MTk1ODVEAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQzdBQkQ0RUZCMjczNTE2QjgwQjBDODRBQTZDRjg2MTcA",
  "timestamp": "1749553048",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "book_visit",
      "title": "📅 Book Site Visit"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "book_visit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "📅 *Book a Site Visit*\n\nLet's schedule your site visit! \n\nPlease share your full name:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQTRDRjJGMzY1OUYyMzJGN0REAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:57:32.013Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:32.275Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:32.492Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:35.788Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM1QTk3QzMxNjk0MzAwNTdERQA=',
  timestamp: '1749544988'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM1QTk3QzMxNjk0MzAwNTdERQA=",
  "timestamp": "1749544988",
  "text": {
    "body": "Hello"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hello"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "view_dashboard",
            "title": "📊 ડેશબોર્ડ જુઓ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGN0Y3RUY5OUIyMUI4QjQ1MDIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "સહાય",
          "rows": [
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:57:38.676Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:39.430Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:39.432Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2Njc1NEI2MDcxODk5MTk3RUEA'
    }
  ]
}
2025-06-10T10:57:40.340Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:40.879Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:50.157Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggREZEQjI5NERGRDE4RTQ4QUJDMzkzNjNBNzRDMEZGNTEA',
  timestamp: '1749553069'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggREZEQjI5NERGRDE4RTQ4QUJDMzkzNjNBNzRDMEZGNTEA",
  "timestamp": "1749553069",
  "text": {
    "body": "Jay"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Jay"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏗️ Welcome to our Site Management Service!\n\nHow can I help you today?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "check_availability",
            "title": "🕐 Check Availability"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "pricing",
            "title": "💰 Pricing & Plans"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQjBFMzdDODBEOTZCMzZGRUE4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:57:52.501Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Or choose from more options:"
    },
    "action": {
      "button": "Select Option",
      "sections": [
        {
          "title": "Services",
          "rows": [
            {
              "id": "talk_to_sales",
              "title": "📞 Talk to Sales",
              "description": "Connect with our sales team"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Get help and support"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T10:57:52.951Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:53.012Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNUFDQUFENzcxQTRFMTU0Mjk1AA=='
    }
  ]
}
2025-06-10T10:57:54.406Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:54.620Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:57:54.722Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T10:58:55.258Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMjM4RTU5Mjg0QkIwMjBDMkRFNzRFOTVBRjUzNjdDQkIA',
  timestamp: '1749553134'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNUFDQUFENzcxQTRFMTU0Mjk1AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMjM4RTU5Mjg0QkIwMjBDMkRFNzRFOTVBRjUzNjdDQkIA",
  "timestamp": "1749553134",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "talk_to_sales",
      "title": "📞 Talk to Sales",
      "description": "Connect with our sales team"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "talk_to_sales"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T10:58:56.797Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📞 *Connect with Sales Team*\n\nOur sales experts are ready to help you!\n\n*Contact Options:*\n🕐 *Immediate Callback:* Type *callback* and we'll call you within 5 minutes\n💬 *WhatsApp Chat:* Continue chatting here, our sales team will join shortly\n📞 *Direct Call:* +91-9999999999\n📧 *Email:* sales@yourcompany.com\n\n*Business Hours:*\nMonday - Saturday: 9:00 AM - 7:00 PM\n\nWhat would you prefer?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "callback",
            "title": "📞 Request Callback"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "continue_chat",
            "title": "💬 Continue Here"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRUZGRjcxOENBRTg3NjU0NTdEAA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T10:58:56.797Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:58:58.636Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:58:58.777Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:58:59.039Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:59:07.023Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRkU2MzMzRTY5REFBMzdCOTA2NTNEMzg5MjdBN0NFMkEA',
  timestamp: '1749553118'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQjBFMzdDODBEOTZCMzZGRUE4AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRkU2MzMzRTY5REFBMzdCOTA2NTNEMzg5MjdBN0NFMkEA",
  "timestamp": "1749553118",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "check_availability",
      "title": "🕐 Check Availability"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "check_availability"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T10:59:08.163Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "📅 *Site Visit Availability*\n\n*This Week:*\n• Monday - Friday: 9:00 AM - 5:00 PM\n• Saturday: 10:00 AM - 4:00 PM\n• Sunday: Closed\n\n*Next Available Slots:*\n• Tomorrow: 11:00 AM, 2:00 PM, 4:00 PM\n• Day after: 9:00 AM, 11:00 AM, 2:00 PM\n\nEach visit takes approximately 1-2 hours.\n\nWould you like to book a slot? Type *book* to start booking process."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQjE1MTg5NzY3RkNFQjdGQjREAA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T10:59:08.163Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T10:59:10.008Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:59:10.213Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T10:59:10.497Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:00:33.466Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T11:19:25.772Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTZEOERCNjMyNjVBNEFEMzNGMAA=',
  timestamp: '1749554362'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTZEOERCNjMyNjVBNEFEMzNGMAA=",
  "timestamp": "1749554362",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T11:19:27.628Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "view_dashboard",
            "title": "📊 ડેશબોર્ડ જુઓ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzMDI2NjUxODVBOTIzNzhGNjIA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T11:19:27.628Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "સહાય",
          "rows": [
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T11:19:29.931Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:30.070Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:30.275Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:30.328Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MzE4RjY1MTg5MzNGREFFOTYA'
    }
  ]
}
2025-06-10T11:19:31.229Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:31.783Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:31.810Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:32.056Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:44.887Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTRCNEY0OUQyN0E3RTNFNTQ1QwA=',
  timestamp: '1749554383'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTRCNEY0OUQyN0E3RTNFNTQ1QwA=",
  "timestamp": "1749554383",
  "text": {
    "body": "admin"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "admin"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting test mode. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1NjFDODIzNUVERkVENjM2N0YA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
2025-06-10T11:19:48.012Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:48.109Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:48.234Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:48.258Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0Mjg2NTdGQjNFNTZBQzY1NjIA'
    }
  ]
}
2025-06-10T11:19:49.545Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T11:19:49.958Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:49.995Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:50.022Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBRUQ2NzIyMUYwQTFDRUY1QjQA'
    }
  ]
}
2025-06-10T11:19:51.439Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:51.997Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:52.064Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:52.251Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:54.727Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTE2NjZFQUQwNEZENTUyMzBCQQA=',
  timestamp: '1749554393'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0Mjg2NTdGQjNFNTZBQzY1NjIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTE2NjZFQUQwNEZENTUyMzBCQQA=",
  "timestamp": "1749554393",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "test_customer",
      "title": "👥 Test Customer Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "test_customer"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧪 *Testing Customer Flow*\n\nYou are now in customer flow test mode. All customer features are available:\n• Site visit booking\n• Availability checking  \n• Pricing information\n• Sales connection\n\nType *exit* anytime to return to admin menu.\n\n---"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQjJFNEEwQjc5NzEyRDBFNTYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🏢 *Suvasam Group – Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\n\n🏗️ *Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n📞 *Contact:* +91 84870 51252 / +91 95103 56093 / +91 94281 02172\n\nWould you like to know more and book a site visit?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "interested",
            "title": "✅ Yes, I'm Interested!"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        }
      ]
    }
  }
}
2025-06-10T11:19:58.011Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:58.336Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:58.375Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:19:58.383Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Button title length invalid. Min length: 1, Max length: 20'
    },
    fbtrace_id: 'AmR_xlJ0fRS2QGb0wJ0-HRh'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async CustomerFlowWrapper.showSuvasamProjectDetails (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:75:9)
    at async CustomerFlowWrapper.handleInitialMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:45:13)
    at async CustomerFlowWrapper.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:37:13)
    at async Timeout._onTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:233:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '1083',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🏢 *Suvasam Group – Gota Commercial Hub*\\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\\n🔗 Google Maps location: https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\\n\\n🏗️ *Project Highlights:*\\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\\n• Prime access to SG Highway, public transport & residential clusters\\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\\n• Developer: Suvasam Group – focused on quality & timely delivery\\n\\n📞 *Contact:* +91 84870 51252 / +91 95103 56093 / +91 94281 02172\\n\\nWould you like to know more and book a site visit?"},"action":{"buttons":[{"type":"reply","reply":{"id":"interested","title":"✅ Yes, I'm Interested!"}},{"type":"reply","reply":{"id":"book_visit","title":"📅 Book Site Visit"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '1083',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 49078,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 656,
        [Symbol(triggerId)]: 654
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 1083\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 1083,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AmR_xlJ0fRS2QGb0wJ0-HRh',
      'x-fb-trace-id': 'HM2Of7rcPPr',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'yaz9zoLz90EkO4GnFnbDPsoGG/cimxMNOevz7dhkmOCNoUjT1TeNbc5so/oj23qB72mHc7B4aCpIVno1NQDADA==',
      date: 'Tue, 10 Jun 2025 11:19:58 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcOrzWxCM5dE3h-qjqvneC00RKjB911bwLizfc8AbfvwlQiLyzIbDqVSlBwfOq20LLfzFwqm4J-HpNil2cXsmm_Of8caMUYy"; e_clientaddr="AcPaHPnngg3BQvI0LfazgAOnrkqZj9TCK9zxVzDXZ_JTtM2JSWEGsDk06dfARy2fvExb4tpfwRppA4OXV4lkvFn1A9cTzocN11zN6Q3imVs5oxqy"; e_upip="AcPmbh3MHpYfIGlQeNasCZau_dv_CaPZZck5fjlyu-qZif3gELsPXqDo9dyVvvDwP62407vCuhyENPhVK7QhJXmN_RcWupD2gcuPEFk"; e_fb_zone="AcOG_i9KfCLx9PLay8iFJ6EFlRqUQ92Ewy5fU2BziHBh9d0Zg7ls0Rh681ir4gow"; e_fb_twtaskhandle="AcM1HaGE4uECOaCXgDhyX0OoUJyDEc_ZcJDEc_UWBTAHGg1K21cwUh1tYhH9d-NifpDjntnzYkPtldr8Wz1y7SYMMaGpNW89dlYBxgkRel9ZlQ"; e_proxy="AcMfeAwzywDAfLUd2rXpOAVx5oEDF-spWR5SN1krPy93K60foSeqWeUoBqTauoC9qM2Aq9a6iVcBs0uXOE2u", http_request_error; e_fb_vipaddr="AcOJFV3JTHjwYkJK9W3WboBHA3Gv9egD37pMmX9zNQ_AEUsMfonXvjw_rEacDBcLAY5fOx_yv_iaJ3gxsNcWuPkPUkPlTMnME3s"; e_clientaddr="AcPugmL8rAamgtOEJYDQwwSZq04fDg61V5hDXt4DmdciVOQ751Su1km2WxVBB7ikUK-LA2LEzaIiX10WqEjU4gRWlCVWzRiaPcmkkWsT4pp_oZQWFsessg"; e_upip="AcO6wKNHdCMHt99VT1XJWd2Fo59N9akxpxCjEIux_BQ_FcwrAmEmKQfQJ6tGq40kPUoQmfb8B3tL7M4N4qu3bjJUEGJ7OzPe"; e_fb_zone="AcMJ4iYV9OyNJfb95aGXwj3EhfSRGV-JsBYN5Mx13HTiWzwrO8AXeoa7V6Kzsg"; e_fb_twtaskhandle="AcMe_FfPco_WjjO-KWZJaLyqnA80HJuj4GFvXdQHQiCF84If17HiH1IYkGUs0EZhOYNrbsYFCSXJshs0OgcxQyvsWv_dbbKAz8_q"; e_proxy="AcNEayXanA-07r-sYWx-O3KUhz3UADtNnD3aY7MmX-zWyIg_erFSzXdhuaweLIsGT8IYNRR02hQcKW4"',
      'x-fb-connection-quality': 'GOOD; q=0.7, rtt=64, rtx=0, c=10, mss=1380, tbw=7057, tp=-1, tpl=-1, uplat=509, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '190'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🏢 *Suvasam Group – Gota Commercial Hub*\\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\\n🔗 Google Maps location: https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\\n\\n🏗️ *Project Highlights:*\\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\\n• Prime access to SG Highway, public transport & residential clusters\\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\\n• Developer: Suvasam Group – focused on quality & timely delivery\\n\\n📞 *Contact:* +91 84870 51252 / +91 95103 56093 / +91 94281 02172\\n\\nWould you like to know more and book a site visit?"},"action":{"buttons":[{"type":"reply","reply":{"id":"interested","title":"✅ Yes, I'm Interested!"}},{"type":"reply","reply":{"id":"book_visit","title":"📅 Book Site Visit"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '1083',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 1083\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T11:23:10.416Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTlENDEzMkQyMEJFMkQ2QUIwQQA=',
  timestamp: '1749554589'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTlENDEzMkQyMEJFMkQ2QUIwQQA=",
  "timestamp": "1749554589",
  "text": {
    "body": "Exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting test mode. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3ODc4QkUwNzM2Qjg4MUJCNjkA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
2025-06-10T11:23:14.045Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:14.288Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:14.334Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:14.573Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCQkVCMDE4NDE2MTk3NTY4MkYA'
    }
  ]
}
2025-06-10T11:23:15.523Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T11:23:15.920Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:16.017Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:16.069Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0QzJENTBGQ0UyQ0Q5RjY3QjQA'
    }
  ]
}
2025-06-10T11:23:17.133Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:17.509Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTREQUI3M0Q2QkIxQjE5NDNCRAA=',
  timestamp: '1749554596'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCQkVCMDE4NDE2MTk3NTY4MkYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTREQUI3M0Q2QkIxQjE5NDNCRAA=",
  "timestamp": "1749554596",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "test_customer",
      "title": "👥 Test Customer Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
2025-06-10T11:23:17.561Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-10T11:23:17.661Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:17.756Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "test_customer"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧪 *Testing Customer Flow*\n\nYou are now in customer flow test mode. All customer features are available:\n• Site visit booking\n• Availability checking  \n• Pricing information\n• Sales connection\n\nType *exit* anytime to return to admin menu.\n\n---"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQ0ZDODkzMzg4Njk5QUI1OUYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:23:20.120Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\n\n🏗️ *Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n📞 *Contact:* +91 84870 51252 / +91 95103 56093 / +91 94281 02172\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* or *\"interested\"* to continue."
  }
}
2025-06-10T11:23:20.601Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:20.698Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:20.707Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFOEQ5NzgyMzg2MzdEMzI1RkEA'
    }
  ]
}
2025-06-10T11:23:21.989Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:22.666Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:22.677Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:22.725Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:34.643Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTRBRjcyRTVGOEVFNTQ5NDM0NAA=',
  timestamp: '1749554613'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTRBRjcyRTVGOEVFNTQ5NDM0NAA=",
  "timestamp": "1749554613",
  "text": {
    "body": "yes"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "yes"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T11:23:35.685Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: { intent: 'inquiry', step: 'collect_name', data: {} }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Great! I'd like to understand your requirements better to provide you with the most suitable options.\n\nPlease share your *full name*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCMzFCQzhGNjFCQzREM0I0QzgA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_name',
  data: {},
  updated_at: 2025-06-10T11:23:35.685Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:23:37.285Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:37.813Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:37.861Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:37.961Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:46.935Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg4MTEyRkIwMDJGOTIyMDNEOQA=',
  timestamp: '1749554626'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg4MTEyRkIwMDJGOTIyMDNEOQA=",
  "timestamp": "1749554626",
  "text": {
    "body": "Patel Yash Rameshbhai"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Patel Yash Rameshbhai"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_name',
  data: {},
  updated_at: 2025-06-10T11:23:47.905Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: { step: 'collect_email', data: { full_name: 'Patel Yash Rameshbhai' } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Thank you Patel Yash Rameshbhai! \n\nPlease share your *email address*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NjQ2OTg3RkExMkNDMzBENUEA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_email',
  data: { full_name: 'Patel Yash Rameshbhai' },
  updated_at: 2025-06-10T11:23:47.906Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:23:49.598Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:49.878Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:50.007Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:50.153Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:23:59.658Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTBFNEUzQ0IyNzhDRjM4N0YxNAA=',
  timestamp: '1749554638'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTBFNEUzQ0IyNzhDRjM4N0YxNAA=",
  "timestamp": "1749554638",
  "text": {
    "body": "Bojrick@gmail.com"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Bojrick@gmail.com"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_email',
  data: { full_name: 'Patel Yash Rameshbhai' },
  updated_at: 2025-06-10T11:24:00.844Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_occupation',
  data: { full_name: 'Patel Yash Rameshbhai', email: 'Bojrick@gmail.com' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Great! \n\nWhat is your *occupation/profession*?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1NUFBNEM0RjYyREFDOUMwQkYA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_occupation',
  data: { full_name: 'Patel Yash Rameshbhai', email: 'Bojrick@gmail.com' },
  updated_at: 2025-06-10T11:24:00.845Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:24:02.626Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:02.988Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:02.990Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:03.152Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:08.525Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ0MzI4NUY3NzEwRkVFQkJENAA=',
  timestamp: '1749554647'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ0MzI4NUY3NzEwRkVFQkJENAA=",
  "timestamp": "1749554647",
  "text": {
    "body": "Business"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Business"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_occupation',
  data: { email: 'Bojrick@gmail.com', full_name: 'Patel Yash Rameshbhai' },
  updated_at: 2025-06-10T11:24:09.770Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_space_requirement',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    occupation: 'Business'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Thanks! \n\nWhat is your *office space requirement*? (e.g., 600 sq ft, 1000 sq ft, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGMzMzRDU5QTNBQTE1NDhFREYA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_space_requirement',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    occupation: 'Business'
  },
  updated_at: 2025-06-10T11:24:09.770Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:24:11.412Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:11.705Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:11.859Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:11.899Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:21.128Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUEzOTM1OEMzQ0MxMEM0QjlDMgA=',
  timestamp: '1749554660'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUEzOTM1OEMzQ0MxMEM0QjlDMgA=",
  "timestamp": "1749554660",
  "text": {
    "body": "900 sqft"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "900 sqft"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_space_requirement',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    occupation: 'Business'
  },
  updated_at: 2025-06-10T11:24:22.552Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_space_use',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    occupation: 'Business',
    office_space_requirement: '900 sqft'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Perfect! \n\nWhat will be the *primary use* of this office space? (e.g., consultancy, retail, café, startup office, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzNzg5RDNGMzU4RjUxODdEQzYA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_space_use',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    occupation: 'Business',
    office_space_requirement: '900 sqft'
  },
  updated_at: 2025-06-10T11:24:22.552Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:24:24.403Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:24.588Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:24.711Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:24.839Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:31.974Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTkxMjc0NEQ5OTU0NUY4MTIxNQA=',
  timestamp: '1749554671'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTkxMjc0NEQ5OTU0NUY4MTIxNQA=",
  "timestamp": "1749554671",
  "text": {
    "body": "Cafe"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Cafe"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_space_use',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    occupation: 'Business',
    office_space_requirement: '900 sqft'
  },
  updated_at: 2025-06-10T11:24:33.134Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_price_range',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    occupation: 'Business',
    office_space_requirement: '900 sqft',
    office_space_use: 'Cafe'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Excellent! \n\nWhat is your *expected price range/budget*? (e.g., ₹50-75 Lakhs, ₹1-2 Crores, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDRDBEMUUxRDBERTdDNDY5MDIA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_price_range',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    occupation: 'Business',
    office_space_requirement: '900 sqft',
    office_space_use: 'Cafe'
  },
  updated_at: 2025-06-10T11:24:33.134Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:24:34.968Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:35.338Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:35.340Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:35.353Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:24:43.383Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc0NTkyNDg4NTQ5OUIwNjA2QgA=',
  timestamp: '1749554682'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc0NTkyNDg4NTQ5OUIwNjA2QgA=",
  "timestamp": "1749554682",
  "text": {
    "body": "60 lakh"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "60 lakh"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_price_range',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    occupation: 'Business',
    office_space_use: 'Cafe',
    office_space_requirement: '900 sqft'
  },
  updated_at: 2025-06-10T11:24:44.431Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "✅ *Thank you for your details!*\n\n📋 *Your Requirements Summary:*\n• Name: Patel Yash Rameshbhai\n• Email: Bojrick@gmail.com\n• Occupation: Business\n• Space Requirement: 900 sqft\n• Intended Use: Cafe\n• Budget Range: 60 lakh\n\nOur team will review your requirements and get back to you with suitable options.\n\nWould you like to book a site visit to see the project in person?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "talk_later",
            "title": "💬 I'll Call You Later"
          }
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Button title length invalid. Min length: 1, Max length: 20'
    },
    fbtrace_id: 'ABw8_V61HVHaajqvMJ7kGGA'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async CustomerFlowWrapper.completeInquiry (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:209:13)
    at async CustomerFlowWrapper.handleInquiryFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:171:17)
    at async CustomerFlowWrapper.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:88:13)
    at async CustomerFlowWrapper.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:34:13)
    at async AdminFlow.handleTestFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:326:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:113:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '700',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"✅ *Thank you for your details!*\\n\\n📋 *Your Requirements Summary:*\\n• Name: Patel Yash Rameshbhai\\n• Email: Bojrick@gmail.com\\n• Occupation: Business\\n• Space Requirement: 900 sqft\\n• Intended Use: Cafe\\n• Budget Range: 60 lakh\\n\\nOur team will review your requirements and get back to you with suitable options.\\n\\nWould you like to book a site visit to see the project in person?"},"action":{"buttons":[{"type":"reply","reply":{"id":"book_visit","title":"📅 Book Site Visit"}},{"type":"reply","reply":{"id":"talk_later","title":"💬 I'll Call You Later"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '700',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 118834,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 1398,
        [Symbol(triggerId)]: 1396
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 700\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 700,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'ABw8_V61HVHaajqvMJ7kGGA',
      'x-fb-trace-id': 'DL4D5SxZrcr',
      'x-fb-rev': '1023673470',
      'x-fb-debug': '5hwK7N06k9eU7xz6+jhx5bu9go3EezhCt0q5iytRU90QLoks7lfaJN08wukE+yoIS9Sjzo49IdCn+cuqkQx74Q==',
      date: 'Tue, 10 Jun 2025 11:24:44 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcMPZfV4py-Im40Y_80MtWxcr-BM_S-9aHToIoqcwdkc98uvWR2DLJxqCLYcjydpPtfR_NO_fF0kra45T3b-BjjoSOh8MiFT"; e_clientaddr="AcM9h37c7WpOciEBOSK_lYwg8ywQ3R9k0tSyOq98dwQZF-v20b6H24JM22TxTPB9ceN4FjlVa7Q7j4X_JeYkcpfT3Lk3jqgZ33T0hSI6LJDb0ASc"; e_upip="AcOzM8OStC7xV0JfZBBI03AEJZCev8uNGTn1Oj88nHgzMdaX7r1FM6bgbpcBgH7FNPmtQKvyCVGVtLIxn8a8GL6AsBXpUo-tG3wNcQ"; e_fb_zone="AcMhgd4b7JjobOf9_wiDdk1dKZvzQSdbZw2TY_UKR6SbKUBdRyR1qGmRxw06d7sA"; e_fb_twtaskhandle="AcOqHRAD8Eo8dO3op5AxmHOTjeEMm-WKzavVGhsZo3uDtbLRSdfqX08vF5bEnideLBn9WorxoL5yrhS8YevEUrd6sRjB3DqaKYkoTKjBN-wqwA"; e_proxy="AcOyMhvYftEp5BlSHzWDjUak_c8Vj16rKglxN9q5nj_QiB4Ucx4SeFL6XJ0j6HE_uEZJj4PuZNFrnUvC66HC", http_request_error; e_fb_vipaddr="AcPwTGIlxK3vbS-LtGdMB72WHo8looUK1q_Mo84r85nc7pA0Hlo-DYCcheTTAdH07VDt5H-ifVcYVAfy8BwxyJCYOHxGIUJzCXY"; e_clientaddr="AcMAFZ6QT25kMQaQSs5AnhG7Hg7II2sX6SZduou8a-wh7LzHkxHp8gGtmnqSgS2Zd1vvQ6qCIFTPKQhndEHlrpWTAvt_n_gAvAKUKHMDwJTeZpITe3e8TQ"; e_upip="AcO0luWTMrQLHBWeMIsSTxEn2gWz9WgGS9T24CVQzl3N4V0DODKmdcFzchJVdINGl512xznHQpkY8QrbpwUXZgFukzzSaQj4"; e_fb_zone="AcPHd7jMVqQ--DLSqk4eMNYWTcxQ-J_BYZ-Hl_PAIitraDQVD_LtHJkN3-8YiQ"; e_fb_twtaskhandle="AcOIUXdgwQrAN0wW1iWRDr59h1dNvYoFUxHlxXXikbu-gbEtMBvE-JLpD2nrsWYqp697WRcKQZ1sa2d-d3vFwvnaXYdybyqSoA"; e_proxy="AcNIWO-wXezDbhW76g6x6klyxOhss3hJDvemRs72SfFLY1gTTrgEwFR3hrkJ6odjsx85o5As3YKMgfs"',
      'x-fb-connection-quality': 'GOOD; q=0.7, rtt=55, rtx=0, c=10, mss=1380, tbw=1380, tp=-1, tpl=-1, uplat=478, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '189'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"✅ *Thank you for your details!*\\n\\n📋 *Your Requirements Summary:*\\n• Name: Patel Yash Rameshbhai\\n• Email: Bojrick@gmail.com\\n• Occupation: Business\\n• Space Requirement: 900 sqft\\n• Intended Use: Cafe\\n• Budget Range: 60 lakh\\n\\nOur team will review your requirements and get back to you with suitable options.\\n\\nWould you like to book a site visit to see the project in person?"},"action":{"buttons":[{"type":"reply","reply":{"id":"book_visit","title":"📅 Book Site Visit"}},{"type":"reply","reply":{"id":"talk_later","title":"💬 I'll Call You Later"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '700',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 700\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: { inquiry_id: '6deafdf7-c8f7-4635-988b-3047b2f1dc6b' }
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    occupation: 'Business',
    office_space_use: 'Cafe',
    office_space_requirement: '900 sqft',
    inquiry_id: '6deafdf7-c8f7-4635-988b-3047b2f1dc6b'
  },
  updated_at: 2025-06-10T11:24:45.035Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:25:05.498Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTZBRjE3MjNDOUQxMTBCMjRDOAA=',
  timestamp: '1749554704'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTZBRjE3MjNDOUQxMTBCMjRDOAA=",
  "timestamp": "1749554704",
  "text": {
    "body": "60"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "60"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    inquiry_id: '6deafdf7-c8f7-4635-988b-3047b2f1dc6b',
    occupation: 'Business',
    office_space_use: 'Cafe',
    office_space_requirement: '900 sqft'
  },
  updated_at: 2025-06-10T11:25:07.162Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\n\n🏗️ *Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n📞 *Contact:* +91 84870 51252 / +91 95103 56093 / +91 94281 02172\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* or *\"interested\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEM0IwOTExNkE2QjE0ODUzNEUA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    inquiry_id: '6deafdf7-c8f7-4635-988b-3047b2f1dc6b',
    occupation: 'Business',
    office_space_use: 'Cafe',
    office_space_requirement: '900 sqft'
  },
  updated_at: 2025-06-10T11:25:07.162Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:25:08.768Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:09.246Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:09.317Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:09.576Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:31.119Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg1NDM4NUJEMzcxMjUwNUZFRAA=',
  timestamp: '1749554730'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg1NDM4NUJEMzcxMjUwNUZFRAA=",
  "timestamp": "1749554730",
  "text": {
    "body": "Yes"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Yes"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    inquiry_id: '6deafdf7-c8f7-4635-988b-3047b2f1dc6b',
    occupation: 'Business',
    office_space_use: 'Cafe',
    office_space_requirement: '900 sqft'
  },
  updated_at: 2025-06-10T11:25:32.497Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: { intent: 'booking', step: 'select_date', data: {} }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📅 *Book Your Site Visit*\n\nGreat! Let's schedule your site visit to see the Suvasam Gota Commercial Hub.\n\nPlease select your preferred date:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwNEM4OTE5NUU3NDdBNkUzMEYA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select your preferred date:"
    },
    "action": {
      "button": "Choose Date",
      "sections": [
        {
          "title": "Available Dates",
          "rows": [
            {
              "id": "2025-06-11",
              "title": "Wed, 11 Jun",
              "description": "Tomorrow"
            },
            {
              "id": "2025-06-12",
              "title": "Thu, 12 Jun",
              "description": ""
            },
            {
              "id": "2025-06-13",
              "title": "Fri, 13 Jun",
              "description": ""
            },
            {
              "id": "2025-06-14",
              "title": "Sat, 14 Jun",
              "description": ""
            },
            {
              "id": "2025-06-15",
              "title": "Sun, 15 Jun",
              "description": ""
            },
            {
              "id": "2025-06-16",
              "title": "Mon, 16 Jun",
              "description": ""
            },
            {
              "id": "2025-06-17",
              "title": "Tue, 17 Jun",
              "description": ""
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T11:25:34.156Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwNDExMzJGQ0Q5OTAwNEYwREEA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'booking',
  step: 'select_date',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    inquiry_id: '6deafdf7-c8f7-4635-988b-3047b2f1dc6b',
    occupation: 'Business',
    office_space_use: 'Cafe',
    office_space_requirement: '900 sqft'
  },
  updated_at: 2025-06-10T11:25:32.498Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:25:34.594Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:34.662Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:34.837Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:35.135Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:35.544Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:35.564Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:35.597Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:40.283Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM4OUNDNTQ4QkI3MzZFNEFDQgA=',
  timestamp: '1749554739'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwNDExMzJGQ0Q5OTAwNEYwREEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM4OUNDNTQ4QkI3MzZFNEFDQgA=",
  "timestamp": "1749554739",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "2025-06-11",
      "title": "Wed, 11 Jun",
      "description": "Tomorrow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "2025-06-11"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'booking',
  step: 'select_date',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    inquiry_id: '6deafdf7-c8f7-4635-988b-3047b2f1dc6b',
    occupation: 'Business',
    office_space_use: 'Cafe',
    office_space_requirement: '900 sqft'
  },
  updated_at: 2025-06-10T11:25:41.336Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'select_time',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    inquiry_id: '6deafdf7-c8f7-4635-988b-3047b2f1dc6b',
    occupation: 'Business',
    office_space_use: 'Cafe',
    office_space_requirement: '900 sqft',
    date: '2025-06-11'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select your preferred time:"
    },
    "action": {
      "button": "Choose Time",
      "sections": [
        {
          "title": "Available Time Slots",
          "rows": [
            {
              "id": "10:00",
              "title": "10:00 AM",
              "description": "Morning slot"
            },
            {
              "id": "12:00",
              "title": "12:00 PM",
              "description": "Noon slot"
            },
            {
              "id": "15:00",
              "title": "3:00 PM",
              "description": "Afternoon"
            },
            {
              "id": "17:00",
              "title": "5:00 PM",
              "description": "Evening"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NEJDRTRBMDQ2RTc0MUVCQjQA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'booking',
  step: 'select_time',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    inquiry_id: '6deafdf7-c8f7-4635-988b-3047b2f1dc6b',
    occupation: 'Business',
    office_space_use: 'Cafe',
    office_space_requirement: '900 sqft',
    date: '2025-06-11'
  },
  updated_at: 2025-06-10T11:25:41.336Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:25:43.006Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:43.381Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:43.474Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:43.736Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:46.577Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNCQjlGMEM2Mjc1N0Q1OTgyNQA=',
  timestamp: '1749554745'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NEJDRTRBMDQ2RTc0MUVCQjQA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNCQjlGMEM2Mjc1N0Q1OTgyNQA=",
  "timestamp": "1749554745",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "12:00",
      "title": "12:00 PM",
      "description": "Noon slot"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "12:00"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'booking',
  step: 'select_time',
  data: {
    date: '2025-06-11',
    email: 'Bojrick@gmail.com',
    full_name: 'Patel Yash Rameshbhai',
    inquiry_id: '6deafdf7-c8f7-4635-988b-3047b2f1dc6b',
    occupation: 'Business',
    office_space_use: 'Cafe',
    office_space_requirement: '900 sqft'
  },
  updated_at: 2025-06-10T11:25:47.605Z
}
🧪 [ADMIN-TEST] Customer flow session clear intercepted
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ *Site Visit Confirmed!*\n\n📋 *Visit Details:*\n• Date: Tuesday 10 June, 2025\n• Time: 12:00 PM\n• Location: Suvasam Gota Commercial Hub, Gota Road, Ahmedabad\n\n📍 *Exact Address:*\nNr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n\n🔗 *Google Maps:* https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\n\n📞 Our team will call you 1 day before your visit to confirm and provide additional details.\n\n*Booking ID:* 73bc20e4\n\nThank you for choosing Suvasam Group! 🏢"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzOUM2NDZEQzE2RThFMTZFMUYA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T11:25:47.725Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:25:49.344Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:49.824Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:49.940Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:25:50.076Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:50:57.980Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919998857188: {
  type: 'text',
  id: 'wamid.HBgMOTE5OTk4ODU3MTg4FQIAEhggRUE4MDc0RUVFQzc0MEFCOEI2MEVBMzY2NkY0NkMxOTAA',
  timestamp: '1749556256'
}
[WEBHOOK] Message content: {
  "from": "919998857188",
  "id": "wamid.HBgMOTE5OTk4ODU3MTg4FQIAEhggRUE4MDc0RUVFQzc0MEFCOEI2MEVBMzY2NkY0NkMxOTAA",
  "timestamp": "1749556256",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919998857188
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ Created new customer: +919998857188
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
🆕 [HANDLER] Creating new session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +919998857188
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919998857188",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\n\n🏗️ *Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n📞 *Contact:* +91 84870 51252 / +91 95103 56093 / +91 94281 02172\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* or *\"interested\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919998857188', wa_id: '919998857188' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5OTk4ODU3MTg4FQIAERgSMEQ3NzkyNTczMjk4QkNDODI4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T11:51:01.674Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T11:51:01.765Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:03:55.444Z - GET /health
2025-06-10T13:13:03.839Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM4RkNDMkRBQzk1ODQxMzlBQQA=',
  timestamp: '1749561182'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM4RkNDMkRBQzk1ODQxMzlBQQA=",
  "timestamp": "1749561182",
  "text": {
    "body": "admin"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "admin"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting test mode. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCRUM1MEMxQzI1QzY4NkQ3NEUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
2025-06-10T13:13:08.199Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:08.914Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:08.982Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQTYxQUMzRUJDOTA2M0U4ODcA'
    }
  ]
}
2025-06-10T13:13:09.266Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:10.035Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T13:13:10.421Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:10.587Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEMTk4NUUyNDY5OUIwNThFQjkA'
    }
  ]
}
2025-06-10T13:13:11.134Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:11.962Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:12.294Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:12.426Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:12.428Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:17.664Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM3OTVDMEE5NjIyMjJEMkE3RAA=',
  timestamp: '1749561196'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQTYxQUMzRUJDOTA2M0U4ODcA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM3OTVDMEE5NjIyMjJEMkE3RAA=",
  "timestamp": "1749561196",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "test_employee",
      "title": "👷‍♂️ Test Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "test_employee"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧪 *Testing Employee Flow*\n\nYou are now in employee flow test mode. All employee features are available:\n• Activity logging with photo upload\n• Material requests\n• Dashboard viewing\n• Gujarati language support\n\n⚠️ *Note:* Employee flow includes OTP verification. As admin, you'll be auto-verified.\n\nType *exit* anytime to return to admin menu.\n\n---"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGMUM2MDVFRDBGQkMwOUFDQjgA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "view_dashboard",
            "title": "📊 ડેશબોર્ડ જુઓ"
          }
        }
      ]
    }
  }
}
2025-06-10T13:13:20.500Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:20.826Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:20.951Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:20.957Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyNTYzNjhGN0IzNEI1MDM1NTMA'
    }
  ]
}
2025-06-10T13:13:22.266Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "સહાય",
          "rows": [
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T13:13:22.775Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:22.916Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:22.972Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0RUMzNkIzMTM3NjQxQjI3REEA'
    }
  ]
}
2025-06-10T13:13:24.209Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:24.703Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:24.850Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:13:24.880Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T13:15:19.186Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTAzRURDNkY2QTZERUQ4MEZCRAA=',
  timestamp: '1749561293'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTAzRURDNkY2QTZERUQ4MEZCRAA=",
  "timestamp": "1749561293",
  "text": {
    "body": "admin"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "admin"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting test mode. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyQjYxRUEyQjdBN0I0RUYyM0MA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
2025-06-10T13:15:22.688Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:23.045Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:23.095Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Invalid buttons count. Min allowed buttons: 1, Max allowed buttons: 3'
    },
    fbtrace_id: 'A1KAe9q_5Qxygrl4ZDMoEUE'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async AdminFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:178:9)
    at async Timeout._onTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:314:17) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '620',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '620',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 38953,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 218,
        [Symbol(triggerId)]: 216
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 620\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 620,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'A1KAe9q_5Qxygrl4ZDMoEUE',
      'x-fb-trace-id': 'E9whDbTRGdR',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'l36ZW+fSxzILOXdqXuyfLNJBVoZlxbpdkNMx9+Ve1t+fxTlutB+Oqwe4u7acVGkpzGr2VKFL5p9rlMq8AdJMsg==',
      date: 'Tue, 10 Jun 2025 13:15:23 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcMyhQbppC4MbDnMIFzOjbV3nqyKpnrOEUta8OAp_2_LarYrM8BRZ5h--Pl9KRI8DdVn_9gMO5LnI2AQksPsKpEmAY57erM8"; e_clientaddr="AcNUZFxwSArLuJ48vmhcrNfrGT6k7zEQ-DZizUu-Hbu5vwrqLs18nQW7-uBUb-vh4GIFe4zhxUNTpWk_iVb79GB7UsPON62WRyBGARJdEWt-P-HrAw"; e_upip="AcOOVfLlvEhC6Lr1DgAQf4MSz2A7Q-5F1VDQkm3elY_VLTjQxEs2P-ZRa0RWxkcWCIp3e9oxqxW48jF5fWywI-MDC6GejfifZXqjcJM"; e_fb_zone="AcM4ABifVBDEHEaQtPDbaeTT2gXOWLZjvIvRCy6f1A9LsjLgPd6ZUckxY17UsaCn"; e_fb_twtaskhandle="AcNeKoqtw2aMYMoNL1jnV8JFoeIAFpB23SPxsMCjDnHH2i8pyXvwm-Z-k7bs6np8DnGPV3NKEOep1rXcMd2sXNVfs_LmeBwNAmc2k7TU_zmaHw"; e_proxy="AcMh9CPN2ulx2FpeIl2yjmUB0jTtkVdv7F6TaUpRXBcUffU--dypDEktxBh2PqpcHCkJYnyGkMf1RylfY5pt", http_request_error; e_fb_vipaddr="AcNuRT1cTypv_5RzXXWX41yRnPIMv6B8E6hUpW1I81iDh5aRXwa0-XdiwFoNh4V_6aen5p7Mrq3e9HXRMGz1YPt5b-j86YS7"; e_clientaddr="AcMw1EKtx-9c2E9I-XA3A98YTw_TEXjPdW40l_yGqRQH3lay_FhuQIgNURn6QFavaW9L3Ee_j_5SHF_HFWyo1cWF56Aa7KX9LI4Jd_9a7mlDPHk-RCMkqA"; e_upip="AcO9u9XGNqGboGu3McIPOeevS-l4-xP-uHRPxTJdZdA151LfXMitIh6h_PRKEh8vktMpomyjpN1vuHKV9vUra9LXn5YDM21x"; e_fb_zone="AcPr40JPPpVeIA6fiIRbUml2yRouYNK9J_8KXvTXVtkdOaWd7gq3Pkuccp64tQ"; e_fb_twtaskhandle="AcM3ecbJzwFixATnAyScRTNsKy1zFBjIhWJxbvVUP1hPkk5IluhuN-VeQ9LukLaxf6JmBfZ37tnVr8vEU4n6IxLUnOZEl7p6c9RU"; e_proxy="AcOdXeBNgP5N_Gbw1s-rYuOBuXf_4BebnByrhoE5EIf2Q-SzIXJ-xbtz3oKcuSXtNkylR-lhe4EBjbQ"',
      'x-fb-connection-quality': 'GOOD; q=0.7, rtt=51, rtx=0, c=10, mss=1380, tbw=5589, tp=-1, tpl=-1, uplat=441, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '192'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '620',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 620\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
2025-06-10T13:15:23.379Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1MTY3RTRDNzQ0REY3OUE0QkUA'
    }
  ]
}
2025-06-10T13:15:25.615Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:26.100Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:26.274Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:26.356Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:33.689Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThBMzY1RjdDREZBNTMyOTAzMwA=',
  timestamp: '1749561332'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1MTY3RTRDNzQ0REY3OUE0QkUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThBMzY1RjdDREZBNTMyOTAzMwA=",
  "timestamp": "1749561332",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "reset_session",
      "title": "🔄 Reset Session",
      "description": "Clear current session state"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "reset_session"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔄 Session reset successfully! All test states cleared."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3ODA5OTk0NUI4NkU4N0NFQ0YA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:15:36.403Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
2025-06-10T13:15:36.792Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:36.793Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Invalid buttons count. Min allowed buttons: 1, Max allowed buttons: 3'
    },
    fbtrace_id: 'Am_JHLHwHQICTpZtKlBXjVW'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async AdminFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:178:9)
    at async Timeout._onTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:441:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '620',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '620',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 52851,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 439,
        [Symbol(triggerId)]: 437
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 620\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 620,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'Am_JHLHwHQICTpZtKlBXjVW',
      'x-fb-trace-id': 'CSvcvCdcM7z',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'naHB/qddem3c32kk6r/EpDjqcUiGjV2jIdkNgSsP82bF5xmMnX/9jeuJSTea0+/g+Y+MgDDT89+zLQvQm8VJ3A==',
      date: 'Tue, 10 Jun 2025 13:15:36 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcNw3W8V9jPzDM51jDnBMdRf_PZQbVRdOYTg61v-oJbIcrHrjkEREbHyLPHD2xvql5gqvdtC_X5KcsTpgEhT1dS5G2L3ntpy"; e_clientaddr="AcMz_7sKcHilVw9Y7NRcKPJ7zTVb9ZTqXZP1SYjGfNohJSrtjW0hlRaCqCaBtze8QV5_6oiOCFNqNXJOSJCC9Y0AWLh-4T3XcXTt7eDMpkDaNi4eYw"; e_upip="AcPpcgVnBxibRzENPIMijGdRWnboln69vrmeBManp56nHbNoC4M-OLoWo9Zc_A-zTNaHZ4jbUmcDrEJt3q6oZrCDvPVVjsqRQDGtCQ"; e_fb_zone="AcMINaXIHVJhQI73Xg4E6tFVck46YwL6sePwt3f9zw6Xjg7Qgh0f7_qnV4jhnqAh"; e_fb_twtaskhandle="AcMHf24vyHRigWkz39zZ41vfYyZ4XoZz7-F_T9d8I_p-H0vW4M1a4IDacYt3SqOW40-tSCK-4Z0vshDo8rQlMpRxmRac8T3tkOBtdddMx9xAmw"; e_proxy="AcN_T5EaaEOeAEpL7BhkXyNABBal40s-scJ01-g-1hTbKhM5d_S0C48KRp3-UkpmSsyMPwxXxVup4r6JZrk", http_request_error; e_fb_vipaddr="AcM3MpKBybDItaB8SCntAZh28Lrz2us3_o5uXPrYZWqXUaxPsy73UzLQRoRxhdFQBsO3huIYKX9lhlb8QOLWUDHKeSbQoxcc"; e_clientaddr="AcPbqz831ZfRMnfZ2neSdXgghTujLA-6i-NtOX4QehnSjv_13sZeLFcmZ4mXMlr14MEi9Dnw3MToC2jiAPccYNl2xlpgl40FtM8qYDHPF7TVYM3yMg0i2w"; e_upip="AcNNp3KaAZynRfEb6Wf6wOSR61q8RcyAANTc2c5LOLAHWaYhC0Ov1v0mPEaFJrKTkuBgtdrUTA_umKlcndv34WdT_xL3u8fE"; e_fb_zone="AcNE02ksfdHbbzA9a2skl-7RMbHZUXVz-jYlptHXa2L3zvWCZ5xgYIBlmUKQ1g"; e_fb_twtaskhandle="AcPa4wRCKc8j6B6zJ7XAyeFn3l0TmppYCxOOa5fqq73j_VQm7ZFLm89B7-ucy5GK2CmU7FNWeJBACGYaWxf-vVdFyyQPzLAf8jfB"; e_proxy="AcNU7Ms23Hja6i22z5HjdShbVXthdMZ1dUuJATNof6jXAO2HdNXKCL2ziL-QhOxTCHguon9RNEHUqro"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=32, rtx=0, c=10, mss=1380, tbw=5590, tp=-1, tpl=-1, uplat=382, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '194'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '620',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 620\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
2025-06-10T13:15:37.049Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NUIyNzFDNDA4RjY3ODkwRDEA'
    }
  ]
}
2025-06-10T13:15:39.552Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:39.893Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:39.970Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:40.045Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:46.692Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ3REEzNThDRDg1ODAyNDVDNwA=',
  timestamp: '1749561345'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ3REEzNThDRDg1ODAyNDVDNwA=",
  "timestamp": "1749561345",
  "text": {
    "body": "admin"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "admin"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Invalid buttons count. Min allowed buttons: 1, Max allowed buttons: 3'
    },
    fbtrace_id: 'A8hs-2WXOWofB2oysujaR4z'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async AdminFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:178:9)
    at async AdminFlow.handleMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:132:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:124:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:117:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '620',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '620',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 64015,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 602,
        [Symbol(triggerId)]: 600
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 620\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 620,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'A8hs-2WXOWofB2oysujaR4z',
      'x-fb-trace-id': 'Es6CU4x9aij',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'ByKm0ftfmtnHV1wQIDVPiC/gnobQm45nyTKoJlq6G03w6Ukiv0c+EXkh8ln7Nv5rpU48mFiGDGyKPiq/skgkaQ==',
      date: 'Tue, 10 Jun 2025 13:15:48 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcMCWcDs9XLJWloqNPNRIv1wBdIk5CofFRS24Z9lNgzhdxNLX9jDd3bW42-Owul_9ZpOzXnLm566rLJCVc7bt0EHdnu6wJuu"; e_clientaddr="AcMeSsSCEF8aZnBSEnDF9mSoaAktGXK4sXiykHcy7ZC0VWtCQMJn09lPv8nMBTupgcH0hw-OpZfn7knGTBB5sgcKxcgyI1UFxOTvgrRimbAN5meZFQ"; e_upip="AcOIRJ8qrkPgi7xCS7f3hQFPZ7N7ajggLDCVg1CMQ1jPTYrny8ZkD5RD37c-nDRuN60QOW52RX2E4CtYPlE8FcmZ2IOMXASoxHCrTXY"; e_fb_zone="AcPg-BkqgVHuCxkdIwNB1JSx0sNINl-aLNfijzkbNldAn6LVcoEkPBfDs58C-t52"; e_fb_twtaskhandle="AcNS1W_x6x47NmZ4T0SKIiQmd-p3gGKt2JThp7_LuWDlvGtfFcfQpxPMvuODC39TIxaIDWD8NmC8x7Z7Z2xFWer9B563Ne6n6HfM962G-PfXFBQ"; e_proxy="AcOX7CAN1ZLo_urdbjfKRI6J5w46oP-lpW19LfaBrpniwgWRjDwoXkdlh3yzjM-7nRj_mmz8Lp-wTXw6bh2g", http_request_error; e_fb_vipaddr="AcM_ze1cACE3-FcAGqL_TxVdDII5Lqb-6I1U9J_dKkKOTDevIMF7FAfHAMkRURriTzROh3hpcdjWAwkOfzyR3nmyyikoQxnz"; e_clientaddr="AcPXPdtu-PWtrhzb6pGSjXkfRS70kzmkf9YLBo50rg860Az4XOttHx118D4hSNgSz73YyRv-gXsxXfp0rD58-MWkTMutnT85IlK4UzOAq10a1u3x9IWKPg"; e_upip="AcPahGWLOp7_dmdtdHrSrfrKCRv10k8KtrfQi0PIuUBJsX1FBliBa4Ckzx384oCdtoEDvvNJhUKMVtF8g4E6T-xPzGpvir3l"; e_fb_zone="AcPOmM3Trg27x3Imk3PotcQnybc8K0QOgxeCxGDHn4KT-oyhgY7Qr5eHZmUvpg"; e_fb_twtaskhandle="AcMXjY94kpx-I7lYueca2MHkVKj_U59do_GGOT3HmrUfFKUXw-Tgo-pagU9x_-kPxmYd6I1_BqrRN-l1Wn_k1Cm7eZYKXxfLVRP0"; e_proxy="AcNK5snQZiAv-MWfPc6uxo9IADv7il5nv46kknP6QPJ2lrJKIiqvPUhp6e8WzPLrTyJQX3lW8ma_cgI"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=34, rtx=0, c=10, mss=1380, tbw=1385, tp=-1, tpl=-1, uplat=486, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '191'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '620',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 620\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0QTAwRDI3Rjc3NDk3MzgwNTcA'
    }
  ]
}
2025-06-10T13:15:51.696Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:52.107Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:52.109Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:15:52.309Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:16:04.471Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTBERTg2OUY0NzY2RkM4NUNFNAA=',
  timestamp: '1749561363'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTBERTg2OUY0NzY2RkM4NUNFNAA=",
  "timestamp": "1749561363",
  "text": {
    "body": "menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Invalid buttons count. Min allowed buttons: 1, Max allowed buttons: 3'
    },
    fbtrace_id: 'AtsAuGQsmHT6d8Gyrh3NDYc'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async AdminFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:178:9)
    at async AdminFlow.handleMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:132:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:124:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:117:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '620',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '620',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 81743,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 760,
        [Symbol(triggerId)]: 758
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 620\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 620,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AtsAuGQsmHT6d8Gyrh3NDYc',
      'x-fb-trace-id': 'CxC+7+jewDN',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'mLHxXookOYb7/NjWoAXXaXwpZe+kA80T0cPEJU9IOpnNZm9uB21MJsXWvt+dky0jNz85lCaSu0OPHTQ2DEqtGA==',
      date: 'Tue, 10 Jun 2025 13:16:05 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcNRVHK8kE9hV6rv_alLseGMHjFCDuQw01tR_0YQtuhlsc1nYhtAlu-rAcuGDcvbfP_TUTbJIBGYeLGEXyVgL_hcDcxniHIP"; e_clientaddr="AcOijfH88Bmhs1pXEEt9V4pedGFhovxeDiun3Mxl7jRH354RofJkzVh_SKIcNNTodEKjRnW3Z_C-DJqcJNsi6L01BBiwuJuMPQJnirX9LUNSbCZ9"; e_upip="AcPiIe0zwFmwqDks66YnhIiGz5MWdjNUh6z1-erfxyQprs41-1x7iHM-GoaUF6GghM-LrksiS8OWOxZ7DxtTv-GOKn069_Itns6qX-M"; e_fb_zone="AcOy8_8MizOC3O1-eULq18ocxtmby3Cg9O95ps-HcRYH8FeBIHUZpQaAYU_p1c6R"; e_fb_twtaskhandle="AcOpopfrHddabzJsCXZG7ZEtxPtDOoY5HZ4DWbEEvvGTZmhp4ph7c2Qt0RPQbr-erxJhdj3QjkkN5K00kSCoYylO8NQl98UiBwF33z_in2VNPQ0"; e_proxy="AcPlyp7lro5oLTCe04kpHXripyBqdw5PpkCgSvkoTchPe5KfChsc6RTBqaJ02BZuDHlaTJYCz0iC7XmJdb72", http_request_error; e_fb_vipaddr="AcP8jdzCuz-Wde9pongzqo0au2QgrQRcWDHDAkfJqh-ApzyJWAK7xZyfQTxZXWlpVhlhvmOSgPq4b3hh6Alaspq5YyrcASdt"; e_clientaddr="AcPyVHoHFjK8CJfbbR-38Hn4PebnqOabyBejXh3k06sGLDWhnP6YaHG_mvPa291HJAaLpWgrAxoH9OIHj_yAD9g92OOojH1dUpySM7Nkv51CgJoKThVu5w"; e_upip="AcOMjKnOMbcWiynBNfboArRwGSLZZmK9JQyuktZPlNs3jBXH7_Q8GmOAalr2HCk-OAzs1uYj-hDz3pqLZQnhqSjky3a5lUTg"; e_fb_zone="AcPdnkxvuV47xFhem6a-rCXcUxrvbgwW5pep8gmsmAjUIzrqkLPMbxeoYg9pbw"; e_fb_twtaskhandle="AcM-avnaTFezz7BguSEgrJIvYPSoCWWrTU3iH0k6MsZn3surflhVLWsH2Xd1dcAulMTn2djD8ZkOvqaZZtSdplyYlE0FjUW7wuhK"; e_proxy="AcMZ_jRa3N1MbPxh0cRVXyBDV650bAD9EU27LOCPzAs4DlFzVlRWdZG5zHFYN5oJYeKbKE1H_MPm5bM"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=32, rtx=0, c=10, mss=1380, tbw=1385, tp=-1, tpl=-1, uplat=424, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '192'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '620',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 620\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwNDU3QUE0MzVENDc2QTYxRDcA'
    }
  ]
}
2025-06-10T13:16:08.427Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:16:08.819Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:16:08.962Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:16:09.081Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:16:15.137Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUE2NjQzRjgzQ0Y3RTIyOEVEQgA=',
  timestamp: '1749561374'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUE2NjQzRjgzQ0Y3RTIyOEVEQgA=",
  "timestamp": "1749561374",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Invalid buttons count. Min allowed buttons: 1, Max allowed buttons: 3'
    },
    fbtrace_id: 'AqWF5qfhUPBy6xrXHdQlAxe'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async AdminFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:178:9)
    at async AdminFlow.handleMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:162:17)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:124:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:117:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '620',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '620',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 92495,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 914,
        [Symbol(triggerId)]: 912
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 620\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 620,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AqWF5qfhUPBy6xrXHdQlAxe',
      'x-fb-trace-id': 'DBEp/OarCkI',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'wdoaQh4/xZlgkq1QngRGi9i5Lxe0/4s1HYlUBKjI1j99HrPZhcp/RDsdkedD0WUPJSPzbZUJc8WrJUXtFY8gvQ==',
      date: 'Tue, 10 Jun 2025 13:16:16 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcPw8_CzoKOfVR21Cj-hLbjTW_1zi2NH53BuIlT8CJ9OEwLDEI_YhxxvBc2qMjQXgt1w2FL43w15QcLYFGvXX8IWI5aGeC-J"; e_clientaddr="AcNLU_7GAgiyyOBPSFhfIVTW93MeRp-63r76KWoQCteaMPBCpQIxvtzYoIM2FeHgoGyVuH_l6qIulHL--1x_YN_GxTOgcsmQts30xS1SJM9QfEtBgQ"; e_upip="AcPwf-1fuCrp4aa7uIifk5_rz5ZIPkPKtYjeqTwDdEkGb0-uZ2gCJLpwfs36IBUIbixtwK2-cIdh8ua1DergtWtoMEZbbD0JpTnyzcY"; e_fb_zone="AcPT_tXXG5JnQIwPtRysZHmNx_tjdFW8DHhIPZlvo5JVzZnydafY0owPpxxZrVOO"; e_fb_twtaskhandle="AcPvE4ywCByArtMtXYfZcnZS08ByaJmfF3UAStP8W1a1tukgxPlsZPcR1oGJlQgFcMBXBSnaInJc6yuFJCBmT1G1s96tVwzNSHeALWPX4flCQZ8"; e_proxy="AcNKrTMhbumGRPxti2ds8AwJAQzJ83HaxrCsF3Av4Vi0aDjNJmYF9vIIr7pNxSY9sklbCJpithat_fVAQ2bW", http_request_error; e_fb_vipaddr="AcM58MGd6oSN21FF_rfjenZ0_H61pJhA4nW7wTATpBNG5Ju_pGVXMw_y5nrSW2MSFd7Z9XPz8F1Ki6aYj6TxZ5KwbmOTgKYT"; e_clientaddr="AcOem3GET0fgdW7eYzSSausVv7EUxBV6cuReCjDPcMN-VGScZWc6Mzp0rThyG9_0s5qB8AOAH-8KHMhEshl0xHkJ5ZelPdvPHZ_NfsvgMn97EKH22TMXmw"; e_upip="AcOunEY1xZfS8fMCL5yu_Sz9kHl0StZYj_Th2yL8eaEp9oU4LTNzxzDTdaUYItQ9HdXVMkW81bX2kAdI15bNhSiahr2G0XEt"; e_fb_zone="AcPfxO435-SD8yfbC1ykvCbYHaC6nQXzj0ix4dXHSLpLFPxmA8seWdn1JKYbkA"; e_fb_twtaskhandle="AcPulpN381KmNBrFMvL1D5rA0eRbCdKHZkFhXBjcUSsQZdx5W4dyuUAglF_GVupS4GgBIdDnRiWgfbhgbuZb81PXOy_XE_tqAnJC"; e_proxy="AcM8ohcr8a3PqXkVuDKNQheUZCFmAbONOn3LAUuU35IlecLXmmCDoSsa25avFNfDZKdZyFthyhB7fhE"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=39, rtx=0, c=10, mss=1380, tbw=1385, tp=-1, tpl=-1, uplat=496, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '191'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '620',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 620\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3Q0E1NEJFMjAzMEVFN0NFNUQA'
    }
  ]
}
2025-06-10T13:16:19.207Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:16:19.725Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:16:19.772Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:16:19.900Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:16:26.485Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM2MzdCRjVCNjgxQjA3MERCMQA=',
  timestamp: '1749561385'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM2MzdCRjVCNjgxQjA3MERCMQA=",
  "timestamp": "1749561385",
  "text": {
    "body": "Hello"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hello"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Invalid buttons count. Min allowed buttons: 1, Max allowed buttons: 3'
    },
    fbtrace_id: 'AREMUjEyLeQIm3IUSvl5JiX'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async AdminFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:178:9)
    at async AdminFlow.handleMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:162:17)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:124:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:117:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '620',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '620',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 103727,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 1068,
        [Symbol(triggerId)]: 1066
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 620\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 620,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AREMUjEyLeQIm3IUSvl5JiX',
      'x-fb-trace-id': 'A5LKX6jTGMy',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'h2OpyKAb8hOUw+Qfrv0ot/IuEenYmt8EGZTOHA4DxK97JCCp8kz8pr3IQ1b9GG7cd056EF9SFa0n0T6kr0JFrA==',
      date: 'Tue, 10 Jun 2025 13:16:27 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcOIF8Co_7ZVT5BmEf_tARXCve143C7CgM_ih7wnoYKK0sPRo2Yb7uMm8nL95-OB0Ax7YEOtIE68dGAGorEJEkK2d_4NfUGJ"; e_clientaddr="AcOuC7YBI5Ds2d8w5pj182pD5UnP9xSCrmgDIWajMqMvgI84jWfxS-9X07wrjsB5e28pGSLlq619cqUVtY1WhBQb3uaCVPIdSF2YHGWD9YRnc36hLw"; e_upip="AcP29xnEHMSTTRQQ7DXWEqhEQdmDuTwtr5dyl4DlJ13DuJvzaF0oFA0O8aTcF5fgpS4WeQEAnlYGEW6JQ0G0GQAYvRC1U2DwtAx3OqY"; e_fb_zone="AcNWnNFZX-l9Ev5bTd8pllLxEzNXoFEweHMLkwguJ96yjEZ9yKsctV8dOi0jvfL_"; e_fb_twtaskhandle="AcMwu3z13o9_7iKf-mAKxYLQykngPezKRvr5gXdwuf8BiSoyXbVJO1kbc8KNYzeiplGhY8NErxG1kboBLQOUBjiYKAGPuMfDmvBPY1dB8UAhZA"; e_proxy="AcPNiRyWRQ8BSH8x5t4ScpPJwpehqNQLt7xE0JPrlgla8tGEGXbh5NQ_X6BFbbg6_u61Rx6L_wT7efQUNPtU", http_request_error; e_fb_vipaddr="AcP91tjMbWcBvb-R9i24XmO0q7tI6xrzsY9VjdPLxJzTZi177cf3x4MM3CO3VueFo9kUrsJaE6KRUaQvqXZqCnaO_kJjuR8M"; e_clientaddr="AcPlVuvxLHQgshypScpJCsYGm2oztT3VlCYebxDw1WBhNRuqyjB_KEpsSZKtouZkGHdzvitYmSnCehtk6vwt9RE0bazmMSJm356qgmj_c5v1XQtJyB7p0Q"; e_upip="AcNH3LbpauUO633aEZN-snSHtw7V8Nhn1wZl8latll0q-I0YZdyuZbZj1Ghj1P6LpmUODTSybnpdXP0RdM_nn40dFVIscszh"; e_fb_zone="AcOK25DHGnpNfZgklRwafkG5a3Bw2730UXxENIxPeIJJTCG9t9d3KZ4rWhgijA"; e_fb_twtaskhandle="AcOsCQB42UdCG4w8iJoYvbZSZed4Zgis4-U3KzRfIG6u-kTdd2c-K9CGoOPgRQB0GM1yreuvXQg1qBbjTXZZJ97tRonS6KbNwgKx"; e_proxy="AcMcU1ICjl9tCcbN6paxn2C3M9ciG3XaJYhcvOtPcWEj0SFJTDFH8CS2vFXCwShAk2YD4SiXHf0EhuM"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=34, rtx=0, c=10, mss=1380, tbw=1385, tp=-1, tpl=-1, uplat=420, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '192'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '620',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 620\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMkIyRUNEQkIyNjgwNTREMDIA'
    }
  ]
}
2025-06-10T13:16:30.630Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:16:30.955Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:16:31.060Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:16:31.703Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:17:00.905Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTlDRjlENjE0RDNGNzA3RDIwNwA=',
  timestamp: '1749561420'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMkIyRUNEQkIyNjgwNTREMDIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTlDRjlENjE0RDNGNzA3RDIwNwA=",
  "timestamp": "1749561420",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "help",
      "title": "❓ Help",
      "description": "Admin help and commands"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "help"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🤝 *Admin Help & Commands*\n\n*Available Commands:*\n• *admin* or *menu* - Show admin main menu\n• *customer* - Quick start customer flow test\n• *employee* - Quick start employee flow test\n• *reset* - Reset session and return to admin menu\n• *dashboard* - View admin dashboard\n\n*Testing Flows:*\n• Customer Flow: Test booking, pricing, availability features\n• Employee Flow: Test activity logging, material requests (requires phone verification)\n\n*Quick Commands:*\n• During flow testing, type *exit* to return to admin menu\n• Type *help* anytime for this help message\n\n*System Status:*\n• Database: ✅ Connected\n• WhatsApp API: ✅ Active\n• Admin Panel: ✅ Ready\n\nNeed technical support? Contact: admin@yourcompany.com"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0RTU1QTZEOTlBNDRFMjM3QTIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:17:03.964Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:17:04.335Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:17:04.471Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:17:04.541Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:17:16.573Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdDREZFNUExOTZCOTRCRDQzQgA=',
  timestamp: '1749561435'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdDREZFNUExOTZCOTRCRDQzQgA=",
  "timestamp": "1749561435",
  "text": {
    "body": "admin"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "admin"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Invalid buttons count. Min allowed buttons: 1, Max allowed buttons: 3'
    },
    fbtrace_id: 'AUZ4ZUL7NqAYGTg9tPqzqb-'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async AdminFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:178:9)
    at async AdminFlow.handleMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:132:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:124:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:117:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '620',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '620',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 154075,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 1383,
        [Symbol(triggerId)]: 1381
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 620\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 620,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AUZ4ZUL7NqAYGTg9tPqzqb-',
      'x-fb-trace-id': 'GPy5414br+H',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'vKlDySMWN1fH33mBLeBNEvRb6bFUfQ5/5xhp8BOL5yc4Jc2lf2wJgDLRsC83+PDhEn5U60KuJb+qlpVrnFNzXA==',
      date: 'Tue, 10 Jun 2025 13:17:18 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcNhMgEkSlRULyXPdlnjevH1_S37xPbT8GfSf3l_uBioi1yux33M92NuF3HLyIEGUia9cOlBsag8wiXofCq4hz9qSyekFBM8"; e_clientaddr="AcO680cMmf_uzURTweGKRWtpvuLESRARC4mICwqbG94-ZQx4QtrXlyFBt3ZEL-tu3MlpMLvDAZoiAbIfR39-vc8OtXRI7CD4bo2YmAWBujtS710iSA"; e_upip="AcOuxT0ELZbWX-ExtkGGzwlgAOJn2Prbm9AnQNB3aH-jyprigY2Td_rc6l-jfC3tSWFATcmJLaI7_NAPNnXNWexhfP2VfRjNfkiued4"; e_fb_zone="AcPSor6u_DZVKnqrjkZnI6LNytvyuBLevyZMz66xSybsMGCKGgv9BahJqtHF_krS"; e_fb_twtaskhandle="AcPazkrG4_OveZnJgbyPulPnn790NWiRKDWH3ETrvBj9rjs6PPGT3Xr6KgVi3bggLYffLviRlKvsFfM1pCcWKTtGkf4H6aN2v8L2hoPxls37ZA"; e_proxy="AcPJSJpR3OrVR2I2ve56VBFGqx_nUZVIgr4yEUUR-cNqH9SrmH0981-JZvRDYKeqMWUnqaBFnttt33uKASDy", http_request_error; e_fb_vipaddr="AcO24MsdIN8_4_-1_2ownDuKj0qYhDuHg1GVZXVbfFpNzlD4b0w68bBtKnQevTCxx-RR9CM8TBsbinMIWtt8L3kZBaMJC6Su"; e_clientaddr="AcM4EPrptitFdPqTZNILuQmq2OZ9cjs2ae9W67W7cwuUb6u5L1yVyUawcqrB54UajTB4dfUAjH8NItuRfVIsiJzd1_pAbZJlcydh2g61TFSA8CXMSGAOVA"; e_upip="AcO5fTU2M8wEi_9JX6vv3jMZ8AIbP6AMlXQS1F_k6MOTZANXROhMyWqehjv8RpbsVOuQvN11MaAtH-YnVoetOg8EpQ93tdTP"; e_fb_zone="AcNWc8SnKEymVzJWsIxRveaRzr61qm5pKp5VqCBxXWq5aZUTKTa3L-glzg_ziA"; e_fb_twtaskhandle="AcPswFUXMsQSGYspqvsnVJ96N6G4eBMEEnrE0tXXa7dg5D1Koj3KN8GWe9runPFVKU5mH41NV-Y9qEIkOJ7bLDYxd3AwHVb1aclr"; e_proxy="AcPcNxYuRxCvNmZfx8czKMEKarILIvo4TGC_ohLPQ0w26lknlo559I6kxzeGtgDHIJxocrOubET10Lc"',
      'x-fb-connection-quality': 'GOOD; q=0.7, rtt=50, rtx=0, c=10, mss=1380, tbw=1385, tp=-1, tpl=-1, uplat=487, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '193'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '620',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 620\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyNTY4MDIzQUMwMzBGNEUxQUMA'
    }
  ]
}
2025-06-10T13:17:21.065Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:17:21.301Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:17:21.332Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:17:21.381Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T13:25:54.170Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTIzMDk4MEVFMDQwRTQ2OTgyMAA=',
  timestamp: '1749561924'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTIzMDk4MEVFMDQwRTQ2OTgyMAA=",
  "timestamp": "1749561924",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-10T13:25:54.963Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI5RDI5RjMyOEU3OTIyMEE1MgA=',
  timestamp: '1749561954'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI5RDI5RjMyOEU3OTIyMEE1MgA=",
  "timestamp": "1749561954",
  "text": {
    "body": "admin"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "admin"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Invalid buttons count. Min allowed buttons: 1, Max allowed buttons: 3'
    },
    fbtrace_id: 'AN1DgvKPdE4UXmwAfZ5xSw7'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async AdminFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:178:9)
    at async AdminFlow.handleMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:162:17)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:124:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:117:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '620',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '620',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 41482,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 228,
        [Symbol(triggerId)]: 226
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 620\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype],
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 2,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 620,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AN1DgvKPdE4UXmwAfZ5xSw7',
      'x-fb-trace-id': 'HiZ0TAdjcxP',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'n2cKocx6qTmVw1zUUlDoepiIcp2anHDTHj7F6KA5sks21wjNZHxc+di4B29lvcdNypiUbWJQrGl2T0Wjvc8y4A==',
      date: 'Tue, 10 Jun 2025 13:25:55 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcNjYwalnJ1etxsN6wzY2lheEX--c0jGTR5WrKJjIQxoK0JXrPK3m6Mwn7Voye0PgpksHKon4VAddWgwrs6lkJOW-K7r7xSD"; e_clientaddr="AcNkXg7w--uN7EBVozKosRcH1csm_AJgzCym8YX8U8w3ImJ1jaq8XdEKKpyF2ihYYNJ3dcu0-i97uusov9wAA4ylAI7Ehd5xx2lVePvru059omtcwQ"; e_upip="AcOtEoB54gkUKslqPDBf_UrYYEpN4MHvCoJ216PxIqOy4FdI0er8WDzWqzovXXgZGcGnl24VlGo-61pXgIPskQvEYt9SNTR7p8n6dWc"; e_fb_zone="AcPrDTBeda4X7i0TdBtG1FtRKi16xA9gvJEpjW1NpBIGiMWyoGVYE4PqZ1YoIndA"; e_fb_twtaskhandle="AcP9ja7en_Yk3xFQPXWHWyncl9XwncP8hbcBhMrHkO5Azq6Y5OncBKLiQF221AX3SmBmjr0vRECo4PqODsqzwPIqEwEt_VeE6wv6TD_wzFiV"; e_proxy="AcP8hrJwqIhdvYDL3MYeu-2HA_PAQG-ssjnYv4VlxZuKmWiSS2jpCmBU1qNeQvcJm-Zl0zv75tPMX0dhkKjx", http_request_error; e_fb_vipaddr="AcNv7JoMts6fPM4yby_UalBWMMI_1DBGN3RebW2j71iZVUhtLH4qK9kk7Xh-CFyMSj1mQWDoxSgbA5ranV3_t1jTS07_MdSM"; e_clientaddr="AcN40S1rmHpdVl1T3vzdtytyIkmMl85sOlZDST5LesROE-DEA-klGOLgXemQd4TA_S07UNKC8O2GfAFHaCYfn5B5-zVGWtk3yY-Ahw4RdVk4xURUNJUGVg"; e_upip="AcM5hngBX8P642Tnnd48uCxWtJ_w5SVfu_VUrJTEYvAkkqi19LxDcdz7d-y8h6dDLU1-1Z52SIvoq3UcyUGVJ9Vw7_azd-p2"; e_fb_zone="AcNXqEtazztBorPpk7x9lb4PPLTvXCdHgWLEcSpqFDKzi4vMxfE73ceCCKOb6g"; e_fb_twtaskhandle="AcMO8lhskgocakKL_6TTHk_bVw7CliKxJSjX2Il6m4z79ManQ6Td4HG95zeZPzRsaT5HpfczsTWRJZx0iNEQC4mpX1wqLM5frWkr"; e_proxy="AcOEVFmAY7afZpNP-ZfY7MM9utYVze7okZTWeEtyjDR3fcgAon3ogXlwV2BKKOYIZTiHrR201MFatOk"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=34, rtx=0, c=10, mss=1380, tbw=4418, tp=-1, tpl=-1, uplat=469, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '192'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '620',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 620\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Invalid buttons count. Min allowed buttons: 1, Max allowed buttons: 3'
    },
    fbtrace_id: 'A7bL-4vF6-X-R5rwmVQcNWn'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async AdminFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:178:9)
    at async AdminFlow.handleMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:132:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:124:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:117:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '620',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '620',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 41765,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 250,
        [Symbol(triggerId)]: 248
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 620\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 2,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 620,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'A7bL-4vF6-X-R5rwmVQcNWn',
      'x-fb-trace-id': 'FkZfEY+9blp',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'PGDDSaEMKjyk83T5PxkcjGT6MubHKWQTTbh+CXf9yqk1Iz/boK8cEz2dZNEAT8f2kXOBmHi6fkldktzkA6v9nQ==',
      date: 'Tue, 10 Jun 2025 13:25:56 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcOnOorVxCbUwr7mWEWaViwO4RDZN5gAZHtTV3egu-b0fR8lvB25c-YPiZ8OZY9qJbT5vnaYjC-Jqu6ho_KUtj7Qo1frTGYE"; e_clientaddr="AcNemnXaV4N11aUDKNrEVQgISBh8P9X6CQGspWvKg_1th0IuaA9bVocGst9VZQNv6UbnEvrliX-M-pUKCaBYCKvETpcWzkhxR-g-Hs6GMD7VKi1ryQ"; e_upip="AcOn6T20Md2YNr9PKlB8FYasba8Pqyl6LqULjQoSnaGzocj1836pHENj4OV-8KGgv5KexUF5r7IvUb4gPLamq55NE6u04ARsCY-ajA8"; e_fb_zone="AcNRV3vuLsC8192DMAWMSCzkWiG1DicjqqGdUvRc58GCDhNMciBL31SiLOePtndZ"; e_fb_twtaskhandle="AcNCw_3G8FTI06oSuuljhR8wXzY4cPx-OnD8OdTJkcWkE3dr4yOBLOX_CBW3yJRZuhM0wqiOvX8LdQNXclXIomeZp4kraRzztI8nce9dqpQH_jg"; e_proxy="AcNHpQZT6ULFgQ_E2vTj_WmO4UyZFajqP6WkWyRc7KJhGbARRhA4Lyvvj9EozkjNilO3-uw2QM_uUzyb1io", http_request_error; e_fb_vipaddr="AcMLLbNT2oNVaFnrsmL88FtWA2h7-7Y-Ph1k46V2uLVR6DvGfz8uPUwXJPBK8IeuQwrcei1ZAg3Ao6GhZyNpbLUMM8qSb0XJ"; e_clientaddr="AcP54S1UxFqWMy0bmzv7g0BJNsnYArPbQvrJ3AMVDU4bVZpn-6NoaPgN50NO2pb9mqCoQoKNL9YVdz_cG45Dkr7ASOWlsdV68dtSL1MJFLeR2IonYFqfTw"; e_upip="AcOBoWZDapb73FaXfNT0_Jl-VzC3PUh_pO0ASx8J2R7qJKcGx-okZzL3Grw5XHuoT9bw4pOS93EbVPqolQfnZTTFQxsV9rxl"; e_fb_zone="AcO5gGXAp3XRFBCgI4op8RWX-dyb4tJnQJM5h3HFvxQusd23CnvyMKbUw4lnzg"; e_fb_twtaskhandle="AcM3zmCV9JRxM3Z49jlIsIu5Hho3Fndjc23DfkQl1l6aO02zQOX-F17Hs2CVFXO6RYHxbmdtYFUsxt6R7jNPLeEC9-uK_1SZuGtu"; e_proxy="AcMaKbOwANw9mLaBJvqR4gdHDT9odfaTFOyWAjX8VvYTgfMFB8QlaZqigqJtLEBkkLg0BLzDF9UqDxI"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=31, rtx=0, c=10, mss=1380, tbw=1385, tp=-1, tpl=-1, uplat=401, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '195'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '620',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 620\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1QjRBMzI2NTI0QTNCNDYwNDUA'
    }
  ]
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBNkNGMjUzNjdGQzU3OTMzNUEA'
    }
  ]
}
2025-06-10T13:25:58.773Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:25:59.443Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:25:59.453Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:25:59.507Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:25:59.634Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:25:59.775Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:25:59.778Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:25:59.851Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:26:05.281Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNGMTE5QzczNkQwMUFCRDU4MQA=',
  timestamp: '1749561964'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBNkNGMjUzNjdGQzU3OTMzNUEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNGMTE5QzczNkQwMUFCRDU4MQA=",
  "timestamp": "1749561964",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "reset_session",
      "title": "🔄 Reset Session",
      "description": "Clear current session state"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "reset_session"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔄 Session reset successfully! All test states cleared."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3Rjg2RUU5QjkzMERGMTUzOTYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
2025-06-10T13:26:08.332Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Invalid buttons count. Min allowed buttons: 1, Max allowed buttons: 3'
    },
    fbtrace_id: 'ATjM_QA4aDFmryd2mr-ObN4'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async AdminFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:178:9)
    at async Timeout._onTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:459:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '620',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '620',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 53875,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 506,
        [Symbol(triggerId)]: 504
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 620\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 620,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'ATjM_QA4aDFmryd2mr-ObN4',
      'x-fb-trace-id': 'C9VupgRt6F2',
      'x-fb-rev': '1023675050',
      'x-fb-debug': '9D3KQA7RmsuznBQqgqHd/fQlz8yH8wVXItWN0ElIQ8gozpZ2bPQhqi3n5AO5Msr4ZpL/TwItP58ypzY5keZgqg==',
      date: 'Tue, 10 Jun 2025 13:26:08 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcPoyc4l0KjsvHhyMuPo3oI6mywCwvrLbmH_zdBdy-6EvnO6kU0TdoDxT8ajl6J_CvSdwpaqPF-N5-t7c6IYISKqek_nB21i"; e_clientaddr="AcMaQynAUU3o-1tPOV_WqT3FKm-JnS3iQlcY-2VFUmeBxmB-eII634iZ3lJPrumWfSmRVc_oJ0W5CK5ogvn9CITifQxE8HRkAln_cgBaO6a95JRISA"; e_upip="AcOok5QfuOIxPbcBiFHk4KKNw0pcx5r8R91g52G4bShc_oCljpxlbbS_anYnS7Y7gjDfmPivyHqvB1sZgOwdooX-oG3V1QKwkdi8"; e_fb_zone="AcNZOsQUjx3NSeKjSPu-5w7MIqcMIVjJjeoKVv2vM7rvNo-JRDwPXJQeZQCUv-Fo"; e_fb_twtaskhandle="AcMZGIU884vW0TwbIWZgITzJurH7UdonGtv9J5saUloWH7CbawIM7yRXhridf5psoNKoQm90cJc7LEjO8kcZmnjxDgkGgTMGHNRPTkbbtuxuXw"; e_proxy="AcOYCP4LFMey9yHu5bM-5HGCUp84DVnbSknuwTTcJmcHhd_f2bptVJz6HPSD00maV32vcNTql5pWwb5jiU1s", http_request_error; e_fb_vipaddr="AcPyYbL9wUe6Y-lqmpRw3P5AlS0kloaME3nMp3ajE4KAjP6pjnGddjzr14rv_rjO5zrLyJiBPvq777MUVS7tYPTtSW65Uqf2"; e_clientaddr="AcOcKG2wjPvM25yDXrDu970VS-HAJjgMvdu1uj0SXBFmjJ4aHFq__LuRGNoULozJ3ca5ALQfwFGejzOuYyLtWX69vCG4UN2iuM8IHwf56uw3xu87LWPPXA"; e_upip="AcMVnlAqghLBgcz88FQ4xQSVTBqez9m-jRhTnyA-m_RDx6KVG_jdHxGGdZ5_uhWkTG_qWmfbFfndATu99roak7eXmjOYIDZG"; e_fb_zone="AcMuvhPQcQ2MkEXatG8jAis-dFX_BtosLlF6x9DMKwgATlcy5sTumTrBGYwO0Q"; e_fb_twtaskhandle="AcN_axAmOknRLQzkZNYU0bFXeDZ1rFNojBQ-Pmaq6hL8DhxpuqmLCDj1n9R4SNA9HxH7y8TMSYFZDYIBC721UZtAbuvv4-ACpnLV"; e_proxy="AcNL5GXTeAABwgn4inFF9AkET5CAcBNVNV7xrXsw6dyiR4x5qtTSCe0hmucmKk66bYZIN3gmMRr5hyo"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=34, rtx=0, c=10, mss=1380, tbw=2557, tp=-1, tpl=-1, uplat=450, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '190'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '620',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 620\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
2025-06-10T13:26:08.572Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:26:08.575Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:26:09.042Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwOUI1MTAzNUVENjU1NTk0NTQA'
    }
  ]
}
2025-06-10T13:26:11.193Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:26:11.524Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:26:11.554Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:26:11.558Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:26:13.162Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUYwNTJEMjlBMzE1NDVFRkI1RgA=',
  timestamp: '1749561972'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUYwNTJEMjlBMzE1NDVFRkI1RgA=",
  "timestamp": "1749561972",
  "text": {
    "body": "admin"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "admin"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "dashboard",
            "title": "📊 Admin Dashboard"
          }
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Invalid buttons count. Min allowed buttons: 1, Max allowed buttons: 3'
    },
    fbtrace_id: 'A1LdIWoUgTD6P0FX0AwjeT0'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async AdminFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:178:9)
    at async AdminFlow.handleMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:132:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:124:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:117:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '620',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '620',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 59940,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 676,
        [Symbol(triggerId)]: 674
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 620\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 620,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'A1LdIWoUgTD6P0FX0AwjeT0',
      'x-fb-trace-id': 'ESXPciQRILc',
      'x-fb-rev': '1023675050',
      'x-fb-debug': '0Ozgbs0T3EbfXKLx2o/byJaGZhhBffu+j3i/7Fegr4CGsljbqfBcir/2Vf7Tyzfw9n/I1ZH+wuy+/LbZQxhuUw==',
      date: 'Tue, 10 Jun 2025 13:26:14 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcMPFz7ffjZXE36DmvagJzAORttxhikj9f7vabY5faRMD5qrHO3-ZYApA_3Z7R2MiKQl_gyGgwRLYh_QJhvPuL7_m6sLg8Gl"; e_clientaddr="AcNX3d3qYXnXeBcWgbjrj9z4k44Fwu-GCzypMjypweeB-XmFd9V6fyWFMWiaQKvVTZOt2O7-t1Pk1AHogHayF2_izM7UsLwWBJTZ9k6VPaDxloPiow"; e_upip="AcPqvMrDEujJsEtQx9N8prD1A0U__dHFm-xN3llRCqUhPFenW0QE-7KBOQh6QvrFhbLxi4mcbQ02fk-gvgNvsX0VyK3oR9lbOdYaUw"; e_fb_zone="AcNFf41khQxEwrU_j_-DeNokx_LgyG3Zkl38u1-knsTSgYmSoFFbvDHh8SkMuf6j"; e_fb_twtaskhandle="AcOcgylygwAIdMSwaFKvtr3_eBOhV1h4Vv_gyoQrlZuqRerBV5sTHtLeIiKNNZY4qCww8TkKm0I46TgwjDdGR3DaDINNmHlPVDNx9UM-0uB_cA"; e_proxy="AcO4x45Iu_DnmIYO48S_vgq7d-lap-n1e0Je-A6MfjeSi-U36EIr4JYluvuX2qG_e4UgFhsUucS0Qj1Eq50x", http_request_error; e_fb_vipaddr="AcMyTDu7lvkGEFOXZrIYAMsfeAgN4I3ncE2XMNLzKTu8uHa_e2B1wIhHwRUkw5QiQb86x_tGBCZ5vk6dlHVYdbxx3SB5Y7R_"; e_clientaddr="AcOJeK2XNq0IwdvFbubiCkac2RnlS27A1r3lf1jH2N6JwUW7FI2i235AUhJ5y9LPJ09uuOG5XsbaD461avkL8e34o6sjgQhh5u9ztftGxCU8UJ2U6VlHDg"; e_upip="AcNog4Z8FHfQssf0qooNUXLVK_0kU9b0Ng--IDgfgnMKTjlpd-f6eDGuugPUfgWHVu5QdxeGD3_IySPSdok7DlBz8dVxOBZd"; e_fb_zone="AcPDh5HUvsTyUdSLFdupBvxgZCtpVlJBIMK7E_iS1WNnPiUqAQIuaK8ymcuAww"; e_fb_twtaskhandle="AcPXp7xUJnpdHg_W7zianqNjnTygWMnoQd7eMgkRgyjLvUWQXX6FzQVw3kQeZkqYHBQx6XtrCkagVeNYce6IwgyXHIVpMoxpSVeI"; e_proxy="AcPBSZJPzyUdq7VUfBg2Gtw84nQnd3XP89GjLRiTZ5eQkHz-0zEJk_8JdaT88PWSvXx60lE2zZ27ubQ"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=36, rtx=0, c=10, mss=1380, tbw=7480, tp=-1, tpl=-1, uplat=489, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '192'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"🔧 *Admin Control Panel*\\n\\nWelcome to the admin interface! Here you can test both customer and employee flows.\\n\\nSelect what you'd like to do:"},"action":{"buttons":[{"type":"reply","reply":{"id":"test_customer","title":"👥 Test Customer Flow"}},{"type":"reply","reply":{"id":"test_employee","title":"👷‍♂️ Test Employee Flow"}},{"type":"reply","reply":{"id":"track_invoices","title":"📋 Track Invoices"}},{"type":"reply","reply":{"id":"dashboard","title":"📊 Admin Dashboard"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '620',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 620\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2NTZBQjQ5OEUyQTg1MzYxM0MA'
    }
  ]
}
2025-06-10T13:26:17.108Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:26:17.638Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:26:17.764Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:26:17.807Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 596092260264515
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T13:29:45.613Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY2NzcwNjFBRTAyRUEzMDYwNwA=',
  timestamp: '1749562184'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY2NzcwNjFBRTAyRUEzMDYwNwA=",
  "timestamp": "1749562184",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQzU3MUU1OUFCQkE1REU2MjEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T13:29:49.080Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:29:49.351Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:29:49.481Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:29:49.561Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFNDUyNDA2RDU2ODREREMwNjUA'
    }
  ]
}
2025-06-10T13:29:50.539Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:29:51.051Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:29:51.306Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:29:51.422Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:29:56.773Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThDQkY5NjBENjQ1NjczNkU5OAA=',
  timestamp: '1749562195'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQzU3MUU1OUFCQkE1REU2MjEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThDQkY5NjBENjQ1NjczNkU5OAA=",
  "timestamp": "1749562195",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "test_employee",
      "title": "👷‍♂️ Test Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "test_employee"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧪 *Testing Employee Flow*\n\nYou are now in employee flow test mode. All employee features are available:\n• Activity logging with photo upload\n• Material requests\n• Dashboard viewing\n• Gujarati language support\n\n⚠️ *Note:* \n1. Employee flow requires site selection first\n2. Employee flow includes OTP verification (auto-verified for admin)\n\nType *exit* anytime to return to admin menu.\n\n---"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NDAwQjk4OTREMUU0QzRDQkQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:29:59.672Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🧪 [ADMIN-TEST] Employee flow session update intercepted: { step: 'select_site', data: { site_selection_shown: true } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T13:30:00.003Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:00.050Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:00.054Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDNkQ0MjkxNDk3REQ1Q0M1NDUA'
    }
  ]
}
2025-06-10T13:30:01.395Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:01.717Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:01.775Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:01.787Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:08.013Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU0MUI4NDY5N0YwMTk0NDdCNwA=',
  timestamp: '1749562207'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDNkQ0MjkxNDk3REQ1Q0M1NDUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU0MUI4NDY5N0YwMTk0NDdCNwA=",
  "timestamp": "1749562207",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: null, site_selection_shown: true },
  updated_at: 2025-06-10T13:30:09.033Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: null,
  data: { selected_site: 'site_1', site_selection_shown: true }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyRTE1OTY2N0IwMzcxRjgxMjIA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-10T13:30:10.675Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2NjhFRDBCRTUwREY0NTg2NkUA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: 'site_1', site_selection_shown: true },
  updated_at: 2025-06-10T13:30:09.033Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:30:11.117Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:11.139Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:11.363Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:11.702Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T13:30:12.056Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:12.090Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:12.163Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0NDFFNjExRDcwRkZBOTdGMEUA'
    }
  ]
}
2025-06-10T13:30:13.440Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:13.736Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:13.862Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:13.987Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:24.104Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI1NzAwRkFCRjBBMzg4MUQ1MAA=',
  timestamp: '1749562222'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2NjhFRDBCRTUwREY0NTg2NkUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI1NzAwRkFCRjBBMzg4MUQ1MAA=",
  "timestamp": "1749562222",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "track_invoices",
      "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "track_invoices"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: 'site_1', site_selection_shown: true },
  updated_at: 2025-06-10T13:30:25.279Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: { intent: 'track_invoices', step: 'enter_company_name', data: {} }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧾 *ઇન્વૉઇસ ટ્રેકિંગ*\n\nકયા કંપનીનું ઇન્વૉઇસ છે? કંપનીનું નામ લખો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2RTIzOEIxN0Q2RkRDQTE4MDkA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'enter_company_name',
  data: { selected_site: 'site_1', site_selection_shown: true },
  updated_at: 2025-06-10T13:30:25.279Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:30:27.092Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:27.418Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:27.462Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:27.519Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:50.302Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY5NUQ0NkQ1MDlDQjlDMjk0MwA=',
  timestamp: '1749562249'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY5NUQ0NkQ1MDlDQjlDMjk0MwA=",
  "timestamp": "1749562249",
  "text": {
    "body": "Vinayak TMT bars"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Vinayak TMT bars"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'enter_company_name',
  data: { selected_site: 'site_1', site_selection_shown: true },
  updated_at: 2025-06-10T13:30:51.258Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'enter_invoice_description',
  data: {
    selected_site: 'site_1',
    site_selection_shown: true,
    company_name: 'Vinayak TMT bars'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📝 આ ઇન્વૉઇસ શેના માટે છે? (જેમ કે: સામગ્રી ખરીદી, સેવા, વિદ્યુત બિલ, વગેરે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGNjcyNDA5QkMyMUQ4NDQ2OUMA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'enter_invoice_description',
  data: {
    selected_site: 'site_1',
    site_selection_shown: true,
    company_name: 'Vinayak TMT bars'
  },
  updated_at: 2025-06-10T13:30:51.258Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:30:52.979Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:53.345Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:53.352Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:30:53.465Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:02.670Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUYzMTFDMEY2RjdDNTYxNDYwQwA=',
  timestamp: '1749562261'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUYzMTFDMEY2RjdDNTYxNDYwQwA=",
  "timestamp": "1749562261",
  "text": {
    "body": "Electricity"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Electricity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'enter_invoice_description',
  data: {
    company_name: 'Vinayak TMT bars',
    selected_site: 'site_1',
    site_selection_shown: true
  },
  updated_at: 2025-06-10T13:31:03.616Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'enter_invoice_date',
  data: {
    company_name: 'Vinayak TMT bars',
    selected_site: 'site_1',
    site_selection_shown: true,
    invoice_description: 'Electricity'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📅 ઇન્વૉઇસની તારીખ કઈ છે? (DD/MM/YYYY ફોર્મેટમાં લખો, જેમ કે: 15/12/2024):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4MzczMkU4MTUzQTVEQzc2MEYA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'enter_invoice_date',
  data: {
    company_name: 'Vinayak TMT bars',
    selected_site: 'site_1',
    site_selection_shown: true,
    invoice_description: 'Electricity'
  },
  updated_at: 2025-06-10T13:31:03.616Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:31:05.346Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:05.624Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:05.694Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:05.892Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:21.723Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUE4QUNDRTk1NzY4Q0I2MDExQgA=',
  timestamp: '1749562280'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUE4QUNDRTk1NzY4Q0I2MDExQgA=",
  "timestamp": "1749562280",
  "text": {
    "body": "10/06/2025"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "10/06/2025"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'enter_invoice_date',
  data: {
    company_name: 'Vinayak TMT bars',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true
  },
  updated_at: 2025-06-10T13:31:22.694Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'enter_amount',
  data: {
    company_name: 'Vinayak TMT bars',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true,
    invoice_date: 2025-06-10T05:00:00.000Z
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "💰 ઇન્વૉઇસની રકમ કેટલી છે? (માત્ર નંબર લખો, જેમ કે: 5000):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NkNENDBCQjM3NDVGMTM5MzgA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'enter_amount',
  data: {
    company_name: 'Vinayak TMT bars',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true,
    invoice_date: 2025-06-10T05:00:00.000Z
  },
  updated_at: 2025-06-10T13:31:22.694Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:31:24.295Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:24.931Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:25.052Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:25.164Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:32.708Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVBREFENDc1NjczODRFRTNBMwA=',
  timestamp: '1749562291'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVBREFENDc1NjczODRFRTNBMwA=",
  "timestamp": "1749562291",
  "text": {
    "body": "5000"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "5000"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'enter_amount',
  data: {
    company_name: 'Vinayak TMT bars',
    invoice_date: '2025-06-10T05:00:00.000Z',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true
  },
  updated_at: 2025-06-10T13:31:33.726Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'select_site',
  data: {
    company_name: 'Vinayak TMT bars',
    invoice_date: '2025-06-10T05:00:00.000Z',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true,
    amount: 500000
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🏗️ આ ઇન્વૉઇસ કઈ સાઈટ માટે છે?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzNTNDQTU0MTZFOUE0MTczMjMA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyQTY3QTE4QTM3Qzg4ODAzOTUA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'select_site',
  data: {
    company_name: 'Vinayak TMT bars',
    invoice_date: '2025-06-10T05:00:00.000Z',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true,
    amount: 500000
  },
  updated_at: 2025-06-10T13:31:33.726Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:31:35.459Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:35.870Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:36.007Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:36.055Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:36.303Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:36.529Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:36.633Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:36.778Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:40.641Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJENEUyMThGOEQxRUE0ODYwRAA=',
  timestamp: '1749562299'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyQTY3QTE4QTM3Qzg4ODAzOTUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJENEUyMThGOEQxRUE0ODYwRAA=",
  "timestamp": "1749562299",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'select_site',
  data: {
    amount: 500000,
    company_name: 'Vinayak TMT bars',
    invoice_date: '2025-06-10T05:00:00.000Z',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true
  },
  updated_at: 2025-06-10T13:31:41.556Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'upload_invoice_image',
  data: {
    amount: 500000,
    company_name: 'Vinayak TMT bars',
    invoice_date: '2025-06-10T05:00:00.000Z',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true,
    site_id: 'site_1'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📸 *હવે ઇન્વૉઇસનો ફોટો અપલોડ કરો:*\n\n• સ્પષ્ટ અને વાંચી શકાય તેવો ફોટો\n• ઇન્વૉઇસના બધા ભાગો દેખાતા હોવા જોઈએ\n• ફોટો અપલોડ કરો અથવા 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwN0VENTk5MUE1QkZGNUQxMzAA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'upload_invoice_image',
  data: {
    amount: 500000,
    company_name: 'Vinayak TMT bars',
    invoice_date: '2025-06-10T05:00:00.000Z',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true,
    site_id: 'site_1'
  },
  updated_at: 2025-06-10T13:31:41.556Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:31:43.118Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:43.698Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:43.706Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:44.978Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:31:48.968Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:32:12.324Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'image',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI5N0NDRDBDMzcyOURFMkY5MgA=',
  timestamp: '1749562329'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI5N0NDRDBDMzcyOURFMkY5MgA=",
  "timestamp": "1749562329",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "+6yY+uL08UCbipMDdgi5OSF5PFNhGjJ1akWrrRTpVDs=",
    "id": "705227742108928"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'upload_invoice_image',
  data: {
    amount: 500000,
    site_id: 'site_1',
    company_name: 'Vinayak TMT bars',
    invoice_date: '2025-06-10T05:00:00.000Z',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true
  },
  updated_at: 2025-06-10T13:32:13.328Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "કૃપા કરીને ઇન્વૉઇસનો ફોટો અપલોડ કરો અથવા 'skip' ટાઈપ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MEIyNDlEQkU5OEM2M0ZENjgA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'upload_invoice_image',
  data: {
    amount: 500000,
    site_id: 'site_1',
    company_name: 'Vinayak TMT bars',
    invoice_date: '2025-06-10T05:00:00.000Z',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true
  },
  updated_at: 2025-06-10T13:32:13.328Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:32:14.980Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:32:15.397Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:32:15.445Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:32:15.648Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:32:30.390Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'image',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUZFODVCOUZDQzIyRUMxNThFQgA=',
  timestamp: '1749562348'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUZFODVCOUZDQzIyRUMxNThFQgA=",
  "timestamp": "1749562348",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "8B5fm7izr9FdTihlg3xZQPziXnaeA7GHUwK2hjgNEy8=",
    "id": "1522059705426067"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'upload_invoice_image',
  data: {
    amount: 500000,
    site_id: 'site_1',
    company_name: 'Vinayak TMT bars',
    invoice_date: '2025-06-10T05:00:00.000Z',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true
  },
  updated_at: 2025-06-10T13:32:31.657Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "કૃપા કરીને ઇન્વૉઇસનો ફોટો અપલોડ કરો અથવા 'skip' ટાઈપ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMzFBNzVCQzY1NzNDNTY2NUQA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'upload_invoice_image',
  data: {
    amount: 500000,
    site_id: 'site_1',
    company_name: 'Vinayak TMT bars',
    invoice_date: '2025-06-10T05:00:00.000Z',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true
  },
  updated_at: 2025-06-10T13:32:31.657Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:32:33.703Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:32:33.913Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:32:33.961Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:32:34.077Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:32:39.491Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTBDMEMxODIzQ0I0NjU5OTI2NQA=',
  timestamp: '1749562358'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTBDMEMxODIzQ0I0NjU5OTI2NQA=",
  "timestamp": "1749562358",
  "text": {
    "body": "skip"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "skip"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'track_invoices',
  step: 'upload_invoice_image',
  data: {
    amount: 500000,
    site_id: 'site_1',
    company_name: 'Vinayak TMT bars',
    invoice_date: '2025-06-10T05:00:00.000Z',
    selected_site: 'site_1',
    invoice_description: 'Electricity',
    site_selection_shown: true
  },
  updated_at: 2025-06-10T13:32:40.379Z
}
Error tracking invoice: TypeError: value.toISOString is not a function
    at PgTimestamp.mapToDriverValue (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/pg-core/columns/timestamp.cjs:60:60)
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/sql/sql.cjs:157:73
    at Array.map (<anonymous>)
    at SQL.buildQueryFromSourceParams (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/sql/sql.cjs:110:32)
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/sql/sql.cjs:129:21
    at Array.map (<anonymous>)
    at SQL.buildQueryFromSourceParams (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/sql/sql.cjs:110:32)
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/sql/sql.cjs:132:21
    at Array.map (<anonymous>)
    at SQL.buildQueryFromSourceParams (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/sql/sql.cjs:110:32)
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "માફ કરશો, તમારો ઇન્વૉઇસ નોંધવામાં ભૂલ થઈ. કૃપા કરીને ફરીથી પ્રયાસ કરો."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzNDVEMTQ1OTMwNjA1RUQzNTYA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow session clear intercepted
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T13:32:41.262Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:32:42.113Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:32:42.481Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:32:42.487Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:32:42.527Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:37:23.452Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNThCRTkzNDEwQ0FEQUFFMjQyNjNBRkRBOTUzMkY4NTAA',
  timestamp: '1749562642'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNThCRTkzNDEwQ0FEQUFFMjQyNjNBRkRBOTUzMkY4NTAA",
  "timestamp": "1749562642",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
🆕 [HANDLER] Creating new session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🔐 Your verification code is: 185429\n\nThis code will expire in 10 minutes. Please enter this code to verify your employee account."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMDI1RDgxQ0U1QkIzREI1QjFFAA=='
    }
  ]
}
📲 OTP sent to +919723132143
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "👋 કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!\n\n🔐 સુરક્ષા માટે, કૃપા કરીને તમારું એકાઉન્ટ વેરિફાઈ કરો. મેં તમને 6-અંકનો વેરિફિકેશન કોડ મોકલ્યો છે.\n\nઆગળ વધવા માટે કૃપા કરીને કોડ દાખલ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMEZGOUExNkUyQTIxOTU4N0U4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:37:27.715Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:37:27.840Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:37:28.134Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:37:28.398Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:37:31.187Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:37:31.365Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:37:53.493Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNkNDNTQ2ODY0OUY2NjhCRDNDQTAxQ0VGOTQxOTg5MTYA',
  timestamp: '1749562672'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNkNDNTQ2ODY0OUY2NjhCRDNDQTAxQ0VGOTQxOTg5MTYA",
  "timestamp": "1749562672",
  "text": {
    "body": "185429"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "185429"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "Successfully verified! Welcome to the employee portal."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQzc3RTZGRjU3NDVBMEU1RTRFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:37:56.303Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:37:56.573Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjNCRjFGOUFFRkI1MEI3MzIxAA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-10T13:37:58.107Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTQ2MjcyNkVEMjAyRjMyM0RGAA=='
    }
  ]
}
2025-06-10T13:37:59.293Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzc1MzY0RDI5RkMwRDY5MkZEAA=='
    }
  ]
}
2025-06-10T13:38:00.449Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:38:00.714Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:38:01.043Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:38:01.076Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:38:05.042Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:38:05.158Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:38:05.194Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:38:05.296Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:38:41.381Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOURCNzU4NzNBREYyQ0U4MkY3RTgyQ0FDRjdCMkNDMjEA',
  timestamp: '1749562720'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTQ2MjcyNkVEMjAyRjMyM0RGAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOURCNzU4NzNBREYyQ0U4MkY3RTgyQ0FDRjdCMkNDMjEA",
  "timestamp": "1749562720",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSODhDNDg5Q0M2M0M1RUU5NUZDAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:38:44.394Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:38:44.719Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:38:55.809Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDlDRDFCMzJCRTY1RDUwNjU4QTFFRDg2ODE3ODc5MkMA',
  timestamp: '1749562734'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSODhDNDg5Q0M2M0M1RUU5NUZDAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDlDRDFCMzJCRTY1RDUwNjU4QTFFRDg2ODE3ODc5MkMA",
  "timestamp": "1749562734",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_2",
      "title": "🏢 સાઈટ B - વાણિજ્યિક",
      "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_2"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ B - વાણિજ્યિક માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOENDQ0QzNjRBOEE2RUQyODQ5AA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ B - વાણિજ્યિક\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-10T13:38:58.481Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTYxRUQ0NzQwRUM5NjY4QzkyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:38:58.553Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:38:59.189Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T13:38:59.496Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMDU3QkY3RTQwNDg5MjRDRUVDAA=='
    }
  ]
}
2025-06-10T13:39:00.940Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:39:01.452Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:39:05.627Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQjg2N0UzNzJGNTU1M0ZGRjM5MEQ4QjAzMDAxMjU2OTcA',
  timestamp: '1749562744'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTYxRUQ0NzQwRUM5NjY4QzkyAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQjg2N0UzNzJGNTU1M0ZGRjM5MEQ4QjAzMDAxMjU2OTcA",
  "timestamp": "1749562744",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQ0YyNzFBMDEzNzA4NUIzNzYzAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:39:08.216Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:39:08.452Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:39:11.757Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:39:31.079Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDc2RDNFNDU1Qjc0RDAzMjFCOTc2RjBBMTBGRkQzRDUA',
  timestamp: '1749562770'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQ0YyNzFBMDEzNzA4NUIzNzYzAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDc2RDNFNDU1Qjc0RDAzMjFCOTc2RjBBMTBGRkQzRDUA",
  "timestamp": "1749562770",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "other",
      "title": "📝 અન્ય",
      "description": "અન્ય કામની પ્રવૃત્તિઓ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "other"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSN0MzRjYzRkE0QjRCMDA1MzUxAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:39:33.595Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:39:33.838Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:40:34.471Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQzE2OEYyRUUwMzlGNzBCOTlERTBEODBEN0JCMjA1OTEA',
  timestamp: '1749562833'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQzE2OEYyRUUwMzlGNzBCOTlERTBEODBEN0JCMjA1OTEA",
  "timestamp": "1749562833",
  "text": {
    "body": "4.5"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "4.5"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMjIxREIzRjIxNEQ0RkYzMjc0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:40:37.337Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:40:37.833Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:42:00.556Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDg5MTIzOTcyQ0M3OENEMDI4RDVFRjYyQTJFMjhGMjEA',
  timestamp: '1749562919'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDg5MTIzOTcyQ0M3OENEMDI4RDVFRjYyQTJFMjhGMjEA",
  "timestamp": "1749562919",
  "text": {
    "body": "Electric wirining"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Electric wirining"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSODkzRTYzQTg4RDJDNjkxNkVEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:42:03.575Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:42:04.033Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:42:31.901Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOEREQjhBODY5QjI3QzA3MUMyOUMxRUIyOTA3NUI3Q0YA',
  timestamp: '1749562949'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOEREQjhBODY5QjI3QzA3MUMyOUMxRUIyOTA3NUI3Q0YA",
  "timestamp": "1749562949",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "A2sPEpGvnRpdYIfDROntItTrFIvdSAOFL1Gf+Uaemp4=",
    "id": "23865834956388925"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 રસિદ અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRTczNjAyRDIwM0M3MkE2QUNCAA=='
    }
  ]
}
2025-06-10T13:42:34.419Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:42:35.212Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/3b14b97d-a2e4-4b93-a17d-0243fd412dcb.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/3b14b97d-a2e4-4b93-a17d-0243fd412dcb.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMzgzMkIzRjc3ODg0NkUyRDQ3AA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: સાઈટ B - વાણિજ્યિક\n• પ્રવૃત્તિ: 📝 અન્ય\n• કલાકો: 4\n• વર્ણન: Electric wirining\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* a79964ca\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
2025-06-10T13:42:38.864Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQzc1MTkyOTNCMUUxNjU4RUU2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:42:38.988Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:42:39.672Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:42:39.959Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:43:12.749Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggN0ZDMzE2RDNDRDk3RkE4RDg5NkY2NEM1RTVGOTI4REQA',
  timestamp: '1749562991'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggN0ZDMzE2RDNDRDk3RkE4RDg5NkY2NEM1RTVGOTI4REQA",
  "timestamp": "1749562991",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRTRBMzQzMzI4OUZDMkY1MUE1AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:43:15.776Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:43:16.155Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:43:24.518Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggM0UyRjAxQTExNjJCMEQ2MTZBNEQ5REZCMzRDQjMwQkEA',
  timestamp: '1749563003'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRTRBMzQzMzI4OUZDMkY1MUE1AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggM0UyRjAxQTExNjJCMEQ2MTZBNEQ5REZCMzRDQjMwQkEA",
  "timestamp": "1749563003",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_2",
      "title": "🏢 સાઈટ B - વાણિજ્યિક",
      "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_2"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ B - વાણિજ્યિક માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRTYwMDc3NDE5QTkxRTQ1MjcxAA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ B - વાણિજ્યિક\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-10T13:43:27.193Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRUIxNEE3REU4MkY0NjJBM0UzAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:43:27.470Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:43:28.215Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T13:43:28.342Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMEU2MTE2RUI4ODBGNDk0RjFGAA=='
    }
  ]
}
2025-06-10T13:43:29.516Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:43:30.152Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:46:57.221Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRkExNjM2ODVDRjcyM0NBQkE2MTQ2MDRGMThFNEU5N0EA',
  timestamp: '1749563215'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRUIxNEE3REU4MkY0NjJBM0UzAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRkExNjM2ODVDRjcyM0NBQkE2MTQ2MDRGMThFNEU5N0EA",
  "timestamp": "1749563215",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzVCMkUzQUYzRERFNjk1NzEyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:47:00.738Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:47:00.750Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:47:08.352Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNkQyMTFEQTMxQzAwOTUyMEIzRkJFMTJBQ0RFNzJDRDMA',
  timestamp: '1749563227'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzVCMkUzQUYzRERFNjk1NzEyAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNkQyMTFEQTMxQzAwOTUyMEIzRkJFMTJBQ0RFNzJDRDMA",
  "timestamp": "1749563227",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMjg4RUU3QjY2RUU2NzAzNzgzAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:47:11.011Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:47:11.266Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:47:29.488Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggODE5MTBCNzgxMzBERjEwMDY1Mzc1QzJGMzREMDY0RjMA',
  timestamp: '1749563248'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggODE5MTBCNzgxMzBERjEwMDY1Mzc1QzJGMzREMDY0RjMA",
  "timestamp": "1749563248",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQjI2ODVDM0E4Qzg2MDMwMzQzAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:47:31.934Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:47:32.220Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:48:01.219Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQ0NENzNEODZDMzE3QzI5M0VGOTg1NDk4RTRFMkZFNjEA',
  timestamp: '1749563280'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQ0NENzNEODZDMzE3QzI5M0VGOTg1NDk4RTRFMkZFNjEA",
  "timestamp": "1749563280",
  "text": {
    "body": "Steel"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Steel"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMDJERDM1NTZGQ0NBNjUwM0Y3AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:48:04.012Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:48:04.264Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:48:40.495Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTM1QUI0OUI4NTdCNzZBQjAxQjRGOTBBRTUwOTUwOUUA',
  timestamp: '1749563318'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTM1QUI0OUI4NTdCNzZBQjAxQjRGOTBBRTUwOTUwOUUA",
  "timestamp": "1749563318",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "c+4nbcu68eXt1/KfuSFyY9VIL2t+Hd9B7lAH5CaxK9g=",
    "id": "1010922267852609"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 રસિદ અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMEQ3QTkwNTEwRUI3QUMzRkE2AA=='
    }
  ]
}
2025-06-10T13:48:43.274Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:48:43.661Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/713b3608-6444-40e0-bac7-8798e7c486d8.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/713b3608-6444-40e0-bac7-8798e7c486d8.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMjkxQ0VEOUMwQ0YzNjYxM0I0AA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: સાઈટ B - વાણિજ્યિક\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Steel\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* ce259b17\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
2025-06-10T13:48:47.982Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRkQxNTZEREQ3ODUwQkRCQ0ZCAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T13:48:48.524Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:48:49.069Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T13:48:49.452Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:10:50.393Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY3QTZCM0UwMzM3QjE5QTI0QwA=',
  timestamp: '1749564648'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY3QTZCM0UwMzM3QjE5QTI0QwA=",
  "timestamp": "1749564648",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: { site_selection_shown: false, selected_site: null },
  updated_at: 2025-06-10T14:10:52.071Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: { step: 'select_site', data: { site_selection_shown: true } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCMzdFNkI2MzE3QTk4OEQ0MzkA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { site_selection_shown: true, selected_site: null },
  updated_at: 2025-06-10T14:10:52.071Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T14:10:54.249Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:10:54.408Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:10:54.456Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:01.290Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQzNzFEQTUzMkU5MzMwMTlEMQA=',
  timestamp: '1749564660'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCMzdFNkI2MzE3QTk4OEQ0MzkA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQzNzFEQTUzMkU5MzMwMTlEMQA=",
  "timestamp": "1749564660",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_2",
      "title": "🏢 સાઈટ B - વાણિજ્યિક",
      "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_2"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: null, site_selection_shown: true },
  updated_at: 2025-06-10T14:11:02.417Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: null,
  data: { selected_site: 'site_2', site_selection_shown: true }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCQUVFOEJGMDAwQUI3MDNCMTcA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5MjM3QTBBRTBENTVDOEQ4RUYA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: 'site_2', site_selection_shown: true },
  updated_at: 2025-06-10T14:11:02.417Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T14:11:04.252Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:04.939Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:04.940Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:04.942Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T14:11:05.306Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:05.386Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyMDQzOTdCOTM0QzQ5MDc3MUUA'
    }
  ]
}
2025-06-10T14:11:06.862Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:07.233Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:07.294Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:07.541Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTgzMkQxMzIzQTcwMTM5QjREOQA=',
  timestamp: '1749564666'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5MjM3QTBBRTBENTVDOEQ4RUYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTgzMkQxMzIzQTcwMTM5QjREOQA=",
  "timestamp": "1749564666",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: 'site_2', site_selection_shown: true },
  updated_at: 2025-06-10T14:11:08.495Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  intent: 'log_activity',
  step: 'select_activity_type',
  data: {
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    employee_intent: null,
    site_id: undefined
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4RTUzQjM2RDVGODNCOUQyNTEA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'select_activity_type',
  data: {
    selected_site: 'site_2',
    site_selection_shown: true,
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    employee_intent: null,
    site_id: undefined
  },
  updated_at: 2025-06-10T14:11:08.546Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T14:11:11.020Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:11.070Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:11.105Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:17.924Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTkzNkY3ODYzNDhFNzlCMjM4QQA=',
  timestamp: '1749564676'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "918487051252",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4RTUzQjM2RDVGODNCOUQyNTEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTkzNkY3ODYzNDhFNzlCMjM4QQA=",
  "timestamp": "1749564676",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'select_activity_type',
  data: {
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-10T14:11:18.850Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'enter_hours',
  data: {
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true,
    activity_type: 'inspection'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3QUZERTUxMTIyNzMyRDZCQzgA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'enter_hours',
  data: {
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true,
    activity_type: 'inspection'
  },
  updated_at: 2025-06-10T14:11:18.850Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T14:11:20.598Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:21.202Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:21.203Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:25.630Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVGRDJEQjczQ0VDQjM3QTVENQA=',
  timestamp: '1749564684'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVGRDJEQjczQ0VDQjM3QTVENQA=",
  "timestamp": "1749564684",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'enter_hours',
  data: {
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-10T14:11:26.741Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'enter_description',
  data: {
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true,
    hours: 1
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1RDI2NzAxODAzRUI4NkRBREYA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'enter_description',
  data: {
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true,
    hours: 1
  },
  updated_at: 2025-06-10T14:11:26.741Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T14:11:28.341Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:28.958Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:29.014Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:37.310Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTAxNjQyQ0RGQTA1NkU1QTEyMQA=',
  timestamp: '1749564696'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTAxNjQyQ0RGQTA1NkU1QTEyMQA=",
  "timestamp": "1749564696",
  "text": {
    "body": "Steel photos"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Steel photos"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'enter_description',
  data: {
    hours: 1,
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-10T14:11:38.601Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'upload_image',
  data: {
    hours: 1,
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true,
    description: 'Steel photos'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5RThCOTBFRjk2MTQ4Rjg1NEYA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true,
    description: 'Steel photos'
  },
  updated_at: 2025-06-10T14:11:38.601Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T14:11:40.461Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:40.862Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:40.934Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:53.408Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'image',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ3OEQ2M0IzMkM2MEE1ODRGNgA=',
  timestamp: '1749564711'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ3OEQ2M0IzMkM2MEE1ODRGNgA=",
  "timestamp": "1749564711",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "qxL2UnQ7nu2DEbNSCGmUHwm4z9uupCAeVdT/cHEzVUo=",
    "id": "738802931819260"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    description: 'Steel photos',
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-10T14:11:54.379Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "કૃપા કરીને ફોટો અપલોડ કરો અથવા 'skip' ટાઈપ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEMThGRkU1OTFBQjEzODJGQjMA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    description: 'Steel photos',
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-10T14:11:54.379Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T14:11:55.977Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:57.171Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:11:57.175Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:12:09.039Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'image',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTA1QkU5MkM0MjlFNjZBNzZCOQA=',
  timestamp: '1749564726'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTA1QkU5MkM0MjlFNjZBNzZCOQA=",
  "timestamp": "1749564726",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "3NeIypmNd6vX9wWcwwElTeZXTpJWgw4fybGAoGP/U78=",
    "id": "2138706809875189"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    description: 'Steel photos',
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-10T14:12:10.171Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "કૃપા કરીને ફોટો અપલોડ કરો અથવા 'skip' ટાઈપ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2NDJBNTM3ODk5QzYzNjcwMUIA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    description: 'Steel photos',
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-10T14:12:10.171Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T14:12:11.658Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:12:12.461Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:12:12.535Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:12:18.866Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURFNUJGNUJEMzhBMUM2RkREMQA=',
  timestamp: '1749564737'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURFNUJGNUJEMzhBMUM2RkREMQA=",
  "timestamp": "1749564737",
  "text": {
    "body": "skip"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "skip"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    description: 'Steel photos',
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-10T14:12:19.789Z
}
Error logging activity: error: insert or update on table "activities" violates foreign key constraint "activities_site_id_sites_id_fk"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlowWrapper.completeActivityLog (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:369:30)
    at async EmployeeFlowWrapper.handleActivityLogging (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:335:17)
    at async EmployeeFlowWrapper.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:253:13)
    at async EmployeeFlowWrapper.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:32:13)
    at async AdminFlow.handleTestFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:390:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:118:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:117:17) {
  length: 311,
  severity: 'ERROR',
  code: '23503',
  detail: 'Key (site_id)=(00000000-0000-0000-0000-000000000000) is not present in table "sites".',
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: 'public',
  table: 'activities',
  column: undefined,
  dataType: undefined,
  constraint: 'activities_site_id_sites_id_fk',
  file: 'ri_triggers.c',
  line: '2596',
  routine: 'ri_ReportViolation'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "માફ કરશો, તમારી પ્રવૃત્તિ નોંધવામાં ભૂલ થઈ. કૃપા કરીને ફરીથી પ્રયાસ કરો."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEOEIzNkY4NUMxQ0MzNzhBMUUA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow session clear intercepted
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T14:12:20.714Z
}
✅ [DB] New client connected
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T14:12:21.605Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:12:22.701Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:12:22.707Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:23:24.802Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919909015708: {
  type: 'unsupported',
  id: 'wamid.HBgMOTE5OTA5MDE1NzA4FQIAEhgSQzU3NDk4RUY1MzUxQkZERDMzAA==',
  timestamp: '1749565402'
}
[WEBHOOK] Message content: {
  "from": "919909015708",
  "id": "wamid.HBgMOTE5OTA5MDE1NzA4FQIAEhgSQzU3NDk4RUY1MzUxQkZERDMzAA==",
  "timestamp": "1749565402",
  "errors": [
    {
      "code": 131051,
      "title": "Message type unknown",
      "message": "Message type unknown",
      "error_data": {
        "details": "Message type is currently not supported."
      }
    }
  ],
  "type": "unsupported"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919909015708
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
Error marking message as read: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.markAsRead (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:202:13)
    at async withTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:22:24)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:58:13)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '126',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: '{"messaging_product":"whatsapp","status":"read","message_id":"wamid.HBgMOTE5OTA5MDE1NzA4FQIAEhgSQzU3NDk4RUY1MzUxQkZERDMzAA=="}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '126',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 3239541,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 6856,
        [Symbol(triggerId)]: 6854
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 126\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: false,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 126,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': 'd83ab97ca0ceb208dd48e18aad7e5c14',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#100) Invalid parameter"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AAFTETgLc7CozLZPRHinflg',
      'x-fb-trace-id': 'BpT/QXC82xh',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'CkWezbd0oPrXhTryf+3Nhi725XuZfglGl8X5hH7a+MPk4xnA7ft53HZj5enrYG1h8UerEtE3Xc/kMqbIH8tg8A==',
      date: 'Tue, 10 Jun 2025 14:23:25 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcPnb0Pynsfr1B3o98301xUktpdvKnHoEwIfRffBISSZpO8tqW0fapBGEF8e22k9iHEYh15nxDbkdEhf1pFiaBladOkOq1xD"; e_clientaddr="AcPtS1gNmIgnufVXHOfZ29dipdTbVGRidKQ80_lROKVEArXMkbOrXYOhV-J8cUuMjCSejWonqBkpK6EWqRcp7N34qH_VI-_JLncTBnbjTku9jTfG"; e_upip="AcMncnXMJkmc2LnrqPYvKd31wy_t0DGVxC48RyfCIlQDH7oGPw30dCY4mI9T5HpQ8RZotm-MI3OdoAeESep47af7fspv02OrZvuofQ"; e_fb_zone="AcNmOXNk9yAiz1GMCM4cqr-j9r6HykR5kREkfBhpmcX2Qu2ziNL21qWdi2NQWD9m"; e_fb_twtaskhandle="AcMSQZmz-7MZ7ZkvyiaudZdeJufRmN6xC1PlhAEe3TO_O1aqv5P4DOTrGk3-Ny23vVkeIpSs8UxhOj3bXRHrqWGHuae2zoL06G4_cMBrM156DZs"; e_proxy="AcNkPTQvCb23hVE7LjIX_6TJIzNrNKUt6orTznuws6blyxeZkggir6Wff9rG06qXtiKf_hVf2iKs6KIv_ZQ", http_request_error; e_fb_vipaddr="AcPpaq0Vxi3nTym_NCfO0r2KbjpkqrTKiKz90mcg59uCNqwBA7H9XWIxGuAEX1RRS2iO6xCr0briz5NfEv6_NTXGxL0owa5j"; e_clientaddr="AcPo3B2D4dnks-TyiuAv1R6PTtoIdozP1gxjwfB64H95EuAxODnMmg5-ZantoycUMqxpvXNALb9lXHAadxvPDrZafxizNJpyDKm-ki2PjoK_C55lJIIg1w"; e_upip="AcPlAr1bqk3ePdRWlfP03v-MlQXQzNu1af5dPgKdId87m9m1v4-Pe4wqA40JKoHTaNVqsaMK6714LR0FejEFgi1d42bWQYIo"; e_fb_zone="AcPmTERhA2i81Qu3PAMVCPxQ9RJkS7eyDlUWoMH5jPI-9mayAFVhM4VIyjfvKQ"; e_fb_twtaskhandle="AcNfoE_74aPBs50XBWxahBxyxPeKrkkrupmpZ5dIv2GJUocDhuVqj4rERIjfpNUixAebNnvXqQTMp8x98b2TUfjFRdSRJbWLC5S1"; e_proxy="AcOkD8bsfYPwIPtEYwaQbmpc9IwoZh3TBcxN31JlKVTQOIxKzFncllNBYVIkRVhRhAJNOFSFKJ5zOr0"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=31, rtx=0, c=10, mss=1380, tbw=372, tp=-1, tpl=-1, uplat=556, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '238'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: '{"messaging_product":"whatsapp","status":"read","message_id":"wamid.HBgMOTE5OTA5MDE1NzA4FQIAEhgSQzU3NDk4RUY1MzUxQkZERDMzAA=="}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '126',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 126\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: false,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
👤 [HANDLER] Getting/creating user...
✅ Created new customer: +919909015708
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
🆕 [HANDLER] Creating new session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +919909015708
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919909015708",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\n\n🏗️ *Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n📞 *Contact:* +91 84870 51252 / +91 95103 56093 / +91 94281 02172\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* or *\"interested\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919909015708', wa_id: '919909015708' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5OTA5MDE1NzA4FQIAERgSQjgxNDk2QTc3RTFGMDQyMzBEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T14:23:28.671Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:23:28.673Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T14:23:29.802Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T15:02:47.853Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919880036079: {
  type: 'unsupported',
  id: 'wamid.HBgMOTE5ODgwMDM2MDc5FQIAEhgSMjY0NDMwREJGQzE0MDg3MThEAA==',
  timestamp: '1749567766'
}
[WEBHOOK] Message content: {
  "from": "919880036079",
  "id": "wamid.HBgMOTE5ODgwMDM2MDc5FQIAEhgSMjY0NDMwREJGQzE0MDg3MThEAA==",
  "timestamp": "1749567766",
  "errors": [
    {
      "code": 131051,
      "title": "Message type unknown",
      "message": "Message type unknown",
      "error_data": {
        "details": "Message type is currently not supported."
      }
    }
  ],
  "type": "unsupported"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919880036079
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
Error marking message as read: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.markAsRead (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:202:13)
    at async withTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:22:24)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:58:13)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '126',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: '{"messaging_product":"whatsapp","status":"read","message_id":"wamid.HBgMOTE5ODgwMDM2MDc5FQIAEhgSMjY0NDMwREJGQzE0MDg3MThEAA=="}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '126',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 5602802,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 7029,
        [Symbol(triggerId)]: 7027
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 126\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: false,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 126,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': 'd83ab97ca0ceb208dd48e18aad7e5c14',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#100) Invalid parameter"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AkVl_P9ZF5Z59oWY6t4VATY',
      'x-fb-trace-id': 'En3KDm+9Tdx',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'HM0DJpUA1i1e/Er40vfqMlpAU0ISPUbXzs7PNLU4SeG0WVVJhSaVc/bMkZRRvMjEByRbOevXRw02jPx8ou2Q/Q==',
      date: 'Tue, 10 Jun 2025 15:02:48 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcOfEm3_YCgneYdGnw5L-wDEbw7ITGEegbYtAlEm6KvVlQdQTMrD23A408Qo38TLfpdidQALtQ5w2wXPCoDMvWVJNOZN9A_6"; e_clientaddr="AcMoY4VlG9spWv3pCik0LWevYLBDX6T4cEk-cANMwCPZ_0IVfRDSGVoHbV-vK1Ojd82y1LFWAGkr8oTwEZMCesP1w2zegQucZb4xK2ZwgaFf4L10"; e_upip="AcPwzYF6G-xLjpA1z4DL_DhCAHATArHn-42bsvGHvgCDj3IKQRxDIidpJVqkjNNZ_-CJQOwaJ10-F_fRzwpNj-DXvY2ZxYe2_NFFYQ"; e_fb_zone="AcPWqpiptTnatiJhjSL1bta2w_aSei95G6AhY8M2m7UKd1CM5vC3pgPIytR3_omG"; e_fb_twtaskhandle="AcNzLa_iRRincrQtzzPcXklFUFrRE8NHcIFdsN6UAEtIZSWhYZ6XIwuZ56fuwQbEM2HGxKQJES6DIDQml6ZYV_NFbfZgplLqlFZp_7EWEJlSP_w"; e_proxy="AcPuiy8vaOjJhDfxTDNN0etUp-KiSInplm9UvlMCLYKfXqK4mRGcGQ5mPjAODe667g8maR5FtZWTBzzDy-A", http_request_error; e_fb_vipaddr="AcPIknu2TWBw6FoHRNzUUIK9h0VpEqvKM6aGRfa63uVmDQlc0-QoAAb64VSB90O9goOJqA0htB2EGsUfThexIMVrDecycFOF"; e_clientaddr="AcN_Ev44MuMaP3qukx_plrebQOP6dU9tsXyfTrCCxsQTzBo7liigk0tUWBJVzHCuvZyCUFot1JO6DqJ8iNm6vCtNOTc57ntkw0JBXw_EFPqmwbe83BIDsA"; e_upip="AcNefRMILWE6gp-1ca-ole6G4O_bVls23VFNIYryYM-rYSBFlrhyDSbkVUFGgNT283Zq-0zAlFmxAbBbQb-OeVbGLXDt4CSL"; e_fb_zone="AcMC4XunD50uAtMkAWBWXxX3aGsUVRtddq5eGPXMCCwTEfDde6HbtjNy_Y07xQ"; e_fb_twtaskhandle="AcPV5MCScF9ePHN45dlGg80Js1Oz8i2KPGXqMVS_eZgkO8EvhT6ad9KrDJm3db1QMaNsf9TSyTP87n2Y30B01oASpqmVuUlhP1HHWXk"; e_proxy="AcO24eLGWnZhFx7h4KOeO6yHyntupDHvfe4Zxpk-VbTHNgnsyxvds7jH91ul6--uozI1Voq7Kj-XmiA"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=34, rtx=0, c=10, mss=1380, tbw=372, tp=-1, tpl=-1, uplat=683, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '238'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: '{"messaging_product":"whatsapp","status":"read","message_id":"wamid.HBgMOTE5ODgwMDM2MDc5FQIAEhgSMjY0NDMwREJGQzE0MDg3MThEAA=="}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '126',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 126\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: false,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
👤 [HANDLER] Getting/creating user...
✅ Created new customer: +919880036079
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +919880036079
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919880036079",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\n\n🏗️ *Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n📞 *Contact:* +91 84870 51252 / +91 95103 56093 / +91 94281 02172\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* or *\"interested\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919880036079', wa_id: '919880036079' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5ODgwMDM2MDc5FQIAERgSRTUwOEI4N0UzOUJBMkM3MTFBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T15:02:50.917Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T15:02:51.165Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T15:33:02.274Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T15:33:02.275Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T15:37:57.798Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T15:43:17.570Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T15:55:24.538Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T15:57:12.413Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T15:57:12.543Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T15:58:36.736Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T16:19:31.016Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:06:47.228Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:08:34.399Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +16465894168: {
  type: 'text',
  id: 'wamid.HBgLMTY0NjU4OTQxNjgVAgASGBJDODI0RTEyRjQ1MDEzNENEQ0UA',
  timestamp: '1749575312'
}
[WEBHOOK] Message content: {
  "from": "16465894168",
  "id": "wamid.HBgLMTY0NjU4OTQxNjgVAgASGBJDODI0RTEyRjQ1MDEzNENEQ0UA",
  "timestamp": "1749575312",
  "text": {
    "body": "*Get started with the WhatsApp Business Platform*\n\nCongratulations on taking the first step with the WhatsApp Business Platform! Together with your Solution Provider, we're committed to your success and we're here to help you do more with conversations every step of the way.\n\nLearn more: https://business.whatsapp.com/resources/resource-library/api-onboarding?lang=en_US"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +16465894168
🗄️ [HANDLER] Testing database connection...
2025-06-10T17:08:34.688Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:08:34.807Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [DB] New client connected
2025-06-10T17:08:34.971Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
Error marking message as read: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at IncomingMessage.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at IncomingMessage.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.markAsRead (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:202:13)
    at async withTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:22:24)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:58:13)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '122',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: '{"messaging_product":"whatsapp","status":"read","message_id":"wamid.HBgLMTY0NjU4OTQxNjgVAgASGBJDODI0RTEyRjQ1MDEzNENEQ0UA"}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '122',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 13149420,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 7347,
        [Symbol(triggerId)]: 7345
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 122\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 46,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: false,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 122,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '3a84e4f67dffaf6ec83815e7bf2daf02',
      vary: 'Origin',
      'access-control-allow-origin': '*',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'cross-origin-resource-policy': 'cross-origin',
      'x-app-usage': '{"call_count":0,"total_cputime":0,"total_time":0}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#33) The requested phone number has been deleted."',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AzS4BTWOENV923i-dur8B3I',
      'x-fb-trace-id': 'F01U++RMM9j',
      'x-fb-rev': '1023675050',
      'x-fb-debug': 'EnypuvSE8Rzl5hknvl8cPuE5Ku0tWZWigJ2fiqimGnEAtrr0jxb46l6FbgB13UzKM61+8k/K+xmRZ5RsS+nlsA==',
      date: 'Tue, 10 Jun 2025 17:08:35 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcOUfzlTZGR2uweUesbrofA8l-NnA7RD8Rk1APBrW0ildiaLMHbl6soECylL4Ww8h7admF7ym2vVFtlZUOL9D9gnGRtHtK9f"; e_clientaddr="AcM2Krf33xoBNPBYh9Z6ltf0tLcyGlGeGIelt_KLvdDYl46GOcfXUUuNoNh7BJ3Uf6faEd9sNBZMcLktwes70d2xsc4AbuCxukon2CTIYQ-3GdbyVQ"; e_upip="AcMhOcTDwCDy92ml8snl58lfZ_yT-Fq2d8Z1XOEXnBrFJlAPrHL7qQgbLQNukRB4Ld3u1vTEhTO4jDakyOOSbvL7Hw8j1EltL1kpwNQ"; e_fb_zone="AcOQAqUA3Dc2xxTOucobNU3q0xWwSKBOx9HIqQCk_XcXoU_VnLUBkL-GmJSJZK6D"; e_fb_twtaskhandle="AcOCh2-CYwnxilXZykQxW6zldfaI4K5LDBO1tg9QrbVVWIUWsw9VHzntBA_fEYAbgtcW2pm74KJFgIVO5S00aDaejo-KdjlsykPixTHUwzXo0_M"; e_proxy="AcMvkZJrBDXe3dsNLNocYll87sk8RPtit6TJVw3kD9Y-VKCetCXA5Oba5QRvdw6ZIgcn5MyHLoGFnm_sZrM_", http_request_error; e_fb_vipaddr="AcOMQoRRZIdFEFnEcyoOEOKElx-ViUgXQd3bUsPcf-kcymA5o_lf9IN1_9Mh_35nRP8c7iHgf_PbM7BxuV_BmJGFGI9dEZZj"; e_clientaddr="AcMPJvTt9V7mTJKTH_JNAcF05kYNRVR4fTdKYn_Gnr5AHg4sG087lt5lv4NvYhw8zDucFADaGYM3hq63op6xIw6-oXClzppMCbhuTSsgFkrE0WRYoLqybA"; e_upip="AcNL_z7EWqyyrQhbQsEk38Ik2EJKzZFXCwLepw__T0ceigd0sQvTyF9U1268x4jKhFEzjROkVEwP44gLYkv22D1FzFBwJgLB"; e_fb_zone="AcOhbWutpocJpbn8Goji_K4pxIF7_fCg-GX4OtdLO2NT6fZ5J4RyMrAu-oG1Fg"; e_fb_twtaskhandle="AcPq3R7nErQg0Sc9S28NTmt52v5OaP4hZ3T9U2PlwZLeQTsCuvG9EaFbyfqNSotmmMlzTwbdOxQzYtatYqRls6FQPugizYjK88yY"; e_proxy="AcMYwCooM8sW0QTLWtxUea8a94JYaZUC1E1yUDvbJo9iEeACvjGoGZXI3krvdQtCFzZddWv_dAw5dnw"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=34, rtx=0, c=10, mss=1380, tbw=372, tp=-1, tpl=-1, uplat=473, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '147'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: '{"messaging_product":"whatsapp","status":"read","message_id":"wamid.HBgLMTY0NjU4OTQxNjgVAgASGBJDODI0RTEyRjQ1MDEzNENEQ0UA"}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '122',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 122\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: false,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
👤 [HANDLER] Getting/creating user...
2025-06-10T17:08:35.832Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Created new customer: +16465894168
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
🆕 [HANDLER] Creating new session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +16465894168
💬 [HANDLER] Message: "*Get started with the WhatsApp Business Platform*

Congratulations on taking the first step with the WhatsApp Business Platform! Together with your Solution Provider, we're committed to your success and we're here to help you do more with conversations every step of the way.

Learn more: https://business.whatsapp.com/resources/resource-library/api-onboarding?lang=en_US"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/596092260264515/messages
📱 Phone Number ID: 596092260264515
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+16465894168",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\n\n🏗️ *Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n📞 *Contact:* +91 84870 51252 / +91 95103 56093 / +91 94281 02172\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* or *\"interested\"* to continue."
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#33) The requested phone number has been deleted.',
    type: 'OAuthException',
    code: 33,
    fbtrace_id: 'AFnAWqU8noszeFUtR4c7EyA'
  }
}
Error message: Request failed with status code 400
Error sending text message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at IncomingMessage.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at IncomingMessage.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendTextMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:32:13)
    at async CustomerFlow.showSuvasamProjectDetails (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:71:9)
    at async CustomerFlow.handleInitialMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:54:9)
    at async CustomerFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:37:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:114:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '926',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
    data: '{"messaging_product":"whatsapp","to":"+16465894168","type":"text","text":{"body":"🏢 *Suvasam Group – Gota Commercial Hub*\\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\\n🔗 Google Maps location: https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\\n\\n🏗️ *Project Highlights:*\\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\\n• Prime access to SG Highway, public transport & residential clusters\\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\\n• Developer: Suvasam Group – focused on quality & timely delivery\\n\\n📞 *Contact:* +91 84870 51252 / +91 95103 56093 / +91 94281 02172\\n\\nWould you like to know more and book a site visit? Please reply with *\\"yes\\"* or *\\"interested\\"* to continue."}}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '926',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 13150276,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 7403,
        [Symbol(triggerId)]: 7401
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 926\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/596092260264515/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 46,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 926,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '3a84e4f67dffaf6ec83815e7bf2daf02',
      vary: 'Origin',
      'access-control-allow-origin': '*',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'cross-origin-resource-policy': 'cross-origin',
      'x-app-usage': '{"call_count":0,"total_cputime":0,"total_time":0}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#33) The requested phone number has been deleted."',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AFnAWqU8noszeFUtR4c7EyA',
      'x-fb-trace-id': 'Hzem+p6Iwwo',
      'x-fb-rev': '1023680336',
      'x-fb-debug': '0ZSncK+5cOBZ4IJqsz8tBYgfKOt3nzrMH4SPjO8CZ58iugVw62mZiVAqrCiTKKX/chPqkHuXcO9BJImItqXzgQ==',
      date: 'Tue, 10 Jun 2025 17:08:36 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcOkYrMSVxR64lJxFDwsi_lOp43h6pc0IbEg_FvPzV-74Eol0aeZPiao5jhWO8PSxq8QK3Efp0d-Ij3VRhUwqvjqQe5ub7rd"; e_clientaddr="AcO4uPyEaTSnE2Uw3u7QQDmLACzS5E20uOSMTJ0r0IoNWpHCIFZboFMswCSrJIhLbonBrIuQ3FCLjfzHOFiMDYCl_LCAiAiZpMxBr9tSZk29FJ8tqg"; e_upip="AcO2TXHvYGOli8lIoA617p-Hx_fmjctUjdYNwnRBrSjGX7qdfYApsxgc5J03uwRwITcT5tBUlYmZQ8wakDLmSH7pZhJWCW6JAQ_rSgk"; e_fb_zone="AcMZMLXWsqUedMg3UzEf_tEvG0qEOvs-hyR020V_zHpKY52f6y9hkgnAGcUFzeGs"; e_fb_twtaskhandle="AcOLdqT0n9VYpMlqKF5PCVAFIgKVt1SB0oNbCZbgmVXeseG3x1I9R_k6yTQCAqELBrX4U8Dq1-67bOjwpGo633cJnqDN-Y06HrZZYHzXC0zynHI"; e_proxy="AcOHdb11c7SgvQ0IF0ScawI14JJsm1Sp2yZacHGazRAunbTHqe9TGsOGOA_ERRjs_MMcNzl7D8Alj1K-tKAO", http_request_error; e_fb_vipaddr="AcM9tKTdZJwsZuSXM4XPnonWh-ZRAxla8_el_eXUfsB-rUxZnyolvB6T2m6dFYK_QC_Y3bssshghmUklo4avZdfdyzhTjwX_"; e_clientaddr="AcNfvOPMtK8ppILaWuMJq1NUbaxEsPmP40BIaCSlRXRt676bOeI-4keqQvXSGgiXu1pPBDuJjGHDr9ydO_AzHGamh5oqGUXIQT9DO-6Su-I6j_XJ6RBM8w"; e_upip="AcNlu-9HcZ9-sAdHWcSXnzfuux3cwJdKUe3vCuqO91oXMzcOnOKeJtsxV9fU0Lj4YosOaz16TL0nH8R2YlrLArI1VvCtD7vk"; e_fb_zone="AcPBe-umRPdBRV_zSLtTjMHDfWLXqH8FhSW-kFerCKTvN0DOZPDAXTl7IqhEcQ"; e_fb_twtaskhandle="AcPxtAQL6bTNNZzLezBYxO5r89ZU_2rD92GZl4nBq4PI-Vc993mzruGFMuhPA8-LnN5wvsIE8-7Ap5j-xjiQlMJQtTbruKaFLdtR"; e_proxy="AcPVQBLx9_QT6sGNSMbNullndxPsVN3XCe4Lqsl6E5Y3HV_CB3uJ8gpFtbl-0P223se3X4-UppCv1fc"',
      'x-fb-connection-quality': 'GOOD; q=0.7, rtt=64, rtx=1, c=10, mss=1380, tbw=2989, tp=-1, tpl=-1, uplat=463, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '147'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/596092260264515/messages',
      data: '{"messaging_product":"whatsapp","to":"+16465894168","type":"text","text":{"body":"🏢 *Suvasam Group – Gota Commercial Hub*\\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\\n🔗 Google Maps location: https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\\n\\n🏗️ *Project Highlights:*\\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\\n• Prime access to SG Highway, public transport & residential clusters\\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\\n• Developer: Suvasam Group – focused on quality & timely delivery\\n\\n📞 *Contact:* +91 84870 51252 / +91 95103 56093 / +91 94281 02172\\n\\nWould you like to know more and book a site visit? Please reply with *\\"yes\\"* or *\\"interested\\"* to continue."}}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '926',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/596092260264515/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 926\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/596092260264515/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:08:38.275Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:08:42.291Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:08:42.519Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:08:42.560Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:08:42.639Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T17:09:57.528Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY0NTUzMTY5NUVFQUI1RDMxNAA=',
  timestamp: '1749575396'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY0NTUzMTY5NUVFQUI1RDMxNAA=",
  "timestamp": "1749575396",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: { site_selection_shown: false, selected_site: null },
  updated_at: 2025-06-10T17:09:59.161Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: { step: 'select_site', data: { site_selection_shown: true } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwNEQ4NDg1N0FFRjU4RkEwQ0QA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { site_selection_shown: true, selected_site: null },
  updated_at: 2025-06-10T17:09:59.162Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:10:00.984Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:01.082Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:01.231Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:01.357Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:03.889Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTE0M0ZDQjk4NzcwN0U0MDUwRAA=',
  timestamp: '1749575377'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTE0M0ZDQjk4NzcwN0U0MDUwRAA=",
  "timestamp": "1749575377",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: null, site_selection_shown: true },
  updated_at: 2025-06-10T17:10:04.682Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "કૃપા કરીને યાદીમાંથી યોગ્ય સાઈટ પસંદ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMzQ5MzA2OEI0QkI4N0U1RjcA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T17:10:06.040Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NkYzNkI5RDFBMjk3NzJEQTUA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: null, site_selection_shown: true },
  updated_at: 2025-06-10T17:10:04.682Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:10:06.399Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:06.731Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:06.848Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:06.962Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:07.281Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:07.732Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:08.235Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM4MzJBNTk1QzdFNUU4MTNEOQA=',
  timestamp: '1749575407'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwNEQ4NDg1N0FFRjU4RkEwQ0QA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM4MzJBNTk1QzdFNUU4MTNEOQA=",
  "timestamp": "1749575407",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: null, site_selection_shown: true },
  updated_at: 2025-06-10T17:10:09.680Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: null,
  data: { selected_site: 'site_1', site_selection_shown: true }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBOUM0QzNBODg2MDc5NEQ1NzQA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-10T17:10:11.271Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBNDFBODk4OEVEREMzQ0NDOEEA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: 'site_1', site_selection_shown: true },
  updated_at: 2025-06-10T17:10:09.680Z
}
2025-06-10T17:10:11.735Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:10:11.808Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:12.023Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:12.397Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T17:10:12.993Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2OUE1ODNCRjU3RjgwMTZDNjAA'
    }
  ]
}
2025-06-10T17:10:13.880Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:14.344Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:14.346Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:14.521Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:18.105Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNCMUU0OUEwMTVGOUVEQzY5RAA=',
  timestamp: '1749575417'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNCMUU0OUEwMTVGOUVEQzY5RAA=",
  "timestamp": "1749575417",
  "text": {
    "body": "admin"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "admin"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting test mode. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDQkFDNDJGOTI3MzQ5NTNDMzgA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:10:20.283Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-10T17:10:20.782Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:20.842Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:21.006Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDOEMwRUZDODU4MjNBQjI2NDMA'
    }
  ]
}
2025-06-10T17:10:21.920Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T17:10:22.533Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:22.557Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:22.691Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2ODlGMTYyRDQyRUYzQzgxRjEA'
    }
  ]
}
2025-06-10T17:10:24.043Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:24.201Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:24.304Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:10:24.352Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:22:46.548Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0Y1OTgyMDE2RTM5N0Q3MTczRTYA',
  timestamp: '1749576164'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0Y1OTgyMDE2RTM5N0Q3MTczRTYA",
  "timestamp": "1749576164",
  "text": {
    "body": "hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T17:22:48.072Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\n\n🏗️ *Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n📞 *Contact:* +91 84870 51252 / +91 95103 56093 / +91 94281 02172\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* or *\"interested\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOEE2Q0M1NTYzRDI1RTQzMjA1AA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T17:22:48.072Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:22:50.228Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:22:50.435Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:23:29.455Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:23:50.851Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0ZFMjdBRDQ1MDdDNzAyNTcxQ0QA',
  timestamp: '1749576230'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0ZFMjdBRDQ1MDdDNzAyNTcxQ0QA",
  "timestamp": "1749576230",
  "text": {
    "body": "yes"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "yes"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T17:23:52.255Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: { intent: 'inquiry', step: 'collect_name', data: {} }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Great! I'd like to understand your requirements better to provide you with the most suitable options.\n\nPlease share your *full name*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNEE1RDY0OTEyQURFNjk0QTlDAA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_name',
  data: {},
  updated_at: 2025-06-10T17:23:52.255Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:23:53.819Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:23:54.028Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:23:54.090Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:01.499Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0Y3QkNEODI5NDE4QzEyN0FFOTEA',
  timestamp: '1749576240'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0Y3QkNEODI5NDE4QzEyN0FFOTEA",
  "timestamp": "1749576240",
  "text": {
    "body": "Jay"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Jay"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_name',
  data: {},
  updated_at: 2025-06-10T17:24:02.334Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: { step: 'collect_email', data: { full_name: 'Jay' } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Thank you Jay! \n\nPlease share your *email address*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMzk0MkM2NTFEMDU3N0RCNEI3AA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_email',
  data: { full_name: 'Jay' },
  updated_at: 2025-06-10T17:24:02.334Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:24:03.624Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:04.067Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:04.329Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:12.300Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0Y4MjgwQzlGNjk4NDZFOTdCQzYA',
  timestamp: '1749576251'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0Y4MjgwQzlGNjk4NDZFOTdCQzYA",
  "timestamp": "1749576251",
  "text": {
    "body": "pateljk5215@gmail.com"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "pateljk5215@gmail.com"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_email',
  data: { full_name: 'Jay' },
  updated_at: 2025-06-10T17:24:13.621Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_occupation',
  data: { full_name: 'Jay', email: 'pateljk5215@gmail.com' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Great! \n\nWhat is your *occupation/profession*?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMDdDQkY4MjMwQ0M4QjY1NUEwAA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_occupation',
  data: { full_name: 'Jay', email: 'pateljk5215@gmail.com' },
  updated_at: 2025-06-10T17:24:13.621Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:24:15.020Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:15.467Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:15.600Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:22.900Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0ZCMEQzQUJEQkY3NThDMUEyOTMA',
  timestamp: '1749576262'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0ZCMEQzQUJEQkY3NThDMUEyOTMA",
  "timestamp": "1749576262",
  "text": {
    "body": "Business"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Business"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_occupation',
  data: { email: 'pateljk5215@gmail.com', full_name: 'Jay' },
  updated_at: 2025-06-10T17:24:23.903Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_space_requirement',
  data: {
    email: 'pateljk5215@gmail.com',
    full_name: 'Jay',
    occupation: 'Business'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Thanks! \n\nWhat is your *office space requirement*? (e.g., 600 sq ft, 1000 sq ft, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMTYzQzkxQkU1OUNENzM0MERCAA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_space_requirement',
  data: {
    email: 'pateljk5215@gmail.com',
    full_name: 'Jay',
    occupation: 'Business'
  },
  updated_at: 2025-06-10T17:24:23.903Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:24:25.690Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:25.691Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:25.869Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:37.543Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0Y1QzhERTM2QURDRTYwNjY3MkMA',
  timestamp: '1749576276'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0Y1QzhERTM2QURDRTYwNjY3MkMA",
  "timestamp": "1749576276",
  "text": {
    "body": "900"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "900"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_space_requirement',
  data: {
    email: 'pateljk5215@gmail.com',
    full_name: 'Jay',
    occupation: 'Business'
  },
  updated_at: 2025-06-10T17:24:38.317Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_space_use',
  data: {
    email: 'pateljk5215@gmail.com',
    full_name: 'Jay',
    occupation: 'Business',
    office_space_requirement: '900'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Perfect! \n\nWhat will be the *primary use* of this office space? (e.g., consultancy, retail, café, startup office, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMTgyMUJGNUJEOTNEOTA5MDVEAA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_space_use',
  data: {
    email: 'pateljk5215@gmail.com',
    full_name: 'Jay',
    occupation: 'Business',
    office_space_requirement: '900'
  },
  updated_at: 2025-06-10T17:24:38.318Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:24:39.860Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:40.139Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:40.269Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:56.391Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0YxN0ZCRUY0MTIzQjI3QUFFOUYA',
  timestamp: '1749576295'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0YxN0ZCRUY0MTIzQjI3QUFFOUYA",
  "timestamp": "1749576295",
  "text": {
    "body": "consultancy"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "consultancy"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_space_use',
  data: {
    email: 'pateljk5215@gmail.com',
    full_name: 'Jay',
    occupation: 'Business',
    office_space_requirement: '900'
  },
  updated_at: 2025-06-10T17:24:57.280Z
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_price_range',
  data: {
    email: 'pateljk5215@gmail.com',
    full_name: 'Jay',
    occupation: 'Business',
    office_space_requirement: '900',
    office_space_use: 'consultancy'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Excellent! \n\nWhat is your *expected price range/budget*? (e.g., ₹50-75 Lakhs, ₹1-2 Crores, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMTA3QjhFOTk0QkNCNzc2N0RCAA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_price_range',
  data: {
    email: 'pateljk5215@gmail.com',
    full_name: 'Jay',
    occupation: 'Business',
    office_space_requirement: '900',
    office_space_use: 'consultancy'
  },
  updated_at: 2025-06-10T17:24:57.280Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:24:58.760Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:59.017Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:24:59.039Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:25:10.079Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0Y0M0FBOTA2QkUzN0Y2RENCQjQA',
  timestamp: '1749576309'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0Y0M0FBOTA2QkUzN0Y2RENCQjQA",
  "timestamp": "1749576309",
  "text": {
    "body": "1 cr"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "1 cr"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_price_range',
  data: {
    email: 'pateljk5215@gmail.com',
    full_name: 'Jay',
    occupation: 'Business',
    office_space_use: 'consultancy',
    office_space_requirement: '900'
  },
  updated_at: 2025-06-10T17:25:10.924Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "✅ *Thank you for your details!*\n\n📋 *Your Requirements Summary:*\n• Name: Jay\n• Email: pateljk5215@gmail.com\n• Occupation: Business\n• Space Requirement: 900\n• Intended Use: consultancy\n• Budget Range: 1 cr\n\nOur team will review your requirements and get back to you with suitable options.\n\nWould you like to book a site visit to see the project in person?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "talk_later",
            "title": "💬 I'll Call You Later"
          }
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Button title length invalid. Min length: 1, Max length: 20'
    },
    fbtrace_id: 'ArECyitz536Zy6GBcE-3DRV'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async CustomerFlowWrapper.completeInquiry (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:209:13)
    at async CustomerFlowWrapper.handleInquiryFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:171:17)
    at async CustomerFlowWrapper.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:88:13)
    at async CustomerFlowWrapper.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:34:13)
    at async AdminFlow.handleTestFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:354:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:118:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '686',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
    data: `{"messaging_product":"whatsapp","to":"+917383489516","type":"interactive","interactive":{"type":"button","body":{"text":"✅ *Thank you for your details!*\\n\\n📋 *Your Requirements Summary:*\\n• Name: Jay\\n• Email: pateljk5215@gmail.com\\n• Occupation: Business\\n• Space Requirement: 900\\n• Intended Use: consultancy\\n• Budget Range: 1 cr\\n\\nOur team will review your requirements and get back to you with suitable options.\\n\\nWould you like to book a site visit to see the project in person?"},"action":{"buttons":[{"type":"reply","reply":{"id":"book_visit","title":"📅 Book Site Visit"}},{"type":"reply","reply":{"id":"talk_later","title":"💬 I'll Call You Later"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '686',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 938089,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 1864,
        [Symbol(triggerId)]: 1862
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 686\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/652783161256584/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 686,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'ArECyitz536Zy6GBcE-3DRV',
      'x-fb-trace-id': 'FqE3BD7B6ir',
      'x-fb-rev': '1023680336',
      'x-fb-debug': 'oE2zptUjPK0d03gyzHgCsT8Aayfh7LVYFimL93kcBJZ1MeGq0Uq5GRF4Bs3M4S/dAeyEndyEJxOQFtTLsJHXTg==',
      date: 'Tue, 10 Jun 2025 17:25:11 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcPYM3MLqj4pyjv4jt3wjF3UuL1xRGJ_WL15uvXDkpfbmGs_1zU00oIj4w2FhNM9DgMQ2zvLqX6uR2OB-aofYU-iByn6x1ov"; e_clientaddr="AcOMjJTPcagv_lGq8W15daDm_eSlfEIYSaIURIufX51LI43iA84UW8_LBYWX5nRbd44PeH9L4kb36Any1kFtOwnUUWw8cJ696cfunjhLkKyQdLnlBQ"; e_upip="AcOs280O8PHwtBZwqNoeSqIxYYo6bnKkbrcjcYotPcPUNUqPK1jvyQ6uS0zEvpKxdkmK8pzTGb2ufjPztGdKgOXtKZwb4lEGtmAgKzQ"; e_fb_zone="AcN0puo4z7NuSNxpLXiVa2_ofmSYIlnIOB3AiVws3p1ooApOTomLnCbWvzQ_2V8A"; e_fb_twtaskhandle="AcMCJf_mj4Z3k4DXG5rtHMyW29u-aMh0gBjhQZxvHFv2vIs3FQ2lzW6GBs9H5fCoHw1lZa5Ke8I1NfEG4UvxPbttLGFyUjglL8J0egcWMZyFRQc"; e_proxy="AcOPMOAixCTQlb9OoRG8Ltg_vHso-lDWdeZsNqYOLA80UY6Fo6bRsvrgPJ5Zq0Sjyq2I0AmYK5dIRfmTNJxD", http_request_error; e_fb_vipaddr="AcOHOFOuooYHjJA6Xc7s2x1tPQh6f4I4XjMchlbfBsurm9nNF4VegiW2dapZUZpNqHhoNCpHuOjBSBD7NkaY-u9Sfu2tM-W9"; e_clientaddr="AcNzim_jIjAjG4gio8tWbD9sja5fEUoBQVqcFZLR2YbA9B7mRh6T1qcjn1uW3pFiHbjNivakFat4Mp_2rottOuvUO0brB0pHybzyFuosYj85aJjjLVLTyw"; e_upip="AcOzIhYpNNPSjopjRp3eJYTuEibmficytRagyFLQdkV8qXg99r1whVuWttd5SmsQSHTBd1j3aKpf8_e9atDnNGcsfC0Uil_7"; e_fb_zone="AcPWlrZ_j67-TDyRQyaqETpdxDYC3_LO9dkkM6n4_16DTf2Mox2PR7Q8AUMDCA"; e_fb_twtaskhandle="AcMd9J2pWpT70I-T799UCV3WU5Tk8d70Y1BzwhHs2Lou_eerWxixJ8X3_IlWQopDhNWqkgqvR2pnm6pV8ot_jDLyLd2_8yXjkKs"; e_proxy="AcN2vXfblZCy6MTKe1BEVgpK_p45Nwn3LOkMDDXh8967mG8CK-8C-97zgBF39a20R8OWbqAO0qADU_4"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=33, rtx=0, c=10, mss=1380, tbw=1385, tp=-1, tpl=-1, uplat=413, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '192'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      data: `{"messaging_product":"whatsapp","to":"+917383489516","type":"interactive","interactive":{"type":"button","body":{"text":"✅ *Thank you for your details!*\\n\\n📋 *Your Requirements Summary:*\\n• Name: Jay\\n• Email: pateljk5215@gmail.com\\n• Occupation: Business\\n• Space Requirement: 900\\n• Intended Use: consultancy\\n• Budget Range: 1 cr\\n\\nOur team will review your requirements and get back to you with suitable options.\\n\\nWould you like to book a site visit to see the project in person?"},"action":{"buttons":[{"type":"reply","reply":{"id":"book_visit","title":"📅 Book Site Visit"}},{"type":"reply","reply":{"id":"talk_later","title":"💬 I'll Call You Later"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '686',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 686\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/652783161256584/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: { inquiry_id: '3e865f2c-5b73-4e13-b1c0-465837cf09e6' }
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    email: 'pateljk5215@gmail.com',
    full_name: 'Jay',
    occupation: 'Business',
    office_space_use: 'consultancy',
    office_space_requirement: '900',
    inquiry_id: '3e865f2c-5b73-4e13-b1c0-465837cf09e6'
  },
  updated_at: 2025-06-10T17:25:11.437Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:27:35.762Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0Y2NkU4MDM2QjYwMENCMzUzNUEA',
  timestamp: '1749576454'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhgUM0Y2NkU4MDM2QjYwMENCMzUzNUEA",
  "timestamp": "1749576454",
  "text": {
    "body": "admin"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "admin"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "🔙 Exiting test mode. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMEYyMTlCNDk0RUMzQ0Q0Mjg0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T17:27:38.681Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-10T17:27:38.989Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:27:39.309Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSODM1RTE2NjdFREVFOENCREZBAA=='
    }
  ]
}
2025-06-10T17:27:40.323Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T17:27:40.716Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:27:41.002Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQjVCNjNEMUU1NTRDOENFNUJGAA=='
    }
  ]
}
2025-06-10T17:27:42.156Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:27:42.396Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T17:27:42.607Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T18:04:36.316Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUExQzRBNkMyRjFENkFBQjgxQgA=',
  timestamp: '1749578674'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDOEMwRUZDODU4MjNBQjI2NDMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUExQzRBNkMyRjFENkFBQjgxQgA=",
  "timestamp": "1749578674",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "test_customer",
      "title": "👥 Test Customer Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "test_customer"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧪 *Testing Customer Flow*\n\nYou are now in customer flow test mode. All customer features are available:\n• Site visit booking\n• Availability checking  \n• Pricing information\n• Sales connection\n\nType *exit* anytime to return to admin menu.\n\n---"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCNjJCMDg4QkYwQTg0QTA2NjYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:04:39.316Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:04:39.818Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
Handling message for +19088483575: { messageText: 'start', intent: null, step: null }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
2025-06-10T18:04:40.062Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:04:40.096Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2OTZCMzJFNzk4RDRBQ0I0OTkA'
    }
  ]
}
2025-06-10T18:04:40.884Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:04:41.610Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:04:41.776Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:04:41.815Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:04:46.768Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM5RkE2MDUzMEM2OEMxM0VGQwA=',
  timestamp: '1749578686'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM5RkE2MDUzMEM2OEMxM0VGQwA=",
  "timestamp": "1749578686",
  "text": {
    "body": "Yes"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Yes"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T18:04:47.630Z
}
Handling message for +19088483575: { messageText: 'Yes', intent: null, step: null }
🧪 [ADMIN-TEST] Customer flow session update intercepted: { intent: 'inquiry', step: 'collect_name', data: {} }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Great! I'd like to understand your requirements better to provide you with the most suitable options.\nPlease share your *full name*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QjA0NEI2M0IxRDdGNzc5NjMA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_name',
  data: {},
  updated_at: 2025-06-10T18:04:47.631Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:04:48.995Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:04:49.407Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:04:49.674Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:04:49.772Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:01.790Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTA2NTBBQzA3MUFBNjVBREMwQwA=',
  timestamp: '1749578701'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTA2NTBBQzA3MUFBNjVBREMwQwA=",
  "timestamp": "1749578701",
  "text": {
    "body": "Yash Thakkar"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Yash Thakkar"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_name',
  data: {},
  updated_at: 2025-06-10T18:05:02.923Z
}
Handling message for +19088483575: {
  messageText: 'Yash Thakkar',
  intent: 'inquiry',
  step: 'collect_name'
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: { step: 'collect_email', data: { full_name: 'Yash Thakkar' } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Thank you Yash Thakkar! \nPlease share your *email address*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFQ0ZBOEIwMkFBRUYxQjAyQ0EA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_email',
  data: { full_name: 'Yash Thakkar' },
  updated_at: 2025-06-10T18:05:02.923Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:05:04.173Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:04.720Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:04.722Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:04.966Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:18.252Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJDMDA0ODBFRTNEOEVCRDRGNAA=',
  timestamp: '1749578717'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJDMDA0ODBFRTNEOEVCRDRGNAA=",
  "timestamp": "1749578717",
  "text": {
    "body": "Bojrick@gmail.com"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Bojrick@gmail.com"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_email',
  data: { full_name: 'Yash Thakkar' },
  updated_at: 2025-06-10T18:05:19.175Z
}
Handling message for +19088483575: {
  messageText: 'Bojrick@gmail.com',
  intent: 'inquiry',
  step: 'collect_email'
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_occupation',
  data: { full_name: 'Yash Thakkar', email: 'Bojrick@gmail.com' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Great! \nWhat is your *occupation/profession*?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5ODM0MTNBMjEyQzBDMTcxQkEA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_occupation',
  data: { full_name: 'Yash Thakkar', email: 'Bojrick@gmail.com' },
  updated_at: 2025-06-10T18:05:19.175Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:05:20.636Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:21.020Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:21.275Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:35.656Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc3RUFFMUU5RUExMDQ2MkZBQwA=',
  timestamp: '1749578735'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc3RUFFMUU5RUExMDQ2MkZBQwA=",
  "timestamp": "1749578735",
  "text": {
    "body": "Student"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Student"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_occupation',
  data: { email: 'Bojrick@gmail.com', full_name: 'Yash Thakkar' },
  updated_at: 2025-06-10T18:05:36.681Z
}
Handling message for +19088483575: {
  messageText: 'Student',
  intent: 'inquiry',
  step: 'collect_occupation'
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_space_requirement',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash Thakkar',
    occupation: 'Student'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Thanks! \nWhat is your *office space requirement*? (e.g., 600 sq ft, 1000 sq ft, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCNzg3RjZGNTVENjA1RDk3NUMA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_space_requirement',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash Thakkar',
    occupation: 'Student'
  },
  updated_at: 2025-06-10T18:05:36.682Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:05:38.064Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:38.452Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:38.465Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:38.620Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:48.258Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTU3QkI5MDMzRkVERDYxQTAzRAA=',
  timestamp: '1749578747'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTU3QkI5MDMzRkVERDYxQTAzRAA=",
  "timestamp": "1749578747",
  "text": {
    "body": "700"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "700"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_space_requirement',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash Thakkar',
    occupation: 'Student'
  },
  updated_at: 2025-06-10T18:05:49.146Z
}
Handling message for +19088483575: {
  messageText: '700',
  intent: 'inquiry',
  step: 'collect_space_requirement'
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_space_use',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash Thakkar',
    occupation: 'Student',
    office_space_requirement: '700'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Perfect! \nWhat will be the *primary use* of this office space? (e.g., consultancy, retail, café, startup office, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFQzlEOTUzMDlDNkNEOUJGOTMA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_space_use',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash Thakkar',
    occupation: 'Student',
    office_space_requirement: '700'
  },
  updated_at: 2025-06-10T18:05:49.146Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:05:50.332Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:50.894Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:50.988Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:50.992Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:05:57.425Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQwNTEzNUNEQjhFMTRDQTQ2MgA=',
  timestamp: '1749578756'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQwNTEzNUNEQjhFMTRDQTQ2MgA=",
  "timestamp": "1749578756",
  "text": {
    "body": "Retail"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Retail"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_space_use',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash Thakkar',
    occupation: 'Student',
    office_space_requirement: '700'
  },
  updated_at: 2025-06-10T18:05:58.280Z
}
Handling message for +19088483575: { messageText: 'Retail', intent: 'inquiry', step: 'collect_space_use' }
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_price_range',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash Thakkar',
    occupation: 'Student',
    office_space_requirement: '700',
    office_space_use: 'Retail'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Excellent! \nWhat is your *expected price range/budget*? (e.g., ₹50-75 Lakhs, ₹1-2 Crores, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3Q0ZENjJEOEFFQTI2MDVEMjIA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_price_range',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash Thakkar',
    occupation: 'Student',
    office_space_requirement: '700',
    office_space_use: 'Retail'
  },
  updated_at: 2025-06-10T18:05:58.281Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:05:59.480Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:06:00.116Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:06:00.217Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:06:00.399Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:06:10.264Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTA0RjBFNkI2MEE2MjM3QUEyMAA=',
  timestamp: '1749578769'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTA0RjBFNkI2MEE2MjM3QUEyMAA=",
  "timestamp": "1749578769",
  "text": {
    "body": "75 lakhs"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "75 lakhs"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_price_range',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash Thakkar',
    occupation: 'Student',
    office_space_use: 'Retail',
    office_space_requirement: '700'
  },
  updated_at: 2025-06-10T18:06:11.181Z
}
Handling message for +19088483575: {
  messageText: '75 lakhs',
  intent: 'inquiry',
  step: 'collect_price_range'
}
Inquiry saved: {
  id: '1e1eb6b2-1eba-4c01-b58e-d4c02de89622',
  phone: '+19088483575',
  full_name: 'Yash Thakkar',
  email: 'Bojrick@gmail.com',
  occupation: 'Student',
  office_space_requirement: '700',
  office_space_use: 'Retail',
  expected_price_range: '75 lakhs',
  status: 'inquiry',
  notes: null,
  created_at: 2025-06-10T18:06:11.192Z,
  updated_at: 2025-06-10T18:06:11.192Z
}
No Zoho refresh token available. Please complete OAuth setup.
Cannot send email - no valid access token
Email notification sent for inquiry: 1e1eb6b2-1eba-4c01-b58e-d4c02de89622
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "✅ *Thank you for your details!*\n\n📋 *Your Requirements Summary:*\n• Name: Yash Thakkar\n• Email: Bojrick@gmail.com\n• Occupation: Student\n• Space Requirement: 700\n• Intended Use: Retail\n• Budget Range: 75 lakhs\n\nOur team will review your requirements and get back to you with suitable options.\n\nWould you like to book a site visit to see the project in person?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "talk_later",
            "title": "💬 I'll Call You Later"
          }
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Button title length invalid. Min length: 1, Max length: 20'
    },
    fbtrace_id: 'Av16dGfylqhLe6Ep4g88gMt'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async CustomerFlowWrapper.completeInquiry (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:234:13)
    at async CustomerFlowWrapper.handleInquiryFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:178:17)
    at async CustomerFlowWrapper.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:100:13)
    at async CustomerFlowWrapper.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:48:13)
    at async AdminFlow.handleTestFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:368:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:132:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '688',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"✅ *Thank you for your details!*\\n\\n📋 *Your Requirements Summary:*\\n• Name: Yash Thakkar\\n• Email: Bojrick@gmail.com\\n• Occupation: Student\\n• Space Requirement: 700\\n• Intended Use: Retail\\n• Budget Range: 75 lakhs\\n\\nOur team will review your requirements and get back to you with suitable options.\\n\\nWould you like to book a site visit to see the project in person?"},"action":{"buttons":[{"type":"reply","reply":{"id":"book_visit","title":"📅 Book Site Visit"}},{"type":"reply","reply":{"id":"talk_later","title":"💬 I'll Call You Later"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '688',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 126045,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 1142,
        [Symbol(triggerId)]: 1140
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 688\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/652783161256584/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 688,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'Av16dGfylqhLe6Ep4g88gMt',
      'x-fb-trace-id': 'Bvfglfx/gG9',
      'x-fb-rev': '1023680336',
      'x-fb-debug': 'ooGBOGjt3FImZgB4ukxxFByRpsVTloPR3njWfiQAK1aHT02T0iSuODLlTcRwNHWDvQI4ot/lb7Zth1qEMk9jRg==',
      date: 'Tue, 10 Jun 2025 18:06:11 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcNliqNd1_6pxt2Ka_ZyiDdeEz7HpKVmpFe0sUc-FROWYAD3H0KYU6n7t0O0VRJGgmd7QIMbIMD6vEPYrtZG85hopIKNGFuX"; e_clientaddr="AcNwR5wJ_H7arzul9OziBG5hmSEqj2n5zPh2Rq4kKFRCwXCDcZZkyE7zXpAWEYpQCepC06HVMoXkfR-Nfr9infB5AjTRcHMKRd4NX6nf-FfgBMvX"; e_upip="AcNfcR782WZzMn_w2XxWXjlL1ec2VK0lEdaEJX440ZZ28HdV59xiE3H1tmc2Y0XySXh6DoqcZAfAnLeQ6020h7JTwA2sDSUSi-ckjkQ"; e_fb_zone="AcNV-7J93MRl6n_yDR3YXDI2ywsaNuN3Io6JkuXy9maXcO2U9rc5JS35BYcemtIo"; e_fb_twtaskhandle="AcP6DOmqkc5D51E6x6Hb5iB3wicPVu9oIut91FEemUfOjgS0ekRLQ6XXgBYNnpfXly4IdQK1WQmCCKWhTZyWemgLlnohgHID_ZcVnNH2hWvq908"; e_proxy="AcNvbGfbpTF8pkn_q0nfcryvak0pMs0f3XUQzJCDxQMgY4LjOjilol1o9gy0wvZeCAH9E1XZJ1ApCf5ypaP0", http_request_error; e_fb_vipaddr="AcPd7lhu0AGdFstw4nvPX2QOgzAgbNBBcSmIkxWI4xDNWZZzpbywMlLqFhGHUtHWNmpGYgO5956vpHpToRkTgHwG17ngopFU"; e_clientaddr="AcPkcC-8p0_YTFcD-Llp8a8OfXen8GxfwQzlOoBVf5Z6JBjAaEq43xggv1CXJvs-XEGEh-Ie6XGq5QJbMKnQPYo3VJnICdRsJ8WKITxBHyybz9DIoWHpeQ"; e_upip="AcOE5rSzt1yPy7FvGhVbBmA1pFmhRFSYiNb1AIBmNGSA-iV0D9u7l3waO6OqiXrZQapXWDJ7O7plVxcK_s-am9aj5j7uXOrz"; e_fb_zone="AcMAgQf03ZZcuI0qxjIeqq7PSOsbmr30fJXw7Kr4O9kcBqcNI0nNoQGYLAn1cQ"; e_fb_twtaskhandle="AcMDPWOSdAyb3dImgNT7h6KGjdEs9r8CojfDVlgx1kR0XeOG1u98lCfptZ2KYkmsBUkxWadKtjpXnnNa-LhCA8LNdqXwG6v67Eg"; e_proxy="AcPl9DJrBp8-t1HS66Et4YRIciqJINvEQ7QXAUTXPMi9rFe6Ta70mMGsiDhCeWudiuTKi6YLSvZn7JQ"',
      'x-fb-connection-quality': 'GOOD; q=0.7, rtt=54, rtx=0, c=10, mss=1380, tbw=1385, tp=-1, tpl=-1, uplat=418, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '190'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"✅ *Thank you for your details!*\\n\\n📋 *Your Requirements Summary:*\\n• Name: Yash Thakkar\\n• Email: Bojrick@gmail.com\\n• Occupation: Student\\n• Space Requirement: 700\\n• Intended Use: Retail\\n• Budget Range: 75 lakhs\\n\\nOur team will review your requirements and get back to you with suitable options.\\n\\nWould you like to book a site visit to see the project in person?"},"action":{"buttons":[{"type":"reply","reply":{"id":"book_visit","title":"📅 Book Site Visit"}},{"type":"reply","reply":{"id":"talk_later","title":"💬 I'll Call You Later"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '688',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 688\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/652783161256584/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    inquiry_id: '1e1eb6b2-1eba-4c01-b58e-d4c02de89622',
    email: 'Bojrick@gmail.com',
    full_name: 'Yash Thakkar',
    occupation: 'Student',
    office_space_use: 'Retail',
    office_space_requirement: '700',
    expected_price_range: '75 lakhs'
  }
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash Thakkar',
    occupation: 'Student',
    office_space_use: 'Retail',
    office_space_requirement: '700',
    inquiry_id: '1e1eb6b2-1eba-4c01-b58e-d4c02de89622',
    expected_price_range: '75 lakhs'
  },
  updated_at: 2025-06-10T18:06:11.709Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

4 moderate severity vulnerabilities

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-10T18:11:08.224Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTgwOTAyQzMxRTdBRTM2OEVDNQA=',
  timestamp: '1749579067'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTgwOTAyQzMxRTdBRTM2OEVDNQA=",
  "timestamp": "1749579067",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting test mode. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGMjY2MTIzQUEyNzQ4MzNBQ0UA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:11:11.531Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-10T18:11:11.809Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:11.845Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxRTk2NjlCM0QwNzlGMjk4OUMA'
    }
  ]
}
2025-06-10T18:11:12.854Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-10T18:11:13.470Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:13.584Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:13.688Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQTVCNTAzREUzOTM2N0E3MUIA'
    }
  ]
}
2025-06-10T18:11:14.520Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:15.083Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:15.268Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:15.341Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:15.495Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY4RjA0NzlFNDU4NDU2RjczOQA=',
  timestamp: '1749579074'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxRTk2NjlCM0QwNzlGMjk4OUMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY4RjA0NzlFNDU4NDU2RjczOQA=",
  "timestamp": "1749579074",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "test_customer",
      "title": "👥 Test Customer Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "test_customer"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧪 *Testing Customer Flow*\n\nYou are now in customer flow test mode. All customer features are available:\n• Site visit booking\n• Availability checking  \n• Pricing information\n• Sales connection\n\nType *exit* anytime to return to admin menu.\n\n---"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBM0M0OTkwOTQ4QUYxNUVGRTMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:11:17.622Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:18.072Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:18.118Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
Handling message for +19088483575: { messageText: 'start', intent: null, step: null }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
2025-06-10T18:11:18.300Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCRjQ5NUY5NUMzMENGRDY5RjQA'
    }
  ]
}
2025-06-10T18:11:19.332Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:19.916Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:19.944Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:19.952Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:23.647Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTk0MUEzQUZEOTg1MjIwNDJFNgA=',
  timestamp: '1749579082'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTk0MUEzQUZEOTg1MjIwNDJFNgA=",
  "timestamp": "1749579082",
  "text": {
    "body": "Yes"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Yes"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-10T18:11:24.671Z
}
Handling message for +19088483575: { messageText: 'Yes', intent: null, step: null }
🧪 [ADMIN-TEST] Customer flow session update intercepted: { intent: 'inquiry', step: 'collect_name', data: {} }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Great! I'd like to understand your requirements better to provide you with the most suitable options.\nPlease share your *full name*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1MjkwM0Q1RkFCQzQyNjMxMTIA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_name',
  data: {},
  updated_at: 2025-06-10T18:11:24.672Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:11:25.822Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:26.469Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:26.487Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:26.692Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:33.146Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ5MTBFQjRFQTYzODE3QkNDMAA=',
  timestamp: '1749579092'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ5MTBFQjRFQTYzODE3QkNDMAA=",
  "timestamp": "1749579092",
  "text": {
    "body": "Yash"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Yash"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_name',
  data: {},
  updated_at: 2025-06-10T18:11:34.165Z
}
Handling message for +19088483575: { messageText: 'Yash', intent: 'inquiry', step: 'collect_name' }
🧪 [ADMIN-TEST] Customer flow session update intercepted: { step: 'collect_email', data: { full_name: 'Yash' } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Thank you Yash! \nPlease share your *email address*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCODMwQzVENDEwQkMwNDUwOUMA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_email',
  data: { full_name: 'Yash' },
  updated_at: 2025-06-10T18:11:34.166Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:11:35.604Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:36.033Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:36.114Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:36.319Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:44.584Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg2N0M2NTg1RDEyODU1MEQ5QgA=',
  timestamp: '1749579103'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg2N0M2NTg1RDEyODU1MEQ5QgA=",
  "timestamp": "1749579103",
  "text": {
    "body": "Bojrick@gmail.com"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Bojrick@gmail.com"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_email',
  data: { full_name: 'Yash' },
  updated_at: 2025-06-10T18:11:45.533Z
}
Handling message for +19088483575: {
  messageText: 'Bojrick@gmail.com',
  intent: 'inquiry',
  step: 'collect_email'
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_occupation',
  data: { full_name: 'Yash', email: 'Bojrick@gmail.com' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Great! \nWhat is your *occupation/profession*?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5MkEyRjFBMjI2REVEQTMzRDAA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_occupation',
  data: { full_name: 'Yash', email: 'Bojrick@gmail.com' },
  updated_at: 2025-06-10T18:11:45.534Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:11:46.764Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:47.350Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:47.363Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:47.469Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:51.772Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUYwRDQyMjVCQkVBOTBBNTEyRQA=',
  timestamp: '1749579111'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUYwRDQyMjVCQkVBOTBBNTEyRQA=",
  "timestamp": "1749579111",
  "text": {
    "body": "Biz"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Biz"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_occupation',
  data: { email: 'Bojrick@gmail.com', full_name: 'Yash' },
  updated_at: 2025-06-10T18:11:52.615Z
}
Handling message for +19088483575: { messageText: 'Biz', intent: 'inquiry', step: 'collect_occupation' }
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_space_requirement',
  data: { email: 'Bojrick@gmail.com', full_name: 'Yash', occupation: 'Biz' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Thanks! \nWhat is your *office space requirement*? (e.g., 600 sq ft, 1000 sq ft, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxM0ZFMkVDNjc4QkEzQUVFODQA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_space_requirement',
  data: { email: 'Bojrick@gmail.com', full_name: 'Yash', occupation: 'Biz' },
  updated_at: 2025-06-10T18:11:52.615Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:11:53.786Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:54.475Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:54.545Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:54.749Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:11:58.213Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUIxMTRBM0Q3NEEyMjBCQUREOQA=',
  timestamp: '1749579117'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUIxMTRBM0Q3NEEyMjBCQUREOQA=",
  "timestamp": "1749579117",
  "text": {
    "body": "600"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "600"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_space_requirement',
  data: { email: 'Bojrick@gmail.com', full_name: 'Yash', occupation: 'Biz' },
  updated_at: 2025-06-10T18:11:59.015Z
}
Handling message for +19088483575: {
  messageText: '600',
  intent: 'inquiry',
  step: 'collect_space_requirement'
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_space_use',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash',
    occupation: 'Biz',
    office_space_requirement: '600'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Perfect! \nWhat will be the *primary use* of this office space? (e.g., consultancy, retail, café, startup office, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGQThBNjQzQTc2OUYwNzg0REQA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_space_use',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash',
    occupation: 'Biz',
    office_space_requirement: '600'
  },
  updated_at: 2025-06-10T18:11:59.015Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:12:00.285Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:12:00.714Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:12:00.928Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:12:00.973Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:12:03.999Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUYyNDk5QjhDMDdDQjI3MzhFQgA=',
  timestamp: '1749579123'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUYyNDk5QjhDMDdDQjI3MzhFQgA=",
  "timestamp": "1749579123",
  "text": {
    "body": "Retail"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Retail"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_space_use',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash',
    occupation: 'Biz',
    office_space_requirement: '600'
  },
  updated_at: 2025-06-10T18:12:04.765Z
}
Handling message for +19088483575: { messageText: 'Retail', intent: 'inquiry', step: 'collect_space_use' }
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_price_range',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash',
    occupation: 'Biz',
    office_space_requirement: '600',
    office_space_use: 'Retail'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "Excellent! \nWhat is your *expected price range/budget*? (e.g., ₹50-75 Lakhs, ₹1-2 Crores, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzQTc1Q0VBN0NCNTVFQ0U4RDUA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_price_range',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash',
    occupation: 'Biz',
    office_space_requirement: '600',
    office_space_use: 'Retail'
  },
  updated_at: 2025-06-10T18:12:04.765Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-10T18:12:06.053Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:12:06.536Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:12:06.607Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:12:06.656Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-10T18:12:09.661Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURFQkM3NzlGMUE4RUZERUMyRgA=',
  timestamp: '1749579128'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURFQkM3NzlGMUE4RUZERUMyRgA=",
  "timestamp": "1749579128",
  "text": {
    "body": "75"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "75"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'inquiry',
  step: 'collect_price_range',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash',
    occupation: 'Biz',
    office_space_use: 'Retail',
    office_space_requirement: '600'
  },
  updated_at: 2025-06-10T18:12:10.441Z
}
Handling message for +19088483575: { messageText: '75', intent: 'inquiry', step: 'collect_price_range' }
🧪 [TEST MODE] Skipping database save and email for inquiry
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "✅ *Thank you for your details!*\n\n📋 *Your Requirements Summary:*\n• Name: Yash\n• Email: Bojrick@gmail.com\n• Occupation: Biz\n• Space Requirement: 600\n• Intended Use: Retail\n• Budget Range: 75\n\nOur team will review your requirements and get back to you with suitable options.\n\nWould you like to book a site visit to see the project in person?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "talk_later",
            "title": "💬 I'll Call You Later"
          }
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Button title length invalid. Min length: 1, Max length: 20'
    },
    fbtrace_id: 'AwfNOZ0MY7qdPr17cEB-4Ka'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async CustomerFlowWrapper.completeInquiry (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:247:13)
    at async CustomerFlowWrapper.handleInquiryFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:183:17)
    at async CustomerFlowWrapper.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:105:13)
    at async CustomerFlowWrapper.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:53:13)
    at async AdminFlow.handleTestFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:370:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:134:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '670',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
    data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"✅ *Thank you for your details!*\\n\\n📋 *Your Requirements Summary:*\\n• Name: Yash\\n• Email: Bojrick@gmail.com\\n• Occupation: Biz\\n• Space Requirement: 600\\n• Intended Use: Retail\\n• Budget Range: 75\\n\\nOur team will review your requirements and get back to you with suitable options.\\n\\nWould you like to book a site visit to see the project in person?"},"action":{"buttons":[{"type":"reply","reply":{"id":"book_visit","title":"📅 Book Site Visit"}},{"type":"reply","reply":{"id":"talk_later","title":"💬 I'll Call You Later"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '670',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 94947,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 1327,
        [Symbol(triggerId)]: 1325
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 670\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/652783161256584/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 670,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AwfNOZ0MY7qdPr17cEB-4Ka',
      'x-fb-trace-id': 'D1GbnNTR5QT',
      'x-fb-rev': '1023680336',
      'x-fb-debug': 'm5nz/gfraM3PJqRjkwBMByZoBsfORH6RRVXlWfQ68dU9XwGpcQYWNiAusD1oIlXhUnVx3xElMbJGRe8sHPVubA==',
      date: 'Tue, 10 Jun 2025 18:12:10 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcOoe4PC6ZjFUaxls_YYbT7jyJ64jqFnAbXEIBQ4siaFuCYPvGHRkh69ZqcdF4FX9L8zmVEjPGSF23Afg3U_TPebTGhVchqJ"; e_clientaddr="AcOOoYnX704uNYPuF6kA81prWl6zWkRFIeoNjvBLXTBwlUkZqez3pVIor3j_Gwe30UlUvWwaLEMCkq6jVZw8Q-xrN4fGdS3LhgWnw_VHawi2sD9Kvg"; e_upip="AcPgy_7NzwP1IPDyFYLY2ZwsEZ6iEYJVIY5tW3Enj4uJNsPbxuPXEDeZB0KgsCgtQDECOLr-PMLzgaS2TXX4LeXLNjn87lpal_YRPuw"; e_fb_zone="AcPRv1WAa68ahYX75PoafkpUmh-HGMgMZTQ5Iz6i2IoZ2DgE9H-4M34LJTgf0Txk"; e_fb_twtaskhandle="AcPJkh9tyJ7IgHdPqLbYpmEEXnt58y_C61zO-7XXEk-R0ydNhOm5k4mSR9tEK0ma4J7905IkSXlKxdvO5dF356F61QoAnF2c3FQHGs_UtilqwtY"; e_proxy="AcN9ENdXMHwZL3zVwCQAi_9xjPwTsUEc3EhVmg86r9OAw0xyyYutjy7YgqIImfuZ6fnc4o469oeHHrbVrpoZMg", http_request_error; e_fb_vipaddr="AcMJeS2w6BCds7kqnoKDqKb83LmTtEF-w_QiJ380ToPJvGrSOx3SGWLKSY5EZJvIkilz9lFjGEgsAJSbBvpdbwWUOxdhB3sPObU"; e_clientaddr="AcO5sPY8wZ4hgFm_Gh-UqxhemdJ61txro-gnfg_tMx8-eVMuyviUfyx1FLOxrwKP0uG_T9d7AuZhzelOfCkEZiDqkvOCwTz-yZFWo7chCSChtsH7O9o8dQ"; e_upip="AcPItACjqLJ6nKNbUu7wU5G8pyI-zXSUgpwTJTT5j4waCqHLl3W1HJYJeN38g_-p2egDUaLU2p7NVwpbuQc3xO-LraUN-r0V"; e_fb_zone="AcNPiDwBRhU2PNKjCVFHGoqS5SfB1kYXvcqDyYGgtkgbAOWeOJ-lYM2SEqkgkw"; e_fb_twtaskhandle="AcOjNzgzUcP6pxyd9JXiiNOmZdkqJmmxlEBItgsNwPXob_EVnZczaGFbkgrBLSeAc3JcfANH4t1VXnKV6WpX-eqQ2ubYWcUh9WY"; e_proxy="AcMlFFg-Yj98Q_NH8-bmbaingvv5bH9X7N2qkmPrgQilxoH7UboKTgzYXiZ3KZPILVD9ocPM2DQkujM"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=49, rtx=0, c=10, mss=1380, tbw=7928, tp=-1, tpl=-1, uplat=410, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '191'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      data: `{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"button","body":{"text":"✅ *Thank you for your details!*\\n\\n📋 *Your Requirements Summary:*\\n• Name: Yash\\n• Email: Bojrick@gmail.com\\n• Occupation: Biz\\n• Space Requirement: 600\\n• Intended Use: Retail\\n• Budget Range: 75\\n\\nOur team will review your requirements and get back to you with suitable options.\\n\\nWould you like to book a site visit to see the project in person?"},"action":{"buttons":[{"type":"reply","reply":{"id":"book_visit","title":"📅 Book Site Visit"}},{"type":"reply","reply":{"id":"talk_later","title":"💬 I'll Call You Later"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '670',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 670\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/652783161256584/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    inquiry_id: 'test-inquiry-id',
    email: 'Bojrick@gmail.com',
    full_name: 'Yash',
    occupation: 'Biz',
    office_space_use: 'Retail',
    office_space_requirement: '600',
    expected_price_range: '75'
  }
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash',
    occupation: 'Biz',
    office_space_use: 'Retail',
    office_space_requirement: '600',
    inquiry_id: 'test-inquiry-id',
    expected_price_range: '75'
  },
  updated_at: 2025-06-10T18:12:10.947Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-11T05:29:48.798Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM0NzZBOTk1MDI3QTIwQzA1NgA=',
  timestamp: '1749619787'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM0NzZBOTk1MDI3QTIwQzA1NgA=",
  "timestamp": "1749619787",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+19088483575',
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    email: 'Bojrick@gmail.com',
    full_name: 'Yash',
    inquiry_id: 'test-inquiry-id',
    occupation: 'Biz',
    office_space_use: 'Retail',
    expected_price_range: '75',
    office_space_requirement: '600'
  },
  updated_at: 2025-06-11T05:29:50.375Z
}
Handling message for +19088483575: {
  messageText: 'Hi',
  intent: 'post_inquiry',
  step: 'awaiting_response'
}
Post-inquiry response from +19088483575: { text: 'hi', responseId: 'hi', interactiveData: undefined }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "I didn't understand that response. Let me show you our project details again.\n\nIf you're interested, simply reply with *\"yes\"* to start the inquiry process."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEMTRGMUQyOUQzOTBCRDZBMEYA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow session clear intercepted
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMTM1NDQ3MkJGQjFDNDk2NUIA'
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-11T05:29:51.126Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-11T05:29:52.175Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-11T05:29:52.381Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-11T05:29:52.568Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-11T05:29:52.681Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-11T05:29:52.936Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-11T05:29:53.052Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-11T06:37:32.541Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQ0EyQjMxRUVGRENGMTQyRThDMDEzNTk2ODY2OTc5NTYA',
  timestamp: '1749623850'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQjVCNjNEMUU1NTRDOENFNUJGAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQ0EyQjMxRUVGRENGMTQyRThDMDEzNTk2ODY2OTc5NTYA",
  "timestamp": "1749623850",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "dashboard",
      "title": "📊 Admin Dashboard",
      "description": "View system statistics and status"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "dashboard"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "📊 *Admin Dashboard*\n\n*System Overview:*\n• Total Users: 10\n• Active Users: 10\n• Active Sessions: 2\n\n*User Breakdown:*\n• 👥 Customers: 4\n• 👷‍♂️ Employees: 4\n• 🔧 Admins: 2\n\n*Invoice Statistics:*\n• 🧾 Total Invoices: 0\n• 💰 Total Amount: ₹0.00\n• ⏳ Pending Invoices: 0\n\n*Recent Activity:*\n• Database: ✅ Operational\n• WhatsApp API: ✅ Connected\n• Flows: ✅ Customer, Employee & Invoice flows active\n\n*Quick Actions:*\n• Type *test_customer* - Test customer flow\n• Type *test_employee* - Test employee flow\n• Type *track_invoices* - Add new invoice\n• Type *menu* - Return to main menu\n\nSystem uptime: Running smoothly 🟢"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSN0EzRjdDRkQwNjE1RDFGN0NBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-11T06:37:36.212Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-11T06:37:36.603Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-11T06:37:36.795Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-11T17:07:32.988Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +16465894168: {
  type: 'text',
  id: 'wamid.HBgLMTY0NjU4OTQxNjgVAgASGBJGNUFBOTQ0NjMyMjBGMDRCM0UA',
  timestamp: '1749661650'
}
[WEBHOOK] Message content: {
  "from": "16465894168",
  "id": "wamid.HBgLMTY0NjU4OTQxNjgVAgASGBJGNUFBOTQ0NjMyMjBGMDRCM0UA",
  "timestamp": "1749661650",
  "text": {
    "body": "*Take a minute right now to send your first message*\n\nBy sending a quick test message to yourself, you can experience messaging before you dive in with customers.\n\nNow, let's send a message:\n1. Open WhatsApp on your personal phone, and send a test message (eg. Testing 123) to your WhatsApp business phone number: +91 73834 89532\n2. Check your test messages on your solution provider's inbox to find your test message\n3. Reply to the test message, and see how the reply looks on your personal phone"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +16465894168
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +16465894168
💬 [HANDLER] Message: "*Take a minute right now to send your first message*

By sending a quick test message to yourself, you can experience messaging before you dive in with customers.

Now, let's send a message:
1. Open WhatsApp on your personal phone, and send a test message (eg. Testing 123) to your WhatsApp business phone number: +91 73834 89532
2. Check your test messages on your solution provider's inbox to find your test message
3. Reply to the test message, and see how the reply looks on your personal phone"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +16465894168: {
  messageText: '*Take a minute right now to send your first message*\n' +
    '\n' +
    'By sending a quick test message to yourself, you can experience messaging before you dive in with customers.\n' +
    '\n' +
    "Now, let's send a message:\n" +
    '1. Open WhatsApp on your personal phone, and send a test message (eg. Testing 123) to your WhatsApp business phone number: +91 73834 89532\n' +
    "2. Check your test messages on your solution provider's inbox to find your test message\n" +
    '3. Reply to the test message, and see how the reply looks on your personal phone',
  intent: null,
  step: null
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+16465894168",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+16465894168', wa_id: '16465894168' } ],
  messages: [
    {
      id: 'wamid.HBgLMTY0NjU4OTQxNjgVAgARGBJGQUQwRTdEM0M5MjA3NzFGMkYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-11T17:07:37.641Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-11T17:07:37.802Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T07:53:30.567Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919106020332: {
  type: 'document',
  id: 'wamid.HBgMOTE5MTA2MDIwMzMyFQIAEhgWM0VCMDdBQjhEQzVEOTAyQ0Q5NDZEQQA=',
  timestamp: '1749714806'
}
[WEBHOOK] Message content: {
  "from": "919106020332",
  "id": "wamid.HBgMOTE5MTA2MDIwMzMyFQIAEhgWM0VCMDdBQjhEQzVEOTAyQ0Q5NDZEQQA=",
  "timestamp": "1749714806",
  "type": "document",
  "document": {
    "caption": "Dear *Reeva Empire LLP*, \r\n Dated: *12-Jun-25* has been generatedYour Invoice No. *1839* of Rs. *8,888.00*. \r\n\r\nTotal Closing Balance as on *12-Jun-25* is *8,888.00 Dr*. \r\n\r\n\r\nRegards,  *HARIOM STEEL TRADERS*.",
    "filename": "HOT-GST_SALES-1839.pdf",
    "mime_type": "application/pdf",
    "sha256": "aIJkkZEVRnH221Dh2In+zKx+h/XkXloD8Bzfk+Q0m6s=",
    "id": "1245455290270324"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919106020332
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ Created new customer: +919106020332
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
🆕 [HANDLER] Creating new session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +919106020332
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +919106020332: { messageText: '', intent: null, step: null }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919106020332",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919106020332', wa_id: '919106020332' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5MTA2MDIwMzMyFQIAERgSMTE0OTQ1QkEzQ0QzQjk5OTZEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-12T07:53:34.915Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T07:53:35.293Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T07:53:35.706Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T09:34:39.088Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:45:10.933Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNzlFNTQ0ODYzNjMzNkI5RjJDNDE4MDYzMkZCNEM0RDcA',
  timestamp: '1749732308'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNzlFNTQ0ODYzNjMzNkI5RjJDNDE4MDYzMkZCNEM0RDcA",
  "timestamp": "1749732308",
  "text": {
    "body": "Admin"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Admin"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMUJCOTc5ODUxRjQzNkVBRTVGAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-12T12:45:14.723Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-12T12:45:15.405Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNkRBMjhEODlDRDZDRjgzODA3AA=='
    }
  ]
}
2025-06-12T12:45:16.566Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:45:16.736Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:45:19.820Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNDlGQjE1N0E5OUQ3NkY5Qzc1MjZFNzdGM0EwMTVGNDIA',
  timestamp: '1749732319'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMUJCOTc5ODUxRjQzNkVBRTVGAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNDlGQjE1N0E5OUQ3NkY5Qzc1MjZFNzdGM0EwMTVGNDIA",
  "timestamp": "1749732319",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "test_customer",
      "title": "👥 Test Customer Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "test_customer"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "🧪 *Testing Customer Flow*\n\nYou are now in customer flow test mode. All customer features are available:\n• Site visit booking\n• Availability checking  \n• Pricing information\n• Sales connection\n\nType *exit* anytime to return to admin menu.\n\n---"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRjQ3QTRBRDQ3Q0Q2RTkyMDM5AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-12T12:45:22.468Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:45:22.566Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
Handling message for +917383489516: { messageText: 'start', intent: null, step: null }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQjNCMzg3NzM3MTRFRDZCN0FCAA=='
    }
  ]
}
2025-06-12T12:45:24.040Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:45:24.475Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:46:06.802Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQTY1MUQ3RDgyQjlBMzdDMEUxNzEwMEY5QjA0NzJBNjEA',
  timestamp: '1749732365'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQTY1MUQ3RDgyQjlBMzdDMEUxNzEwMEY5QjA0NzJBNjEA",
  "timestamp": "1749732365",
  "text": {
    "body": "Yes"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Yes"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-12T12:46:08.263Z
}
Handling message for +917383489516: { messageText: 'Yes', intent: null, step: null }
🧪 [ADMIN-TEST] Customer flow session update intercepted: { intent: 'inquiry', step: 'collect_name', data: {} }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Great! I'd like to understand your requirements better to provide you with the most suitable options.\nPlease share your *full name*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQzNCMDAwMjI3NUUzRUMyMERDAA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_name',
  data: {},
  updated_at: 2025-06-12T12:46:08.264Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-12T12:46:09.944Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:46:10.246Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:46:16.099Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMzkwNDYyOUE5QUY2RjUyMkEyOTQzMDBGODU1MzVGNjQA',
  timestamp: '1749732375'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMzkwNDYyOUE5QUY2RjUyMkEyOTQzMDBGODU1MzVGNjQA",
  "timestamp": "1749732375",
  "text": {
    "body": "Jay patel"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Jay patel"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_name',
  data: {},
  updated_at: 2025-06-12T12:46:17.128Z
}
Handling message for +917383489516: { messageText: 'Jay patel', intent: 'inquiry', step: 'collect_name' }
🧪 [ADMIN-TEST] Customer flow session update intercepted: { step: 'collect_email', data: { full_name: 'Jay patel' } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Thank you Jay patel! \nPlease share your *email address*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMjlCQUQ0NTdBODNFNzUxMDAyAA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_email',
  data: { full_name: 'Jay patel' },
  updated_at: 2025-06-12T12:46:17.128Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-12T12:46:18.925Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:46:18.991Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:46:31.284Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNzFENzVEMjI0RDE5NjlFQzMxMEE3RENDMDZDRDlEMUQA',
  timestamp: '1749732390'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNzFENzVEMjI0RDE5NjlFQzMxMEE3RENDMDZDRDlEMUQA",
  "timestamp": "1749732390",
  "text": {
    "body": "pateljk5216@gmail.com"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "pateljk5216@gmail.com"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_email',
  data: { full_name: 'Jay patel' },
  updated_at: 2025-06-12T12:46:32.434Z
}
Handling message for +917383489516: {
  messageText: 'pateljk5216@gmail.com',
  intent: 'inquiry',
  step: 'collect_email'
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_occupation',
  data: { full_name: 'Jay patel', email: 'pateljk5216@gmail.com' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Great! \nWhat is your *occupation/profession*?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNDdBNkQ2RTQyQ0FBNDVENTEzAA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_occupation',
  data: { full_name: 'Jay patel', email: 'pateljk5216@gmail.com' },
  updated_at: 2025-06-12T12:46:32.435Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-12T12:46:34.081Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:46:34.348Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:46:43.115Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNjkxODBFQ0ZGOTFFNUNGMEFCODM2Q0Y4NDRFNUUzOUIA',
  timestamp: '1749732402'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNjkxODBFQ0ZGOTFFNUNGMEFCODM2Q0Y4NDRFNUUzOUIA",
  "timestamp": "1749732402",
  "text": {
    "body": "Business"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Business"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_occupation',
  data: { email: 'pateljk5216@gmail.com', full_name: 'Jay patel' },
  updated_at: 2025-06-12T12:46:44.475Z
}
Handling message for +917383489516: {
  messageText: 'Business',
  intent: 'inquiry',
  step: 'collect_occupation'
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_space_requirement',
  data: {
    email: 'pateljk5216@gmail.com',
    full_name: 'Jay patel',
    occupation: 'Business'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Thanks! \nWhat is your *office space requirement*? (e.g., 600 sq ft, 1000 sq ft, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNThDNEJBRUNGNTYyN0Y1OTExAA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_space_requirement',
  data: {
    email: 'pateljk5216@gmail.com',
    full_name: 'Jay patel',
    occupation: 'Business'
  },
  updated_at: 2025-06-12T12:46:44.475Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-12T12:46:46.060Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:46:46.378Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:46:52.717Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMEI4OTU4MTY5NTA5MkFERjM3MzMyNUVDQkRFQkNERkQA',
  timestamp: '1749732412'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMEI4OTU4MTY5NTA5MkFERjM3MzMyNUVDQkRFQkNERkQA",
  "timestamp": "1749732412",
  "text": {
    "body": "1000"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "1000"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Customer flow state before: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_space_requirement',
  data: {
    email: 'pateljk5216@gmail.com',
    full_name: 'Jay patel',
    occupation: 'Business'
  },
  updated_at: 2025-06-12T12:46:53.647Z
}
Handling message for +917383489516: {
  messageText: '1000',
  intent: 'inquiry',
  step: 'collect_space_requirement'
}
🧪 [ADMIN-TEST] Customer flow session update intercepted: {
  step: 'collect_space_use',
  data: {
    email: 'pateljk5216@gmail.com',
    full_name: 'Jay patel',
    occupation: 'Business',
    office_space_requirement: '1000'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Perfect! \nWhat will be the *primary use* of this office space? (e.g., consultancy, retail, café, startup office, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMEJGOUE2NDZEMjc0OUI5NjFEAA=='
    }
  ]
}
🧪 [ADMIN-TEST] Customer flow state after: {
  phone: '+917383489516',
  intent: 'inquiry',
  step: 'collect_space_use',
  data: {
    email: 'pateljk5216@gmail.com',
    full_name: 'Jay patel',
    occupation: 'Business',
    office_space_requirement: '1000'
  },
  updated_at: 2025-06-12T12:46:53.648Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-12T12:46:55.561Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T12:46:55.609Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T17:07:32.639Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +16465894168: {
  type: 'text',
  id: 'wamid.HBgLMTY0NjU4OTQxNjgVAgASGBJCNzhGN0JDMDY3QjcxODUzMDQA',
  timestamp: '1749748050'
}
[WEBHOOK] Message content: {
  "from": "16465894168",
  "id": "wamid.HBgLMTY0NjU4OTQxNjgVAgASGBJCNzhGN0JDMDY3QjcxODUzMDQA",
  "timestamp": "1749748050",
  "text": {
    "body": "*Get inspiration from success stories*\n\nNow that you're set up on the WhatsApp Business platform, it's time to think about what you'd like to accomplish first. Learn about how you can send promos, capture and nurture leads, and streamline customer support through these success stories!\n\nLearn more: https://business.whatsapp.com/resources/success-stories?lang=en_US"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +16465894168
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +16465894168
💬 [HANDLER] Message: "*Get inspiration from success stories*

Now that you're set up on the WhatsApp Business platform, it's time to think about what you'd like to accomplish first. Learn about how you can send promos, capture and nurture leads, and streamline customer support through these success stories!

Learn more: https://business.whatsapp.com/resources/success-stories?lang=en_US"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +16465894168: {
  messageText: '*Get inspiration from success stories*\n' +
    '\n' +
    "Now that you're set up on the WhatsApp Business platform, it's time to think about what you'd like to accomplish first. Learn about how you can send promos, capture and nurture leads, and streamline customer support through these success stories!\n" +
    '\n' +
    'Learn more: https://business.whatsapp.com/resources/success-stories?lang=en_US',
  intent: null,
  step: null
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+16465894168",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+16465894168', wa_id: '16465894168' } ],
  messages: [
    {
      id: 'wamid.HBgLMTY0NjU4OTQxNjgVAgARGBIwRTUzQ0Q5OUJENzRCODFEMzMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-12T17:07:36.773Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-12T17:07:36.869Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-13T17:07:32.670Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +16465894168: {
  type: 'text',
  id: 'wamid.HBgLMTY0NjU4OTQxNjgVAgASGBI5REQ1ODZCN0YxQzZENDE5NkMA',
  timestamp: '1749834450'
}
[WEBHOOK] Message content: {
  "from": "16465894168",
  "id": "wamid.HBgLMTY0NjU4OTQxNjgVAgASGBI5REQ1ODZCN0YxQzZENDE5NkMA",
  "timestamp": "1749834450",
  "text": {
    "body": "*Open more doors to growth with business verification*\n\nBusiness verification confirms the legitimacy of your business and unlocks additional WhatsApp benefits including:\n1. Send more messages to customers\n2. Register up to 20 phone numbers\n3. Authenticate your business and establish trust by showing your display name in chats\n\nReach out to your Solution Provider to get started or learn more about the business verification here: https://www.facebook.com/business/help/1095661473946872"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +16465894168
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +16465894168
💬 [HANDLER] Message: "*Open more doors to growth with business verification*

Business verification confirms the legitimacy of your business and unlocks additional WhatsApp benefits including:
1. Send more messages to customers
2. Register up to 20 phone numbers
3. Authenticate your business and establish trust by showing your display name in chats

Reach out to your Solution Provider to get started or learn more about the business verification here: https://www.facebook.com/business/help/1095661473946872"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +16465894168: {
  messageText: '*Open more doors to growth with business verification*\n' +
    '\n' +
    'Business verification confirms the legitimacy of your business and unlocks additional WhatsApp benefits including:\n' +
    '1. Send more messages to customers\n' +
    '2. Register up to 20 phone numbers\n' +
    '3. Authenticate your business and establish trust by showing your display name in chats\n' +
    '\n' +
    'Reach out to your Solution Provider to get started or learn more about the business verification here: https://www.facebook.com/business/help/1095661473946872',
  intent: null,
  step: null
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+16465894168",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+16465894168', wa_id: '16465894168' } ],
  messages: [
    {
      id: 'wamid.HBgLMTY0NjU4OTQxNjgVAgARGBIwRDk5QjEyMTQ2OERGQjhBQjYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-13T17:07:36.250Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-13T17:07:36.693Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T05:08:50.043Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919106020332: {
  type: 'document',
  id: 'wamid.HBgMOTE5MTA2MDIwMzMyFQIAEhgWM0VCMDM4QjEwOThBNjNCRTM2QzQzRgA=',
  timestamp: '1749877726'
}
[WEBHOOK] Message content: {
  "from": "919106020332",
  "id": "wamid.HBgMOTE5MTA2MDIwMzMyFQIAEhgWM0VCMDM4QjEwOThBNjNCRTM2QzQzRgA=",
  "timestamp": "1749877726",
  "type": "document",
  "document": {
    "caption": "Dear *Reeva Empire LLP*, \r\n Dated: *14-Jun-25* has been generatedYour Invoice No. *1883* of Rs. *10,783.00*. \r\n\r\nTotal Closing Balance as on *14-Jun-25* is *19,671.00 Dr*. \r\n\r\n\r\nRegards,  *HARIOM STEEL TRADERS*.",
    "filename": "HOT-GST_SALES-1883.pdf",
    "mime_type": "application/pdf",
    "sha256": "rdBdszgPkS51xvsknmXKUIyXQiZl6c1zcLucMv4XyNE=",
    "id": "584279941185307"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919106020332
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +919106020332
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +919106020332: { messageText: '', intent: null, step: null }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919106020332",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919106020332', wa_id: '919106020332' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5MTA2MDIwMzMyFQIAERgSQTQzNjc4MTg1QjQ2MTVGOTc0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T05:08:53.665Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T05:08:53.828Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T05:08:54.237Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T05:09:42.803Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:17:55.448Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUEyQjkwNzYxODgzM0RCMTJFMEVEQzk2REU3NzBGRDUA',
  timestamp: '1749910673'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUEyQjkwNzYxODgzM0RCMTJFMEVEQzk2REU3NzBGRDUA",
  "timestamp": "1749910673",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQkU1RjJCMzg3OTNEQTIxMzkwAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:17:59.508Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:18:00.474Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:18:16.032Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggN0U0QzYxRjk4Mjk2QzgzMDcxODkwREFCNEU0RDRDMDkA',
  timestamp: '1749910694'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQkU1RjJCMzg3OTNEQTIxMzkwAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggN0U0QzYxRjk4Mjk2QzgzMDcxODkwREFCNEU0RDRDMDkA",
  "timestamp": "1749910694",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_2",
      "title": "🏢 સાઈટ B - વાણિજ્યિક",
      "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_2"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ B - વાણિજ્યિક માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQTkyQUI0MEI3Q0Y0MTcxRTFFAA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ B - વાણિજ્યિક\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-14T14:18:19.229Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNUQ0RkE1NTVCMjEyRkNGODMwAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:18:19.480Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:18:19.940Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:18:20.096Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTRGNzQ0NkZDQjg2MDI3M0FDAA=='
    }
  ]
}
2025-06-14T14:18:22.077Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:18:22.083Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:18:27.091Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUJBRTU2M0MwMEEwQzAwM0NDMzFCQjIyREUwOTNFOEUA',
  timestamp: '1749910706'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNUQ0RkE1NTVCMjEyRkNGODMwAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUJBRTU2M0MwMEEwQzAwM0NDMzFCQjIyREUwOTNFOEUA",
  "timestamp": "1749910706",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTQ5NzRGNjY3NjdENDZGQkJCAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:18:30.018Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:18:30.331Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:18:46.589Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNzZFMjk4NDlERDU4QjFFMEVGOEY3NTg0ODRFMkYxOTkA',
  timestamp: '1749910725'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTQ5NzRGNjY3NjdENDZGQkJCAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNzZFMjk4NDlERDU4QjFFMEVGOEY3NTg0ODRFMkYxOTkA",
  "timestamp": "1749910725",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMDlGNDZBRTg5RkE2OUJBODgyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:18:49.519Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:18:49.878Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:18:57.710Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDAzNjBEOUJCRUQzODA1NDZFNjI1OUU2NDk2RTlCMTAA',
  timestamp: '1749910736'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDAzNjBEOUJCRUQzODA1NDZFNjI1OUU2NDk2RTlCMTAA",
  "timestamp": "1749910736",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNEVDMUMwMjM1MjYyQjQ0QTZFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:19:00.578Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:19:00.720Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:19:38.673Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQjM1RUFEQ0VCQjM3ODc4NzM3NDBFQkM2ODgzMThFMzcA',
  timestamp: '1749910778'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQjM1RUFEQ0VCQjM3ODc4NzM3NDBFQkM2ODgzMThFMzcA",
  "timestamp": "1749910778",
  "text": {
    "body": "Senching"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Senching"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNDRFNjFFNDBGQTE0NjhGODBFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:19:41.742Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:19:42.092Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:20:07.769Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggN0U1QTZGRDdDNTc0NzJBMzg3RjkzOUFEMjZERUVFM0EA',
  timestamp: '1749910805'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggN0U1QTZGRDdDNTc0NzJBMzg3RjkzOUFEMjZERUVFM0EA",
  "timestamp": "1749910805",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "J158CwmLpLJoUEigHxtnzhwpT7vLpNzi1iVx+zZ6m2I=",
    "id": "1332301181202707"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMEY5QTc1NjUyNUIxODQzOTU4AA=='
    }
  ]
}
2025-06-14T14:20:10.322Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:20:10.630Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:20:12.881Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/3b1ec3c3-d185-466d-a179-347860897276.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/3b1ec3c3-d185-466d-a179-347860897276.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTM5NUYxNzMwNDBEODREMTNDAA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: સાઈટ B - વાણિજ્યિક\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Senching\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* 7ceb10e3\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
2025-06-14T14:20:20.254Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjlBQzQwQkVCNjY3RDU2MDNFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:20:20.343Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:20:20.964Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:20:21.274Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:01.429Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUE2QzVCNjk0QzJFODhFRTM2NzUzNTg3NURDODE4RjUA',
  timestamp: '1749910980'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUE2QzVCNjk0QzJFODhFRTM2NzUzNTg3NURDODE4RjUA",
  "timestamp": "1749910980",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjI1NEE3QzQ4QURBODgxMjQ4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:23:04.707Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:05.006Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:11.260Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNzgzQUE4QUEyMzBGOTlGMkZFRDlDRjgwQ0UwN0REOUYA',
  timestamp: '1749910990'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjI1NEE3QzQ4QURBODgxMjQ4AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNzgzQUE4QUEyMzBGOTlGMkZFRDlDRjgwQ0UwN0REOUYA",
  "timestamp": "1749910990",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_2",
      "title": "🏢 સાઈટ B - વાણિજ્યિક",
      "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_2"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ B - વાણિજ્યિક માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMjQ2OENCMEI5ODI3NUUwOEVGAA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ B - વાણિજ્યિક\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMzZDOThGOEFDQzYyRDE4QzMzAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:23:14.362Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:14.886Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:15.253Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:15.257Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMTdGNTA0RDgxQTcyQTcxQjdGAA=='
    }
  ]
}
2025-06-14T14:23:17.096Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:17.728Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:18.632Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:18.761Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:18.878Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:25.690Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDBCQzlDQzYzRUNDMzREMEY2RjUyN0IwMjlDMTQxRTYA',
  timestamp: '1749911004'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMzZDOThGOEFDQzYyRDE4QzMzAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDBCQzlDQzYzRUNDMzREMEY2RjUyN0IwMjlDMTQxRTYA",
  "timestamp": "1749911004",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjA0MTAyNUU4MjlCRDQzMDRCAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:23:28.157Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:28.574Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:34.498Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDc1Q0Y4RTkzOEJBMEY2Qzk2MTZGMEIzQjA1Rjk2NDkA',
  timestamp: '1749911013'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjA0MTAyNUU4MjlCRDQzMDRCAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDc1Q0Y4RTkzOEJBMEY2Qzk2MTZGMEIzQjA1Rjk2NDkA",
  "timestamp": "1749911013",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSODFGODFFRTYxMDExQ0ZDOEREAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:23:37.377Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:37.872Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:41.575Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQzY2MEVENTczQkY2Q0EwQzA5NkFBMUY1MEMwNUY4NTEA',
  timestamp: '1749911020'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQzY2MEVENTczQkY2Q0EwQzA5NkFBMUY1MEMwNUY4NTEA",
  "timestamp": "1749911020",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQ0FGMEMzMDVBMDMzODczMDM4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:23:44.465Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:23:44.941Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:24:32.143Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUI2MDI0NDZBNTU5NkU4QzgzMDU4OEIwODg5MUQyMzEA',
  timestamp: '1749911071'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUI2MDI0NDZBNTU5NkU4QzgzMDU4OEIwODg5MUQyMzEA",
  "timestamp": "1749911071",
  "text": {
    "body": "સળિયાવાળા"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
❌ [TIMEOUT] Database connection test failed: Error: Database connection test timed out after 3000ms
    at Timeout.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:18:20)
    at listOnTimeout (node:internal/timers:581:17)
    at process.processTimers (node:internal/timers:519:7)
⚠️ [HANDLER] Database not available, continuing without DB features
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [DB] New client connected
✅ [DB] New client connected
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
⚠️ [HANDLER] Using temporary session (DB unavailable)
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "સળિયાવાળા"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMUI1MjdENDlDMzhBNDEwNUI1AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-14T14:24:39.833Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-14T14:24:40.091Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T05:45:59.888Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919106020332: {
  type: 'document',
  id: 'wamid.HBgMOTE5MTA2MDIwMzMyFQIAEhgWM0VCMDVBNDMwREY5NjZFMTA0NkYxNwA=',
  timestamp: '1749966356'
}
[WEBHOOK] Message content: {
  "from": "919106020332",
  "id": "wamid.HBgMOTE5MTA2MDIwMzMyFQIAEhgWM0VCMDVBNDMwREY5NjZFMTA0NkYxNwA=",
  "timestamp": "1749966356",
  "type": "document",
  "document": {
    "caption": "Dear *Reeva Empire LLP*, \r\n Dated: *15-Jun-25* has been generatedYour Invoice No. *1924* of Rs. *34,397.00*. \r\n\r\nTotal Closing Balance as on *15-Jun-25* is *54,068.00 Dr*. \r\n\r\n\r\nRegards,  *HARIOM STEEL TRADERS*.",
    "filename": "HOT-GST_SALES-1924.pdf",
    "mime_type": "application/pdf",
    "sha256": "7Ce21HyDPBJQexIG6+SVdpB0BDXV8ocRrJ3xUZmE5fM=",
    "id": "1450901042580423"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919106020332
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +919106020332
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +919106020332: { messageText: '', intent: null, step: null }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919106020332",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919106020332', wa_id: '919106020332' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5MTA2MDIwMzMyFQIAERgSQ0JGNDkwRkJDMTA1QzJDMjg0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T05:46:03.307Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T05:46:03.545Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T06:10:30.097Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNjBBNDYyNDNCQkRBMjAyQTExRjU1NjkyODk3MzUyNUYA',
  timestamp: '1749967828'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNjBBNDYyNDNCQkRBMjAyQTExRjU1NjkyODk3MzUyNUYA",
  "timestamp": "1749967828",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_site
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "કૃપા કરીને યાદીમાંથી યોગ્ય સાઈટ પસંદ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNjk5NTA5OUI0OEU4QjkyRUEzAA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMUIyNzM5MTZFNkNCMUE0MEI0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T06:10:33.770Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T06:10:34.194Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T06:10:34.549Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T06:10:34.732Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T06:10:41.339Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNkJGRDg4NDJCNzBEQTc2RjE1QjE1NEIwOUYyRDkxQUQA',
  timestamp: '1749967840'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMUIyNzM5MTZFNkNCMUE0MEI0AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNkJGRDg4NDJCNzBEQTc2RjE1QjE1NEIwOUYyRDkxQUQA",
  "timestamp": "1749967840",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_2",
      "title": "🏢 સાઈટ B - વાણિજ્યિક",
      "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_2"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_site
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ B - વાણિજ્યિક માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSODlCRDk4Q0E1RkI3RTY3NTYyAA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ B - વાણિજ્યિક\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNkFBMzUzNTI5REI0RURCRUFBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T06:10:44.318Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T06:10:44.388Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T06:10:45.135Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-15T06:10:45.654Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMzFGRkU5NzBCMjFFMjUxRUE5AA=='
    }
  ]
}
2025-06-15T06:10:46.775Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T06:10:47.491Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T06:10:53.914Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNTREMDMwQzhGODAwNkUyODI3RjcwMTFDNzk3MDNDQjYA',
  timestamp: '1749967853'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNkFBMzUzNTI5REI0RURCRUFBAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNTREMDMwQzhGODAwNkUyODI3RjcwMTFDNzk3MDNDQjYA",
  "timestamp": "1749967853",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T06:13:47.139Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMDNERUE3Mzg1QTBGRjlGNzIzNzk1REU4MkUyOTlBRDEA',
  timestamp: '1749968025'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNkFBMzUzNTI5REI0RURCRUFBAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMDNERUE3Mzg1QTBGRjlGNzIzNzk1REU4MkUyOTlBRDEA",
  "timestamp": "1749968025",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "request_materials",
      "title": "📦 સામગ્રીની માંગ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
❌ [TIMEOUT] Mark as read failed: Error: Mark as read timed out after 2000ms
    at Timeout.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:18:20)
    at listOnTimeout (node:internal/timers:581:17)
    at process.processTimers (node:internal/timers:519:7)
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "request_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T06:22:22.939Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMjQ4QUEwRjY1MDE2RTM2QjcxNEFEQjBDQTE3RkU2NzgA',
  timestamp: '1749968541'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMjQ4QUEwRjY1MDE2RTM2QjcxNEFEQjBDQTE3RkU2NzgA",
  "timestamp": "1749968541",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T08:46:58.340Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:45:39.508Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919924468844: {
  type: 'text',
  id: 'wamid.HBgMOTE5OTI0NDY4ODQ0FQIAEhgUM0FBM0Y1MkVBRkVGNENCNjlCN0UA',
  timestamp: '1749991537'
}
[WEBHOOK] Message content: {
  "from": "919924468844",
  "id": "wamid.HBgMOTE5OTI0NDY4ODQ0FQIAEhgUM0FBM0Y1MkVBRkVGNENCNjlCN0UA",
  "timestamp": "1749991537",
  "text": {
    "body": "Hii"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919924468844
🗄️ [HANDLER] Testing database connection...
❌ [TIMEOUT] Database connection test failed: Error: Database connection test timed out after 3000ms
    at Timeout.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:18:20)
    at listOnTimeout (node:internal/timers:581:17)
    at process.processTimers (node:internal/timers:519:7)
⚠️ [HANDLER] Database not available, continuing without DB features
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [DB] New client connected
✅ [DB] New client connected
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
⚠️ [HANDLER] Using temporary session (DB unavailable)
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919924468844
💬 [HANDLER] Message: "Hii"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919924468844",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919924468844', wa_id: '919924468844' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5OTI0NDY4ODQ0FQIAERgSNzQwQzFENjA3NTBBQzZDNUFBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T12:45:48.523Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:45:49.191Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:45:49.517Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:45:55.717Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919924468844: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5OTI0NDY4ODQ0FQIAEhgUM0FGRDM0OUY4MTg4QUM2QzZCRDMA',
  timestamp: '1749991555'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5OTI0NDY4ODQ0FQIAERgSNzQwQzFENjA3NTBBQzZDNUFBAA=="
  },
  "from": "919924468844",
  "id": "wamid.HBgMOTE5OTI0NDY4ODQ0FQIAEhgUM0FGRDM0OUY4MTg4QUM2QzZCRDMA",
  "timestamp": "1749991555",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_2",
      "title": "🏢 સાઈટ B - વાણિજ્યિક",
      "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919924468844
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919924468844
💬 [HANDLER] Message: "site_2"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919924468844",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ B - વાણિજ્યિક માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919924468844', wa_id: '919924468844' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5OTI0NDY4ODQ0FQIAERgSNzcxQzZGRUUyRTI5OTE2OEI5AA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919924468844",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ B - વાણિજ્યિક\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-15T12:45:58.717Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919924468844', wa_id: '919924468844' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5OTI0NDY4ODQ0FQIAERgSNDNCNTk0MTE0MTU0MUY2NzdEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T12:45:58.732Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:45:58.972Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:45:59.340Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919924468844",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-15T12:45:59.978Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:45:59.980Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919924468844', wa_id: '919924468844' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5OTI0NDY4ODQ0FQIAERgSMDNGRUJGMDBCRjExQ0U4REU1AA=='
    }
  ]
}
2025-06-15T12:46:01.176Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:46:01.648Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:46:01.768Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:46:09.782Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919924468844: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5OTI0NDY4ODQ0FQIAEhgUM0EzRDRERkU1NzMyMjM0RUQ1RjcA',
  timestamp: '1749991569'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5OTI0NDY4ODQ0FQIAERgSNDNCNTk0MTE0MTU0MUY2NzdEAA=="
  },
  "from": "919924468844",
  "id": "wamid.HBgMOTE5OTI0NDY4ODQ0FQIAEhgUM0EzRDRERkU1NzMyMjM0RUQ1RjcA",
  "timestamp": "1749991569",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919924468844
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919924468844
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919924468844",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919924468844', wa_id: '919924468844' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5OTI0NDY4ODQ0FQIAERgSNUFCMTMwQzgzOEJEQjcxQkFFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T12:46:12.453Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:46:12.833Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:46:12.870Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:46:20.368Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919924468844: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5OTI0NDY4ODQ0FQIAEhgUM0FCNEI3MDdGNjE1NDBFNDBGRTgA',
  timestamp: '1749991579'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5OTI0NDY4ODQ0FQIAERgSNUFCMTMwQzgzOEJEQjcxQkFFAA=="
  },
  "from": "919924468844",
  "id": "wamid.HBgMOTE5OTI0NDY4ODQ0FQIAEhgUM0FCNEI3MDdGNjE1NDBFNDBGRTgA",
  "timestamp": "1749991579",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "construction",
      "title": "🔨 બાંધકામ કાર્ય",
      "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919924468844
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919924468844
💬 [HANDLER] Message: "construction"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919924468844",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919924468844', wa_id: '919924468844' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5OTI0NDY4ODQ0FQIAERgSNUFBODJFNUQwQzdEMjlEMUQyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T12:46:22.746Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:46:23.256Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:46:23.416Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:46:28.921Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919924468844: {
  type: 'text',
  id: 'wamid.HBgMOTE5OTI0NDY4ODQ0FQIAEhgUM0E0Nzg1NDM0NDExQjlGRjk1ODQA',
  timestamp: '1749991588'
}
[WEBHOOK] Message content: {
  "from": "919924468844",
  "id": "wamid.HBgMOTE5OTI0NDY4ODQ0FQIAEhgUM0E0Nzg1NDM0NDExQjlGRjk1ODQA",
  "timestamp": "1749991588",
  "text": {
    "body": "15"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919924468844
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919924468844
💬 [HANDLER] Message: "15"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919924468844",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919924468844', wa_id: '919924468844' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5OTI0NDY4ODQ0FQIAERgSOEE1NDQ2QkEwRTM3OUUzMTI2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T12:46:31.547Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:46:32.211Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T12:46:32.452Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T13:20:21.704Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggM0I3NDAxOTFCMUZDODVENjg2N0Q0N0JCRkU3NkE1NTAA',
  timestamp: '1749993619'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggM0I3NDAxOTFCMUZDODVENjg2N0Q0N0JCRkU3NkE1NTAA",
  "timestamp": "1749993619",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T13:20:36.032Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUNDOUE1MjYzODMxMTk2QUREMDhBMzUxRDJBRTQ1REUA',
  timestamp: '1749993634'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUNDOUE1MjYzODMxMTk2QUREMDhBMzUxRDJBRTQ1REUA",
  "timestamp": "1749993634",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T13:21:32.854Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggREUwRUEwNTFBOEQ4OENFMjhBOTMwQjQyMDUxNUQyODMA',
  timestamp: '1749993691'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggREUwRUEwNTFBOEQ4OENFMjhBOTMwQjQyMDUxNUQyODMA",
  "timestamp": "1749993691",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🔐 Your verification code is: 166054\n\nThis code will expire in 10 minutes. Please enter this code to verify your employee account."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjZERTUwOUU5NDUwRUU2NDBGAA=='
    }
  ]
}
📲 OTP sent to +919723132143
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "👋 કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!\n\n🔐 સુરક્ષા માટે, કૃપા કરીને તમારું એકાઉન્ટ વેરિફાઈ કરો. મેં તમને 6-અંકનો વેરિફિકેશન કોડ મોકલ્યો છે.\n\nઆગળ વધવા માટે કૃપા કરીને કોડ દાખલ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQUQ5QTFGRUU4MjdDMjcxMEZBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T13:21:36.428Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T13:21:36.785Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T13:21:37.363Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T13:21:37.513Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T13:21:49.171Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTRCQkI5MjczQzhFOTI3RkJGMkU5REQ4REMxMzU2MUYA',
  timestamp: '1749993708'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTRCQkI5MjczQzhFOTI3RkJGMkU5REQ4REMxMzU2MUYA",
  "timestamp": "1749993708",
  "text": {
    "body": "166054"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "166054"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "Successfully verified! Welcome to the employee portal."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSN0E4MENBMTYxRkE0RkFBREVEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T13:21:52.001Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T13:21:52.287Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ B - વાણિજ્યિક માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjM0MTAzNDY3QURFMjhGNDdEAA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ B - વાણિજ્યિક\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-15T13:21:54.138Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTkyNjM3Qjc4NjY5Q0RDNzBFAA=='
    }
  ]
}
2025-06-15T13:21:54.318Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-15T13:21:55.248Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T13:21:55.485Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQ0NDOEVBOTE2RDMxNTcyNkQ5AA=='
    }
  ]
}
2025-06-15T13:21:56.791Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T13:21:57.126Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-15T13:22:02.387Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMjc4MjI5QTVFNDE3QTQwMkVERjgyNTdBNjNDQ0I4NjMA',
  timestamp: '1749993721'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTkyNjM3Qjc4NjY5Q0RDNzBFAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMjc4MjI5QTVFNDE3QTQwMkVERjgyNTdBNjNDQ0I4NjMA",
  "timestamp": "1749993721",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-15T13:22:43.165Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRENGQjJGQTM5Nzk4MzQ5MzI2NzBBNzJGNjM4RDgxM0QA',
  timestamp: '1749993762'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRENGQjJGQTM5Nzk4MzQ5MzI2NzBBNzJGNjM4RDgxM0QA",
  "timestamp": "1749993762",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:20:13.194Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOEYyQkVBN0Y4OUJBMEM0RDVBRkU1MEYyNzMyMjcyRDYA',
  timestamp: '1750051210'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOEYyQkVBN0Y4OUJBMEM0RDVBRkU1MEYyNzMyMjcyRDYA",
  "timestamp": "1750051210",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm notice
npm notice New minor version of npm available! 11.1.0 -> 11.4.2
npm notice Changelog: https://github.com/npm/cli/releases/tag/v11.4.2
npm notice To update run: npm install -g npm@11.4.2
npm notice
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_message_sent: boolean | null; ... 4 more ...; updated_at: Date | null; }': introduction_message_sent, introduction_message_sent_at, reminder_message_sent, reminder_message_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_message_sent: boolean | null; ... 4 more ...; updated_at: Date | null; }': introduction_message_sent, introduction_message_sent_at, reminder_message_sent, reminder_message_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_message_sent: boolean | null; ... 4 more ...; updated_at: Date | null; }': introduction_message_sent, introduction_message_sent_at, reminder_message_sent, reminder_message_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_message_sent: boolean | null; ... 4 more ...; updated_at: Date | null; }': introduction_message_sent, introduction_message_sent_at, reminder_message_sent, reminder_message_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T05:22:50.101Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTgyOTA3OERERjZCMDY3RjJBM0I0NDhDREFDNTE1NDIA',
  timestamp: '1750051369'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTgyOTA3OERERjZCMDY3RjJBM0I0NDhDREFDNTE1NDIA",
  "timestamp": "1750051369",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:25:32.076Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUIxOEYzRkJEMENEQzhDNTBGMQA=',
  timestamp: '1750051531'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUIxOEYzRkJEMENEQzhDNTBGMQA=",
  "timestamp": "1750051531",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting test mode. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2OTFERDI3Qjc2MDExNzE4MkQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:25:35.254Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can test both customer and employee flows.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "test_customer",
            "title": "👥 Test Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "test_employee",
            "title": "👷‍♂️ Test Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T05:25:35.619Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:35.869Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDNTVENTg1QjUyQzE2NzQ4MzMA'
    }
  ]
}
2025-06-16T05:25:36.157Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:36.766Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T05:25:37.197Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:37.466Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:37.689Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBRjZBQTZCN0VGQzE1NkYzM0MA'
    }
  ]
}
2025-06-16T05:25:38.609Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:38.941Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:38.965Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:38.991Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:41.804Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUI4RjIzMEQ5MDI1MzdENEI3NQA=',
  timestamp: '1750051541'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDNTVENTg1QjUyQzE2NzQ4MzMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUI4RjIzMEQ5MDI1MzdENEI3NQA=",
  "timestamp": "1750051541",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "test_employee",
      "title": "👷‍♂️ Test Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "test_employee"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧪 *Testing Employee Flow*\n\nYou are now in employee flow test mode. All employee features are available:\n• Activity logging with photo upload\n• Material requests\n• Dashboard viewing\n• Gujarati language support\n\n⚠️ *Note:* \n1. Employee flow requires site selection first\n2. Employee flow includes OTP verification (auto-verified for admin)\n\nType *exit* anytime to return to admin menu.\n\n---"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFODNFMTZEMUQ1MEI1NDgyNUMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:25:44.363Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🧪 [ADMIN-TEST] Employee flow session update intercepted: { step: 'select_site', data: { site_selection_shown: true } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T05:25:44.632Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:44.788Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:44.831Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwQ0M1MDc0RjYyRDJEQjQzODYA'
    }
  ]
}
2025-06-16T05:25:45.982Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:46.244Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:46.253Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:25:46.385Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:00.917Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU4N0JDRDRDMEUwODIwMjczMgA=',
  timestamp: '1750051560'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwQ0M1MDc0RjYyRDJEQjQzODYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU4N0JDRDRDMEUwODIwMjczMgA=",
  "timestamp": "1750051560",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_2",
      "title": "🏢 સાઈટ B - વાણિજ્યિક",
      "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_2"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: null, site_selection_shown: true },
  updated_at: 2025-06-16T05:26:01.852Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: null,
  data: { selected_site: 'site_2', site_selection_shown: true }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4ODg3Q0Y0ODE0RjA1NEFENUMA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNTA0ODNCM0Y4QTVBRDU4QkIA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: 'site_2', site_selection_shown: true },
  updated_at: 2025-06-16T05:26:01.852Z
}
2025-06-16T05:26:03.716Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:26:03.818Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:03.922Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:04.099Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:04.327Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T05:26:04.756Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:05.426Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:05.439Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzNzk4NUI5QzZEQzBENEEyMzgA'
    }
  ]
}
2025-06-16T05:26:06.011Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:06.681Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:06.685Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:06.743Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:11.530Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUFBN0I3QzlGRjFGOTdDNTI4OQA=',
  timestamp: '1750051570'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNTA0ODNCM0Y4QTVBRDU4QkIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUFBN0I3QzlGRjFGOTdDNTI4OQA=",
  "timestamp": "1750051570",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: 'site_2', site_selection_shown: true },
  updated_at: 2025-06-16T05:26:12.322Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  intent: 'log_activity',
  step: 'select_activity_type',
  data: {
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    employee_intent: null,
    site_id: undefined
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFMDE4MjlCMzVFRjAzQzk0ODAA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'select_activity_type',
  data: {
    selected_site: 'site_2',
    site_selection_shown: true,
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    employee_intent: null,
    site_id: undefined
  },
  updated_at: 2025-06-16T05:26:12.376Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:26:13.772Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:14.199Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:14.330Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:14.461Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:20.491Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUFCQUVEOTg1NTgzNkVFQUIyNQA=',
  timestamp: '1750051579'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFMDE4MjlCMzVFRjAzQzk0ODAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUFCQUVEOTg1NTgzNkVFQUIyNQA=",
  "timestamp": "1750051579",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'select_activity_type',
  data: {
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-16T05:26:21.447Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'enter_hours',
  data: {
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true,
    activity_type: 'inspection'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGN0UxODVDOEZCNkUzQkE1ODcA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'enter_hours',
  data: {
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true,
    activity_type: 'inspection'
  },
  updated_at: 2025-06-16T05:26:21.447Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:26:22.805Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:23.347Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:23.458Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:23.478Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:27.117Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNCMzFBMkZDRkJCQTE0NjY5OQA=',
  timestamp: '1750051586'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNCMzFBMkZDRkJCQTE0NjY5OQA=",
  "timestamp": "1750051586",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'enter_hours',
  data: {
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-16T05:26:28.060Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'enter_description',
  data: {
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true,
    hours: 1
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0NjU3ODg5NjI3NjIyREI4NkYA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'enter_description',
  data: {
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true,
    hours: 1
  },
  updated_at: 2025-06-16T05:26:28.061Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:26:29.596Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:29.828Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:29.911Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:26:30.134Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:46:38.194Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:46:39.365Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:46:41.289Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:46:42.722Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:46:43.690Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:46:45.624Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:52:11.297Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:54:42.731Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUI1MTNCNUFBNUNBNTczMDQ5MwA=',
  timestamp: '1750053281'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUI1MTNCNUFBNUNBNTczMDQ5MwA=",
  "timestamp": "1750053281",
  "text": {
    "body": "Test"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Test"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'enter_description',
  data: {
    hours: 1,
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-16T05:54:44.042Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'upload_image',
  data: {
    hours: 1,
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true,
    description: 'Test',
    upload_retry_count: 0
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCNjE1QTNDMTkzMjQxMkFDRUQA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    site_selection_shown: true,
    description: 'Test',
    upload_retry_count: 0
  },
  updated_at: 2025-06-16T05:54:44.043Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:54:45.847Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:54:46.320Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:54:46.562Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:54:55.822Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'image',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg4NkIzRkM1RjQxNjZEQjdEMAA=',
  timestamp: '1750053293'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg4NkIzRkM1RjQxNjZEQjdEMAA=",
  "timestamp": "1750053293",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "A56vSmRpzPER7SshiYDSxYaTcjzQ+k6zdUAtOK3QbVY=",
    "id": "1942151506596553"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    description: 'Test',
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    upload_retry_count: 0,
    site_selection_shown: true
  },
  updated_at: 2025-06-16T05:54:56.685Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "કૃપા કરીને ફોટો અપલોડ કરો અથવા 'skip' ટાઈપ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCRkY4QkExNDMwQzQyQTc1MjEA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    description: 'Test',
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    upload_retry_count: 0,
    site_selection_shown: true
  },
  updated_at: 2025-06-16T05:54:56.685Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:54:58.299Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:54:58.673Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:54:58.774Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:54:58.957Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:04.984Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI5MjRBQTU3NTIwQzgzRUFGNQA=',
  timestamp: '1750053304'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI5MjRBQTU3NTIwQzgzRUFGNQA=",
  "timestamp": "1750053304",
  "text": {
    "body": "skip"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "skip"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    description: 'Test',
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_2', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_2',
    employee_intent: null,
    upload_retry_count: 0,
    site_selection_shown: true
  },
  updated_at: 2025-06-16T05:55:05.844Z
}
Error logging activity: error: insert or update on table "activities" violates foreign key constraint "activities_site_id_sites_id_fk"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlowWrapper.completeActivityLog (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:362:30)
    at async EmployeeFlowWrapper.handleImageUpload (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:777:17)
    at async EmployeeFlowWrapper.handleActivityLogging (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:331:17)
    at async EmployeeFlowWrapper.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:273:13)
    at async EmployeeFlowWrapper.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:34:13)
    at async AdminFlow.handleTestFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:406:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:134:13) {
  length: 311,
  severity: 'ERROR',
  code: '23503',
  detail: 'Key (site_id)=(00000000-0000-0000-0000-000000000000) is not present in table "sites".',
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: 'public',
  table: 'activities',
  column: undefined,
  dataType: undefined,
  constraint: 'activities_site_id_sites_id_fk',
  file: 'ri_triggers.c',
  line: '2596',
  routine: 'ri_ReportViolation'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "માફ કરશો, તમારી પ્રવૃત્તિ નોંધવામાં ભૂલ થઈ. કૃપા કરીને ફરીથી પ્રયાસ કરો."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFM0RDOUQ2OEUxQzRDNzU3OEMA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow session clear intercepted
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: {},
  updated_at: 2025-06-16T05:55:06.942Z
}
✅ [DB] New client connected
2025-06-16T05:55:07.777Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:55:08.051Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:08.132Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:08.787Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:27.080Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'image',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ1NTNCMjYzMThBNEVBRjBERgA=',
  timestamp: '1750053325'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ1NTNCMjYzMThBNEVBRjBERgA=",
  "timestamp": "1750053325",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "EHAadkh8g63Q5+ABy9TIDqWU4SdRxjwW4nMDOVdirYU=",
    "id": "2120721551746211"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: null,
  data: { site_selection_shown: false, selected_site: null },
  updated_at: 2025-06-16T05:55:28.047Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: { step: 'select_site', data: { site_selection_shown: true } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGQjU0MEM3QzdBRUI4NzlFNEIA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { site_selection_shown: true, selected_site: null },
  updated_at: 2025-06-16T05:55:28.047Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:55:29.588Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:30.205Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:30.222Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:30.236Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:35.732Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUMwNTdCNTVDMkVCQjdEN0EyMAA=',
  timestamp: '1750053334'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGQjU0MEM3QzdBRUI4NzlFNEIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUMwNTdCNTVDMkVCQjdEN0EyMAA=",
  "timestamp": "1750053334",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: null, site_selection_shown: true },
  updated_at: 2025-06-16T05:55:36.603Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: null,
  data: { selected_site: 'site_1', site_selection_shown: true }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1NjRDQTAzRjY5NkU3RDMwRjYA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGQUVFQzE1RDgwMEVFNTU4RkEA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: 'site_1', site_selection_shown: true },
  updated_at: 2025-06-16T05:55:36.603Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:55:38.180Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:38.565Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:38.696Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:38.703Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:39.006Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T05:55:39.254Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:39.402Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:39.423Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGODRCNjlCMTk1RTI1QjkxOTQA'
    }
  ]
}
2025-06-16T05:55:40.424Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:41.052Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:41.119Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:41.142Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:47.942Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTU3N0ExNjRDMEUzQzY5OUJGRQA=',
  timestamp: '1750053347'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGQUVFQzE1RDgwMEVFNTU4RkEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTU3N0ExNjRDMEUzQzY5OUJGRQA=",
  "timestamp": "1750053347",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: null,
  step: 'select_site',
  data: { selected_site: 'site_1', site_selection_shown: true },
  updated_at: 2025-06-16T05:55:48.842Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  intent: 'log_activity',
  step: 'select_activity_type',
  data: {
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    employee_intent: null,
    site_id: undefined
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDQTk1QUExMEY2M0VGNUNCNjMA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'select_activity_type',
  data: {
    selected_site: 'site_1',
    site_selection_shown: true,
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    employee_intent: null,
    site_id: undefined
  },
  updated_at: 2025-06-16T05:55:48.903Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:55:50.314Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:50.596Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:50.727Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:50.763Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:55.915Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJFRjY3Q0RDQTM3MUE4RURGQwA=',
  timestamp: '1750053355'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDQTk1QUExMEY2M0VGNUNCNjMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJFRjY3Q0RDQTM3MUE4RURGQwA=",
  "timestamp": "1750053355",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'select_activity_type',
  data: {
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_1',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-16T05:55:56.732Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'enter_hours',
  data: {
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_1',
    employee_intent: null,
    site_selection_shown: true,
    activity_type: 'inspection'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFRDUzMzIwMTU0RTM2QkE3NEIA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'enter_hours',
  data: {
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_1',
    employee_intent: null,
    site_selection_shown: true,
    activity_type: 'inspection'
  },
  updated_at: 2025-06-16T05:55:56.733Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:55:58.285Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:58.620Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:58.773Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:55:58.833Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:56:07.162Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTE1QjhDMUMwQjE2QUE5MENDNAA=',
  timestamp: '1750053366'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTE1QjhDMUMwQjE2QUE5MENDNAA=",
  "timestamp": "1750053366",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'enter_hours',
  data: {
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_1',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-16T05:56:07.963Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'enter_description',
  data: {
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_1',
    employee_intent: null,
    site_selection_shown: true,
    hours: 1
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNUNDNjkyN0Y0MkZBMTcyRTQA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'enter_description',
  data: {
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_1',
    employee_intent: null,
    site_selection_shown: true,
    hours: 1
  },
  updated_at: 2025-06-16T05:56:07.963Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:56:09.631Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:56:09.786Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:56:09.909Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:56:10.029Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:56:15.591Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUwMzJFQUZEQkRGOTE4NjU2NAA=',
  timestamp: '1750053374'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUwMzJFQUZEQkRGOTE4NjU2NAA=",
  "timestamp": "1750053374",
  "text": {
    "body": "Test"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Test"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'enter_description',
  data: {
    hours: 1,
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_1',
    employee_intent: null,
    site_selection_shown: true
  },
  updated_at: 2025-06-16T05:56:16.578Z
}
🧪 [ADMIN-TEST] Employee flow session update intercepted: {
  step: 'upload_image',
  data: {
    hours: 1,
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_1',
    employee_intent: null,
    site_selection_shown: true,
    description: 'Test',
    upload_retry_count: 0
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFODhGQkE3MjUxOTlFNjU5QjYA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_1',
    employee_intent: null,
    site_selection_shown: true,
    description: 'Test',
    upload_retry_count: 0
  },
  updated_at: 2025-06-16T05:56:16.578Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:56:18.035Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:56:18.335Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:56:18.480Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:56:18.500Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:56:26.692Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'image',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTZGQUU3RDBDQTJCMzRGQ0I4RAA=',
  timestamp: '1750053384'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTZGQUU3RDBDQTJCMzRGQ0I4RAA=",
  "timestamp": "1750053384",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "WtiivzFWFqhqi9uKyiyMCNJ52KYCdh1Dpz1WEBV7FK0=",
    "id": "4146809645581841"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-TEST] Employee flow state before: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    description: 'Test',
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_1',
    employee_intent: null,
    upload_retry_count: 0,
    site_selection_shown: true
  },
  updated_at: 2025-06-16T05:56:27.770Z
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "કૃપા કરીને ફોટો અપલોડ કરો અથવા 'skip' ટાઈપ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFMDZGM0I5NEMyNEVCNkZERjgA'
    }
  ]
}
🧪 [ADMIN-TEST] Employee flow state after: {
  phone: '+19088483575',
  intent: 'log_activity',
  step: 'upload_image',
  data: {
    hours: 1,
    description: 'Test',
    activity_type: 'inspection',
    employee_data: { selected_site: 'site_1', site_selection_shown: true },
    employee_step: 'select_site',
    original_role: 'admin',
    selected_site: 'site_1',
    employee_intent: null,
    upload_retry_count: 0,
    site_selection_shown: true
  },
  updated_at: 2025-06-16T05:56:27.770Z
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T05:56:29.300Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:56:29.651Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:56:29.852Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T05:56:29.975Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_sent: boolean | null; introduction_sent_at: Date | null; created_at: Date | null; updated_at: Date | null; }': introduction_sent, introduction_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_sent: boolean | null; introduction_sent_at: Date | null; created_at: Date | null; updated_at: Date | null; }': introduction_sent, introduction_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_sent: boolean | null; introduction_sent_at: Date | null; created_at: Date | null; updated_at: Date | null; }': introduction_sent, introduction_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_sent: boolean | null; introduction_sent_at: Date | null; created_at: Date | null; updated_at: Date | null; }': introduction_sent, introduction_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_sent: boolean | null; introduction_sent_at: Date | null; created_at: Date | null; updated_at: Date | null; }': introduction_sent, introduction_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_sent: boolean | null; introduction_sent_at: Date | null; created_at: Date | null; updated_at: Date | null; }': introduction_sent, introduction_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_sent: boolean | null; introduction_sent_at: Date | null; created_at: Date | null; updated_at: Date | null; }': introduction_sent, introduction_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_sent: boolean | null; introduction_sent_at: Date | null; created_at: Date | null; updated_at: Date | null; }': introduction_sent, introduction_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_sent: boolean | null; introduction_sent_at: Date | null; created_at: Date | null; updated_at: Date | null; }': introduction_sent, introduction_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_sent: boolean | null; introduction_sent_at: Date | null; created_at: Date | null; updated_at: Date | null; }': introduction_sent, introduction_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/messageHandler.ts(109,9): error TS2739: Type '{ id: string; phone: string; role: "customer"; name: string; email: null; is_verified: false; verified_at: null; created_at: Date; updated_at: Date; }' is missing the following properties from type '{ id: string; name: string | null; phone: string; role: "employee" | "customer" | "admin"; email: string | null; is_verified: boolean | null; verified_at: Date | null; introduction_sent: boolean | null; introduction_sent_at: Date | null; created_at: Date | null; updated_at: Date | null; }': introduction_sent, introduction_sent_at
src/services/messageHandler.ts(121,49): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(160,41): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(166,46): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(167,11): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(175,18): error TS18047: 'user' is possibly 'null'.
src/services/messageHandler.ts(182,18): error TS18047: 'user' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T06:04:52.107Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUZGRjEyMEU0NDczRjI4Q0Q5MAA=',
  timestamp: '1750053890'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUZGRjEyMEU0NDczRjI4Q0Q5MAA=",
  "timestamp": "1750053890",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFM0EwREM3QTAwNzA5MUE2RjUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:04:55.405Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:04:55.646Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:04:55.866Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4RkNENzUyNjZBMDg4NUMzOTYA'
    }
  ]
}
2025-06-16T06:04:56.908Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:04:57.430Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:04:57.454Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:04:57.541Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:01.250Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg1QjkyNEQ1NkVBQjQ5MUI0MgA=',
  timestamp: '1750053900'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFM0EwREM3QTAwNzA5MUE2RjUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg1QjkyNEQ1NkVBQjQ5MUI0MgA=",
  "timestamp": "1750053900",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\nType *exit* anytime to return to admin menu."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGM0MwRkIyOUE3Q0IwRTQxNkYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:05:03.957Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:05:04.246Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:04.354Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:04.508Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1NDMxRUJBMEM2NTEwOUI4OTMA'
    }
  ]
}
2025-06-16T06:05:05.349Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:05.807Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:06.062Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:06.088Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:16.772Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNEODMxN0M2NDBCMDU5QzVGOQA=',
  timestamp: '1750053915'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1NDMxRUJBMEM2NTEwOUI4OTMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNEODMxN0M2NDBCMDU5QzVGOQA=",
  "timestamp": "1750053915",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4MENFN0E1NDdCMkZFRTEyMDAA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQTk1N0RGMjM2RDdCQjcyQkEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:05:19.464Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:19.522Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:19.774Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:19.831Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:20.150Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:05:20.629Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:20.662Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:20.893Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4QkQ5MEFBQjYxQTgxMTREMjkA'
    }
  ]
}
2025-06-16T06:05:22.145Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:22.483Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM2RTc1MEMxRDYxOEQ0OUFBRgA=',
  timestamp: '1750053921'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQTk1N0RGMjM2RDdCQjcyQkEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM2RTc1MEMxRDYxOEQ0OUFBRgA=",
  "timestamp": "1750053921",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
2025-06-16T06:05:22.626Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👁️ [HANDLER] Marking message as read...
2025-06-16T06:05:22.694Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:22.736Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:05:32.031Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU0QkY1NTU2QjUxMjgyOTFFRAA=',
  timestamp: '1750053931'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQTk1N0RGMjM2RDdCQjcyQkEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU0QkY1NTU2QjUxMjgyOTFFRAA=",
  "timestamp": "1750053931",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "request_materials",
      "title": "📦 સામગ્રીની માંગ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "request_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:05:47.326Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:05:59.679Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUzMDk2MzY5RDUwOEEzQTkxQwA=',
  timestamp: '1750053959'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUzMDk2MzY5RDUwOEEzQTkxQwA=",
  "timestamp": "1750053959",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFQ0ZFNTE0MjQzQjE1MzczREYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:06:02.240Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T06:06:02.451Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:02.476Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:02.526Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NkE0RjRDNjQ1RTMwREM2NzkA'
    }
  ]
}
2025-06-16T06:06:03.670Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:06:04.201Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:04.236Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:04.441Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJENjAxMDVCQjM1MkNGMDlDMDgA'
    }
  ]
}
2025-06-16T06:06:05.412Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:05.895Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:06.238Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:08.017Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ3OEQ3MEFBRTQxMjRERTg4OAA=',
  timestamp: '1750053967'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NkE0RjRDNjQ1RTMwREM2NzkA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ3OEQ3MEFBRTQxMjRERTg4OAA=",
  "timestamp": "1750053967",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "customer_flow",
      "title": "👥 Customer Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "customer_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Customer*\n\nYou are now acting as a customer. All actions will be recorded as real customer records.\nType *exit* anytime to return to admin menu."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEQ0M4RTU1MzM0QkZCQTUxQUUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:06:10.533Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
Handling message for +19088483575: { messageText: 'start', intent: null, step: null }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
2025-06-16T06:06:10.862Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:11.134Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:11.256Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1RTdCQjk3NTExQ0E3OTJGQzEA'
    }
  ]
}
2025-06-16T06:06:12.419Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:12.711Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:12.832Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:12.854Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:06:26.335Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVFMDBFRjBDM0ZBQ0VDQkZEQwA=',
  timestamp: '1750053985'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVFMDBFRjBDM0ZBQ0VDQkZEQwA=",
  "timestamp": "1750053985",
  "text": {
    "body": "yes"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "yes"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
Handling message for +19088483575: { messageText: 'yes', intent: 'impersonate_customer', step: 'active' }
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:09:08.124Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURFODYwRTA2OUFBNEZFNzUyMQA=',
  timestamp: '1750054146'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURFODYwRTA2OUFBNEZFNzUyMQA=",
  "timestamp": "1750054146",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting customer impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxMDZGRTgyOUZCMTg0QjdEMUIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:09:11.132Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T06:09:11.551Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:11.861Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:11.943Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyODNBQUYwMTdCN0I1RjgyRjgA'
    }
  ]
}
2025-06-16T06:09:13.031Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:09:13.370Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:13.647Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:13.856Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzNDU3QjRCODZGREIzRDEzNkUA'
    }
  ]
}
2025-06-16T06:09:15.062Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:15.413Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUYwNjc1MkQ4RDkwMkM4NDQxOQA=',
  timestamp: '1750054154'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyODNBQUYwMTdCN0I1RjgyRjgA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUYwNjc1MkQ4RDkwMkM4NDQxOQA=",
  "timestamp": "1750054154",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
2025-06-16T06:09:15.534Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:15.551Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-16T06:09:15.824Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\nType *exit* anytime to return to admin menu."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NjMzRjlGODkzMTY3NUU1RDEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:09:18.331Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:09:18.679Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:18.877Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:18.943Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDNTIzNzJDREUyRDE4NTM2MzEA'
    }
  ]
}
2025-06-16T06:09:20.044Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:20.339Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:20.530Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:20.587Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:25.415Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNFQ0Y0QjZDMkI2NjY2NUJDNAA=',
  timestamp: '1750054164'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDNTIzNzJDREUyRDE4NTM2MzEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTNFQ0Y0QjZDMkI2NjY2NUJDNAA=",
  "timestamp": "1750054164",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MUVFOEE4QUQxRkI4Q0U5RjkA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T06:09:29.488Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QjlEMzMzQjExNkY4OTAyMjgA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:09:29.913Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:09:31.143Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:31.144Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:31.392Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:32.248Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:32.281Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:32.375Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:32.538Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUMwOTEyRUE4QjQ5MjM4QTE5QQA=',
  timestamp: '1750054171'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QjlEMzMzQjExNkY4OTAyMjgA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUMwOTEyRUE4QjQ5MjM4QTE5QQA=",
  "timestamp": "1750054171",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCNjFBOTUxMTU4NEFCRDAxMDIA'
    }
  ]
}
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-16T06:09:33.466Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
2025-06-16T06:09:33.784Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:34.151Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:09:34.517Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:09:40.634Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY5RTlBQkUwRkZGRUQ5Q0RFNQA=',
  timestamp: '1750054179'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QjlEMzMzQjExNkY4OTAyMjgA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY5RTlBQkUwRkZGRUQ5Q0RFNQA=",
  "timestamp": "1750054179",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "request_materials",
      "title": "📦 સામગ્રીની માંગ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "request_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:09:50.493Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ0NDlFQ0Y2Q0Q1NTVBM0EyMQA=',
  timestamp: '1750054189'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QjlEMzMzQjExNkY4OTAyMjgA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ0NDlFQ0Y2Q0Q1NTVBM0EyMQA=",
  "timestamp": "1750054189",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "track_invoices",
      "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "track_invoices"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:18:32.206Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVFN0RDMjQyNDVGQzc4OUVEMgA=',
  timestamp: '1750054710'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVFN0RDMjQyNDVGQzc4OUVEMgA=",
  "timestamp": "1750054710",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGRkFFMDAzNkIyQkFFMEZEQkIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T06:18:35.865Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:36.096Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:36.126Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:36.336Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MEE1RkEzNDNCMDE5N0FEMDMA'
    }
  ]
}
2025-06-16T06:18:37.324Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:18:37.551Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:37.554Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:37.643Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2RTUwM0I3QjRERDg1RTFFMEYA'
    }
  ]
}
2025-06-16T06:18:38.795Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:39.105Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:39.176Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:39.348Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTBBMTlEQkNBOERBREJERTE1MAA=',
  timestamp: '1750054718'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MEE1RkEzNDNCMDE5N0FEMDMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTBBMTlEQkNBOERBREJERTE1MAA=",
  "timestamp": "1750054718",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
2025-06-16T06:18:39.598Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\nType *exit* anytime to return to admin menu."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzRTE5OTc2MkM5NzBDQjk2NUIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:18:45.007Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:18:45.539Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:45.598Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:45.610Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxODQ5MjZCNzAyRkY0MTZBQzEA'
    }
  ]
}
2025-06-16T06:18:46.800Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:47.269Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:47.284Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:47.342Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:18:51.611Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU3QkZDNDQ0QkFEMjg5MzlERQA=',
  timestamp: '1750054730'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxODQ5MjZCNzAyRkY0MTZBQzEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU3QkZDNDQ0QkFEMjg5MzlERQA=",
  "timestamp": "1750054730",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
❌ [TIMEOUT] Database connection test failed: Error: Database connection test timed out after 3000ms
    at Timeout.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:18:20)
    at listOnTimeout (node:internal/timers:581:17)
    at process.processTimers (node:internal/timers:519:7)
⚠️ [HANDLER] Database not available, continuing without DB features
👁️ [HANDLER] Marking message as read...
❌ [TIMEOUT] Mark as read failed: Error: Mark as read timed out after 2000ms
    at Timeout.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:18:20)
    at listOnTimeout (node:internal/timers:581:17)
    at process.processTimers (node:internal/timers:519:7)
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
⚠️ [HANDLER] Using temporary session (DB unavailable)
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MEVEMjExOUUxNjVFMzM2QjcA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:19:00.385Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:19:00.844Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:00.886Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:00.967Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEMzNDRTY1NUI4RUQwNkQ2Q0YA'
    }
  ]
}
2025-06-16T06:19:02.167Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:02.454Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:02.632Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:02.667Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:05.873Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUZBRjc2MEVGQzYzRDUzRUY4RAA=',
  timestamp: '1750054743'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MEVEMjExOUUxNjVFMzM2QjcA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUZBRjc2MEVGQzYzRDUzRUY4RAA=",
  "timestamp": "1750054743",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "કૃપા કરીને યાદીમાંથી યોગ્ય સાઈટ પસંદ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxRjNGMUIzRjc2NjlFQ0RBQTEA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:19:08.894Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NjA4RTdBODg0NEQyQjFBNDgA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:19:09.300Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:09.406Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:09.453Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:09.901Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:10.191Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:10.226Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:10.291Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:15.615Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTk4MDBFQjJDMEZERTU2RjY1OAA=',
  timestamp: '1750054754'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NjA4RTdBODg0NEQyQjFBNDgA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTk4MDBFQjJDMEZERTU2RjY1OAA=",
  "timestamp": "1750054754",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NDA1MzVBMjNBMkM3OEYwNDIA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T06:19:18.055Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyMEE2MEQwMDQ5QzJEMzY3QzMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:19:18.589Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:18.618Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:18.680Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:19.208Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:19:19.389Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:19.592Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:19.594Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyNzM3NEZEOTM2RkVFQTkxRTQA'
    }
  ]
}
2025-06-16T06:19:21.114Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:21.377Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTczNUI0RjgyM0QxQUNDMjRGOAA=',
  timestamp: '1750054760'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyMEE2MEQwMDQ5QzJEMzY3QzMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTczNUI0RjgyM0QxQUNDMjRGOAA=",
  "timestamp": "1750054760",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
2025-06-16T06:19:21.492Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:19:21.607Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-16T06:19:21.879Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:19:32.668Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM3NkVFRkZDMEU5NDhFRDUyMAA=',
  timestamp: '1750054771'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyMEE2MEQwMDQ5QzJEMzY3QzMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM3NkVFRkZDMEU5NDhFRDUyMAA=",
  "timestamp": "1750054771",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "request_materials",
      "title": "📦 સામગ્રીની માંગ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "request_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:21:40.948Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTU0RUNDNjk2MzBDNEU1QjRGRgA=',
  timestamp: '1750054899'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTU0RUNDNjk2MzBDNEU1QjRGRgA=",
  "timestamp": "1750054899",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyRDZGNzY5QzFCQkM4RjQ3RDYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:21:44.093Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T06:21:44.846Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QjA3NEU3OUQxQzcwNjFCNkYA'
    }
  ]
}
2025-06-16T06:21:45.113Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:45.114Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:45.825Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:21:46.200Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:46.456Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:46.658Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGMzRBNDk5QTgyRDI5MUQ0QzcA'
    }
  ]
}
2025-06-16T06:21:47.536Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:47.990Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:47.991Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:48.117Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:50.028Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVDRjVBQ0RDNTMyMTk0QkUzMgA=',
  timestamp: '1750054909'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QjA3NEU3OUQxQzcwNjFCNkYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVDRjVBQ0RDNTMyMTk0QkUzMgA=",
  "timestamp": "1750054909",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\nType *exit* anytime to return to admin menu."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGQThGMDBGOURDQjE4NTk1OTIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:21:52.418Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:21:52.750Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:52.787Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:52.936Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBRDNGODgyNDk3MkQyQjU2NjAA'
    }
  ]
}
2025-06-16T06:21:54.166Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:54.473Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:54.557Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:54.775Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:21:58.803Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJEMkZFMzZCOTFFNUFBRUI1MAA=',
  timestamp: '1750054918'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBRDNGODgyNDk3MkQyQjU2NjAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJEMkZFMzZCOTFFNUFBRUI1MAA=",
  "timestamp": "1750054918",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEOTU3OThGQUFFNUY0NTRGNzcA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMzg1NkFCRENFNzYwNDg5RTMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:22:01.396Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:22:01.725Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:22:01.786Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:22:01.967Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:22:02.087Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:22:02.679Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:22:02.747Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:22:02.863Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2RDlEMjlFQzVDQ0I0ODJBRjEA'
    }
  ]
}
2025-06-16T06:22:03.736Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:22:04.185Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:22:04.241Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:22:04.282Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:22:06.195Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFDOTY0QkYwODQwMjYyNjhBMQA=',
  timestamp: '1750054925'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMzg1NkFCRENFNzYwNDg5RTMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFDOTY0QkYwODQwMjYyNjhBMQA=",
  "timestamp": "1750054925",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:24:02.000Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ4OTcxMjc3QTZGQzFFMDQ1QwA=',
  timestamp: '1750055040'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ4OTcxMjc3QTZGQzFFMDQ1QwA=",
  "timestamp": "1750055040",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NzMxRkZERjc0REM4NTQxOEIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:24:05.143Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T06:24:05.543Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:05.783Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2NzhDOTgxNjFBNEE1OEZCNTgA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:24:07.036Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:07.041Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:07.060Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:07.282Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNzY5MDA3RkMwRDc2NEE2OTkA'
    }
  ]
}
2025-06-16T06:24:08.403Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:08.984Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:09.227Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:09.266Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:10.142Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUwMjg1RDExQzY1Qzk2RDNDNAA=',
  timestamp: '1750055049'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2NzhDOTgxNjFBNEE1OEZCNTgA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUwMjg1RDExQzY1Qzk2RDNDNAA=",
  "timestamp": "1750055049",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\nType *exit* anytime to return to admin menu."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5RTY5OTZFRjEwNDk5QTQ2REYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:24:12.459Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:24:12.895Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:12.984Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:13.254Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMkNCNUJCMkE5OTQ0MkExNzYA'
    }
  ]
}
2025-06-16T06:24:14.446Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:14.643Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:14.773Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:14.893Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:20.353Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY3QTMxRkNFRjRDQkQyODY4NAA=',
  timestamp: '1750055059'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMkNCNUJCMkE5OTQ0MkExNzYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY3QTMxRkNFRjRDQkQyODY4NAA=",
  "timestamp": "1750055059",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4MEQyQzU2RkJBNTY1MDlCMDcA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T06:24:22.756Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5NURCRDM4QjRGOERFNDZCQzgA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:24:23.279Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:23.360Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:23.386Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:23.544Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:24:23.834Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:23.964Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:24.145Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCRUEyN0YwOTAxREJDRTYyNTAA'
    }
  ]
}
2025-06-16T06:24:25.415Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:25.677Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ1RkY3QzRCMEQzQzg0ODQ4NgA=',
  timestamp: '1750055064'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5NURCRDM4QjRGOERFNDZCQzgA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ1RkY3QzRCMEQzQzg0ODQ4NgA=",
  "timestamp": "1750055064",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-16T06:24:25.953Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:25.975Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:24:26.220Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:24:35.952Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJCQzM2M0JBQ0YwMkMxNzhENgA=',
  timestamp: '1750055075'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5NURCRDM4QjRGOERFNDZCQzgA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJCQzM2M0JBQ0YwMkMxNzhENgA=",
  "timestamp": "1750055075",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "request_materials",
      "title": "📦 સામગ્રીની માંગ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "request_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 5s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T06:26:00.977Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTAxQkMyNjhCOUE2REMyRDQ2MwA=',
  timestamp: '1750055159'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTAxQkMyNjhCOUE2REMyRDQ2MwA=",
  "timestamp": "1750055159",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: none
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Menu',
  sessionIntent: 'impersonate_employee',
  sessionStep: null,
  sessionData: '{"selected_site":"site_1","site_selection_shown":true}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "selected_site": "site_1",
  "site_selection_shown": true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDQTQ2MUM4NkM1RkI3QjNERTUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:26:03.709Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T06:26:04.381Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:04.700Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNUNBRTJDOTg1RURFOTQyRTQA'
    }
  ]
}
2025-06-16T06:26:05.435Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:26:05.901Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:05.996Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:06.257Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1Qjk3RTgzMzUzQUE5RUEzRUMA'
    }
  ]
}
2025-06-16T06:26:07.399Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:07.711Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM3RjcxREE5RTUyNTA5NkE1RgA=',
  timestamp: '1750055167'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNUNBRTJDOTg1RURFOTQyRTQA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM3RjcxREE5RTUyNTA5NkE1RgA=",
  "timestamp": "1750055167",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
2025-06-16T06:26:07.734Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-16T06:26:07.949Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:07.980Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'employee_flow',
  sessionIntent: null,
  sessionStep: null,
  sessionData: '{}'
}
🧪 [ADMIN-MAIN] Routing to handleMainMenu
🧪 [ADMIN-START] Starting employee impersonation for: +19088483575
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\nType *exit* anytime to return to admin menu."
  }
}
2025-06-16T06:26:09.173Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTgyQTkzQzQ3MUVFN0ZFMTgyMQA=',
  timestamp: '1750055141'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTgyQTkzQzQ3MUVFN0ZFMTgyMQA=",
  "timestamp": "1750055141",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyNjYyN0M4OEIwOTQ0M0NCMEIA'
    }
  ]
}
🧪 [ADMIN-START] Initial employee session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {},
  "updated_at": "2025-06-16T06:26:09.245Z"
}
🧪 [ADMIN-START] Impersonated user: {
  "id": "2a155060-c282-4560-bf1e-6502ee5b10dd",
  "phone": "+19088483575",
  "role": "employee",
  "name": "Yash Patel",
  "email": "bojrick@gmail.com",
  "is_verified": true,
  "verified_at": "2025-05-30T05:47:50.157Z",
  "introduction_sent": false,
  "introduction_sent_at": null,
  "created_at": "2025-05-30T05:47:50.141Z",
  "updated_at": "2025-05-30T05:47:50.141Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Menu',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"original_role":"admin"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "original_role": "admin"
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
2025-06-16T06:26:10.161Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🧪 [ADMIN-START] Calling employeeFlow.handleMessage with "start"
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:26:10.393Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:10.583Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2NEUwRTlEQ0YxNzE0Qjk5MTIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:26:10.922Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwRjc1NzE4NEI0N0I3QTA5RTkA'
    }
  ]
}
🧪 [ADMIN-START] Employee session after start: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {},
  "updated_at": "2025-06-16T06:26:09.245Z"
}
🧪 [ADMIN-START] Latest session from DB after start: {
  "phone": "+19088483575",
  "intent": null,
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:26:10.247Z"
}
🧪 [ADMIN-START] Final admin session data saved
2025-06-16T06:26:11.467Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T06:26:11.758Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:11.879Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:12.018Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:12.020Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:12.284Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFRUYwMjhCRkQ1MTBEQ0VDRkYA'
    }
  ]
}
2025-06-16T06:26:12.407Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:12.434Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:13.064Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:26:13.475Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:13.504Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:13.730Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFQzJCQjBCNUI2NjVBMjY0QjQA'
    }
  ]
}
2025-06-16T06:26:14.759Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:14.983Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:15.120Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:15.169Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:17.336Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdDMUI5QjkyN0UyNkU3NDFDOAA=',
  timestamp: '1750055176'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwRjc1NzE4NEI0N0I3QTA5RTkA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdDMUI5QjkyN0UyNkU3NDFDOAA=",
  "timestamp": "1750055176",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'site_1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":null}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": null
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": null,
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:26:18.093Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyMTAzNjc5RkI1NDU0NkI5MTUA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1OEY4ODVEOEFCMTgzRTVERDcA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": null,
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:26:18.093Z"
}
2025-06-16T06:26:19.789Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:26:18.093Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:26:20.059Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:20.277Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:20.301Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:20.521Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:20.759Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:20.761Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:26:20.938Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzNTIxQTdCMjUyQkE4NTVBMkIA'
    }
  ]
}
2025-06-16T06:26:22.442Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:22.632Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:22.706Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:22.835Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJDNjA4RjkxODhEM0I1QTMxMQA=',
  timestamp: '1750055181'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1OEY4ODVEOEFCMTgzRTVERDcA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJDNjA4RjkxODhEM0I1QTMxMQA=",
  "timestamp": "1750055181",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
2025-06-16T06:26:22.872Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":"impersonate_employee"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": "impersonate_employee"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:26:23.609Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: log_activity
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:26:23.609Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "active",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": "select_site",
    "original_role": "admin",
    "employee_intent": "impersonate_employee"
  },
  "updated_at": "2025-06-16T06:26:19.867Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:26:44.218Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM2ODNBNDdFRkJGRkFGODU1MAA=',
  timestamp: '1750055203'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1OEY4ODVEOEFCMTgzRTVERDcA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM2ODNBNDdFRkJGRkFGODU1MAA=",
  "timestamp": "1750055203",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "request_materials",
      "title": "📦 સામગ્રીની માંગ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "request_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'request_materials',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":"impersonate_employee"},"employee_step":"active","original_role":"admin","employee_intent":"impersonate_employee"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": "select_site",
    "original_role": "admin",
    "employee_intent": "impersonate_employee"
  },
  "employee_step": "active",
  "original_role": "admin",
  "employee_intent": "impersonate_employee"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "active",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": "select_site",
    "original_role": "admin",
    "employee_intent": "impersonate_employee"
  },
  "updated_at": "2025-06-16T06:26:45.242Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: request_materials
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxOEFENEU3ODc4MzhEMTUxQjYA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "active",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": "select_site",
    "original_role": "admin",
    "employee_intent": "impersonate_employee"
  },
  "updated_at": "2025-06-16T06:26:45.242Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:26:45.242Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:26:46.673Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:47.293Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:47.323Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:47.449Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:26:57.721Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQwNUIyNEU5NEFDNkZERDE1MgA=',
  timestamp: '1750055216'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxOEFENEU3ODc4MzhEMTUxQjYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQwNUIyNEU5NEFDNkZERDE1MgA=",
  "timestamp": "1750055216",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'site_1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":"impersonate_employee"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": "impersonate_employee"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:26:58.650Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzOTc0Njg5QjM0MkQ4N0QzMUEA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T06:27:00.213Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMkZBOUU0MTNEQjVBRTQ0RkEA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:26:58.650Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:26:58.650Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:27:00.646Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:00.693Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:00.802Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:00.915Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:27:01.361Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:01.392Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:01.449Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDNzhENjI3MjAwODE3Rjg4M0MA'
    }
  ]
}
2025-06-16T06:27:02.671Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:03.024Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFFMzhEREM5Q0E4NjA0RUVCOAA=',
  timestamp: '1750055222'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMkZBOUU0MTNEQjVBRTQ0RkEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFFMzhEREM5Q0E4NjA0RUVCOAA=",
  "timestamp": "1750055222",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
2025-06-16T06:27:03.103Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👁️ [HANDLER] Marking message as read...
2025-06-16T06:27:03.148Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:03.171Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":"impersonate_employee"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": "impersonate_employee"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:27:03.810Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: log_activity
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:27:03.810Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "active",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": "select_site",
    "original_role": "admin",
    "employee_intent": "impersonate_employee"
  },
  "updated_at": "2025-06-16T06:27:00.331Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:27:13.960Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUVBRTZDOTY3MEFBNTVENjY4RgA=',
  timestamp: '1750055232'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMkZBOUU0MTNEQjVBRTQ0RkEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUVBRTZDOTY3MEFBNTVENjY4RgA=",
  "timestamp": "1750055232",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "request_materials",
      "title": "📦 સામગ્રીની માંગ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "request_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'request_materials',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":"impersonate_employee"},"employee_step":"active","original_role":"admin","employee_intent":"impersonate_employee"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": "select_site",
    "original_role": "admin",
    "employee_intent": "impersonate_employee"
  },
  "employee_step": "active",
  "original_role": "admin",
  "employee_intent": "impersonate_employee"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "active",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": "select_site",
    "original_role": "admin",
    "employee_intent": "impersonate_employee"
  },
  "updated_at": "2025-06-16T06:27:15.135Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: request_materials
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3OUVBQkJEMTk5NkI1RjVCMUEA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "active",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": "select_site",
    "original_role": "admin",
    "employee_intent": "impersonate_employee"
  },
  "updated_at": "2025-06-16T06:27:15.135Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:27:15.135Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:27:16.722Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:17.193Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:17.196Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:17.242Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:21.182Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFGNUZDNTk2MUM2OUNGOTQ2RQA=',
  timestamp: '1750055240'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3OUVBQkJEMTk5NkI1RjVCMUEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFGNUZDNTk2MUM2OUNGOTQ2RQA=",
  "timestamp": "1750055240",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'site_1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":"impersonate_employee"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": "impersonate_employee"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:27:22.072Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxMzMzMzE2OEY0MzZDQUNBMTQA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T06:27:23.672Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NjVFMzUyMDIyQUI4QjgxNTYA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:27:22.072Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:27:22.072Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:27:24.125Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:24.323Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:24.425Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:24.785Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:27:24.994Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:25.019Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:25.083Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QTZGRDIwMkVFMTE2MjI4QkYA'
    }
  ]
}
2025-06-16T06:27:26.424Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:26.702Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:26.852Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:26.942Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:27:28.442Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUNBQTkwODk5N0YwNDMxRjdFMwA=',
  timestamp: '1750055247'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NjVFMzUyMDIyQUI4QjgxNTYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUNBQTkwODk5N0YwNDMxRjdFMwA=",
  "timestamp": "1750055247",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":"impersonate_employee"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": "impersonate_employee"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:27:29.228Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: log_activity
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:27:29.228Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "active",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": "select_site",
    "original_role": "admin",
    "employee_intent": "impersonate_employee"
  },
  "updated_at": "2025-06-16T06:27:23.881Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:31:00.272Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTA5QjAyRUI1MDNDNTE4MzgyQwA=',
  timestamp: '1750055459'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTA5QjAyRUI1MDNDNTE4MzgyQwA=",
  "timestamp": "1750055459",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Menu',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":"impersonate_employee"},"employee_step":"active","original_role":"admin","employee_intent":"impersonate_employee"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": "select_site",
    "original_role": "admin",
    "employee_intent": "impersonate_employee"
  },
  "employee_step": "active",
  "original_role": "admin",
  "employee_intent": "impersonate_employee"
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwNEIxNTA4MUFFMDkwQ0VDOTMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:31:03.417Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T06:31:04.075Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:04.345Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDNDlGQTkwOTExRUI4QjY5NjAA'
    }
  ]
}
2025-06-16T06:31:04.522Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:05.210Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:31:05.592Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:05.850Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:05.943Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0OTcxQkJEMzEwRDAzRjY0N0QA'
    }
  ]
}
2025-06-16T06:31:07.031Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:07.258Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:07.274Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:07.501Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:10.944Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdENDlFRkI0ODY4NUI2MjczMQA=',
  timestamp: '1750055469'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDNDlGQTkwOTExRUI4QjY5NjAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdENDlFRkI0ODY4NUI2MjczMQA=",
  "timestamp": "1750055469",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'employee_flow',
  sessionIntent: null,
  sessionStep: null,
  sessionData: '{}'
}
🧪 [ADMIN-MAIN] Routing to handleMainMenu
🧪 [ADMIN-START] Starting employee impersonation for: +19088483575
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\nType *exit* anytime to return to admin menu."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFNTVDNEYyODhCQTA0NTU1QTkA'
    }
  ]
}
🧪 [ADMIN-START] Initial employee session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {},
  "updated_at": "2025-06-16T06:31:12.515Z"
}
🧪 [ADMIN-START] Impersonated user: {
  "id": "2a155060-c282-4560-bf1e-6502ee5b10dd",
  "phone": "+19088483575",
  "role": "employee",
  "name": "Yash Patel",
  "email": "bojrick@gmail.com",
  "is_verified": true,
  "verified_at": "2025-05-30T05:47:50.157Z",
  "introduction_sent": false,
  "introduction_sent_at": null,
  "created_at": "2025-05-30T05:47:50.141Z",
  "updated_at": "2025-05-30T05:47:50.141Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:31:13.279Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🧪 [ADMIN-START] Calling employeeFlow.handleMessage with "start"
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:31:13.751Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:13.815Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:13.990Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1RkY1MUIyNTE1NTNEODJDRTkA'
    }
  ]
}
🧪 [ADMIN-START] Employee session after start: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {},
  "updated_at": "2025-06-16T06:31:12.515Z"
}
🧪 [ADMIN-START] Latest session from DB after start: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:31:13.516Z"
}
🧪 [ADMIN-START] Final admin session data saved
2025-06-16T06:31:14.964Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:15.523Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:15.729Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:15.731Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:20.740Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTZBOUU3NkIwNkQ5QjkyQjE5RQA=',
  timestamp: '1750055480'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1RkY1MUIyNTE1NTNEODJDRTkA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTZBOUU3NkIwNkQ5QjkyQjE5RQA=",
  "timestamp": "1750055480",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'site_1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":"impersonate_employee"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": "impersonate_employee"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:31:21.593Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMTM2RDI0RkIzMDM1M0E4MDUA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJERjdCQzYxRjdCMzJCQTZFRjQA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:31:21.593Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:31:21.593Z"
}
2025-06-16T06:31:23.171Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:31:23.493Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:23.635Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:23.719Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:23.762Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:31:24.217Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:24.295Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:24.374Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxMTU2RDVFMEMyOUUxOTYwNkEA'
    }
  ]
}
2025-06-16T06:31:25.691Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:26.010Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:26.099Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:26.116Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:31:28.469Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUI5RTE4NjgwRUE1QkFBQzdFOAA=',
  timestamp: '1750055487'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJERjdCQzYxRjdCMzJCQTZFRjQA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUI5RTE4NjgwRUE1QkFBQzdFOAA=",
  "timestamp": "1750055487",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":"impersonate_employee"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": "impersonate_employee"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:31:29.248Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: log_activity
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:31:29.248Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "active",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": "select_site",
    "original_role": "admin",
    "employee_intent": "impersonate_employee"
  },
  "updated_at": "2025-06-16T06:31:23.170Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T06:32:17.708Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ4MDM3MkU4MTk1MkYyNTlBMwA=',
  timestamp: '1750055510'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ4MDM3MkU4MTk1MkYyNTlBMwA=",
  "timestamp": "1750055510",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Menu',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":"impersonate_employee"},"employee_step":"active","original_role":"admin","employee_intent":"impersonate_employee"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": "select_site",
    "original_role": "admin",
    "employee_intent": "impersonate_employee"
  },
  "employee_step": "active",
  "original_role": "admin",
  "employee_intent": "impersonate_employee"
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBNDJGREVFQzBGMzExMDlDMzEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T06:32:20.999Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:32:21.016Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:32:21.240Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:32:21.296Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFNUY5NzAwOUM5QTM5QzYwNzAA'
    }
  ]
}
2025-06-16T06:32:22.319Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:32:22.699Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:32:22.923Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQzE2MkJENzIyMTIyNEM2QzkA'
    }
  ]
}
2025-06-16T06:32:24.104Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:32:24.516Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:39.509Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:39.733Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:43.725Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTYyMERFNEU2ODFCN0Y3RTY5NAA=',
  timestamp: '1750055622'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFNUY5NzAwOUM5QTM5QzYwNzAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTYyMERFNEU2ODFCN0Y3RTY5NAA=",
  "timestamp": "1750055622",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'employee_flow',
  sessionIntent: null,
  sessionStep: null,
  sessionData: '{}'
}
🧪 [ADMIN-MAIN] Routing to handleMainMenu
🧪 [ADMIN-START] Starting employee impersonation for: +19088483575
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\nType *exit* anytime to return to admin menu."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQTk2NjE3NEE1MjE2QzhDMjIA'
    }
  ]
}
🧪 [ADMIN-START] Initial employee session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {},
  "updated_at": "2025-06-16T06:33:45.915Z"
}
🧪 [ADMIN-START] Impersonated user: {
  "id": "2a155060-c282-4560-bf1e-6502ee5b10dd",
  "phone": "+19088483575",
  "role": "employee",
  "name": "Yash Patel",
  "email": "bojrick@gmail.com",
  "is_verified": true,
  "verified_at": "2025-05-30T05:47:50.157Z",
  "introduction_sent": false,
  "introduction_sent_at": null,
  "created_at": "2025-05-30T05:47:50.141Z",
  "updated_at": "2025-05-30T05:47:50.141Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:33:46.541Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🧪 [ADMIN-START] Calling employeeFlow.handleMessage with "start"
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:33:47.401Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:47.583Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1ODRBRDRGM0VEOTk0MzcxMEYA'
    }
  ]
}
🧪 [ADMIN-START] Employee session after start: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {},
  "updated_at": "2025-06-16T06:33:45.915Z"
}
🧪 [ADMIN-START] Latest session from DB after start: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:33:46.916Z"
}
🧪 [ADMIN-START] Final admin session data saved
2025-06-16T06:33:48.735Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:49.065Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:49.219Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:49.342Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:53.593Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTE1NDkzQTZBNUM2NTFGOTE5NQA=',
  timestamp: '1750055632'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1ODRBRDRGM0VEOTk0MzcxMEYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTE1NDkzQTZBNUM2NTFGOTE5NQA=",
  "timestamp": "1750055632",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'site_1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":"impersonate_employee"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": "impersonate_employee"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:33:54.486Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0RUU0MDA4Q0RCQTVDODcyODcA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEQjE2NzVGMUFGNTJCRkVEN0EA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:33:54.486Z"
}
2025-06-16T06:33:56.062Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:33:54.486Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:33:56.655Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:56.686Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:56.930Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:56.985Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:33:57.122Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:57.249Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MzQ0ODQ4NDFGNzBGNTQ0NjkA'
    }
  ]
}
2025-06-16T06:33:58.600Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:59.032Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:59.089Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:33:59.173Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:00.564Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc1NkE1QTg4Q0RDNTBCOEYxRgA=',
  timestamp: '1750055639'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEQjE2NzVGMUFGNTJCRkVEN0EA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc1NkE1QTg4Q0RDNTBCOEYxRgA=",
  "timestamp": "1750055639",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":null,"original_role":"admin","employee_intent":null}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "employee_step": null,
  "original_role": "admin",
  "employee_intent": null
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:34:01.447Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: log_activity
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCQUQ0MTM0MEVFOTYyOURGN0EA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:34:01.447Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "updated_at": "2025-06-16T06:34:01.515Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:34:02.926Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:03.290Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:03.420Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:03.541Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:07.874Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUE2OTg1NDREQzZBM0NFMTExNwA=',
  timestamp: '1750055647'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCQUQ0MTM0MEVFOTYyOURGN0EA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUE2OTg1NDREQzZBM0NFMTExNwA=",
  "timestamp": "1750055647",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":null,"original_role":"admin","employee_intent":null},"employee_step":"select_activity_type","original_role":"admin","employee_intent":"log_activity"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "employee_step": "select_activity_type",
  "original_role": "admin",
  "employee_intent": "log_activity"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "updated_at": "2025-06-16T06:34:08.757Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: inspection
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGQUM4NkU1OEIxNTlFN0ZBMDMA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "updated_at": "2025-06-16T06:34:08.757Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:34:08.757Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:34:10.217Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:10.502Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:10.584Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:10.635Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:14.837Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVBMDgzQTYxQzZCNEM4MEZEMQA=',
  timestamp: '1750055654'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGQUM4NkU1OEIxNTlFN0ZBMDMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVBMDgzQTYxQzZCNEM4MEZEMQA=",
  "timestamp": "1750055654",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'site_1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":null}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": null
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": null,
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:34:15.964Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFMUExOUE5NUJDMTVCQkU5MDQA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T06:34:17.463Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:17.981Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:17.985Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFRkE0RUU3MTgyRTkyRDU5RDUA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": null,
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:34:15.964Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:34:15.964Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:34:18.117Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:18.821Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:34:19.251Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:19.282Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGRjQyRURBRUVBRTAxMUI1NDYA'
    }
  ]
}
2025-06-16T06:34:20.571Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:20.867Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:20.949Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:21.039Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:34.784Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJCNTVFQ0Y2NTBCMzcxNDQ5OQA=',
  timestamp: '1750055673'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFRkE0RUU3MTgyRTkyRDU5RDUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJCNTVFQ0Y2NTBCMzcxNDQ5OQA=",
  "timestamp": "1750055673",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":null,"original_role":"admin","employee_intent":null}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "employee_step": null,
  "original_role": "admin",
  "employee_intent": null
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:34:35.770Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: log_activity
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5MjQ5OTc1NTBDRTgwMUVBQzIA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:34:35.770Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "updated_at": "2025-06-16T06:34:35.825Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:34:37.434Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:37.834Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:37.965Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:38.059Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:43.306Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM5MkYzRjdCOTc1MUI0NDE2MgA=',
  timestamp: '1750055682'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5MjQ5OTc1NTBDRTgwMUVBQzIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM5MkYzRjdCOTc1MUI0NDE2MgA=",
  "timestamp": "1750055682",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":null,"original_role":"admin","employee_intent":null},"employee_step":"select_activity_type","original_role":"admin","employee_intent":"log_activity"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "employee_step": "select_activity_type",
  "original_role": "admin",
  "employee_intent": "log_activity"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "updated_at": "2025-06-16T06:34:44.225Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: inspection
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFNUQ1QUQ4REVGRDQ4OTE3QUEA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "updated_at": "2025-06-16T06:34:44.225Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:34:44.226Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:34:45.916Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:46.264Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:46.273Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:46.491Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:50.269Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFFNTQxQ0I4RDA0Qzg1MEYxQgA=',
  timestamp: '1750055689'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFNUQ1QUQ4REVGRDQ4OTE3QUEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFFNTQxQ0I4RDA0Qzg1MEYxQgA=",
  "timestamp": "1750055689",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'site_1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":null}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": null
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": null,
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:34:51.130Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwNjkxQ0Y5MDc2MjA3MkJEQkIA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T06:34:52.812Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2NUZDOUI0Q0Q4NjVBOTFGQ0IA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": null,
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:34:51.130Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:34:51.130Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:34:53.284Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:53.454Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:53.525Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:53.927Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:34:54.168Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:54.275Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:54.353Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyREFCNzExMzYyNzYzOTFCMzkA'
    }
  ]
}
2025-06-16T06:34:55.594Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:55.988Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:56.073Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:34:56.180Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:23.630Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTlERDZFQzVEREFDNzMzRUNGRQA=',
  timestamp: '1750056202'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2NUZDOUI0Q0Q4NjVBOTFGQ0IA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTlERDZFQzVEREFDNzMzRUNGRQA=",
  "timestamp": "1750056202",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":null,"original_role":"admin","employee_intent":null}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "employee_step": null,
  "original_role": "admin",
  "employee_intent": null
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:43:24.946Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: log_activity
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyRUNFNDA3M0FGNDdGNEZBQjkA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:43:24.946Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "updated_at": "2025-06-16T06:43:25.005Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:43:27.090Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:27.331Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:27.561Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:31.226Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQyQ0I3RjkwQUU0MkZFNzA2OQA=',
  timestamp: '1750056210'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyRUNFNDA3M0FGNDdGNEZBQjkA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQyQ0I3RjkwQUU0MkZFNzA2OQA=",
  "timestamp": "1750056210",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":null,"original_role":"admin","employee_intent":null},"employee_step":"select_activity_type","original_role":"admin","employee_intent":"log_activity"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "employee_step": "select_activity_type",
  "original_role": "admin",
  "employee_intent": "log_activity"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "updated_at": "2025-06-16T06:43:32.102Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: inspection
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDQUE0NkIyNzEzMUFBMTA1QTQA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "updated_at": "2025-06-16T06:43:32.102Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:43:32.102Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:43:33.566Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:34.127Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:34.275Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:34.368Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:37.732Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJDMzExQUMyNzI4MjcwNjA0MwA=',
  timestamp: '1750056216'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDQUE0NkIyNzEzMUFBMTA1QTQA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJDMzExQUMyNzI4MjcwNjA0MwA=",
  "timestamp": "1750056216",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'site_1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":null}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": null
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": null,
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:43:38.684Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQzUxOEZGNDk0ODdBRTIxNUUA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2ODM4OURBOTQyNTJFNkREOUYA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": null,
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:43:38.684Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:43:38.684Z"
}
2025-06-16T06:43:40.453Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:43:40.791Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:40.889Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:41.080Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:41.155Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:43:41.394Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:41.595Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGOTk2M0U4QUM1QUZDMjVCRDQA'
    }
  ]
}
2025-06-16T06:43:42.950Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:43.198Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI5MURCMEQwRjZFRDcwODNGMAA=',
  timestamp: '1750056222'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2ODM4OURBOTQyNTJFNkREOUYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI5MURCMEQwRjZFRDcwODNGMAA=",
  "timestamp": "1750056222",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
2025-06-16T06:43:43.245Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-16T06:43:43.392Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:43.410Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":null,"original_role":"admin","employee_intent":null}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "employee_step": null,
  "original_role": "admin",
  "employee_intent": null
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:43:44.098Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: log_activity
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5RjY2QUFFMDY1OEZGNjJBOUYA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:43:44.098Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "updated_at": "2025-06-16T06:43:44.147Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:43:45.647Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:46.138Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:46.247Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:46.340Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:51.448Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURFMkQ1OEY5QUJCMjM5N0ZBNwA=',
  timestamp: '1750056230'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5RjY2QUFFMDY1OEZGNjJBOUYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURFMkQ1OEY5QUJCMjM5N0ZBNwA=",
  "timestamp": "1750056230",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"employee_data":{"selected_site":"site_1","site_selection_shown":true},"employee_step":null,"original_role":"admin","employee_intent":null},"employee_step":"select_activity_type","original_role":"admin","employee_intent":"log_activity"}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "employee_step": "select_activity_type",
  "original_role": "admin",
  "employee_intent": "log_activity"
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "updated_at": "2025-06-16T06:43:52.542Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: inspection
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે જ્યાં કામ કર્યું છે તે સાઈટ પસંદ કરો:"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "સક્રિય સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ સાઈટ A - રહેઠાણ",
              "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
            },
            {
              "id": "site_2",
              "title": "🏢 સાઈટ B - વાણિજ્યિક",
              "description": "ઓફિસ કોમ્પ્લેક્સ પ્રોજેક્ટ"
            },
            {
              "id": "site_3",
              "title": "🏬 સાઈટ C - રિટેલ",
              "description": "શોપિંગ સેન્ટર પ્રોજેક્ટ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDRTk3MTM5ODMwNzBCQkI3NUYA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "employee_data": {
      "selected_site": "site_1",
      "site_selection_shown": true
    },
    "employee_step": null,
    "original_role": "admin",
    "employee_intent": null
  },
  "updated_at": "2025-06-16T06:43:52.542Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:43:52.542Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:43:54.198Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:54.453Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:54.548Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:54.708Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:43:58.335Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY1OUM4M0IwNjg2RUFENUJGQwA=',
  timestamp: '1750056237'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDRTk3MTM5ODMwNzBCQkI3NUYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY1OUM4M0IwNjg2RUFENUJGQwA=",
  "timestamp": "1750056237",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ સાઈટ A - રહેઠાણ",
      "description": "મુખ્ય રહેઠાણ પ્રોજેક્ટ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🧪 [ADMIN-MAIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'site_1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  sessionData: '{"employee_data":{"site_selection_shown":true},"employee_step":"select_site","original_role":"admin","employee_intent":null}'
}
🧪 [ADMIN-MAIN] Routing to handleImpersonateEmployee
🧪 [ADMIN-IMPERSONATE] Employee session data: {
  "employee_data": {
    "site_selection_shown": true
  },
  "employee_step": "select_site",
  "original_role": "admin",
  "employee_intent": null
}
🧪 [ADMIN-IMPERSONATE] Reconstructed employee session: {
  "phone": "+19088483575",
  "intent": null,
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:43:59.122Z"
}
🧪 [ADMIN-IMPERSONATE] Calling employeeFlow.handleMessage with: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે સાઈટ A - રહેઠાણ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxMDYwRDk1MjUwQ0YwMUYwMUIA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* સાઈટ A - રહેઠાણ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T06:44:00.709Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyRDY3QzY2QTE4QUE2MTY2NTEA'
    }
  ]
}
🧪 [ADMIN-IMPERSONATE] Employee session after flow: {
  "phone": "+19088483575",
  "intent": null,
  "step": "select_site",
  "data": {
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:43:59.122Z"
}
🧪 [ADMIN-IMPERSONATE] Latest session from DB: {
  "phone": "+19088483575",
  "intent": "impersonate_employee",
  "step": null,
  "data": {
    "selected_site": "site_1",
    "site_selection_shown": true
  },
  "updated_at": "2025-06-16T06:43:59.122Z"
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T06:44:01.277Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:44:01.316Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:44:01.322Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:44:01.363Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:44:01.520Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "change_site",
              "title": "🏗️ સાઈટ બદલો",
              "description": "બીજી સાઈટ પસંદ કરો"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T06:44:01.917Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzMTA2MzBBMzJCM0VGMkI0NjYA'
    }
  ]
}
2025-06-16T06:44:02.994Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T06:44:03.638Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T07:04:09.463Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUyQUJFREY2ODNCMkI3RjNFNQA=',
  timestamp: '1750057447'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUyQUJFREY2ODNCMkI3RjNFNQA=",
  "timestamp": "1750057447",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Menu',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: Menu
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGM0E0OTA1MTg5MjY1QkYxNDcA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:04:12.699Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T07:04:12.943Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:13.273Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMjRBRDUxQkI4REJFMUM0NkMA'
    }
  ]
}
2025-06-16T07:04:14.514Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T07:04:14.789Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:15.032Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:15.139Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJERUZGM0EzNUFBMkQxNDI2NTMA'
    }
  ]
}
2025-06-16T07:04:16.031Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:16.278Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:16.414Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:16.516Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:19.305Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUIwOUI5M0FDNUY5QkFDRTY2MgA=',
  timestamp: '1750057458'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMjRBRDUxQkI4REJFMUM0NkMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUIwOUI5M0FDNUY5QkFDRTY2MgA=",
  "timestamp": "1750057458",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'employee_flow',
  sessionIntent: null,
  sessionStep: null
}
🔧 [ADMIN] Starting employee impersonation - showing site selection first
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\n\nFirst, select which site you want to work on:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4OTg3NTNDMTVBQzhGQ0YwRUIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:04:21.765Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🔧 [ADMIN] Showing site selection
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select the site where you are working:"
    },
    "action": {
      "button": "Select Site",
      "sections": [
        {
          "title": "Active Sites",
          "rows": [
            {
              "id": "site_site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T07:04:22.148Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:22.214Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:22.276Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3N0U0RDREQzQ5RkQwRTIzQTMA'
    }
  ]
}
2025-06-16T07:04:23.610Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:23.798Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:23.872Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:24.037Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:32.215Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJERjBGQURFNzlDQUU2OTYwRAA=',
  timestamp: '1750057471'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3N0U0RDREQzQ5RkQwRTIzQTMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJERjBGQURFNzlDQUU2OTYwRAA=",
  "timestamp": "1750057471",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
2025-06-16T07:04:32.218Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'site_site_1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'select_site'
}
🔧 [ADMIN] Employee impersonation step: select_site message: site_site_1
🔧 [ADMIN] Site selected: site_site_1
🔧 [ADMIN] Starting employee flow with site: site_site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ Site selected: Unknown Site\n\nNow you can use all employee functions. Type *exit* to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQjYxMDNDNTQ1RkRGQUMyNDcA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:04:34.775Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'menu',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T07:04:35.090Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:35.192Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:35.237Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2RjkwQzVCODYyODAxNENDRjcA'
    }
  ]
}
2025-06-16T07:04:36.436Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T07:04:36.716Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:36.931Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:37.013Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBNDA0MjlDMTYxRDAzRjIzRjgA'
    }
  ]
}
2025-06-16T07:04:38.151Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:38.498Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:38.500Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:38.658Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:40.387Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTU1OTQ3NTIyODdFNzRCMTE5MAA=',
  timestamp: '1750057479'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2RjkwQzVCODYyODAxNENDRjcA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTU1OTQ3NTIyODdFNzRCMTE5MAA=",
  "timestamp": "1750057479",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: log_activity
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_site_1",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T07:04:41.155Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzODc0NUNEQTdEMzFDQkY3MTkA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:04:42.669Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:43.077Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:43.100Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:43.170Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:47.080Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTczMTM3NzEwMDVGMzFDN0JBOAA=',
  timestamp: '1750057486'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzODc0NUNEQTdEMzFDQkY3MTkA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTczMTM3NzEwMDVGMzFDN0JBOAA=",
  "timestamp": "1750057486",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: inspection
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "site_id": "site_site_1",
    "original_role": "admin",
    "selected_site": "site_site_1",
    "employee_session": {
      "selected_site": "site_site_1",
      "site_selection_shown": true,
      "is_admin_impersonation": true
    },
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T07:04:48.264Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4M0NBMTc0OTA4NTcxNkZCNDAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:04:49.822Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:50.129Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:50.241Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:50.379Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:53.817Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTAxNUVCMzE3QkVCNjYyQzUzNAA=',
  timestamp: '1750057492'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTAxNUVCMzE3QkVCNjYyQzUzNAA=",
  "timestamp": "1750057492",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: 1
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": "enter_hours",
  "data": {
    "site_id": "site_site_1",
    "activity_type": "inspection",
    "original_role": "admin",
    "selected_site": "site_site_1",
    "employee_session": {
      "selected_site": "site_site_1",
      "site_selection_shown": true,
      "is_admin_impersonation": true
    },
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T07:04:54.626Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: '1',
  sessionIntent: null,
  sessionStep: 'enter_hours',
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQTBCMEU3MEIxMEUyMTdENDcA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:04:56.139Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:56.465Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:56.507Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:04:56.538Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:05:00.758Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI2MDYyRTY5NkQ4NDcyQzI4QQA=',
  timestamp: '1750057499'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQTBCMEU3MEIxMEUyMTdENDcA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI2MDYyRTY5NkQ4NDcyQzI4QQA=",
  "timestamp": "1750057499",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: inspection
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "site_id": "site_site_1",
    "employee_step": "enter_hours",
    "original_role": "admin",
    "selected_site": "site_site_1",
    "employee_intent": null,
    "employee_session": {
      "site_id": "site_site_1",
      "activity_type": "inspection",
      "original_role": "admin",
      "selected_site": "site_site_1",
      "employee_session": {
        "selected_site": "site_site_1",
        "site_selection_shown": true,
        "is_admin_impersonation": true
      },
      "site_selection_shown": true,
      "is_admin_impersonation": true
    },
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T07:05:01.600Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGMjk2ODFBMDMzNzNDRTlEMkIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:05:03.063Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:05:03.560Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:05:03.602Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:05:03.604Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:05:06.896Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTczNERBQjU5REFBMjdDNzI3NQA=',
  timestamp: '1750057506'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTczNERBQjU5REFBMjdDNzI3NQA=",
  "timestamp": "1750057506",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: 1
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": "enter_hours",
  "data": {
    "site_id": "site_site_1",
    "activity_type": "inspection",
    "employee_step": "enter_hours",
    "original_role": "admin",
    "selected_site": "site_site_1",
    "employee_intent": null,
    "employee_session": {
      "site_id": "site_site_1",
      "activity_type": "inspection",
      "original_role": "admin",
      "selected_site": "site_site_1",
      "employee_session": {
        "selected_site": "site_site_1",
        "site_selection_shown": true,
        "is_admin_impersonation": true
      },
      "site_selection_shown": true,
      "is_admin_impersonation": true
    },
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T07:05:07.636Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: '1',
  sessionIntent: null,
  sessionStep: 'enter_hours',
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0NDZDMDdCOTc0MDRBNzhDNEEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:05:09.057Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:05:09.591Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:05:09.685Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:05:09.736Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:05:59.193Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM4NDBCMThFMjBFNzlFOTE2OQA=',
  timestamp: '1750057558'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0NDZDMDdCOTc0MDRBNzhDNEEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM4NDBCMThFMjBFNzlFOTE2OQA=",
  "timestamp": "1750057558",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "planning",
      "title": "📋 આયોજન",
      "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "planning"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'planning',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: planning
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "site_id": "site_site_1",
    "employee_step": "enter_hours",
    "original_role": "admin",
    "selected_site": "site_site_1",
    "employee_intent": null,
    "employee_session": {
      "site_id": "site_site_1",
      "activity_type": "inspection",
      "employee_step": "enter_hours",
      "original_role": "admin",
      "selected_site": "site_site_1",
      "employee_intent": null,
      "employee_session": {
        "site_id": "site_site_1",
        "activity_type": "inspection",
        "original_role": "admin",
        "selected_site": "site_site_1",
        "employee_session": {
          "selected_site": "site_site_1",
          "site_selection_shown": true,
          "is_admin_impersonation": true
        },
        "site_selection_shown": true,
        "is_admin_impersonation": true
      },
      "site_selection_shown": true,
      "is_admin_impersonation": true
    },
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T07:06:00.536Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'planning',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJENTZDREM2REJBRUY5OTFDOUUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:06:01.964Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:06:02.549Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:06:02.992Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:06:05.903Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUIxNjU2MEM0RjM0ODNCMzI4RgA=',
  timestamp: '1750057564'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUIxNjU2MEM0RjM0ODNCMzI4RgA=",
  "timestamp": "1750057564",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: 1
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": "enter_hours",
  "data": {
    "site_id": "site_site_1",
    "activity_type": "planning",
    "employee_step": "enter_hours",
    "original_role": "admin",
    "selected_site": "site_site_1",
    "employee_intent": null,
    "employee_session": {
      "site_id": "site_site_1",
      "activity_type": "inspection",
      "employee_step": "enter_hours",
      "original_role": "admin",
      "selected_site": "site_site_1",
      "employee_intent": null,
      "employee_session": {
        "site_id": "site_site_1",
        "activity_type": "inspection",
        "original_role": "admin",
        "selected_site": "site_site_1",
        "employee_session": {
          "selected_site": "site_site_1",
          "site_selection_shown": true,
          "is_admin_impersonation": true
        },
        "site_selection_shown": true,
        "is_admin_impersonation": true
      },
      "site_selection_shown": true,
      "is_admin_impersonation": true
    },
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T07:06:06.701Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: '1',
  sessionIntent: null,
  sessionStep: 'enter_hours',
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MUU2MTIzQTBFNUEzNzg1OEIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:06:08.312Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:06:08.668Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:06:08.672Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:06:08.771Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:06:13.381Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTEwNzRDNERDOTM1OEI3QThDRgA=',
  timestamp: '1750057572'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MUU2MTIzQTBFNUEzNzg1OEIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTEwNzRDNERDOTM1OEI3QThDRgA=",
  "timestamp": "1750057572",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: inspection
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "site_id": "site_site_1",
    "employee_step": "enter_hours",
    "original_role": "admin",
    "selected_site": "site_site_1",
    "employee_intent": null,
    "employee_session": {
      "site_id": "site_site_1",
      "activity_type": "planning",
      "employee_step": "enter_hours",
      "original_role": "admin",
      "selected_site": "site_site_1",
      "employee_intent": null,
      "employee_session": {
        "site_id": "site_site_1",
        "activity_type": "inspection",
        "employee_step": "enter_hours",
        "original_role": "admin",
        "selected_site": "site_site_1",
        "employee_intent": null,
        "employee_session": {
          "site_id": "site_site_1",
          "activity_type": "inspection",
          "original_role": "admin",
          "selected_site": "site_site_1",
          "employee_session": {
            "selected_site": "site_site_1",
            "site_selection_shown": true,
            "is_admin_impersonation": true
          },
          "site_selection_shown": true,
          "is_admin_impersonation": true
        },
        "site_selection_shown": true,
        "is_admin_impersonation": true
      },
      "site_selection_shown": true,
      "is_admin_impersonation": true
    },
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T07:06:14.250Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NEM3ODVDNjIxRkM3MDc2QjcA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:06:15.656Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:06:16.276Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:06:16.297Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:06:16.310Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 4s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T07:56:26.619Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTcyQTg0MUY3NUEyMEZEQTU5MAA=',
  timestamp: '1750060585'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTcyQTg0MUY3NUEyMEZEQTU5MAA=",
  "timestamp": "1750060585",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Menu',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: Menu
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5QUEyRUQwNUM5MkY2MzVFMjEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T07:56:30.217Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:30.491Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:30.772Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:30.805Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFQ0Y4MTMwRkUwM0VERTJBMzcA'
    }
  ]
}
2025-06-16T07:56:31.764Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T07:56:32.206Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:32.207Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:32.522Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MTQ3RDFGNzE1NTI1MzEyNjkA'
    }
  ]
}
2025-06-16T07:56:33.507Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:33.830Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:33.942Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:33.944Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:34.320Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM4NEQ2NTRBQ0M3OEE2N0M2MwA=',
  timestamp: '1750060593'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFQ0Y4MTMwRkUwM0VERTJBMzcA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM4NEQ2NTRBQ0M3OEE2N0M2MwA=",
  "timestamp": "1750060593",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'employee_flow',
  sessionIntent: null,
  sessionStep: null
}
🔧 [ADMIN] Starting employee impersonation - showing site selection first
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\n\nFirst, select which site you want to work on:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEOTQ3QkZGNEU1NzExMDYyOEMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:56:36.825Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🔧 [ADMIN] Showing site selection
2025-06-16T07:56:37.010Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select the site where you are working:"
    },
    "action": {
      "button": "Select Site",
      "sections": [
        {
          "title": "Active Sites",
          "rows": [
            {
              "id": "site_site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T07:56:37.131Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:37.247Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFMTA0NzIyNkRENTQ2NTBBNjQA'
    }
  ]
}
2025-06-16T07:56:38.485Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:38.998Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:39.022Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:39.173Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:43.786Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTIwMkYxNzVGMTg1Nzk5MzU4QgA=',
  timestamp: '1750060602'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFMTA0NzIyNkRENTQ2NTBBNjQA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTIwMkYxNzVGMTg1Nzk5MzU4QgA=",
  "timestamp": "1750060602",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "site_site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'site_site_1',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'select_site'
}
🔧 [ADMIN] Employee impersonation step: select_site message: site_site_1
🔧 [ADMIN] Site selected: site_site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ Site selected: Unknown Site\n\nNow you can use all employee functions. Type *exit* to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzRjU5MTI5MDE3MzlENjU1RDQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:56:46.475Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'menu',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T07:56:46.687Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:46.960Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:47.123Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyRTRFNEU2RTEwM0Y4M0IwREIA'
    }
  ]
}
2025-06-16T07:56:48.086Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T07:56:48.491Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:48.690Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:48.732Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBM0NDMzk0QkY4NjUwMTUxMjQA'
    }
  ]
}
2025-06-16T07:56:49.722Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:50.097Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:50.115Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTRBOTc3RUI0OTJEOTExMjY4MgA=',
  timestamp: '1750060609'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyRTRFNEU2RTEwM0Y4M0IwREIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTRBOTc3RUI0OTJEOTExMjY4MgA=",
  "timestamp": "1750060609",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
2025-06-16T07:56:50.210Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👁️ [HANDLER] Marking message as read...
2025-06-16T07:56:50.385Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: log_activity
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_site_1",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T07:56:51.096Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1OUM3NTEzMzJDQTZDQjI1MEYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:56:52.684Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:53.207Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:53.262Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:56:53.458Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:02.497Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUE3MzQ2NjdEQTIwNzY5OENCRgA=',
  timestamp: '1750060621'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1OUM3NTEzMzJDQTZDQjI1MEYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUE3MzQ2NjdEQTIwNzY5OENCRgA=",
  "timestamp": "1750060621",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: inspection
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_site_1",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T07:57:03.482Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2ODM0MDkwOEFCRjE2Qzk4QTUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:57:04.829Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T07:57:05.274Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:05.623Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:05.654Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MEVBRDQ0NTgyMzNBOEY2MjEA'
    }
  ]
}
2025-06-16T07:57:06.754Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:07.177Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:07.207Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:07.416Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:33.269Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdFQTY2MkJFRkREMDZEMkQ0NQA=',
  timestamp: '1750060652'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2ODM0MDkwOEFCRjE2Qzk4QTUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdFQTY2MkJFRkREMDZEMkQ0NQA=",
  "timestamp": "1750060652",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: log_activity
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_site_1",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T07:57:34.338Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCOTZFMkUxREUxNzdBQUExOUUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:57:35.894Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:36.279Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:36.300Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:36.560Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:48.666Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTk0NjAxQUVCOENGNDFBOTcwNAA=',
  timestamp: '1750060668'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCOTZFMkUxREUxNzdBQUExOUUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTk0NjAxQUVCOENGNDFBOTcwNAA=",
  "timestamp": "1750060668",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "maintenance",
      "title": "🔧 જાળવણી",
      "description": "સાધનો અને સાઈટની જાળવણી"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "maintenance"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'maintenance',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: maintenance
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "site_site_1",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T07:57:49.784Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'maintenance',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_site_1',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJENzQ3NjM4RUZDNDM4Q0VFNkUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T07:57:51.866Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T07:57:52.194Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:52.278Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGRTNCQ0JBQUQyQzNBOTQwRkUA'
    }
  ]
}
2025-06-16T07:57:53.347Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:53.931Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:53.934Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T07:57:54.182Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T08:10:37.281Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTczMThDNjNGOTIyNUZEQTk0RAA=',
  timestamp: '1750061436'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTczMThDNjNGOTIyNUZEQTk0RAA=",
  "timestamp": "1750061436",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Menu',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: Menu
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEMkJFMDcxQjY0QTRCNDlCNzgA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T08:10:40.846Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:41.016Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:41.160Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:41.271Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNzlCMzg5M0IzOUUxQUE4MjcA'
    }
  ]
}
2025-06-16T08:10:42.712Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:10:42.999Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:43.031Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:43.136Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEQTkyRDMwRkQ1MzU2NjE4RUYA'
    }
  ]
}
2025-06-16T08:10:44.243Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:44.572Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:44.706Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:44.771Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTRDNkM0OTNGNjE4MzFDNDY3NQA=',
  timestamp: '1750061444'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNzlCMzg5M0IzOUUxQUE4MjcA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTRDNkM0OTNGNjE4MzFDNDY3NQA=",
  "timestamp": "1750061444",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-16T08:10:45.109Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'employee_flow',
  sessionIntent: null,
  sessionStep: null
}
🔧 [ADMIN] Starting employee impersonation - showing site selection first
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\n\nFirst, select which site you want to work on:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGMEI0RUE0OTVDQ0Y0MTU3OTAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:10:48.329Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🔧 [ADMIN] Showing site selection
🔧 [ADMIN] Found sites in DB: 3
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select the site where you are working:"
    },
    "action": {
      "button": "Select Site",
      "sections": [
        {
          "title": "Active Sites",
          "rows": [
            {
              "id": "11111111-1111-1111-1111-111111111111",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "22222222-2222-2222-2222-222222222222",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "33333333-3333-3333-3333-333333333333",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:10:48.441Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:48.692Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:48.784Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzODJEQzYxODVBODhBNjREOEMA'
    }
  ]
}
2025-06-16T08:10:49.956Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:50.483Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:50.485Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:50.504Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:10:56.321Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThDMDBEMkQ4RUREQzJCNUU3MwA=',
  timestamp: '1750061455'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzODJEQzYxODVBODhBNjREOEMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThDMDBEMkQ4RUREQzJCNUU3MwA=",
  "timestamp": "1750061455",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "11111111-1111-1111-1111-111111111111",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "11111111-1111-1111-1111-111111111111"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '11111111-1111-1111-1111-111111111111',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'select_site'
}
🔧 [ADMIN] Employee impersonation step: select_site message: 11111111-1111-1111-1111-111111111111
🔧 [ADMIN] Validating site selection: 11111111-1111-1111-1111-111111111111
🔧 [ADMIN] Valid site selected: Suvasam Group
🔧 [ADMIN] Site selected: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ Site selected: Suvasam Group\n\nNow you can use all employee functions. Type *exit* to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MzREMzZBRDdCNTNBNDMxN0IA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:10:59.658Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'menu',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
2025-06-16T08:10:59.977Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* Suvasam Group\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T08:11:00.018Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:00.217Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4ODUyNEVCOUUwQ0QwMkE4ODYA'
    }
  ]
}
2025-06-16T08:11:01.418Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:01.847Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:11:01.968Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:02.187Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDRUMyNjA0QzQ2MjEyNjZBRkMA'
    }
  ]
}
2025-06-16T08:11:03.504Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:03.938Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:04.057Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:06.233Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTcxMDZCNTlBOTUxMThFOEI4RgA=',
  timestamp: '1750061465'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4ODUyNEVCOUUwQ0QwMkE4ODYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTcxMDZCNTlBOTUxMThFOEI4RgA=",
  "timestamp": "1750061465",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: log_activity
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T08:11:07.105Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyMEJBOUZFQ0Y4NTI5RDdDQjYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:11:08.807Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:09.185Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:09.197Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:09.444Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:13.390Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJDQjZCRkJEQjREMEI3ODhBNAA=',
  timestamp: '1750061472'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyMEJBOUZFQ0Y4NTI5RDdDQjYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJDQjZCRkJEQjREMEI3ODhBNAA=",
  "timestamp": "1750061472",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: inspection
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T08:11:14.474Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* Suvasam Group\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0QjY2NzYwODNBQUU4MDQzQkQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:11:16.257Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:11:16.613Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:16.792Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:16.863Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyNTlDNUQwMzlEOTUzNjg0MEMA'
    }
  ]
}
2025-06-16T08:11:18.126Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:18.540Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:18.589Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:11:18.715Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T08:20:28.480Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg2NkZGMkVEMDMyRjI0Q0E1NwA=',
  timestamp: '1750062027'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg2NkZGMkVEMDMyRjI0Q0E1NwA=",
  "timestamp": "1750062027",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Menu',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: Menu
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBNTBCODAwMkMxRENGNzYwMTMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T08:20:34.120Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:34.380Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:34.426Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxMTNBOTEwRUYwQkM0NzFFNEMA'
    }
  ]
}
2025-06-16T08:20:35.862Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:20:36.148Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:36.289Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:36.454Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1QUMwNUQ2NjFENzRGNjhGQTEA'
    }
  ]
}
2025-06-16T08:20:37.419Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:38.015Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:38.158Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:38.163Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:39.942Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFCNTlCQzFGOEQ3N0ZBRjFCMgA=',
  timestamp: '1750062039'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxMTNBOTEwRUYwQkM0NzFFNEMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFCNTlCQzFGOEQ3N0ZBRjFCMgA=",
  "timestamp": "1750062039",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'employee_flow',
  sessionIntent: null,
  sessionStep: null
}
🔧 [ADMIN] Starting employee impersonation - showing site selection first
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\n\nFirst, select which site you want to work on:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NjNBQzRFNDE5NjRFQ0REMEEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:20:42.359Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🔧 [ADMIN] Showing site selection
🔧 [ADMIN] Found sites in DB: 3
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select the site where you are working:"
    },
    "action": {
      "button": "Select Site",
      "sections": [
        {
          "title": "Active Sites",
          "rows": [
            {
              "id": "11111111-1111-1111-1111-111111111111",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "22222222-2222-2222-2222-222222222222",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "33333333-3333-3333-3333-333333333333",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:20:42.732Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:42.908Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:42.913Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0RUFENkRDNDgyQTA4Q0M0QUMA'
    }
  ]
}
2025-06-16T08:20:44.271Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:44.665Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:44.900Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:44.975Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:49.122Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUExRjlBMUNDNDc2OEM4RDMxNwA=',
  timestamp: '1750062048'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0RUFENkRDNDgyQTA4Q0M0QUMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUExRjlBMUNDNDc2OEM4RDMxNwA=",
  "timestamp": "1750062048",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "11111111-1111-1111-1111-111111111111",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "11111111-1111-1111-1111-111111111111"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '11111111-1111-1111-1111-111111111111',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'select_site'
}
🔧 [ADMIN] Employee impersonation step: select_site message: 11111111-1111-1111-1111-111111111111
🔧 [ADMIN] Validating site selection: 11111111-1111-1111-1111-111111111111
🔧 [ADMIN] Valid site selected: Suvasam Group
🔧 [ADMIN] Site selected: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ Site selected: Suvasam Group\n\nNow you can use all employee functions. Type *exit* to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEMEU4NTI5REQ2RUQ5NkVBODkA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:20:51.868Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:52.218Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'menu',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* Suvasam Group\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T08:20:52.330Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:52.381Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCQjU0OTQ4RUM5RUQ0RTJDODIA'
    }
  ]
}
2025-06-16T08:20:53.897Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:20:54.349Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:54.404Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:54.673Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1NDczRTA1NzM0QjRGRDhEODEA'
    }
  ]
}
2025-06-16T08:20:55.600Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:55.902Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY2Njk0QTY5OUY5QTNCN0NCMAA=',
  timestamp: '1750062055'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCQjU0OTQ4RUM5RUQ0RTJDODIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY2Njk0QTY5OUY5QTNCN0NCMAA=",
  "timestamp": "1750062055",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-16T08:20:56.037Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:56.073Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:56.131Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: log_activity
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T08:20:56.788Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NTQ3MTQxOTI2MEYxRUM1MjgA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:20:58.401Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:58.797Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:59.047Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:20:59.127Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:09.408Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUI2NTBBMEI3MDhCMjJDRjUyNwA=',
  timestamp: '1750062068'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NTQ3MTQxOTI2MEYxRUM1MjgA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUI2NTBBMEI3MDhCMjJDRjUyNwA=",
  "timestamp": "1750062068",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: inspection
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T08:21:10.685Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* Suvasam Group\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBNEUzNzRFQkQwN0U0QTdBNUUA'
    }
  ]
}
🔧 [ADMIN] Employee flow completed, admin context preserved
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:21:12.316Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:21:12.574Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:12.691Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:12.740Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyMzg1OEUyNEMwNEQ5MjJGNDMA'
    }
  ]
}
2025-06-16T08:21:14.069Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:14.249Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:14.440Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:14.528Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:21.216Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVFRTE3MzczOUFCQjlGNDU5RAA=',
  timestamp: '1750062080'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBNEUzNzRFQkQwN0U0QTdBNUUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVFRTE3MzczOUFCQjlGNDU5RAA=",
  "timestamp": "1750062080",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: log_activity
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T08:21:22.190Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QjM5NURDNUJCNkExMDgwMEMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:21:23.793Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:24.409Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:24.410Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:24.476Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:28.603Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY5NjRBNzM4OTQ2M0Q2Q0REMwA=',
  timestamp: '1750062087'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QjM5NURDNUJCNkExMDgwMEMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY5NjRBNzM4OTQ2M0Q2Q0REMwA=",
  "timestamp": "1750062087",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: inspection
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T08:21:29.621Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* Suvasam Group\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzQ0FBQkE5OUYxNTQwODc5NTUA'
    }
  ]
}
🔧 [ADMIN] Employee flow completed, admin context preserved
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:21:31.330Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:21:31.655Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:31.942Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMTQwMDREQTExRTczNjM2MUEA'
    }
  ]
}
2025-06-16T08:21:33.222Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:33.570Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:21:33.606Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T08:28:18.051Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:21.918Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUYzM0Y3NTUwMEVFNDIwNTZGNwA=',
  timestamp: '1750062500'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUYzM0Y3NTUwMEVFNDIwNTZGNwA=",
  "timestamp": "1750062500",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Menu',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: Menu
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwNkY1MjJBMkQzMTRGMDhDM0UA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:28:24.980Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T08:28:25.461Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:25.815Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1OUVDRTc0NzhFOTdCQkJGODUA'
    }
  ]
}
2025-06-16T08:28:26.775Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:28:27.392Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:27.394Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:28.533Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGQTdEMjc0NzFCNkI0NzRDNTAA'
    }
  ]
}
2025-06-16T08:28:28.882Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUE4RkE5QzhFMzMyQjJDQkFGOQA=',
  timestamp: '1750062508'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1OUVDRTc0NzhFOTdCQkJGODUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUE4RkE5QzhFMzMyQjJDQkFGOQA=",
  "timestamp": "1750062508",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-16T08:28:29.337Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:29.637Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:29.645Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'employee_flow',
  sessionIntent: null,
  sessionStep: null
}
🔧 [ADMIN] Starting employee impersonation - showing site selection first
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\n\nFirst, select which site you want to work on:"
  }
}
2025-06-16T08:28:29.982Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5RjQ0QzZBNjJFRDE0ODdEMTAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:28:31.374Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🔧 [ADMIN] Showing site selection
🔧 [ADMIN] Found sites in DB: 3
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select the site where you are working:"
    },
    "action": {
      "button": "Select Site",
      "sections": [
        {
          "title": "Active Sites",
          "rows": [
            {
              "id": "11111111-1111-1111-1111-111111111111",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "22222222-2222-2222-2222-222222222222",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "33333333-3333-3333-3333-333333333333",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:28:31.901Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:32.107Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:32.113Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxMUYyNEQzQ0E3MUJBN0NFQUMA'
    }
  ]
}
2025-06-16T08:28:33.192Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:33.738Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:33.916Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:38.432Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFCRDI2NEI0NjQzQzc5MjA1NgA=',
  timestamp: '1750062517'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxMUYyNEQzQ0E3MUJBN0NFQUMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFCRDI2NEI0NjQzQzc5MjA1NgA=",
  "timestamp": "1750062517",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "11111111-1111-1111-1111-111111111111",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "11111111-1111-1111-1111-111111111111"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '11111111-1111-1111-1111-111111111111',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'select_site'
}
🔧 [ADMIN] Employee impersonation step: select_site message: 11111111-1111-1111-1111-111111111111
🔧 [ADMIN] Validating site selection: 11111111-1111-1111-1111-111111111111
🔧 [ADMIN] Valid site selected: Suvasam Group
🔧 [ADMIN] Site selected: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ Site selected: Suvasam Group\n\nNow you can use all employee functions. Type *exit* to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5MzlCNUU5NkQzRjc3NDQwQUQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:28:41.439Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'menu',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* Suvasam Group\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T08:28:41.881Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:41.908Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:42.124Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3RkMyRUFFRTk2MUQwRkQ4RjAA'
    }
  ]
}
2025-06-16T08:28:43.341Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:28:43.666Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:43.921Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:43.934Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFQzBBMEExNzUwOTFCQjRFMTgA'
    }
  ]
}
2025-06-16T08:28:44.671Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:45.101Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:45.167Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:45.226Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:45.323Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTIzOUJCMzlBQkMwNjQzQjI4NQA=',
  timestamp: '1750062524'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3RkMyRUFFRTk2MUQwRkQ4RjAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTIzOUJCMzlBQkMwNjQzQjI4NQA=",
  "timestamp": "1750062524",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: log_activity
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T08:28:46.382Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEQzM1RkMzNDk0Q0IzQzgyNkYA'
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'log_activity', step: 'select_activity_type' }
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:28:48.140Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:48.401Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:48.507Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:48.711Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:53.270Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY0RkRDODgyRkM4Njg3NzE4NwA=',
  timestamp: '1750062532'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEQzM1RkMzNDk0Q0IzQzgyNkYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY0RkRDODgyRkM4Njg3NzE4NwA=",
  "timestamp": "1750062532",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNDU4QzdBNDlCOEFBNzdCNzgA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:28:55.858Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:56.299Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:28:56.500Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:56.518Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDNTFGMEFCMDhCMzg2QjcwOTUA'
    }
  ]
}
2025-06-16T08:28:57.673Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:58.188Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:58.264Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:28:58.271Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:00.548Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJGMjgxNDc4RDRFN0Y3NUExMAA=',
  timestamp: '1750062539'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNDU4QzdBNDlCOEFBNzdCNzgA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJGMjgxNDc4RDRFN0Y3NUExMAA=",
  "timestamp": "1750062539",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'employee_flow',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type'
}
🔧 [ADMIN] Starting employee impersonation - showing site selection first
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\n\nFirst, select which site you want to work on:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxMDk5MkM1MENEQjlGQTE2MzUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:29:03.109Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🔧 [ADMIN] Showing site selection
🔧 [ADMIN] Found sites in DB: 3
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select the site where you are working:"
    },
    "action": {
      "button": "Select Site",
      "sections": [
        {
          "title": "Active Sites",
          "rows": [
            {
              "id": "11111111-1111-1111-1111-111111111111",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "22222222-2222-2222-2222-222222222222",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "33333333-3333-3333-3333-333333333333",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:29:03.435Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:03.448Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:03.486Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2NkRCRkVCQzUzRTE3MEM3OTQA'
    }
  ]
}
2025-06-16T08:29:04.732Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:04.958Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:05.128Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:05.129Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:08.668Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ4RTMzRTQ5RTY0MTZEOEYzMAA=',
  timestamp: '1750062547'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2NkRCRkVCQzUzRTE3MEM3OTQA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ4RTMzRTQ5RTY0MTZEOEYzMAA=",
  "timestamp": "1750062547",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "11111111-1111-1111-1111-111111111111",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "11111111-1111-1111-1111-111111111111"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '11111111-1111-1111-1111-111111111111',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'select_site'
}
🔧 [ADMIN] Employee impersonation step: select_site message: 11111111-1111-1111-1111-111111111111
🔧 [ADMIN] Validating site selection: 11111111-1111-1111-1111-111111111111
🔧 [ADMIN] Valid site selected: Suvasam Group
🔧 [ADMIN] Site selected: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ Site selected: Suvasam Group\n\nNow you can use all employee functions. Type *exit* to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5Njc3OTNBNzNDRTgzNzI5Q0UA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:29:11.756Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'menu',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* Suvasam Group\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T08:29:12.119Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:12.163Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:12.431Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxMDU3OTRCRDI4NDA3MzZDQTEA'
    }
  ]
}
2025-06-16T08:29:13.740Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:29:13.956Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:14.052Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:14.116Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwRDc2REQwRUIzODQxMERBNjIA'
    }
  ]
}
2025-06-16T08:29:15.602Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:15.794Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY0MjRGNjNGQjREQTBGRUVBOQA=',
  timestamp: '1750062555'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxMDU3OTRCRDI4NDA3MzZDQTEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY0MjRGNjNGQjREQTBGRUVBOQA=",
  "timestamp": "1750062555",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
2025-06-16T08:29:15.847Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
2025-06-16T08:29:15.990Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:16.003Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active'
}
🔧 [ADMIN] Employee impersonation step: active message: log_activity
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T08:29:16.769Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0Q0U4NUFBNjVBOTEyRTJDMTIA'
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'log_activity', step: 'select_activity_type' }
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:29:18.645Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:19.248Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:19.260Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:19.264Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:24.396Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTgzNzk1RDkxMkVFNUQ2OUM4QQA=',
  timestamp: '1750062563'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0Q0U4NUFBNjVBOTEyRTJDMTIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTgzNzk1RDkxMkVFNUQ2OUM4QQA=",
  "timestamp": "1750062563",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can act as a customer or employee to capture real records.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2RjZGMDg0QzEyREMzNDY2MEUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Admin Tools",
          "rows": [
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:29:27.039Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:27.246Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:27.309Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:27.334Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1NzRDRkJCRDkxRUU4MjlCNUYA'
    }
  ]
}
2025-06-16T08:29:28.664Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:29.039Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:29:29.173Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 2s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T08:37:34.167Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 388 packages in 3s

40 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T08:39:37.107Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ0MUQ2QUEzMjQ2OEFGNUU0OQA=',
  timestamp: '1750063175'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2RjZGMDg0QzEyREMzNDY2MEUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQ0MUQ2QUEzMjQ2OEFGNUU0OQA=",
  "timestamp": "1750063175",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'employee_flow',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: select_activity_type message: employee_flow
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T08:39:38.933Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'employee_flow',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "કૃપા કરીને યોગ્ય પ્રવૃત્તિનો પ્રકાર પસંદ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0QTEwMjY2QUE2MjJGMDM2NEQA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T08:39:40.495Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0MzE2RDIxQzJBQTRCRjE0MEMA'
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'log_activity', step: 'select_activity_type' }
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:39:40.834Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:41.109Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:41.289Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:41.466Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:41.645Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:41.718Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:41.794Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:46.748Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQyRTQ2ODJFRkIzN0ZBQUY5QQA=',
  timestamp: '1750063185'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0MzE2RDIxQzJBQTRCRjE0MEMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQyRTQ2ODJFRkIzN0ZBQUY5QQA=",
  "timestamp": "1750063185",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: select_activity_type message: inspection
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T08:39:47.663Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MjJBRDIzNTBEMDJGMTQ2RkQA'
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'log_activity', step: 'enter_hours' }
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:39:49.497Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:49.702Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:49.716Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:50.058Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:53.608Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY4MzU3NTU3MDVGODhGNTBFOQA=',
  timestamp: '1750063192'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY4MzU3NTU3MDVGODhGNTBFOQA=",
  "timestamp": "1750063192",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: enter_hours message: 1
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "enter_hours",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true,
    "activity_type": "inspection"
  },
  "updated_at": "2025-06-16T08:39:54.806Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5QkVCQzYzM0Y3QTE4OTNFNDYA'
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'log_activity', step: 'enter_description' }
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:39:56.683Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:56.845Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:56.854Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:39:57.032Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:40:03.265Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM3NjlBMUE1MEU1MDQ1MzAwQQA=',
  timestamp: '1750063202'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM3NjlBMUE1MEU1MDQ1MzAwQQA=",
  "timestamp": "1750063202",
  "text": {
    "body": "Test"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Test"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Test',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: enter_description message: Test
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "enter_description",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true,
    "activity_type": "inspection",
    "hours": 1
  },
  "updated_at": "2025-06-16T08:40:04.141Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'Test',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3RkNDRkFBQzNERkI3QzJFRTAA'
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'log_activity', step: 'upload_image' }
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:40:06.025Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:40:06.198Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:40:06.229Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:40:06.461Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:40:14.400Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'image',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUMzQTEwNjI0NTRBOEQwN0RCQQA=',
  timestamp: '1750063212'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUMzQTEwNjI0NTRBOEQwN0RCQQA=",
  "timestamp": "1750063212",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "Mcdxhqptx8Ee6NplBkrrCKOeGU/i98GOzQ/Qzmz8Tfg=",
    "id": "1298239588331798"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: upload_image message: 
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "upload_image",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true,
    "activity_type": "inspection",
    "hours": 1,
    "description": "Test"
  },
  "updated_at": "2025-06-16T08:40:15.299Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCRDkwMjgyMkJBMzdEQjE2NUEA'
    }
  ]
}
2025-06-16T08:40:16.660Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:40:17.132Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:40:17.224Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:40:17.232Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/68cc5731-9262-4222-839c-cf75c6642e4a.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/68cc5731-9262-4222-839c-cf75c6642e4a.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5N0REMzQwQzA2MjY2QjlEQ0YA'
    }
  ]
}
Error logging activity: error: insert or update on table "activities" violates foreign key constraint "activities_site_id_sites_id_fk"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.completeActivityLog (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:508:30)
    at async EmployeeFlow.handleImageUpload (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:879:25)
    at async EmployeeFlow.handleActivityLogging (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:477:17)
    at async EmployeeFlow.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:431:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:43:13)
    at async AdminFlow.handleImpersonateEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:458:9)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:70:13) {
  length: 311,
  severity: 'ERROR',
  code: '23503',
  detail: 'Key (site_id)=(00000000-0000-0000-0000-000000000000) is not present in table "sites".',
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: 'public',
  table: 'activities',
  column: undefined,
  dataType: undefined,
  constraint: 'activities_site_id_sites_id_fk',
  file: 'ri_triggers.c',
  line: '2596',
  routine: 'ri_ReportViolation'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "માફ કરશો, તમારી પ્રવૃત્તિ નોંધવામાં ભૂલ થઈ. કૃપા કરીને ફરીથી પ્રયાસ કરો."
  }
}
2025-06-16T08:40:21.258Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:40:21.551Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:40:21.638Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1NDczN0NEODI1RjI0RDI1RjIA'
    }
  ]
}
2025-06-16T08:40:21.749Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [DB] New client connected
2025-06-16T08:40:22.348Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🔧 [ADMIN] Employee flow completed, admin context preserved
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T08:40:22.940Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:40:22.996Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T08:40:22.997Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:04:43.756Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMTU2QjNFODY4QzNCRTU1OTI4QzBCMjQwOEFDMENBNzQA',
  timestamp: '1750071882'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMTU2QjNFODY4QzNCRTU1OTI4QzBCMjQwOEFDMENBNzQA",
  "timestamp": "1750071882",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: 'log_activity',
  sessionStep: null,
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:27:03.384Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNThCRDJFRTk5NTA5OTJFN0UzREZCQjJDRTM5QkJCRTgA',
  timestamp: '1750073221'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNThCRDJFRTk5NTA5OTJFN0UzREZCQjJDRTM5QkJCRTgA",
  "timestamp": "1750073221",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: 'log_activity',
  sessionStep: null,
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🔐 Your verification code is: 486485\n\nThis code will expire in 10 minutes. Please enter this code to verify your employee account."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRkEzQTVEODFFREQwNzYwNkU5AA=='
    }
  ]
}
📲 OTP sent to +919723132143
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "👋 કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!\n\n🔐 સુરક્ષા માટે, કૃપા કરીને તમારું એકાઉન્ટ વેરિફાઈ કરો. મેં તમને 6-અંકનો વેરિફિકેશન કોડ મોકલ્યો છે.\n\nઆગળ વધવા માટે કૃપા કરીને કોડ દાખલ કરો:"
  }
}
2025-06-16T11:27:06.959Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMEIyRDAyNTA0RDAxNENBNEJEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:27:07.236Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:27:07.969Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:27:08.392Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:27:35.765Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMzlDRDg5QjUyMTlFRjE3OUI3MDc1REFCRTNCMjBDMTQA',
  timestamp: '1750073254'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMzlDRDg5QjUyMTlFRjE3OUI3MDc1REFCRTNCMjBDMTQA",
  "timestamp": "1750073254",
  "text": {
    "body": "486485"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "486485"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '486485',
  sessionIntent: 'log_activity',
  sessionStep: null,
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "Successfully verified! Welcome to the employee portal."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQUVDN0JGQjMwOEJCRUFGMUNCAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:27:39.360Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
2025-06-16T11:27:39.533Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRTk3NUZEQjJDRDZENEU4QTg3AA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* No Site Selected\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNTQ4MDdEMjc2MzE4MTFFRDQ5AA=='
    }
  ]
}
2025-06-16T11:27:41.194Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:27:41.433Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T11:27:42.178Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:27:42.611Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMzVDRjZCMTBBRTg2MURENzQyAA=='
    }
  ]
}
2025-06-16T11:27:43.724Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:27:44.196Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:28:37.797Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQ0EyQzBEQjNEQTVDQUNERTZFNzVDREJBQ0UzMzRBNkIA',
  timestamp: '1750073316'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNTQ4MDdEMjc2MzE4MTFFRDQ5AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQ0EyQzBEQjNEQTVDQUNERTZFNzVDREJBQ0UzMzRBNkIA",
  "timestamp": "1750073316",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: 'log_activity',
  sessionStep: null,
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:29:18.726Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggN0RBNUREODMyMDdCNUZDMEEwMUQxRDI3QTMwRUIzM0IA',
  timestamp: '1750073357'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggN0RBNUREODMyMDdCNUZDMEEwMUQxRDI3QTMwRUIzM0IA",
  "timestamp": "1750073357",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: 'log_activity',
  sessionStep: null,
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:31:11.062Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDkwM0FFRkUxOTIwQ0FBNzdGOTdERjAxMkMxMjcyRDAA',
  timestamp: '1750073469'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDkwM0FFRkUxOTIwQ0FBNzdGOTdERjAxMkMxMjcyRDAA",
  "timestamp": "1750073469",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: 'log_activity',
  sessionStep: null,
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:41:47.862Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUI4RjAzRjAyRDBERjU5MUE3NjhFRjhBM0VGMzBBQjkA',
  timestamp: '1750074106'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUI4RjAzRjAyRDBERjU5MUE3NjhFRjhBM0VGMzBBQjkA",
  "timestamp": "1750074106",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: 'log_activity',
  sessionStep: null,
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:42:05.847Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQkU3NEJBMUU4NTMwMjIyREUwM0U5RkY4MEZFQTA3NkYA',
  timestamp: '1750074124'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNTQ4MDdEMjc2MzE4MTFFRDQ5AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQkU3NEJBMUU4NTMwMjIyREUwM0U5RkY4MEZFQTA3NkYA",
  "timestamp": "1750074124",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "request_materials",
      "title": "📦 સામગ્રીની માંગ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "request_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'request_materials',
  sessionIntent: 'log_activity',
  sessionStep: null,
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:58:47.958Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggREU5REIxOTRCRTkxMTMzQ0IzMzhBQ0E5NkVDODA4NEQA',
  timestamp: '1750075126'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggREU5REIxOTRCRTkxMTMzQ0IzMzhBQ0E5NkVDODA4NEQA",
  "timestamp": "1750075126",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
2025-06-16T11:58:48.141Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggOTgwOTYyQUZBOEJGQ0VGMTBDMDZDMTc4RUYyMzVFRTIA',
  timestamp: '1750075127'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggOTgwOTYyQUZBOEJGQ0VGMTBDMDZDMTc4RUYyMzVFRTIA",
  "timestamp": "1750075127",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
2025-06-16T11:58:48.258Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggRkQ2RTFCNDk5REI0Q0FFQ0IxMjcwRTU0Mzg5REFDNzUA',
  timestamp: '1750075127'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggRkQ2RTFCNDk5REI0Q0FFQ0IxMjcwRTU0Mzg5REFDNzUA",
  "timestamp": "1750075127",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
👤 [HANDLER] Getting/creating user...
✅ Created new customer: +917990197662
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
❌ [TIMEOUT] Get/create user failed: error: duplicate key value violates unique constraint "users_phone_unique"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async UserService.createUser (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/userService.js:35:24)
    at async UserService.getOrCreateUser (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/userService.js:15:20)
    at async withTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:22:24)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:61:24)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 211,
  severity: 'ERROR',
  code: '23505',
  detail: 'Key (phone)=(+917990197662) already exists.',
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: 'public',
  table: 'users',
  column: undefined,
  dataType: undefined,
  constraint: 'users_phone_unique',
  file: 'nbtinsert.c',
  line: '664',
  routine: '_bt_check_unique'
}
⚠️ [HANDLER] Using temporary user (DB unavailable)
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
🆕 [HANDLER] Creating new session...
🆕 [HANDLER] Creating new session...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Hi', intent: null, step: null }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
❌ [TIMEOUT] Create session failed: error: duplicate key value violates unique constraint "sessions_pkey"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async MessageHandler.createSession (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:190:24)
    at async withTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:22:24)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:92:31)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 204,
  severity: 'ERROR',
  code: '23505',
  detail: 'Key (phone)=(+917990197662) already exists.',
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: 'public',
  table: 'sessions',
  column: undefined,
  dataType: undefined,
  constraint: 'sessions_pkey',
  file: 'nbtinsert.c',
  line: '664',
  routine: '_bt_check_unique'
}
⚠️ [HANDLER] Using temporary session (DB unavailable)
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Hi', intent: null, step: null }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ [DB] New client connected
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Hi', intent: null, step: null }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSNEM3RkI5MTZFQTQwNDQ0QkM2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSNjhFQkYyMDlERDAzREQ1QjE1AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSRDY0QzYzOTQxMjVFMDAyNTQ0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:58:51.307Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:58:51.602Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:58:51.780Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:58:51.839Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:58:51.923Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:58:52.063Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:00.245Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggODYwQkM2QzQ0MzU0RjVDNUUyQkUyMkRFRjQyNDEzNDEA',
  timestamp: '1750075139'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggODYwQkM2QzQ0MzU0RjVDNUUyQkUyMkRFRjQyNDEzNDEA",
  "timestamp": "1750075139",
  "text": {
    "body": "yes"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "yes"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'yes', intent: null, step: null }
Session updated for +917990197662: { intent: 'inquiry', step: 'collect_name', data: {} }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Great! I'd like to understand your requirements better to provide you with the most suitable options.\nPlease share your *full name*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSQTNGNzhFMzlCNzM3Q0ZFOTY2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:59:02.806Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:03.083Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:10.051Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggRjc5MERBRkJENjY5MDRDQzNCMTE4N0REM0QyNzc4NUYA',
  timestamp: '1750075149'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggRjc5MERBRkJENjY5MDRDQzNCMTE4N0REM0QyNzc4NUYA",
  "timestamp": "1750075149",
  "text": {
    "body": "Exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_name
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Exit', intent: 'inquiry', step: 'collect_name' }
Session updated for +917990197662: { step: 'collect_email', data: { full_name: 'Exit' } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Thank you Exit! \nPlease share your *email address*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSREJGRjRGRjkyNUE1QzIyOTRCAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:59:12.332Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:12.738Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:21.046Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNUU5REU3QUVBRERBNDkwQ0UyNzA1NjU0MDE4NDUwMUMA',
  timestamp: '1750075160'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNUU5REU3QUVBRERBNDkwQ0UyNzA1NjU0MDE4NDUwMUMA",
  "timestamp": "1750075160",
  "text": {
    "body": "Tezt"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Tezt"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_email
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Tezt', intent: 'inquiry', step: 'collect_email' }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Please enter a valid email address:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSOTVCNDNGQ0NDRDZFQTE4Q0RDAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:59:23.459Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:23.863Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:30.148Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggOURFMzQwRDk2MjkyNTZFMEFCQ0U2ODlCRTJGREZFRTgA',
  timestamp: '1750075169'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggOURFMzQwRDk2MjkyNTZFMEFCQ0U2ODlCRTJGREZFRTgA",
  "timestamp": "1750075169",
  "text": {
    "body": "dspatel2160@gmail.com"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "dspatel2160@gmail.com"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_email
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: 'dspatel2160@gmail.com',
  intent: 'inquiry',
  step: 'collect_email'
}
Session updated for +917990197662: {
  step: 'collect_occupation',
  data: { full_name: 'Exit', email: 'dspatel2160@gmail.com' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Great! \nWhat is your *occupation/profession*?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSQjFDQkVBMjQ5N0FBMzFCMDdFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:59:32.568Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:32.903Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:37.498Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggQjVDMkEwRjEzNEM4NUVGN0JFOTUwMUU5QUIyNTZCQTUA',
  timestamp: '1750075176'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggQjVDMkEwRjEzNEM4NUVGN0JFOTUwMUU5QUIyNTZCQTUA",
  "timestamp": "1750075176",
  "text": {
    "body": "Business"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Business"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_occupation
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: 'Business',
  intent: 'inquiry',
  step: 'collect_occupation'
}
Session updated for +917990197662: {
  step: 'collect_space_requirement',
  data: {
    email: 'dspatel2160@gmail.com',
    full_name: 'Exit',
    occupation: 'Business'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Thanks! \nWhat is your *office space requirement*? (e.g., 600 sq ft, 1000 sq ft, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSMzI4MUIzNzE2MkVCRkQxRENCAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:59:39.817Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:40.167Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:43.800Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggQTg0ODcxMTlCNzRCODVBRkZDNTNBRkVGRURFNzAxNDAA',
  timestamp: '1750075183'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggQTg0ODcxMTlCNzRCODVBRkZDNTNBRkVGRURFNzAxNDAA",
  "timestamp": "1750075183",
  "text": {
    "body": "900"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "900"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_space_requirement
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: '900',
  intent: 'inquiry',
  step: 'collect_space_requirement'
}
Session updated for +917990197662: {
  step: 'collect_space_use',
  data: {
    email: 'dspatel2160@gmail.com',
    full_name: 'Exit',
    occupation: 'Business',
    office_space_requirement: '900'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Perfect! \nWhat will be the *primary use* of this office space? (e.g., consultancy, retail, café, startup office, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSRUE4RTA2RDFDOTQwNTZFODgxAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:59:46.225Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:46.581Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:51.391Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggQTQ5QkMyNTVFNkM2NjExRkEwNUNFNDYxQjg4RDAwMzIA',
  timestamp: '1750075190'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggQTQ5QkMyNTVFNkM2NjExRkEwNUNFNDYxQjg4RDAwMzIA",
  "timestamp": "1750075190",
  "text": {
    "body": "Retail"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Retail"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_space_use
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Retail', intent: 'inquiry', step: 'collect_space_use' }
Session updated for +917990197662: {
  step: 'collect_price_range',
  data: {
    email: 'dspatel2160@gmail.com',
    full_name: 'Exit',
    occupation: 'Business',
    office_space_requirement: '900',
    office_space_use: 'Retail'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Excellent! \nWhat is your *expected price range/budget*? (e.g., ₹50-75 Lakhs, ₹1-2 Crores, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSQ0I0NjBDMkMwNDJBMDlBNjQwAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T11:59:53.570Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:53.886Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T11:59:59.734Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggQkJBRTJDMUNERUQ4NUQ4NDg0Njk2RUMxRTM3MjJEQkYA',
  timestamp: '1750075198'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggQkJBRTJDMUNERUQ4NUQ4NDg0Njk2RUMxRTM3MjJEQkYA",
  "timestamp": "1750075198",
  "text": {
    "body": "50000"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "50000"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_price_range
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: '50000',
  intent: 'inquiry',
  step: 'collect_price_range'
}
Inquiry saved: {
  id: '946517b4-ca26-4da2-8fd5-f944efe7783a',
  phone: '+917990197662',
  full_name: 'Exit',
  email: 'dspatel2160@gmail.com',
  occupation: 'Business',
  office_space_requirement: '900',
  office_space_use: 'Retail',
  expected_price_range: '50000',
  status: 'inquiry',
  notes: null,
  created_at: 2025-06-16T12:00:00.732Z,
  updated_at: 2025-06-16T12:00:00.732Z
}
No Zoho refresh token available. Please complete OAuth setup.
Cannot send email - no valid access token
Email notification sent for inquiry: 946517b4-ca26-4da2-8fd5-f944efe7783a
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "✅ *Thank you for your details!*\n\n📋 *Your Requirements Summary:*\n• Name: Exit\n• Email: dspatel2160@gmail.com\n• Occupation: Business\n• Space Requirement: 900\n• Intended Use: Retail\n• Budget Range: 50000\n\nOur team will review your requirements and get back to you with suitable options.\n\nWould you like to book a site visit to see the project in person?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Site Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "talk_later",
            "title": "💬 I'll Call You Later"
          }
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Button title length invalid. Min length: 1, Max length: 20'
    },
    fbtrace_id: 'AWEPztO-NcGcWzBJmuj-Xmz'
  }
}
Error message: Request failed with status code 400
Error sending button message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:179:30)
    at async WhatsAppService.sendButtonMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:58:13)
    at async CustomerFlow.completeInquiry (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:247:13)
    at async CustomerFlow.handleInquiryFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:183:17)
    at async CustomerFlow.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:105:13)
    at async CustomerFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/customerFlow.js:53:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:121:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '683',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
    data: `{"messaging_product":"whatsapp","to":"+917990197662","type":"interactive","interactive":{"type":"button","body":{"text":"✅ *Thank you for your details!*\\n\\n📋 *Your Requirements Summary:*\\n• Name: Exit\\n• Email: dspatel2160@gmail.com\\n• Occupation: Business\\n• Space Requirement: 900\\n• Intended Use: Retail\\n• Budget Range: 50000\\n\\nOur team will review your requirements and get back to you with suitable options.\\n\\nWould you like to book a site visit to see the project in person?"},"action":{"buttons":[{"type":"reply","reply":{"id":"book_visit","title":"📅 Book Site Visit"}},{"type":"reply","reply":{"id":"talk_later","title":"💬 I'll Call You Later"}}]}}}`,
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '683',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 12043177,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 3773,
        [Symbol(triggerId)]: 3771
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 683\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/652783161256584/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 683,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AWEPztO-NcGcWzBJmuj-Xmz',
      'x-fb-trace-id': 'Fl3DxaQYiIc',
      'x-fb-rev': '1023868176',
      'x-fb-debug': '94jTr/SYGUV8AoQcP2FDkHFwcpeWYCfQP9UgT+2yNIbEwByEFJSkIKjA7Y6zWmTSRSQ1gI7TBDiTjfYEiH28ww==',
      date: 'Mon, 16 Jun 2025 12:00:01 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcPhSWWgt2Nw4KWfXltFuLhsG6gDPu-9LVIg8zxYGkxXHnrWxiMSmmAOunZSR2fkznK5tt4s0_--3sQKNHL1YuiIgYzbb2JH"; e_clientaddr="AcNXXR6yc_e-NHAA5YjuqvT5HvcAPx_Dh7nmwKnXONhTI_WcUWyPWbMp-pFqzZ2iNTTo7H8DNoOficMA3Bhv8cwEj2JlyA8MGXBLTFXF0PVLAN518A"; e_upip="AcPffQlTzr9e5_5yJ-GBYNM8NVzp0m6ksvx2xtBFFaK_X5rQBWv3sq-OmFc7xKYn_XktOXotVvT_VtD5SuNhWkiE54pvasSrt-_wcDw"; e_fb_zone="AcMz6CQYM3SJcCOXbbas5yXCJC_sIZAgcsupGh4g63KJ5xqfNOoBRuYEuqixrSLV"; e_fb_twtaskhandle="AcPGsWLoZ4dIfLg2UD-72xN-wng0CCx5Iwe9vrrvj09m_L68jQlDvTmnXet97WgqpkUHh-2ZD_hgluATZ6cj2_zBmhLihXE2d-thoLJg2B6vvgw"; e_proxy="AcMpmTUFxpK-GQjETImOIHsmWEh96LO_MKjFhxbqV__WsYfdNSOgsWsx1T0-dORI7j30sYUjh2pSprpJqE0", http_request_error; e_fb_vipaddr="AcMBYPdx7xXVS58EotrRtR0ljHsKflwLH-VC1wSx40huvS4MSLW8i_oHZszdXePIsFw-ax4BOWI8xzjMuiL5D8TP85SkYh-G"; e_clientaddr="AcM8kxbwzJ_i2AEzHCM1Mx85Lvo4pfuAER76Ih6fU4rJSwNQBxILIE42RgEg9GV59gejUtwEbkTJcTRqIJbq-3T8u1lCIoOZUeAT6O5JtfiDXgPMj-ZqeA"; e_upip="AcPmoWl7vmgjoer9nvzcFaiuQe76lsN5XKNUzOy2_3fVAobizRp6AXT_NRoVC-LK8OUssuI4ZdazgeVe4Nxxm5sMMz_hRDww"; e_fb_zone="AcOdTCHuCzOVQ8lVTvbfqLmvf62X9V79IkQX1GBGf0_zuZqIaMlScg_YyifqPw"; e_fb_twtaskhandle="AcMya5dsVwZZ7tz-FhIAisAPbx9ACTUU-rBBHZLACQ5_Wz-5icC37ljXCB4878t1cPJoqOCpGuImxi6iTwEjVoUIWih5Z-xLv0AIlw"; e_proxy="AcOpyk4c8TjX5fNonzEvpL9HOdCUehp6TsmDuhbJh52ZPBbd9U4Szf3oCI8xIqtzLzp_Ft09bMC3Acc"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=43, rtx=0, c=10, mss=1380, tbw=1385, tp=-1, tpl=-1, uplat=433, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '192'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      data: `{"messaging_product":"whatsapp","to":"+917990197662","type":"interactive","interactive":{"type":"button","body":{"text":"✅ *Thank you for your details!*\\n\\n📋 *Your Requirements Summary:*\\n• Name: Exit\\n• Email: dspatel2160@gmail.com\\n• Occupation: Business\\n• Space Requirement: 900\\n• Intended Use: Retail\\n• Budget Range: 50000\\n\\nOur team will review your requirements and get back to you with suitable options.\\n\\nWould you like to book a site visit to see the project in person?"},"action":{"buttons":[{"type":"reply","reply":{"id":"book_visit","title":"📅 Book Site Visit"}},{"type":"reply","reply":{"id":"talk_later","title":"💬 I'll Call You Later"}}]}}}`,
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '683',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 683\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/652783161256584/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
Session updated for +917990197662: {
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    inquiry_id: '946517b4-ca26-4da2-8fd5-f944efe7783a',
    email: 'dspatel2160@gmail.com',
    full_name: 'Exit',
    occupation: 'Business',
    office_space_use: 'Retail',
    office_space_requirement: '900',
    expected_price_range: '50000'
  }
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T12:05:04.629Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMDM3RTdDM0RCMzFDNDExMzY2OTdFMkNDM0U2NzYwQjgA',
  timestamp: '1750075503'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMDM3RTdDM0RCMzFDNDExMzY2OTdFMkNDM0U2NzYwQjgA",
  "timestamp": "1750075503",
  "text": {
    "body": "Menu"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Menu"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: post_inquiry, Step: awaiting_response
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: 'Menu',
  intent: 'post_inquiry',
  step: 'awaiting_response'
}
User +917990197662 requested menu/restart, clearing session and showing project details
Session cleared for +917990197662
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSQzMyMUE2MEZGOEM3QzUzNzRBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:05:08.234Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:08.290Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:14.693Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggQjg2RDAxQkY0ODBGNjZBMEZEMkYxNzc1NzY2RUYyNkYA',
  timestamp: '1750075514'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggQjg2RDAxQkY0ODBGNjZBMEZEMkYxNzc1NzY2RUYyNkYA",
  "timestamp": "1750075514",
  "text": {
    "body": "Yes"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Yes"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Yes', intent: null, step: null }
Session updated for +917990197662: { intent: 'inquiry', step: 'collect_name', data: {} }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Great! I'd like to understand your requirements better to provide you with the most suitable options.\nPlease share your *full name*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSMjM3QjQ4RjcyODBFNzA3OEY3AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:05:17.181Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:17.417Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:26.006Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMjcyRjBDMkM0MjkwNjYzM0I3NkJFNEZDRjFGOEE4QjIA',
  timestamp: '1750075525'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMjcyRjBDMkM0MjkwNjYzM0I3NkJFNEZDRjFGOEE4QjIA",
  "timestamp": "1750075525",
  "text": {
    "body": "Gd Patel"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Gd Patel"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_name
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Gd Patel', intent: 'inquiry', step: 'collect_name' }
Session updated for +917990197662: { step: 'collect_email', data: { full_name: 'Gd Patel' } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Thank you Gd Patel! \nPlease share your *email address*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSNkZGQ0ZDRDcxRERGREY0ODdEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:05:28.367Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:28.926Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:33.532Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNDM3N0ZERDY3RUJEQTVEQjI4QjA4RDNFNjEyOThEREQA',
  timestamp: '1750075532'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNDM3N0ZERDY3RUJEQTVEQjI4QjA4RDNFNjEyOThEREQA",
  "timestamp": "1750075532",
  "text": {
    "body": "DSPATEL2160@GMAIL.COM"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "DSPATEL2160@GMAIL.COM"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_email
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: 'DSPATEL2160@GMAIL.COM',
  intent: 'inquiry',
  step: 'collect_email'
}
Session updated for +917990197662: {
  step: 'collect_occupation',
  data: { full_name: 'Gd Patel', email: 'DSPATEL2160@GMAIL.COM' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Great! \nWhat is your *occupation/profession*?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSQzc3MjYwOTZBODcxRTI3OTQ5AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:05:35.797Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:36.111Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:39.713Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNEU4MDExRjFGMUJBNTc1MERFRDdFRDNCODI0QzZFRjAA',
  timestamp: '1750075539'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNEU4MDExRjFGMUJBNTc1MERFRDdFRDNCODI0QzZFRjAA",
  "timestamp": "1750075539",
  "text": {
    "body": "Biz"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Biz"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_occupation
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Biz', intent: 'inquiry', step: 'collect_occupation' }
Session updated for +917990197662: {
  step: 'collect_space_requirement',
  data: {
    email: 'DSPATEL2160@GMAIL.COM',
    full_name: 'Gd Patel',
    occupation: 'Biz'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Thanks! \nWhat is your *office space requirement*? (e.g., 600 sq ft, 1000 sq ft, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSNzNGNDVGMzE5Q0QxQkIyODI4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:05:42.509Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:42.749Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:46.204Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggRThEMzdCM0RCQ0E1RDlGMDExQkRBOEFBNkE4REIwMzEA',
  timestamp: '1750075545'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggRThEMzdCM0RCQ0E1RDlGMDExQkRBOEFBNkE4REIwMzEA",
  "timestamp": "1750075545",
  "text": {
    "body": "700"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "700"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_space_requirement
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: '700',
  intent: 'inquiry',
  step: 'collect_space_requirement'
}
Session updated for +917990197662: {
  step: 'collect_space_use',
  data: {
    email: 'DSPATEL2160@GMAIL.COM',
    full_name: 'Gd Patel',
    occupation: 'Biz',
    office_space_requirement: '700'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Perfect! \nWhat will be the *primary use* of this office space? (e.g., consultancy, retail, café, startup office, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSMjI2N0EwNjlCMkIwOEM1NEIwAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:05:48.410Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:48.744Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:56.975Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggOTMzRDQ5NEEzOEY5RTM3MjFDRDM2RUM1MDc1NUU1OUYA',
  timestamp: '1750075556'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggOTMzRDQ5NEEzOEY5RTM3MjFDRDM2RUM1MDc1NUU1OUYA",
  "timestamp": "1750075556",
  "text": {
    "body": "Office"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Office"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_space_use
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Office', intent: 'inquiry', step: 'collect_space_use' }
Session updated for +917990197662: {
  step: 'collect_price_range',
  data: {
    email: 'DSPATEL2160@GMAIL.COM',
    full_name: 'Gd Patel',
    occupation: 'Biz',
    office_space_requirement: '700',
    office_space_use: 'Office'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Excellent! \nWhat is your *expected price range/budget*? (e.g., ₹50-75 Lakhs, ₹1-2 Crores, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSRkI0NzA0MEM5RDk5QzQwNDQ3AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:05:59.257Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:05:59.653Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:06:06.705Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNkI5NzRBRENCQUE4QTE5NDAyRkM2M0RBRDc0N0ZBOEYA',
  timestamp: '1750075565'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNkI5NzRBRENCQUE4QTE5NDAyRkM2M0RBRDc0N0ZBOEYA",
  "timestamp": "1750075565",
  "text": {
    "body": "50 lakh"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "50 lakh"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_price_range
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: '50 lakh',
  intent: 'inquiry',
  step: 'collect_price_range'
}
Inquiry saved: {
  id: '53503c0d-f35d-4f8a-bd26-bdd090cd8c5b',
  phone: '+917990197662',
  full_name: 'Gd Patel',
  email: 'DSPATEL2160@GMAIL.COM',
  occupation: 'Biz',
  office_space_requirement: '700',
  office_space_use: 'Office',
  expected_price_range: '50 lakh',
  status: 'inquiry',
  notes: null,
  created_at: 2025-06-16T12:06:07.686Z,
  updated_at: 2025-06-16T12:06:07.686Z
}
No Zoho refresh token available. Please complete OAuth setup.
Cannot send email - no valid access token
Email notification sent for inquiry: 53503c0d-f35d-4f8a-bd26-bdd090cd8c5b
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "✅ *Thank you for your details!*\n\n📋 *Your Requirements Summary:*\n• Name: Gd Patel\n• Email: DSPATEL2160@GMAIL.COM\n• Occupation: Biz\n• Space Requirement: 700\n• Intended Use: Office\n• Budget Range: 50 lakh\n\nOur team will review your requirements and get back to you with suitable options.\n\nWould you like to book a site visit to see the project in person?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "talk_later",
            "title": "💬 Call Later"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSQzYyNzU5MUQ4NzdDRUQwODZFAA=='
    }
  ]
}
Session updated for +917990197662: {
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    inquiry_id: '53503c0d-f35d-4f8a-bd26-bdd090cd8c5b',
    email: 'DSPATEL2160@GMAIL.COM',
    full_name: 'Gd Patel',
    occupation: 'Biz',
    office_space_use: 'Office',
    office_space_requirement: '700',
    expected_price_range: '50 lakh'
  }
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:06:08.976Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:06:09.284Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:06:15.976Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMjI3QTY4NzUxQzJGMDNCMDVEQTVBMTNGRTQ0QUQ4MEMA',
  timestamp: '1750075575'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSQzYyNzU5MUQ4NzdDRUQwODZFAA=="
  },
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMjI3QTY4NzUxQzJGMDNCMDVEQTVBMTNGRTQ0QUQ4MEMA",
  "timestamp": "1750075575",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "book_visit",
      "title": "📅 Book Visit"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "book_visit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: post_inquiry, Step: awaiting_response
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: 'book_visit',
  intent: 'post_inquiry',
  step: 'awaiting_response'
}
Post-inquiry response from +917990197662: {
  text: 'book_visit',
  responseId: 'book_visit',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'book_visit', title: '📅 Book Visit' }
  }
}
Session updated for +917990197662: {
  intent: 'booking',
  step: 'select_date',
  data: { customer_name: 'Gd Patel' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "📅 *Book Your Site Visit*\n\nGreat! Let's schedule your site visit to see the Suvasam Gota Commercial Hub.\n\nPlease select your preferred date:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSMTQ4NDlFRUYzNjFFNjBCOEI4AA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select your preferred date:"
    },
    "action": {
      "button": "Choose Date",
      "sections": [
        {
          "title": "Available Dates",
          "rows": [
            {
              "id": "2025-06-17",
              "title": "Tue, 17 Jun",
              "description": "Tomorrow"
            },
            {
              "id": "2025-06-18",
              "title": "Wed, 18 Jun",
              "description": ""
            },
            {
              "id": "2025-06-19",
              "title": "Thu, 19 Jun",
              "description": ""
            },
            {
              "id": "2025-06-20",
              "title": "Fri, 20 Jun",
              "description": ""
            },
            {
              "id": "2025-06-21",
              "title": "Sat, 21 Jun",
              "description": ""
            },
            {
              "id": "2025-06-22",
              "title": "Sun, 22 Jun",
              "description": ""
            },
            {
              "id": "2025-06-23",
              "title": "Mon, 23 Jun",
              "description": ""
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T12:06:18.355Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSRTVCMUZGNDkzNjMwNUIzQzE5AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:06:18.532Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:06:19.025Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:06:19.331Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:06:23.133Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggRjU5MDVEOTk0MjA4OTlCMTlGNDhBMkE5RDFFRURDM0QA',
  timestamp: '1750075582'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSRTVCMUZGNDkzNjMwNUIzQzE5AA=="
  },
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggRjU5MDVEOTk0MjA4OTlCMTlGNDhBMkE5RDFFRURDM0QA",
  "timestamp": "1750075582",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "2025-06-18",
      "title": "Wed, 18 Jun"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "2025-06-18"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: booking, Step: select_date
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: '2025-06-18', intent: 'booking', step: 'select_date' }
Session updated for +917990197662: {
  step: 'select_time',
  data: { customer_name: 'Gd Patel', date: '2025-06-18' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select your preferred time:"
    },
    "action": {
      "button": "Choose Time",
      "sections": [
        {
          "title": "Available Time Slots",
          "rows": [
            {
              "id": "10:00",
              "title": "10:00 AM",
              "description": "Morning slot"
            },
            {
              "id": "12:00",
              "title": "12:00 PM",
              "description": "Noon slot"
            },
            {
              "id": "15:00",
              "title": "3:00 PM",
              "description": "Afternoon"
            },
            {
              "id": "17:00",
              "title": "5:00 PM",
              "description": "Evening"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSRDMyRkVCNkUxNzIwMzA2RUU0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:06:25.483Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:06:25.746Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:06:28.988Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMDgyQkQ0NEJCQTMyM0EyODQzMURFQjA4RTQwQkEzRjgA',
  timestamp: '1750075588'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSRDMyRkVCNkUxNzIwMzA2RUU0AA=="
  },
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMDgyQkQ0NEJCQTMyM0EyODQzMURFQjA4RTQwQkEzRjgA",
  "timestamp": "1750075588",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "12:00",
      "title": "12:00 PM",
      "description": "Noon slot"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "12:00"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: booking, Step: select_time
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: '12:00', intent: 'booking', step: 'select_time' }
Booking created: {
  id: 'eb4f90a3-c83f-403e-a1aa-9f2beb6174f3',
  customer_phone: '+917990197662',
  customer_name: 'Gd Patel',
  slot_time: 2025-06-18T17:00:00.000Z,
  duration_minutes: 60,
  status: 'pending',
  notes: 'Site visit for Suvasam Gota Commercial Hub',
  created_at: 2025-06-16T12:06:29.952Z,
  updated_at: 2025-06-16T12:06:29.952Z
}
Session cleared for +917990197662
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "✅ *Site Visit Confirmed!*\n\n📋 *Visit Details:*\n• Date: Tuesday 17 June, 2025\n• Time: 12:00 PM\n• Location: Suvasam Gota Commercial Hub, Gota Road, Ahmedabad\n\n📍 *Exact Address:*\nNr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n\n🔗 *Google Maps:* https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\n\n📞 Our team will call you 1 day before your visit to confirm and provide additional details.\n\n*Booking ID:* eb4f90a3\n\nThank you for choosing Suvasam Group! 🏢"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSOTVDRTczNjBGNzAyQzJFMzUwAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:06:31.634Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:06:31.711Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:06:43.893Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNDEzRDBFMzMxODRDQUE3NTdCNUMyRDYxNzZBM0EyQjYA',
  timestamp: '1750075603'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNDEzRDBFMzMxODRDQUE3NTdCNUMyRDYxNzZBM0EyQjYA",
  "timestamp": "1750075603",
  "text": {
    "body": "Exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Exit', intent: null, step: null }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSNTExNEEyNTQ5QUMwN0YxNkUzAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:06:46.258Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:06:46.691Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:07:12.085Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMEY5RDFFQ0NFQkY2QzA3MDQxMTZCRkRBOTlFRDY3QjkA',
  timestamp: '1750075631'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMEY5RDFFQ0NFQkY2QzA3MDQxMTZCRkRBOTlFRDY3QjkA",
  "timestamp": "1750075631",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Hi', intent: null, step: null }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "🏢 *Suvasam Group – Upcoming Gota Commercial Hub*\n📍 Nr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n🔗 Google Maps location: [Click here](https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy)\n\n🏗️ *Upcoming Project Highlights:*\n• Total 74 units (600–2,000 sq ft): 21 shops + 53 office suites\n• Ideal mix for retail outlets, cafés, services, SMEs, consultancies, and start-ups\n• Prime access to SG Highway, public transport & residential clusters\n• Amenities include well-planned common areas, parking provisions & utility-ready setups\n• Developer: Suvasam Group – focused on quality & timely delivery\n\n\nWould you like to know more and book a site visit? Please reply with *\"yes\"* to continue."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSOTExOTNEQzVFQ0U5OURGRDMxAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:07:14.568Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:07:14.925Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:08:45.741Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMEI2QUM5QzUwOUM3NUIwRUMwMzUwRjc0MTUwOUI1MDEA',
  timestamp: '1750075724'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMEI2QUM5QzUwOUM3NUIwRUMwMzUwRjc0MTUwOUI1MDEA",
  "timestamp": "1750075724",
  "text": {
    "body": "Yes"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Yes"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Yes', intent: null, step: null }
Session updated for +917990197662: { intent: 'inquiry', step: 'collect_name', data: {} }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Great! I'd like to understand your requirements better to provide you with the most suitable options.\nPlease share your *full name*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSMTU2RUFERjFFOTc2MzhGODJFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:08:49.130Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:08:49.253Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:09:20.132Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNDk0M0M5REZENjJFRTRFM0VDMkI0NzE0MTFGQjcwNzMA',
  timestamp: '1750075759'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNDk0M0M5REZENjJFRTRFM0VDMkI0NzE0MTFGQjcwNzMA",
  "timestamp": "1750075759",
  "text": {
    "body": "Patel"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Patel"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_name
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Patel', intent: 'inquiry', step: 'collect_name' }
Session updated for +917990197662: { step: 'collect_email', data: { full_name: 'Patel' } }
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Thank you Patel! \nPlease share your *email address*:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSNUQ3QUNCRkU3NUMzMUZFRjk4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:09:22.985Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:09:23.368Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:10:09.985Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMTEyQTJGQjNCNjg5QzQ2REU2REQzNEU4RkNGNzhENjIA',
  timestamp: '1750075809'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMTEyQTJGQjNCNjg5QzQ2REU2REQzNEU4RkNGNzhENjIA",
  "timestamp": "1750075809",
  "text": {
    "body": "Gdpatrl@gmail.com"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Gdpatrl@gmail.com"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_email
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: 'Gdpatrl@gmail.com',
  intent: 'inquiry',
  step: 'collect_email'
}
Session updated for +917990197662: {
  step: 'collect_occupation',
  data: { full_name: 'Patel', email: 'Gdpatrl@gmail.com' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Great! \nWhat is your *occupation/profession*?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSNzk3MjcxQ0M5ODEyMjdGODA4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:10:13.332Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:10:13.431Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:10:50.037Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMUY1NTY4QjY5OUEwQkUwRTZGQ0MyNTlCQzE2NDYwRDIA',
  timestamp: '1750075849'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMUY1NTY4QjY5OUEwQkUwRTZGQ0MyNTlCQzE2NDYwRDIA",
  "timestamp": "1750075849",
  "text": {
    "body": "Bijnes"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Bijnes"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_occupation
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: 'Bijnes',
  intent: 'inquiry',
  step: 'collect_occupation'
}
Session updated for +917990197662: {
  step: 'collect_space_requirement',
  data: {
    email: 'Gdpatrl@gmail.com',
    full_name: 'Patel',
    occupation: 'Bijnes'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Thanks! \nWhat is your *office space requirement*? (e.g., 600 sq ft, 1000 sq ft, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSRjdEQzlFODNGNENDNzg3QzA3AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:10:53.826Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:10:53.856Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:11:11.483Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNUE1MjBDMjJDNTA4NDVFN0JCQThCMDlGREYxMTY5NzEA',
  timestamp: '1750075870'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNUE1MjBDMjJDNTA4NDVFN0JCQThCMDlGREYxMTY5NzEA",
  "timestamp": "1750075870",
  "text": {
    "body": "800"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "800"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_space_requirement
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: '800',
  intent: 'inquiry',
  step: 'collect_space_requirement'
}
Session updated for +917990197662: {
  step: 'collect_space_use',
  data: {
    email: 'Gdpatrl@gmail.com',
    full_name: 'Patel',
    occupation: 'Bijnes',
    office_space_requirement: '800'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Perfect! \nWhat will be the *primary use* of this office space? (e.g., consultancy, retail, café, startup office, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSRjRBQjk0QTk0NDg1RkM4QUNBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:11:14.089Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:11:14.392Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:12:02.330Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMzY2OTc5OTRCNUMxREFFRkUyQjVGMDE2NDY3N0QzQzEA',
  timestamp: '1750075921'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMzY2OTc5OTRCNUMxREFFRkUyQjVGMDE2NDY3N0QzQzEA",
  "timestamp": "1750075921",
  "text": {
    "body": "Ofise"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "Ofise"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_space_use
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: 'Ofise', intent: 'inquiry', step: 'collect_space_use' }
Session updated for +917990197662: {
  step: 'collect_price_range',
  data: {
    email: 'Gdpatrl@gmail.com',
    full_name: 'Patel',
    occupation: 'Bijnes',
    office_space_requirement: '800',
    office_space_use: 'Ofise'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "Excellent! \nWhat is your *expected price range/budget*? (e.g., ₹50-75 Lakhs, ₹1-2 Crores, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSNTIwQTZBMkI4NDZDOEQxREUyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:12:05.134Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:12:06.235Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:12:50.263Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'text',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMkM4QkNDODExRjZBQTVDM0FEQzNFREExQ0M2QUU2N0UA',
  timestamp: '1750075969'
}
[WEBHOOK] Message content: {
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMkM4QkNDODExRjZBQTVDM0FEQzNFREExQ0M2QUU2N0UA",
  "timestamp": "1750075969",
  "text": {
    "body": "20l"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "20l"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inquiry, Step: collect_price_range
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: '20l', intent: 'inquiry', step: 'collect_price_range' }
Inquiry saved: {
  id: '0a26aee6-2465-45f0-b5a3-3d7c891bba4e',
  phone: '+917990197662',
  full_name: 'Patel',
  email: 'Gdpatrl@gmail.com',
  occupation: 'Bijnes',
  office_space_requirement: '800',
  office_space_use: 'Ofise',
  expected_price_range: '20l',
  status: 'inquiry',
  notes: null,
  created_at: 2025-06-16T12:12:51.743Z,
  updated_at: 2025-06-16T12:12:51.743Z
}
No Zoho refresh token available. Please complete OAuth setup.
Cannot send email - no valid access token
Email notification sent for inquiry: 0a26aee6-2465-45f0-b5a3-3d7c891bba4e
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "✅ *Thank you for your details!*\n\n📋 *Your Requirements Summary:*\n• Name: Patel\n• Email: Gdpatrl@gmail.com\n• Occupation: Bijnes\n• Space Requirement: 800\n• Intended Use: Ofise\n• Budget Range: 20l\n\nOur team will review your requirements and get back to you with suitable options.\n\nWould you like to book a site visit to see the project in person?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "book_visit",
            "title": "📅 Book Visit"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "talk_later",
            "title": "💬 Call Later"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSRURFRTVDRUU4NEY0QUQ5RDE5AA=='
    }
  ]
}
Session updated for +917990197662: {
  intent: 'post_inquiry',
  step: 'awaiting_response',
  data: {
    inquiry_id: '0a26aee6-2465-45f0-b5a3-3d7c891bba4e',
    email: 'Gdpatrl@gmail.com',
    full_name: 'Patel',
    occupation: 'Bijnes',
    office_space_use: 'Ofise',
    office_space_requirement: '800',
    expected_price_range: '20l'
  }
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:12:53.179Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:12:53.517Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:13:25.588Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNDQzMTE5M0Y0MkUxN0REQUY0QUU0NkE1QkFERjhCRjUA',
  timestamp: '1750076004'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSRURFRTVDRUU4NEY0QUQ5RDE5AA=="
  },
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggNDQzMTE5M0Y0MkUxN0REQUY0QUU0NkE1QkFERjhCRjUA",
  "timestamp": "1750076004",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "book_visit",
      "title": "📅 Book Visit"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "book_visit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: post_inquiry, Step: awaiting_response
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: {
  messageText: 'book_visit',
  intent: 'post_inquiry',
  step: 'awaiting_response'
}
Post-inquiry response from +917990197662: {
  text: 'book_visit',
  responseId: 'book_visit',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'book_visit', title: '📅 Book Visit' }
  }
}
Session updated for +917990197662: {
  intent: 'booking',
  step: 'select_date',
  data: { customer_name: 'Patel' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "📅 *Book Your Site Visit*\n\nGreat! Let's schedule your site visit to see the Suvasam Gota Commercial Hub.\n\nPlease select your preferred date:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSRDc2QjVGMEMzMDExREJDNDg2AA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select your preferred date:"
    },
    "action": {
      "button": "Choose Date",
      "sections": [
        {
          "title": "Available Dates",
          "rows": [
            {
              "id": "2025-06-17",
              "title": "Tue, 17 Jun",
              "description": "Tomorrow"
            },
            {
              "id": "2025-06-18",
              "title": "Wed, 18 Jun",
              "description": ""
            },
            {
              "id": "2025-06-19",
              "title": "Thu, 19 Jun",
              "description": ""
            },
            {
              "id": "2025-06-20",
              "title": "Fri, 20 Jun",
              "description": ""
            },
            {
              "id": "2025-06-21",
              "title": "Sat, 21 Jun",
              "description": ""
            },
            {
              "id": "2025-06-22",
              "title": "Sun, 22 Jun",
              "description": ""
            },
            {
              "id": "2025-06-23",
              "title": "Mon, 23 Jun",
              "description": ""
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T12:13:28.408Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSREVFRTM0OENBQzc2N0U0ODAyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:13:28.759Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:13:29.168Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:13:29.600Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:13:53.411Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMjYzMkMwQ0E5NzZGNjI3NTZFRUMxOTMxMDJDOTlGNzIA',
  timestamp: '1750076032'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSREVFRTM0OENBQzc2N0U0ODAyAA=="
  },
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMjYzMkMwQ0E5NzZGNjI3NTZFRUMxOTMxMDJDOTlGNzIA",
  "timestamp": "1750076032",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "2025-06-23",
      "title": "Mon, 23 Jun"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "2025-06-23"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: booking, Step: select_date
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: '2025-06-23', intent: 'booking', step: 'select_date' }
Session updated for +917990197662: {
  step: 'select_time',
  data: { customer_name: 'Patel', date: '2025-06-23' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select your preferred time:"
    },
    "action": {
      "button": "Choose Time",
      "sections": [
        {
          "title": "Available Time Slots",
          "rows": [
            {
              "id": "10:00",
              "title": "10:00 AM",
              "description": "Morning slot"
            },
            {
              "id": "12:00",
              "title": "12:00 PM",
              "description": "Noon slot"
            },
            {
              "id": "15:00",
              "title": "3:00 PM",
              "description": "Afternoon"
            },
            {
              "id": "17:00",
              "title": "5:00 PM",
              "description": "Evening"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSMkMzNjM3RkJGQjcyQkMyRkM3AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:13:55.765Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:13:56.098Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:14:16.926Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917990197662: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMDUyNDk5MjUyOEM1RTRCRDgyRkFGQzNDMTA1NEE1M0IA',
  timestamp: '1750076056'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSMkMzNjM3RkJGQjcyQkMyRkM3AA=="
  },
  "from": "917990197662",
  "id": "wamid.HBgMOTE3OTkwMTk3NjYyFQIAEhggMDUyNDk5MjUyOEM1RTRCRDgyRkFGQzNDMTA1NEE1M0IA",
  "timestamp": "1750076056",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "12:00",
      "title": "12:00 PM",
      "description": "Noon slot"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917990197662
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: customer
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: customer, Phone: +917990197662
💬 [HANDLER] Message: "12:00"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: booking, Step: select_time
🚦 [HANDLER] Routing to customer flow...
Handling message for +917990197662: { messageText: '12:00', intent: 'booking', step: 'select_time' }
Booking created: {
  id: '3f90baab-b199-4f9e-9de7-f3469a029a03',
  customer_phone: '+917990197662',
  customer_name: 'Patel',
  slot_time: 2025-06-23T17:00:00.000Z,
  duration_minutes: 60,
  status: 'pending',
  notes: 'Site visit for Suvasam Gota Commercial Hub',
  created_at: 2025-06-16T12:14:17.970Z,
  updated_at: 2025-06-16T12:14:17.970Z
}
Session cleared for +917990197662
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917990197662",
  "type": "text",
  "text": {
    "body": "✅ *Site Visit Confirmed!*\n\n📋 *Visit Details:*\n• Date: Sunday 22 June, 2025\n• Time: 12:00 PM\n• Location: Suvasam Gota Commercial Hub, Gota Road, Ahmedabad\n\n📍 *Exact Address:*\nNr. Vishwakarma Temple, Gota Road, Chandlodiya, Gota, Ahmedabad – 382481\n\n🔗 *Google Maps:* https://maps.app.goo.gl/hsBg4wq4JdRs3SUSA?g_st=com.google.maps.preview.copy\n\n📞 Our team will call you 1 day before your visit to confirm and provide additional details.\n\n*Booking ID:* 3f90baab\n\nThank you for choosing Suvasam Group! 🏢"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917990197662', wa_id: '917990197662' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3OTkwMTk3NjYyFQIAERgSMTk2QzVFNzVBQ0Y3OThDMUIyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:14:19.640Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:14:19.964Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:16:53.180Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNkZDRkFFQUUyOUI3MjJFNDczMDY1MjlDRjU1Rjg3REMA',
  timestamp: '1750076211'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNkZDRkFFQUUyOUI3MjJFNDczMDY1MjlDRjU1Rjg3REMA",
  "timestamp": "1750076211",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: 'log_activity',
  sessionStep: null,
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
🎯 [EMPLOYEE] Starting activity logging flow - no step found
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📝 *પ્રવૃત્તિ લોગ કરો*\n\nતમે કયા પ્રકારની પ્રવૃત્તિ કરી છે?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTU1Nzc4MkY1QjVDQzNBMjcyAA=='
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQ0U3NkI3RDdDNTRFNzA5QkI2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:16:57.119Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:16:57.678Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:16:57.909Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:16:57.919Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:18:03.022Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOURDMzg3MTA3NjVENDQzMEJGMzg5QUE1RkM5RjcxRTQA',
  timestamp: '1750076282'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQ0U3NkI3RDdDNTRFNzA5QkI2AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOURDMzg3MTA3NjVENDQzMEJGMzg5QUE1RkM5RjcxRTQA",
  "timestamp": "1750076282",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNTA0MUU4RDdGMkY5OEE4QTBBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:18:06.169Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:18:06.463Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:18:11.888Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTg1QjBEODY2OEJEM0ZDOEIyNUE3NUQ3Qjc3N0M3RjgA',
  timestamp: '1750076290'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTg1QjBEODY2OEJEM0ZDOEIyNUE3NUQ3Qjc3N0M3RjgA",
  "timestamp": "1750076290",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSM0E0M0E5NjdFNzQ1RUYxRDQxAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:18:14.523Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:18:14.930Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:18:18.471Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:19:18.239Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMzJENjI3NjM2M0UyMDYyNzY2OEEzQzQ2NzhENzI0MEUA',
  timestamp: '1750076357'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMzJENjI3NjM2M0UyMDYyNzY2OEEzQzQ2NzhENzI0MEUA",
  "timestamp": "1750076357",
  "text": {
    "body": "સેનચીગ"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "સેનચીગ"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'સેનચીગ',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzRFMjYyNzM5OUMyODdBQURFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:19:21.786Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:19:22.263Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:19:44.572Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDMzMDRCNzBDQjRGMjUyNjU3NjY4QzUwQkM0RTRGMkQA',
  timestamp: '1750076381'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDMzMDRCNzBDQjRGMjUyNjU3NjY4QzUwQkM0RTRGMkQA",
  "timestamp": "1750076381",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "YGbRSVSuiHvxRRUt/3OdusvkilNDfkDGlv+/9vKISoA=",
    "id": "1447861849722650"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: 'site_2',
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNTk4OUJBQzEyQzYyNTkxQjZBAA=='
    }
  ]
}
2025-06-16T12:19:47.168Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:19:47.480Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/a67520de-7204-47a0-9ff9-3632552473f4.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/a67520de-7204-47a0-9ff9-3632552473f4.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMTYyRTJGN0YzMDYwMzEzMzc3AA=='
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: undefined,
  selected_site: 'site_2',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: undefined
}
🔧 [EMPLOYEE] Converting site ID: site_2
🔧 [EMPLOYEE] Using legacy site mapping: site_2 → 22222222-2222-2222-2222-222222222222
🔧 [EMPLOYEE] Site UUID after conversion: 22222222-2222-2222-2222-222222222222
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: Samyak\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: સેનચીગ\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* f61e989d\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
2025-06-16T12:19:53.647Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjgzRTVDOUMzNDgyQzM1RTNFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:19:54.631Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:20:02.493Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:20:02.742Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:21:42.260Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNEM3Q0E5ODhBN0U0NDNDMzk0MDMwRTI2MDU1Q0JDQjgA',
  timestamp: '1750076501'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNEM3Q0E5ODhBN0U0NDNDMzk0MDMwRTI2MDU1Q0JDQjgA",
  "timestamp": "1750076501",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRkE5OUM5ODA3NzA2QjQwNEE5AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:21:45.780Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:21:46.102Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:21:55.876Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNTY0NEQ1QkZCMjYwMUM4Rjc0NkVBNDQ5MTY3OEUxRDMA',
  timestamp: '1750076514'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRkE5OUM5ODA3NzA2QjQwNEE5AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNTY0NEQ1QkZCMjYwMUM4Rjc0NkVBNDQ5MTY3OEUxRDMA",
  "timestamp": "1750076514",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'site_site_1',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Real employee selected site: site_site_1
Error fetching site name: error: invalid input syntax for type uuid: "site_site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:862:26)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:296:30)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 143,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQTU5RDRDNkMxRTZCMEY5M0U1AA=='
    }
  ]
}
✅ [DB] New client connected
Error fetching site name: error: invalid input syntax for type uuid: "site_site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:862:26)
    at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:343:41)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:301:9)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 143,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T12:21:58.649Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQUEyRjg5ODc5M0JBQTRDMTJDAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:21:59.020Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:21:59.596Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T12:22:00.071Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQjQyOTkwRURBRjc0NzFDQTEwAA=='
    }
  ]
}
2025-06-16T12:22:01.880Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:22:01.902Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:22:02.141Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNTU5MDlDQjY1MzcwMERDRTQzQjVBNjg4NkI1OEZGMTkA',
  timestamp: '1750076521'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQUEyRjg5ODc5M0JBQTRDMTJDAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNTU5MDlDQjY1MzcwMERDRTQzQjVBNjg4NkI1OEZGMTkA",
  "timestamp": "1750076521",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_site_1',
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSM0UwQ0E2RTA4RTE4MEQ4QzY3AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:22:05.254Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:22:05.300Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:22:46.208Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDE4NzJDMTE2RTIzQjdGOTcyREVDQjQ1Qjk2QUM2MDMA',
  timestamp: '1750076565'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSM0UwQ0E2RTA4RTE4MEQ4QzY3AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDE4NzJDMTE2RTIzQjdGOTcyREVDQjQ1Qjk2QUM2MDMA",
  "timestamp": "1750076565",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSN0M5RTk3OTBBNDI0NUIxNDBDAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:22:49.134Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:22:49.613Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:22:53.719Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNjY2QTI1NDlENjlDMTFBM0U0MEFCMjUyNzdGODBGMTUA',
  timestamp: '1750076572'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNjY2QTI1NDlENjlDMTFBM0U0MEFCMjUyNzdGODBGMTUA",
  "timestamp": "1750076572",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: 'site_site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOUE5N0FGNjI3QUU5MkIyNzBFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:22:56.008Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:22:56.380Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:23:47.205Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRUQ2NkY0REM1NDY1OTgyOEE2NUJERjhBQjJBMzNBMEMA',
  timestamp: '1750076625'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRUQ2NkY0REM1NDY1OTgyOEE2NUJERjhBQjJBMzNBMEMA",
  "timestamp": "1750076625",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "q1+asFEzKDEhD9zC2Uu28rQL2Ok2lBplsIX47UrHtxg=",
    "id": "1402835950744224"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: 'site_site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQ0Y0NEQ3N0I4OEU5RTIzMTRDAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:23:49.938Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:23:50.552Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:16.328Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI5MjBGQ0QwMzU1RUE0RDQ3RAA=',
  timestamp: '1750078095'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI5MjBGQ0QwMzU1RUE0RDQ3RAA=",
  "timestamp": "1750078095",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Hi',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: active message: Hi
🔧 [ADMIN] Extracted session data for employee: {
  selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined,
  final_selected_site: '11111111-1111-1111-1111-111111111111'
}
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T12:48:18.364Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* Suvasam Group\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDQjI0MkE5QzUyMUE1N0M5MzYA'
    }
  ]
}
🔧 [ADMIN] Employee flow completed, admin context preserved
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T12:48:20.648Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:20.730Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:20.765Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:21.038Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5RTc4NkI4RjNCRTMyQThDNTYA'
    }
  ]
}
2025-06-16T12:48:22.067Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:22.466Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg3MDI2NDdFNUMzMkE2MTAxRQA=',
  timestamp: '1750078101'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDQjI0MkE5QzUyMUE1N0M5MzYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg3MDI2NDdFNUMzMkE2MTAxRQA=",
  "timestamp": "1750078101",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
2025-06-16T12:48:22.502Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:22.573Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:22.600Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: active message: log_activity
🔧 [ADMIN] Extracted session data for employee: {
  selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined,
  final_selected_site: '11111111-1111-1111-1111-111111111111'
}
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T12:48:24.021Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQTlEQ0NGN0I4MjM5NTBBRjMA'
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'log_activity', step: 'select_activity_type' }
🔧 [ADMIN] Session data before update: {
  original_selected_site: '11111111-1111-1111-1111-111111111111',
  updated_selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: '11111111-1111-1111-1111-111111111111'
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:48:25.650Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:26.159Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:26.169Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:26.434Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:30.260Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUEwOTE1MDg5MzVFMEM5ODdBNQA=',
  timestamp: '1750078109'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQTlEQ0NGN0I4MjM5NTBBRjMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUEwOTE1MDg5MzVFMEM5ODdBNQA=",
  "timestamp": "1750078109",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: select_activity_type message: inspection
🔧 [ADMIN] Extracted session data for employee: {
  selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: '11111111-1111-1111-1111-111111111111',
  final_selected_site: '11111111-1111-1111-1111-111111111111'
}
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "select_activity_type",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T12:48:31.468Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGOTYzNjMxMEIyQjEzOEE3NjAA'
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'log_activity', step: 'enter_hours' }
🔧 [ADMIN] Session data before update: {
  original_selected_site: '11111111-1111-1111-1111-111111111111',
  updated_selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:48:32.937Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:33.381Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:33.416Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:33.747Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:37.638Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUEzNDIzMURCRUQ2MUJGQTUwQgA=',
  timestamp: '1750078116'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUEzNDIzMURCRUQ2MUJGQTUwQgA=",
  "timestamp": "1750078116",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: enter_hours message: 1
🔧 [ADMIN] Extracted session data for employee: {
  selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined,
  final_selected_site: '11111111-1111-1111-1111-111111111111'
}
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "enter_hours",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true,
    "activity_type": "inspection"
  },
  "updated_at": "2025-06-16T12:48:38.548Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4Rjc2NzU2RDgzMDlCMTM2ODIA'
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'log_activity', step: 'enter_description' }
🔧 [ADMIN] Session data before update: {
  original_selected_site: '11111111-1111-1111-1111-111111111111',
  updated_selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:48:40.188Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:40.694Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:40.743Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:40.812Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:45.533Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUVENjgxNjA1NjMzMkRGM0ExQwA=',
  timestamp: '1750078124'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUVENjgxNjA1NjMzMkRGM0ExQwA=",
  "timestamp": "1750078124",
  "text": {
    "body": "Test"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Test"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Test',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: enter_description message: Test
🔧 [ADMIN] Extracted session data for employee: {
  selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined,
  final_selected_site: '11111111-1111-1111-1111-111111111111'
}
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "enter_description",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true,
    "activity_type": "inspection",
    "hours": 1
  },
  "updated_at": "2025-06-16T12:48:46.570Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: 'Test',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzQjExNkU5RDE3MkEzOEM2ODgA'
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'log_activity', step: 'upload_image' }
🔧 [ADMIN] Session data before update: {
  original_selected_site: '11111111-1111-1111-1111-111111111111',
  updated_selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:48:48.560Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:48.916Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:48.951Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:49.068Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:48:57.188Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'image',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY5NDE3NjM1ODg1QTQ0MzdCRQA=',
  timestamp: '1750078135'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY5NDE3NjM1ODg1QTQ0MzdCRQA=",
  "timestamp": "1750078135",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "zvBbcaV0R0hmS5UOOYnammLtGlMJhuFC4hAIdespJlg=",
    "id": "711449024949213"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: upload_image message: 
🔧 [ADMIN] Extracted session data for employee: {
  selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined,
  final_selected_site: '11111111-1111-1111-1111-111111111111'
}
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+19088483575",
  "intent": "log_activity",
  "step": "upload_image",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true,
    "activity_type": "inspection",
    "hours": 1,
    "description": "Test"
  },
  "updated_at": "2025-06-16T12:48:58.198Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+19088483575',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NTNEMEFDOTkwNTZDRkI0OUEA'
    }
  ]
}
2025-06-16T12:48:59.865Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:00.108Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:00.411Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/53978230-af60-4955-9f57-ac78b0effb94.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/53978230-af60-4955-9f57-ac78b0effb94.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NTNBRURENTVCRUI1MzhDQkEA'
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: undefined,
  selected_site: '11111111-1111-1111-1111-111111111111',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: true
}
🔧 [EMPLOYEE] Converting site ID: 11111111-1111-1111-1111-111111111111
🔧 [EMPLOYEE] Site UUID after conversion: 11111111-1111-1111-1111-111111111111
🔧 [EMPLOYEE] Admin impersonation detected, preserving admin context
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: Suvasam Group\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Test\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* 1a133c82\n\nTest completed! Type *exit* to return to admin panel or continue testing employee features."
  }
}
2025-06-16T12:49:03.957Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyNkY3MzQ1NzVBMkFCQUNERTcA'
    }
  ]
}
🔧 [ADMIN] Employee flow completed, admin context preserved
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:49:04.662Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:04.679Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:04.857Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:05.152Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:05.666Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:05.965Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:32.214Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUZCOTE5MjE1MTJEM0EzMkU1MwA=',
  timestamp: '1750078171'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUZCOTE5MjE1MTJEM0EzMkU1MwA=",
  "timestamp": "1750078171",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: active message: exit
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting employee impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2QTI5NTVDNEFBRTBBNjhBRjAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:49:34.623Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T12:49:35.262Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:35.268Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:35.279Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzODk5RTBFQ0IxNDA4OEY5N0QA'
    }
  ]
}
2025-06-16T12:49:36.590Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T12:49:36.930Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:37.370Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MzdGQUE5NjFGOUNCM0ZCM0YA'
    }
  ]
}
2025-06-16T12:49:38.320Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:38.716Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:38.840Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:39.259Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:43.475Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg1N0E5QzIyRkEyQ0Y0RTUyRAA=',
  timestamp: '1750078182'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MzdGQUE5NjFGOUNCM0ZCM0YA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg1N0E5QzIyRkEyQ0Y0RTUyRAA=",
  "timestamp": "1750078182",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2NTM5MjU0RDU1Q0JDOEM5OTQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:49:45.836Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'start',
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: null with message: start
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T12:49:46.337Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:46.341Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:46.517Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5OEE3OTJDQjU5RDdFNUMzREEA'
    }
  ]
}
2025-06-16T12:49:47.773Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Inventory Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Day-to-Day Transactions",
              "description": "Daily transaction log"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T12:49:48.158Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:48.421Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Row title is too long. Max length is 24'
    },
    fbtrace_id: 'AYxk5Epc_3WCeoZQc5E_tci'
  }
}
Error message: Request failed with status code 400
Error sending list message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:200:30)
    at async WhatsAppService.sendListMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:82:13)
    at async Timeout._onTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:128:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '439',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
    data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Additional inventory options:"},"action":{"button":"More Options","sections":[{"title":"Reports & Analytics","rows":[{"id":"inventory_balance","title":"📊 Inventory Balance","description":"View current stock levels"},{"id":"day_to_day","title":"📅 Day-to-Day Transactions","description":"Daily transaction log"}]}]}}}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '439',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 2704941,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 7196,
        [Symbol(triggerId)]: 7194
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 439\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/652783161256584/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 439,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AYxk5Epc_3WCeoZQc5E_tci',
      'x-fb-trace-id': 'ACsVtwu4VqW',
      'x-fb-rev': '1023869344',
      'x-fb-debug': 'l/vzCNDeXbbWUw7+vE/4LvWdCQ5uU5VWIyU1BkBJRFjdjDAxD3HuE/68DigfkyoStNUK1fx/8x5gkq9m76sBRA==',
      date: 'Mon, 16 Jun 2025 12:49:48 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcP4lTIPHT3zD2rwhHwMjlMo-jg0i9hCEJVpwWBwjtPZuquxYGJvL1kKBxsAgwcnSkI-20-JA3jlkxqwY9EOWCuYwuQtPU93"; e_clientaddr="AcMRsmtR_7f_60rBCAuof-e5tI-q_NxVCt_ricAknfwRuLS_RnUq9FT1aPoZWn5FQJz3p5fiqUljwplViLgoJmGE3tsVNJ_HIZl_Sdl33-Et6pAwCQ"; e_upip="AcNBNOOx59ClAolAboap9fUt7bLEgSdbaBybyNtXdkCfyw3AyfVCLIiJPKYa3G6iQHq7OePusivKsDbPFIdtMoZLvSzz_HT8trOz1W0"; e_fb_zone="AcMJV5cpe2Kp5fYvSyZMay9sIzVP-Yxyfpzjp7GBZ_wqDycfK6abTTGOWRK8rJn2"; e_fb_twtaskhandle="AcNoj_7rZI3UfVCDX8ez485Po7gWgro8R_g-mgMQ3fhwrVWtlHJQeoFOb07uMotg9atGiYLpddErr3FFjAwTTMtfANlA-Z-3fL90azQdSUNSXoo"; e_proxy="AcM4uYzFmlMdrruOLvNzwKDuThM5PAwvybqGfQ_G_hSMbBj207Jy3rq1uvwrpgrtsxEkgfO9JMkPglaEago0", http_request_error; e_fb_vipaddr="AcOOtiw8_adTU6RsTBgSOZr8Qtbj-o7AXEXBobj9tVIBCqjNEHgvYXf3kIwTo9Cycm3LDCPo1RbT7gVNJ7Tu6Ze8MlWV8JcD"; e_clientaddr="AcNSy_PeiW4t8GFH9gjqBCY4QDq0mu5kG5dYtMp1_EiMosQb8Ryb9HVhX2SNG00Bs7wajwKg3y5c7xHPmekca7rmlnoD5AHazCY0tX9-02kaeYORkhz6dw"; e_upip="AcORKdTAwyTmWWk-SiG-XBBe15KSRoYWwUu6sokOpL-FENOFtl55se0kEiSMwEUnRKI3AhafoTqqVljcrKoDphMIcPhdix5_"; e_fb_zone="AcPpDTy2uA6sGNgxQF77gG4LTCPu1g059cGuoY_mGkv_JMAe0I4lRSLu3ZoZSg"; e_fb_twtaskhandle="AcMbfFvYJ4qgSaea_brFl6sZ4GFu1cHMwMBA_99psPGpp2011b4r3QKbsoNDf5CwIx-SjuXMVgIcquIfxk4kezAXU-4vK1vaHcM"; e_proxy="AcMYFEMFemR74AhzLNdcyuksGtAFbqt1ODc2SBmQA2aiUryh6rOxhqv3rWYM9xTOYy_KIBtYt3OacMQ"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=46, rtx=0, c=10, mss=1380, tbw=3729, tp=-1, tpl=-1, uplat=397, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '187'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Additional inventory options:"},"action":{"button":"More Options","sections":[{"title":"Reports & Analytics","rows":[{"id":"inventory_balance","title":"📊 Inventory Balance","description":"View current stock levels"},{"id":"day_to_day","title":"📅 Day-to-Day Transactions","description":"Daily transaction log"}]}]}}}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '439',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 439\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/652783161256584/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
2025-06-16T12:49:50.336Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQxMEVGQkE4RkVDRkE2QTdGRQA=',
  timestamp: '1750078189'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5OEE3OTJDQjU5RDdFNUMzREEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTQxMEVGQkE4RkVDRkE2QTdGRQA=",
  "timestamp": "1750078189",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: item_in
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMkIzODAyMTdFNzM5NTc3REYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:49:52.784Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Inventory Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Day-to-Day Transactions",
              "description": "Daily transaction log"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T12:49:53.107Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:53.169Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:49:53.242Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Row title is too long. Max length is 24'
    },
    fbtrace_id: 'Ay3cH3TxAgsVtk7YF2hBTA7'
  }
}
Error message: Request failed with status code 400
Error sending list message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at IncomingMessage.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at IncomingMessage.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:200:30)
    at async WhatsAppService.sendListMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:82:13)
    at async Timeout._onTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:128:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '439',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
    data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Additional inventory options:"},"action":{"button":"More Options","sections":[{"title":"Reports & Analytics","rows":[{"id":"inventory_balance","title":"📊 Inventory Balance","description":"View current stock levels"},{"id":"day_to_day","title":"📅 Day-to-Day Transactions","description":"Daily transaction log"}]}]}}}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '439',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 2709963,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 7341,
        [Symbol(triggerId)]: 7339
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 439\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/652783161256584/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 44,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 439,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'Ay3cH3TxAgsVtk7YF2hBTA7',
      'x-fb-trace-id': 'GnYWFj4EqCh',
      'x-fb-rev': '1023868176',
      'x-fb-debug': 'TWTFiU+2Eae4xW+aqzF8WA4SsVfMPI6bJft2sEDf1bzHGeJzmHn8gQnCPqZrnLawUmwlk10cIDyLbvKwnPf1jw==',
      date: 'Mon, 16 Jun 2025 12:49:53 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcPBpIxryRJa0x07lb4G9sP-nZAVAtke0x620WLH6cvyEXF1N_e6jCtNLlDZKa1OFcXkGL37Zxv0xKB55UCQgpT3a85Latv_"; e_clientaddr="AcMBX3ESKudX6cvfjq3hFzT8vXT1sXeePTO5M4RA0FlNMj05sHFT9LdcDGFEymBgwQi1mx83ooiMLNqqLh6JZobHD9sKKSVOotXpq-nsA1Nqjq-ZQA"; e_upip="AcPaDSSwxPGNB9fq3RHyaa9tD1ZXeYDLEBPf924VIePPyylrHut3TWZ0ZQneQ1CWu6ST0QG433WUWLi-SxyU8ChOP_HFvr3uPYRI_CM"; e_fb_zone="AcM9YUsdHfs4oeAoLVUPppLe4dfPV5yso3dOs30_Q1fFMGmEfxo7OH72sLJOEsH-"; e_fb_twtaskhandle="AcPGFOc-fsl-4ji0MeDQ3Vn4Ia2GD2n9ggVeWCFb8M0khZlAjTUGKv8DJJiWRZoAvrTS7fJrDU3hYmhnE5_Uqne6IgPE6fX3mn4T2eOrqUzPn40"; e_proxy="AcOu6JSx2opU0SX5cASVoUgpMFxuGx5sIvN_AV0OncyIXNC2Lc1SbrKLY7HdxVonxhBQSE5tLo9UbpYlx5FU", http_request_error; e_fb_vipaddr="AcPdW7mioiR6yhC2_rACcXhq3xUl_-HoWO1wphoC4ejfqgTLnjJG_6ll0Te1AQohTduXvWbuTmjqgFkTg0vvVJnn9uab2H1E"; e_clientaddr="AcMDfvPim6gWLigKgbDlkYSR5y7_wcGgVgi25AmtMJjiAzt_YbSXCxJ8iq3bpSOlF_hHVW3WjFH_I4Q9KdpOnNYGGu7E07AuKQrNeO9hV2Yxcr_n_05BWg"; e_upip="AcNJKKORyeaCI2ReG6P60qeUvnFScjBrUbvxBpJapwTb-CaaKosIDZGoltRp3vGWMa_oFzXYWMpZSwalqW1SxOFfPi1ed00c"; e_fb_zone="AcM5gugeNpVP4YPIdvnVdlIZgeVJpHGjbe-xjmeojBjVzs07CRP2d7xuPPsvBg"; e_fb_twtaskhandle="AcOoOal0Aa5nZpqNnHQ5oSO8M9PE1BjP3V9hx_upVMOQ2YoTYh9jtKqZeIV56FU2xYEqDDxAOxIwIRXyEz_3XJ6p0n19IG8J668"; e_proxy="AcPstgBqsPHFVF_QgS35fj36mI6lW8Q8TZS0MUSXj2uSQw_nqoVHucNrqTHYDPwAt7xbUXdCyRMnutw"',
      'x-fb-connection-quality': 'GOOD; q=0.7, rtt=51, rtx=0, c=10, mss=1380, tbw=8642, tp=-1, tpl=-1, uplat=486, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '237'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Additional inventory options:"},"action":{"button":"More Options","sections":[{"title":"Reports & Analytics","rows":[{"id":"inventory_balance","title":"📊 Inventory Balance","description":"View current stock levels"},{"id":"day_to_day","title":"📅 Day-to-Day Transactions","description":"Daily transaction log"}]}]}}}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '439',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 439\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/652783161256584/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
2025-06-16T12:49:56.043Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQxREE4MTQxNEQzMEI2MjUwRQA=',
  timestamp: '1750078195'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMkIzODAyMTdFNzM5NTc3REYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQxREE4MTQxNEQzMEI2MjUwRQA=",
  "timestamp": "1750078195",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: item_in
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGMEM2MDRBNDI4Q0Y1NjZBRDQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:49:58.624Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Inventory Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Day-to-Day Transactions",
              "description": "Daily transaction log"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T12:49:58.967Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Row title is too long. Max length is 24'
    },
    fbtrace_id: 'A7sB9-S3PX_UGF71tjvqGw9'
  }
}
Error message: Request failed with status code 400
Error sending list message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at IncomingMessage.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at IncomingMessage.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:200:30)
    at async WhatsAppService.sendListMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:82:13)
    at async Timeout._onTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:128:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '439',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
    data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Additional inventory options:"},"action":{"button":"More Options","sections":[{"title":"Reports & Analytics","rows":[{"id":"inventory_balance","title":"📊 Inventory Balance","description":"View current stock levels"},{"id":"day_to_day","title":"📅 Day-to-Day Transactions","description":"Daily transaction log"}]}]}}}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '439',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 2715826,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 7462,
        [Symbol(triggerId)]: 7460
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 439\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/652783161256584/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 44,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 439,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'A7sB9-S3PX_UGF71tjvqGw9',
      'x-fb-trace-id': 'DuGTj2rdc7k',
      'x-fb-rev': '1023869344',
      'x-fb-debug': 'eoSHAFKbxQvsHbEvJCsFwb9pZJyK7lDjNqhPGL/LsjL4Rhhn6if0uRW7sjrfJh7L7SqqjRAzIU/xc0zpCKhndQ==',
      date: 'Mon, 16 Jun 2025 12:49:59 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcMrZz-RFDV10ymZPnEyZll19toXRh0PpbBw9HHTgeb6HEcJfVJCtASPZz99j4slrMsSJXgNAKQHs4HP8u1602ZUbEwxguYq"; e_clientaddr="AcM9wsmUBfbthaSihFt7FH66fQTti8q7hGn3SgsQAi0szEQCcIziJl1QMxBVqxXxmESWFlfYZJGcV9qbrcHokzDjCUXwGOzxJgMmrntx4-RvIy-H5A"; e_upip="AcMIfNeTz8lwVd8jRu_Hhu8cenU2VdxyrQ7ucTd4OqZRCbus1mIVPoDk1q_dJDPWVQqdcoyOOPYlJQrGl-P52U5ESE5HAsZQlDw"; e_fb_zone="AcMCa0-q-NFY8eqbRDwpaFFtbcjGmi6DxOH2W3T7d17jZxiOsTJSyCd2XI9Vc1g1"; e_fb_twtaskhandle="AcMHzyLD5UNyiLMUwwXN-BOGpIQypEZdtoR8gFbsGURRE5pLT_Hf6zbdR0zj_4LsIHTTmpBwVELXLvOlTZs9AjEjJRGAmNe-cWB8IvneIyUYuI8"; e_proxy="AcMqfL73ei6Qwqjl3-zPQo1AUjekM-2-S-KpXPeUchxp8gpgJ2qbOCythdW3X-dLRk1UyrOXRdKKaZmQkni3", http_request_error; e_fb_vipaddr="AcMT8BRq2vvPxIjlLh_31pY_-btQz6gdwfIoFLJxDN5ZhEYj7zkr5msD-h3JrDHTfZtGhcWFJTpIv5dWuLz7FwoQF7Oo-OQN"; e_clientaddr="AcN5XDabaEdT-0re5ASX1d3sNLxI8iS7p9mVQkt6sXuiD780EWDpuGTW4IbryMxGraLoEWsJFKBc7PIasQ_s9sxjJHrUxKoEW1oz00gTj8V0-nFn3y7lgQ"; e_upip="AcPi2Tzh9DTWOe4sDQpXQ6SpKrbqIESFwfidaALUxUQzbt6fzTysQPzfxnt0hFpSQfZkYFnQ-zkmI-JMLELE6IQbwORJOu6x"; e_fb_zone="AcNghlKQxcKc67xT5Xq9SXO4AdGxPurdnlqM2O-9IHfWPDobrvEnMyR3zuLAgg"; e_fb_twtaskhandle="AcPDMWUkZWBS0t_bkT-U5BXp3SQVeiab7timMMfyfV4_8C_Hl-r7qRl_liQDd-BAjEEQ5ylCWh8cI4KYLsy8xGL7jXyvLqLfDFU"; e_proxy="AcN1veqwed8xcdmDt3B7jXhqlYCWKJAqoZW-xQOZWbmFUoY63nmk_ttM-soiMVhf_bZAoxktaj3L_DY"',
      'x-fb-connection-quality': 'GOOD; q=0.7, rtt=92, rtx=1, c=10, mss=1380, tbw=13558, tp=-1, tpl=-1, uplat=465, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '237'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Additional inventory options:"},"action":{"button":"More Options","sections":[{"title":"Reports & Analytics","rows":[{"id":"inventory_balance","title":"📊 Inventory Balance","description":"View current stock levels"},{"id":"day_to_day","title":"📅 Day-to-Day Transactions","description":"Daily transaction log"}]}]}}}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '439',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 439\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/652783161256584/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
2025-06-16T12:49:59.369Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:54:01.792Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:54:55.993Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMkExMEQ0MTA0RTNBMTc0NkUzRTY3RjgzMDUzRUU1MDgA',
  timestamp: '1750078493'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMkExMEQ0MTA0RTNBMTc0NkUzRTY3RjgzMDUzRUU1MDgA",
  "timestamp": "1750078493",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "nanNe5bmukorO9atCkAtliaHzZiKZRzWB0ikUM8lVGA=",
    "id": "2755343461321106"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: 'site_site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjMwMUQxNTA2RjQ4QUI0OUI0AA=='
    }
  ]
}
2025-06-16T12:54:58.911Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:54:59.515Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/5be2dff0-e662-4140-a3ac-377e37433d39.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/5be2dff0-e662-4140-a3ac-377e37433d39.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMDU0MThBNEZEQjQ2RjVGOUJBAA=='
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: 'site_site_1',
  selected_site: 'site_site_1',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: false
}
🔧 [EMPLOYEE] Converting site ID: site_site_1
⚠️ [EMPLOYEE] Invalid site ID provided: site_site_1
Error logging activity: Error: Invalid site ID: site_site_1
    at EmployeeFlow.getSiteUUID (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:896:15)
    at EmployeeFlow.completeActivityLog (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:522:35)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async EmployeeFlow.handleImageUpload (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:934:25)
    at async EmployeeFlow.handleActivityLogging (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:477:17)
    at async EmployeeFlow.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:431:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:43:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "માફ કરશો, તમારી પ્રવૃત્તિ નોંધવામાં ભૂલ થઈ. કૃપા કરીને ફરીથી પ્રયાસ કરો."
  }
}
2025-06-16T12:55:03.268Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNUM3MDU3RDg5RkUwRkY2RTM0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:55:03.590Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:55:04.242Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:55:04.635Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:55:12.647Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggODg1RDdFN0I2NEFFNTcyNzUwQ0NGNTAzRjA5RjFFQUMA',
  timestamp: '1750078511'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggODg1RDdFN0I2NEFFNTcyNzUwQ0NGNTAzRjA5RjFFQUMA",
  "timestamp": "1750078511",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSN0NBQ0U3NkVCQTc4RTUwNjVDAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:55:15.416Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:55:15.689Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:55:21.497Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOEU5NjE4ODkxQ0IwOTgzNDZCNjM4RjUyNkZFNkJCNEIA',
  timestamp: '1750078520'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSN0NBQ0U3NkVCQTc4RTUwNjVDAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOEU5NjE4ODkxQ0IwOTgzNDZCNjM4RjUyNkZFNkJCNEIA",
  "timestamp": "1750078520",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'site_site_1',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Real employee selected site: site_site_1
Error fetching site name: error: invalid input syntax for type uuid: "site_site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:862:26)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:296:30)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 143,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQjMyMzVEMDRBOEVGRkVDMkEwAA=='
    }
  ]
}
✅ [DB] New client connected
Error fetching site name: error: invalid input syntax for type uuid: "site_site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:862:26)
    at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:343:41)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:301:9)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 143,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T12:55:24.638Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:55:24.986Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMzAxQ0MyRDU0NkI0RjE2RjkzAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:55:26.098Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T12:55:26.671Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQzkwNUEyRjQ0OTI5N0VGRDEyAA=='
    }
  ]
}
2025-06-16T12:55:28.410Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:55:28.569Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:55:40.448Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNEE4RUQ5MTk3QUIzMDgzOTlBRDA4ODQxM0EwQzA4NDQA',
  timestamp: '1750078539'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMzAxQ0MyRDU0NkI0RjE2RjkzAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNEE4RUQ5MTk3QUIzMDgzOTlBRDA4ODQxM0EwQzA4NDQA",
  "timestamp": "1750078539",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_site_1',
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSODM3RjA3NTY0MTUxMjdGM0Y2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:55:43.623Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:55:44.403Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:55:50.060Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggREQwMzkyOUY4NTI0NkM1MTlGRTMzRUVBNzQ1QzE1RDYA',
  timestamp: '1750078549'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSODM3RjA3NTY0MTUxMjdGM0Y2AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggREQwMzkyOUY4NTI0NkM1MTlGRTMzRUVBNzQ1QzE1RDYA",
  "timestamp": "1750078549",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRkM0QzkwRjVCNDZEMDBFMDg3AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:55:52.670Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:55:53.039Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:55:58.132Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMzNFNDc2NjRENDA2NjhGRTRCMzJEMEY2MEI0RkY0RUIA',
  timestamp: '1750078557'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMzNFNDc2NjRENDA2NjhGRTRCMzJEMEY2MEI0RkY0RUIA",
  "timestamp": "1750078557",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: 'site_site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRTBDMDgwRUVEQjQ3MDFGQThEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:56:00.760Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:56:01.109Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:56:39.415Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMkJDM0I4NjU4NTMzQTJBNkM2QUU1OTM1NTlBMzE1ODYA',
  timestamp: '1750078598'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMkJDM0I4NjU4NTMzQTJBNkM2QUU1OTM1NTlBMzE1ODYA",
  "timestamp": "1750078598",
  "text": {
    "body": "Steel"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Steel"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Steel',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: 'site_site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMTgxNkZDOTZFNzMyRjVCNTE1AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:56:42.665Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:56:43.057Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:57:12.344Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggM0EzQUIwRUFENDEwNTU3ODVBOUUwQTQ4MEQ1MEE0QkMA',
  timestamp: '1750078630'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggM0EzQUIwRUFENDEwNTU3ODVBOUUwQTQ4MEQ1MEE0QkMA",
  "timestamp": "1750078630",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "TLqL1hPBV1SwY8KZqResnnLYQ+TlZzfprhdRGt8YCjM=",
    "id": "716731397729711"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: 'site_site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNUJFRkZEQTU0MTQxODk4MjA1AA=='
    }
  ]
}
2025-06-16T12:57:15.602Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:57:15.882Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/95e2372c-0f52-43ce-9205-eeddefab95da.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/95e2372c-0f52-43ce-9205-eeddefab95da.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNTVEQjA3MUZENzE4QjQ0MTY3AA=='
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: 'site_site_1',
  selected_site: 'site_site_1',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: false
}
🔧 [EMPLOYEE] Converting site ID: site_site_1
⚠️ [EMPLOYEE] Invalid site ID provided: site_site_1
Error logging activity: Error: Invalid site ID: site_site_1
    at EmployeeFlow.getSiteUUID (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:896:15)
    at EmployeeFlow.completeActivityLog (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:522:35)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async EmployeeFlow.handleImageUpload (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:934:25)
    at async EmployeeFlow.handleActivityLogging (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:477:17)
    at async EmployeeFlow.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:431:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:43:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "માફ કરશો, તમારી પ્રવૃત્તિ નોંધવામાં ભૂલ થઈ. કૃપા કરીને ફરીથી પ્રયાસ કરો."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTg3QzdFNkNFOUUzQjMxNjgwAA=='
    }
  ]
}
2025-06-16T12:57:19.567Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:57:19.814Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:57:20.240Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:57:20.588Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:57:52.451Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDc3MTIxNDUzRDZFN0E4OEU2QUNGRTJCNEY3Mzk4REQA',
  timestamp: '1750078670'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDc3MTIxNDUzRDZFN0E4OEU2QUNGRTJCNEY3Mzk4REQA",
  "timestamp": "1750078670",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "gKCK12I3y6wTJ1ZVHUWPo3Bu3PhNv65ZywnIs5IzE8g=",
    "id": "1315176340611261"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNjkzMkRDQjYyNDE4MzdCNTdFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T12:57:55.970Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T12:57:56.385Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T13:04:40.709Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVDRDJGRUJCOTdCNzlCMjY3MwA=',
  timestamp: '1750079079'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGMEM2MDRBNDI4Q0Y1NjZBRDQA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVDRDJGRUJCOTdCNzlCMjY3MwA=",
  "timestamp": "1750079079",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: item_in
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0RDg4QzE0QTQ2RjQ5ODFGNkYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:04:44.171Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:04:44.625Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:04:44.874Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2RDY3QkYwNjJENEJCQjFCNEQA'
    }
  ]
}
2025-06-16T13:04:45.939Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:04:45.969Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:04:46.509Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:04:50.223Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUyQjM5Qjc2REY1RjUwMEIyNgA=',
  timestamp: '1750079089'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0RDg4QzE0QTQ2RjQ5ODFGNkYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUyQjM5Qjc2REY1RjUwMEIyNgA=",
  "timestamp": "1750079089",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: item_in
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NEQ1NjM5Mzg0QTc4N0Q4NkYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:04:53.132Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:04:53.345Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:04:53.466Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:04:53.503Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzMEREMDg2Rjk0NkE0NjA1RUMA'
    }
  ]
}
2025-06-16T13:04:54.367Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:04:54.961Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:04:55.023Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:04:55.204Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:04:59.126Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTRCMTE4OUU0NzVGNjk3RUJDNgA=',
  timestamp: '1750079098'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NEQ1NjM5Mzg0QTc4N0Q4NkYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTRCMTE4OUU0NzVGNjk3RUJDNgA=",
  "timestamp": "1750079098",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_out",
      "title": "📤 Item Out"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_out"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_out',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_out',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: item_out
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NEMzNEY1ODI3NDAxNjcyRkQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:05:02.178Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:05:02.180Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:05:02.183Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:05:02.301Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFOEIzQ0Y2MjZDOEFDRUY5RDcA'
    }
  ]
}
2025-06-16T13:05:03.632Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:05:03.968Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:05:04.101Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:05:04.282Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T13:14:57.897Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVENUFCNTAwN0FEOTU4MEJCMwA=',
  timestamp: '1750079693'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTVENUFCNTAwN0FEOTU4MEJCMwA=",
  "timestamp": "1750079693",
  "text": {
    "body": "Exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Exit',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Exit',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: Exit interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting inventory management..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1NTIwMEJGNEQ3OENGRjZFNEYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:15:01.521Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:01.775Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:01.817Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:01.951Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:14.353Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTRDRUIzMjAzMUYwODU2Q0IwNgA=',
  timestamp: '1750079713'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTRDRUIzMjAzMUYwODU2Q0IwNgA=",
  "timestamp": "1750079713",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCQUJGNkI0M0QxNkU0NDMzMEMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:15:16.749Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:15:17.308Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:17.359Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:17.512Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MzAwQUJDMTk5N0NBQkZBMzQA'
    }
  ]
}
2025-06-16T13:15:18.482Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:19.163Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:19.429Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:19.445Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:24.687Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU4NTkyMjA3MEY0NzMzMTIwQQA=',
  timestamp: '1750079723'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MzAwQUJDMTk5N0NBQkZBMzQA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU4NTkyMjA3MEY0NzMzMTIwQQA=",
  "timestamp": "1750079723",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyQkE2RjRFNTkwMzgxMEFFODQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:15:27.112Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'start',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: null with message: start interactiveData: undefined
📦 [INVENTORY] Handling main menu selection: start
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "❌ Invalid selection. Please choose from the available options."
  }
}
2025-06-16T13:15:27.511Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:27.610Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:27.620Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MEI3RUQxMzhGREQ3QzBBREIA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T13:15:28.850Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCNUVGN0YwRDUzNjE3MzNFMjkA'
    }
  ]
}
2025-06-16T13:15:29.185Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:29.392Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:29.597Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:29.859Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:15:30.268Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:30.319Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:30.363Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQTBBMDM4MTcwN0NFRDk2QkEA'
    }
  ]
}
2025-06-16T13:15:31.963Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:32.194Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:32.206Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:32.311Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:40.828Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI2RjQwNEYyMzQ3Nzc4RUYyQQA=',
  timestamp: '1750079739'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQTBBMDM4MTcwN0NFRDk2QkEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTI2RjQwNEYyMzQ3Nzc4RUYyQQA=",
  "timestamp": "1750079739",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "create_sample_data",
      "title": "🧪 Create Sample Data",
      "description": "Add sample items for testing"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "create_sample_data"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'create_sample_data',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'create_sample_data',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'create_sample_data',
      title: '🧪 Create Sample Data',
      description: 'Add sample items for testing'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: create_sample_data interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'create_sample_data',
    title: '🧪 Create Sample Data',
    description: 'Add sample items for testing'
  }
}
📦 [INVENTORY] Handling main menu selection: {
  type: 'list_reply',
  list_reply: {
    id: 'create_sample_data',
    title: '🧪 Create Sample Data',
    description: 'Add sample items for testing'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "❌ Invalid selection. Please choose from the available options."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwQUMxRDUxNjJEMTcwMjFDQUIA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T13:15:43.443Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0RjM5OUZDQkQ4Mzg3NjJENjAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:15:43.763Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:43.925Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:44.069Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:44.312Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:15:44.534Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:44.640Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:44.822Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzRTg3N0I0QUU0MzEwQzNEOUEA'
    }
  ]
}
2025-06-16T13:15:46.136Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:46.512Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:46.520Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:46.644Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFFNDdFQkI4OTUwQkJGRjY3NQA=',
  timestamp: '1750079745'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0RjM5OUZDQkQ4Mzg3NjJENjAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFFNDdFQkI4OTUwQkJGRjY3NQA=",
  "timestamp": "1750079745",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
2025-06-16T13:15:46.932Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'item_in', title: '📦 Item In' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Handling main menu selection: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "❌ Invalid selection. Please choose from the available options."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1MjMzMDc4NDU3RDQ1NUE0MzMA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T13:15:49.367Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0M0I0MDZBMDE3Q0ZFRjQ0ODEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:15:49.698Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:49.714Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:49.830Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:50.493Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:15:50.966Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:51.007Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:51.076Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCRjYwOTAwOEUwNDRGMTc3MDYA'
    }
  ]
}
2025-06-16T13:15:52.049Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:52.453Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:15:52.776Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(648,10): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(879,14): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(950,30): error TS2339: Property 'notes' does not exist on type 'PgTableWithColumns<{ name: "inventory_items"; schema: undefined; columns: { id: PgColumn<{ name: "id"; tableName: "inventory_items"; dataType: "string"; columnType: "PgUUID"; data: string; driverParam: string; notNull: true; hasDefault: true; enumValues: undefined; baseColumn: never; }, {}, {}>; ... 7 more ...; upda...'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(648,10): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(879,14): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(950,30): error TS2339: Property 'notes' does not exist on type 'PgTableWithColumns<{ name: "inventory_items"; schema: undefined; columns: { id: PgColumn<{ name: "id"; tableName: "inventory_items"; dataType: "string"; columnType: "PgUUID"; data: string; driverParam: string; notNull: true; hasDefault: true; enumValues: undefined; baseColumn: never; }, {}, {}>; ... 7 more ...; upda...'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(648,10): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(879,14): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(950,30): error TS2339: Property 'notes' does not exist on type 'PgTableWithColumns<{ name: "inventory_items"; schema: undefined; columns: { id: PgColumn<{ name: "id"; tableName: "inventory_items"; dataType: "string"; columnType: "PgUUID"; data: string; driverParam: string; notNull: true; hasDefault: true; enumValues: undefined; baseColumn: never; }, {}, {}>; ... 7 more ...; upda...'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(648,10): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(879,14): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(950,30): error TS2339: Property 'notes' does not exist on type 'PgTableWithColumns<{ name: "inventory_items"; schema: undefined; columns: { id: PgColumn<{ name: "id"; tableName: "inventory_items"; dataType: "string"; columnType: "PgUUID"; data: string; driverParam: string; notNull: true; hasDefault: true; enumValues: undefined; baseColumn: never; }, {}, {}>; ... 7 more ...; upda...'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(648,10): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(879,14): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(950,30): error TS2339: Property 'notes' does not exist on type 'PgTableWithColumns<{ name: "inventory_items"; schema: undefined; columns: { id: PgColumn<{ name: "id"; tableName: "inventory_items"; dataType: "string"; columnType: "PgUUID"; data: string; driverParam: string; notNull: true; hasDefault: true; enumValues: undefined; baseColumn: never; }, {}, {}>; ... 7 more ...; upda...'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(648,10): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(879,14): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 5 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(950,30): error TS2339: Property 'notes' does not exist on type 'PgTableWithColumns<{ name: "inventory_items"; schema: undefined; columns: { id: PgColumn<{ name: "id"; tableName: "inventory_items"; dataType: "string"; columnType: "PgUUID"; data: string; driverParam: string; notNull: true; hasDefault: true; enumValues: undefined; baseColumn: never; }, {}, {}>; ... 7 more ...; upda...'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(648,10): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(879,14): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(950,30): error TS2339: Property 'notes' does not exist on type 'PgTableWithColumns<{ name: "inventory_items"; schema: undefined; columns: { id: PgColumn<{ name: "id"; tableName: "inventory_items"; dataType: "string"; columnType: "PgUUID"; data: string; driverParam: string; notNull: true; hasDefault: true; enumValues: undefined; baseColumn: never; }, {}, {}>; ... 8 more ...; upda...'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(648,10): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(879,14): error TS2769: No overload matches this call.
  Overload 1 of 2, '(value: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'notes' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }'.
  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }[]): PgInsertBase<...>', gave the following error.
    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; unit: string | SQL<unknown> | Placeholder<string, any>; id?: string | SQL<unknown> | Placeholder<string, any> | undefined; ... 6 more ...; created_by?: string | ... 3 more ... | undefined; }[]'.
src/services/flows/inventoryFlow.ts(950,30): error TS2339: Property 'notes' does not exist on type 'PgTableWithColumns<{ name: "inventory_items"; schema: undefined; columns: { id: PgColumn<{ name: "id"; tableName: "inventory_items"; dataType: "string"; columnType: "PgUUID"; data: string; driverParam: string; notNull: true; hasDefault: true; enumValues: undefined; baseColumn: never; }, {}, {}>; ... 8 more ...; upda...'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T13:31:11.383Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTA3M0JENjEwMjhGMUFDM0U4NgA=',
  timestamp: '1750080670'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTA3M0JENjEwMjhGMUFDM0U4NgA=",
  "timestamp": "1750080670",
  "text": {
    "body": "Exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Exit',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Exit',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: Exit interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting inventory management..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGREQzOTJDQzExQTM3N0JCMjgA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:31:15.360Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:15.406Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:15.612Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:15.679Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:27.258Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTlCMzczNURFNkRGMjZDN0M0RAA=',
  timestamp: '1750080686'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTlCMzczNURFNkRGMjZDN0M0RAA=",
  "timestamp": "1750080686",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1OUY0RTI3RUE5OUEwODAxMUUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:31:29.686Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:30.152Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:31:30.220Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:30.252Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4N0REQzA0RUE4QzhBNDE2Q0QA'
    }
  ]
}
2025-06-16T13:31:32.607Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:32.874Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:33.168Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:33.384Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:37.538Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM3M0Y1NkZBQTlFRjA0OTdGNAA=',
  timestamp: '1750080696'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4N0REQzA0RUE4QzhBNDE2Q0QA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM3M0Y1NkZBQTlFRjA0OTdGNAA=",
  "timestamp": "1750080696",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2ODA2QjNGMTM0ODExNzQ3MDEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:31:40.132Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'start',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: null with message: start interactiveData: undefined
📦 [INVENTORY] Handling main menu selection: start
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "❌ Invalid selection. Please choose from the available options."
  }
}
2025-06-16T13:31:40.742Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:40.846Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:41.012Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2OEExRDJFNEY1ODEwNkFERDgA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T13:31:42.037Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:42.532Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBMEVCNDEyNzIwODlFRTZBRUIA'
    }
  ]
}
2025-06-16T13:31:42.651Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:42.785Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:31:43.684Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:44.565Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:44.715Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:44.716Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDRDYyM0U5Q0M0NUFCQzdCOTMA'
    }
  ]
}
2025-06-16T13:31:46.067Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:46.512Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:46.625Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:46.735Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:48.284Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdDODZBMTU4NjY4MjE5QjMwMAA=',
  timestamp: '1750080707'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBMEVCNDEyNzIwODlFRTZBRUIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdDODZBMTU4NjY4MjE5QjMwMAA=",
  "timestamp": "1750080707",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'item_in', title: '📦 Item In' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Handling main menu selection: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "❌ Invalid selection. Please choose from the available options."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5NEY2QzlFNUJBOTRGRjQ2MTgA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T13:31:50.638Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:51.199Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:51.211Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:51.279Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwRjlDNEE4NDQ3MTUwRDRGQjkA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:31:52.001Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:31:52.554Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:52.625Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:52.658Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1QjE4NUQ3MEM5N0VFODBGNkYA'
    }
  ]
}
2025-06-16T13:31:53.773Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:54.422Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:54.502Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:31:54.689Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:34:18.635Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQyMERGNDQ0RDE0RERFOEEwQQA=',
  timestamp: '1750080414'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQyMERGNDQ0RDE0RERFOEEwQQA=",
  "timestamp": "1750080414",
  "text": {
    "body": "Exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "Exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Exit',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'Exit',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: Exit interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting inventory management..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCOTExMjgyMEI4MEM4QTUwOTUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:34:22.053Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:34:22.957Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:34:24.392Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 4s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T13:39:36.896Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:40.759Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThEQ0ZGRUE3OTI3MTQxQjYyMQA=',
  timestamp: '1750081179'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThEQ0ZGRUE3OTI3MTQxQjYyMQA=",
  "timestamp": "1750081179",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMDQ1MzZGMkZDNzhCMDdBMEUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:39:44.417Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:39:44.671Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:44.785Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2Rjg4QTY0MTcyMTdFREJEREIA'
    }
  ]
}
2025-06-16T13:39:45.994Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:46.438Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:46.572Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:46.688Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:47.197Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTcxNjM3RUREQkM4REZBOTU5RQA=',
  timestamp: '1750081160'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTcxNjM3RUREQkM4REZBOTU5RQA=",
  "timestamp": "1750081160",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1RTBEMzY4MjA0RTM1MkRBODcA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:39:50.018Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:39:50.382Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4MzA4M0E3MUZDRTQ4RjcxNTkA'
    }
  ]
}
2025-06-16T13:39:51.055Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:51.547Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:52.110Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJGM0E4MDFDQzVBRDc0M0RERgA=',
  timestamp: '1750081190'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2Rjg4QTY0MTcyMTdFREJEREIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJGM0E4MDFDQzVBRDc0M0RERgA=",
  "timestamp": "1750081190",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
2025-06-16T13:39:52.116Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
2025-06-16T13:39:52.515Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1M0ZGQjY4RDI3NDM4QTUzNDAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:39:54.977Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'start',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: null with message: start interactiveData: undefined
📦 [INVENTORY] Handling main menu selection: start
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "❌ Invalid selection. Please choose from the available options."
  }
}
2025-06-16T13:39:55.447Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:55.461Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0OUUzRUM1ODU2RUYwMTRBNTEA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T13:39:56.780Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxRDgwOUNGQUI5MDMxMENCNDkA'
    }
  ]
}
2025-06-16T13:39:57.043Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:57.214Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:57.455Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items for testing"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2RTg1Q0Y2OTA3Q0Q0QTlDNzMA'
    }
  ]
}
2025-06-16T13:39:59.242Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:59.344Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:59.390Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:59.844Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:59.954Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:39:59.998Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:40:03.100Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc0NDdFRjU3RDRDNzlENjc2RAA=',
  timestamp: '1750081202'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxRDgwOUNGQUI5MDMxMENCNDkA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc0NDdFRjU3RDRDNzlENjc2RAA=",
  "timestamp": "1750081202",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'item_in', title: '📦 Item In' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Handling main menu selection: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "❌ Invalid selection. Please choose from the available options."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4RDk1RkMwNkY5NDYzNjFBNkYA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDQzVCNEJGRUYzQTkyRTZEMjYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T13:40:05.472Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:40:05.777Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:40:05.955Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:40:06.088Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T13:40:06.662Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:40:06.665Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:40:06.668Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwRUY3NzA0OTI2MkNDNzAzQjYA'
    }
  ]
}
2025-06-16T13:40:08.026Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:40:08.410Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:40:08.515Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T13:40:08.533Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:24.090Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg0RjM0RTBDNDlDNjY4OERCNAA=',
  timestamp: '1750083262'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg0RjM0RTBDNDlDNjY4OERCNAA=",
  "timestamp": "1750083262",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: exit interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting inventory management..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwMDZCQUJBMTNBM0JBNTBDMTgA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:14:27.928Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:28.146Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:28.340Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:31.412Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY0RTkxNTg2MTE1MkVGRDcyNQA=',
  timestamp: '1750083270'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY0RTkxNTg2MTE1MkVGRDcyNQA=",
  "timestamp": "1750083270",
  "text": {
    "body": "hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'hi',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJENkFEQzU5MTNGMjA5NDI5NTAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:14:34.032Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:14:34.527Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:34.812Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGM0I1QkU3NzA5RkU0OUE5NEUA'
    }
  ]
}
2025-06-16T14:14:35.901Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:36.422Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:36.457Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:41.754Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU4NDc1RjUyOEFGMTlGMkJFMAA=',
  timestamp: '1750083281'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGM0I1QkU3NzA5RkU0OUE5NEUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU4NDc1RjUyOEFGMTlGMkJFMAA=",
  "timestamp": "1750083281",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3Q0IwN0U4QTRFQTA2M0M4QzUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:14:44.498Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'start',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: null with message: start interactiveData: undefined
📦 [INVENTORY] Handling main menu selection: start
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "❌ Invalid selection. Please choose from the available options."
  }
}
2025-06-16T14:14:44.704Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:44.880Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzNDRBODkyQUNENDgwRDAwODQA'
    }
  ]
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T14:14:46.012Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCQ0MwODdDQTNFRURERjNBOUIA'
    }
  ]
}
2025-06-16T14:14:46.714Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:46.716Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:46.981Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:14:47.239Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:47.299Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3RUFGMzkyNEY0NzRGM0JBMDgA'
    }
  ]
}
2025-06-16T14:14:48.922Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:49.307Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:14:49.343Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T14:20:40.166Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY2ODVEM0E2OTg2RDVENjUxNAA=',
  timestamp: '1750083638'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY2ODVEM0E2OTg2RDVENjUxNAA=",
  "timestamp": "1750083638",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: exit interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting inventory management..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBMTkwMDVBNUY2RTA0MzlEQ0QA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:20:43.607Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:20:43.678Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:20:43.932Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:20:57.461Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc0NUVCQTBFMUJCQTlEQjY0NAA=',
  timestamp: '1750083656'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc0NUVCQTBFMUJCQTlEQjY0NAA=",
  "timestamp": "1750083656",
  "text": {
    "body": "hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'hi',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3RDNEODEwRTU1RUFCODlFREYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:20:59.839Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:21:00.299Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:00.562Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2N0Y4RjE3NkREMjQ0M0M0NjUA'
    }
  ]
}
2025-06-16T14:21:01.770Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:02.081Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:02.264Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:07.744Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUZFNUUyOTIzRDhBNThFRkExOQA=',
  timestamp: '1750083667'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2N0Y4RjE3NkREMjQ0M0M0NjUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUZFNUUyOTIzRDhBNThFRkExOQA=",
  "timestamp": "1750083667",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBNjA4MEIzREIzMUY2RDZGQjIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:21:10.457Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: null with message:  interactiveData: undefined
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T14:21:10.731Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:10.777Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MDA5NjdCRTc3QjEwRTk0RDAA'
    }
  ]
}
2025-06-16T14:21:12.302Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:21:12.554Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:12.560Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NTY1N0UyNzQzM0QxMkU3NEMA'
    }
  ]
}
2025-06-16T14:21:13.902Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:14.346Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:14.618Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:16.835Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTZBMzNDMEE2NkI5MEU0OEQ0NwA=',
  timestamp: '1750083676'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2MDA5NjdCRTc3QjEwRTk0RDAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTZBMzNDMEE2NkI5MEU0OEQ0NwA=",
  "timestamp": "1750083676",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'item_in', title: '📦 Item In' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Handling main menu selection: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
} interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Invalid selection received: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "❌ Invalid selection. Please choose from the available options."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwQzc3MThBNzM4NEFEMzdGRjAA'
    }
  ]
}
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T14:21:19.318Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4QUM1Mzk1M0VBNzkyQzlEMjkA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:21:19.779Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:19.834Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:20.199Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:21:20.675Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:20.764Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0NkQ4MUFCNzBFMzFERjFBM0IA'
    }
  ]
}
2025-06-16T14:21:22.270Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:22.732Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:21:22.834Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(571,9): error TS18047: 'item.current_stock' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(571,9): error TS18047: 'item.current_stock' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(571,9): error TS18047: 'item.current_stock' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(571,9): error TS18047: 'item.current_stock' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/services/flows/inventoryFlow.ts(571,9): error TS18047: 'item.current_stock' is possibly 'null'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T14:31:52.634Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM5MTY2RkY3NERGRUMxNjRCMQA=',
  timestamp: '1750084311'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUM5MTY2RkY3NERGRUMxNjRCMQA=",
  "timestamp": "1750084311",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: exit interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting inventory management..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwQkM4QTQzNEE4N0Y2QkUzODIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:31:56.021Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:31:56.428Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:31:56.567Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:03.564Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:06.490Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY2MkI0REQ2NkFENjMzMjc0OQA=',
  timestamp: '1750084325'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY2MkI0REQ2NkFENjMzMjc0OQA=",
  "timestamp": "1750084325",
  "text": {
    "body": "hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'hi',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1QzYwMUY2RjNFRTQ1NTFBM0YA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:32:08.981Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:32:09.482Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:09.505Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNjZBOUI1OUY1QTBBRjkxQTEA'
    }
  ]
}
2025-06-16T14:32:10.778Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:11.389Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:11.648Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:21.231Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURCRjk4MEMxQTJBMTdERTc1MQA=',
  timestamp: '1750084340'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNjZBOUI1OUY1QTBBRjkxQTEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURCRjk4MEMxQTJBMTdERTc1MQA=",
  "timestamp": "1750084340",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzREYyNzY4MTY5MDg1Q0M3MEYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:32:23.771Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: null with message:  interactiveData: undefined
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T14:32:24.299Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:24.365Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2RjYyQUY0MzFCOTlBRjBFQjMA'
    }
  ]
}
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:32:26.442Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:26.445Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:26.626Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCNDgzMTE3MkQzMzREQTk4MjEA'
    }
  ]
}
2025-06-16T14:32:27.350Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:28.032Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:28.298Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:31.573Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURENjRGRTYxMTdGNzE3NDYyMgA=',
  timestamp: '1750084350'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI2RjYyQUY0MzFCOTlBRjBFQjMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQURENjRGRTYxMTdGNzE3NDYyMgA=",
  "timestamp": "1750084350",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'item_in', title: '📦 Item In' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Handling main menu selection: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Starting Item In flow with category selection
📦 [INVENTORY] Showing category selection for action: item_in user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending category selection list with action text: add stock to
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Select Inventory Category*\n\nWhich type of inventory do you want to add stock to?"
    },
    "action": {
      "button": "Select Category",
      "sections": [
        {
          "title": "Inventory Categories",
          "rows": [
            {
              "id": "building_material",
              "title": "🏗️ Building Material",
              "description": "Cement, Steel, Bricks, Sand, etc."
            },
            {
              "id": "contractor_materials",
              "title": "🛠️ Contractor Materials",
              "description": "Scaffolding, Props, Tools, etc."
            },
            {
              "id": "electrical_materials",
              "title": "⚡ Electrical Materials",
              "description": "Wires, Switches, MCBs, etc."
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMDA5NDU3MjRFMkZFNDUyNTQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:32:34.101Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:34.681Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:34.690Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:40.379Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUE2NEVCQzkyRTZCOEFCRDkyOAA=',
  timestamp: '1750084359'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMDA5NDU3MjRFMkZFNDUyNTQA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUE2NEVCQzkyRTZCOEFCRDkyOAA=",
  "timestamp": "1750084359",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "contractor_materials",
      "title": "🛠️ Contractor Materials",
      "description": "Scaffolding, Props, Tools, etc."
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "contractor_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: category_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'contractor_materials',
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'contractor_materials',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'contractor_materials',
      title: '🛠️ Contractor Materials',
      description: 'Scaffolding, Props, Tools, etc.'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  sessionData: {
    action: 'item_in',
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd'
  }
}
📦 [INVENTORY] Processing step: category_select with message: contractor_materials interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'contractor_materials',
    title: '🛠️ Contractor Materials',
    description: 'Scaffolding, Props, Tools, etc.'
  }
}
📦 [INVENTORY] Category selected: contractor_materials for action: item_in
📦 [INVENTORY] Starting Item In flow for category: contractor_materials
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "❌ *No Contractor Materials items found*\n\nTo use Item In, you need to add items first.\n\n🔹 Use 'New Item' to add your first contractor materials item\n🔹 Then you can add stock using 'Item In'"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQzVGQUVGRTNFOTU5OTdCRTYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:32:43.034Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:43.582Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:43.839Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGNjEzREZBRTY2OTAxN0I1OUMA'
    }
  ]
}
2025-06-16T14:32:46.041Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:32:46.337Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:46.426Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCQ0IyMEY5MUM4RTdGMzZBRDAA'
    }
  ]
}
2025-06-16T14:32:47.755Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:48.213Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:32:48.437Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T14:41:22.639Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJCNzk5NUU5MDZCN0Q2REE1RgA=',
  timestamp: '1750084881'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUJCNzk5NUU5MDZCN0Q2REE1RgA=",
  "timestamp": "1750084881",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: exit interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting inventory management..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3QzAwRjYwQTMzNjMwQzMxMzQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:41:26.170Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:26.507Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:26.600Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:31.394Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUFFMzZEODlBOUI5REY4MzkyNgA=',
  timestamp: '1750084890'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUFFMzZEODlBOUI5REY4MzkyNgA=",
  "timestamp": "1750084890",
  "text": {
    "body": "hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'hi',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzQzAzNjU3NkU4Q0E2OUVBNzQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:41:34.150Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:41:34.468Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:34.789Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxRkFGNjM0RUNFOTc1QzIzNzIA'
    }
  ]
}
2025-06-16T14:41:35.709Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:36.179Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:36.222Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:41.990Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM0MUQxNkQ4M0Y4N0JEQTdFMAA=',
  timestamp: '1750084901'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxRkFGNjM0RUNFOTc1QzIzNzIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTM0MUQxNkQ4M0Y4N0JEQTdFMAA=",
  "timestamp": "1750084901",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDQjJGOUIwNTkxMTJDOTYxMkQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:41:44.337Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: null with message:  interactiveData: undefined
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T14:41:44.812Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:45.018Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEQkI2REEwMzIwNjFGNDIzQTAA'
    }
  ]
}
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Complete Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:41:46.550Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:46.551Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:46.873Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Row title is too long. Max length is 24'
    },
    fbtrace_id: 'AU_o9uOwPRL2AuhThPUx4oO'
  }
}
Error message: Request failed with status code 400
Error sending list message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:200:30)
    at async WhatsAppService.sendListMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:82:13)
    at async Timeout._onTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:150:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '674',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
    data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Additional inventory options:"},"action":{"button":"More Options","sections":[{"title":"Reports & Analytics","rows":[{"id":"inventory_balance","title":"📊 Stock Balance","description":"View current stock levels"},{"id":"day_to_day","title":"📅 Daily Reports","description":"Daily transaction log"},{"id":"setup_comprehensive_inventory","title":"🚀 Setup Complete Inventory","description":"Add all category items with 0 stock"},{"id":"create_sample_data","title":"🧪 Create Sample Data","description":"Add sample items with stock for testing"}]}]}}}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '674',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 49035,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 553,
        [Symbol(triggerId)]: 551
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 674\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/652783161256584/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 674,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AU_o9uOwPRL2AuhThPUx4oO',
      'x-fb-trace-id': 'CwLjUCBHuyh',
      'x-fb-rev': '1023869344',
      'x-fb-debug': '1VJezzM9/kgyF+chs3Zad/Aj29KXRO8oipgrtdLevMMLRHhFdpJTupX/G4NsCx4OUuJZce7QZ+7y1iKTyiGEEQ==',
      date: 'Mon, 16 Jun 2025 14:41:46 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcOU_D7kPfh7enOxyIAJUTPdIeaM-_fxb9V3JvCH2YZ5-7B820JPeCcDoGfKPh364dZ3CpYevLc66e-YaaLCfHq93A66ohWU"; e_clientaddr="AcPYJOeaB2FWThmEIe7V8S8LfZgIonf7JNEN4nS0wcjojNpQebV59Om-OnKPgJ8qXVMCNj30EbuM0iHQ864zYf_ZhYFV5zybY1NvLTzR4jeJFLTFog"; e_upip="AcMGJp-jn65w6V-bXX0SBqCWP0nKHgf9muDW9EiNoM8BnfJtwHsbPEQQoOK-B9WXeszyHVGH_eH--rY7CeEbxvPB-rQCR-0EWEAcqN0"; e_fb_zone="AcP2eF5AxyHGT6-WRGnxMHQ9zckkA0VBm578SRwiWN59NbCiQ4JRw_PyX-0tvTCm"; e_fb_twtaskhandle="AcPd_E9QUS6704t8Rdth_jfDx3bs9tiq69YTkBZybtrmnZtt8n7CvisO1rqRiR7ZDqL8_3a6rUkp__FG9w81tZ4XBXynGJ8FsJbz3FN6et0SRoI"; e_proxy="AcPSHRoV_N_hDjl70dEb2OY5aUTIdz8HXGDAQbh2VAR7r9jzmJJ1rqvcuPelR28n_GjSYer7kE4XZ4pq7jAK", http_request_error; e_fb_vipaddr="AcOGQiSy5G0o6R5NF5WUoYQUkGIYLAHGOO57E5HqGyU8wiw6DXWDXDXW3-39szhJONznPl97oGkwGSm80avQ4yre1CJA0nR0FwI"; e_clientaddr="AcNq_YThzOOwK4RkRmcSTdn4AEam7xP_DGXOWse88THZpA6mFXepVs36mp9nP5FUZs2_Ck8kKr2IZIhROkIEXE3aaT_9vTxEjyL_xYFzOhKOHsG8v6m2sw"; e_upip="AcOoYGAyvnGu2D_PyvFBlqynnVgZfwovCU0QVFby-NLhWbR0csjNrvQ5D0EmHSedyy3gxpwEPjSGJo1TIVp4uRHOPyTLa5yI"; e_fb_zone="AcPl5I5aAnOpd5I2IDwn-443EkIN1otS7AdjDXJk8GoeLhk7QDLATaZu_s5TIw"; e_fb_twtaskhandle="AcN8IcVJKBSvNQOSp6nroMHXLCoe3mE9Emb6gTo0MSmdDbv6CE89P1aWyMraQi72ZKZP_umcmJBP1OSCgEgS3d62IyrR44tuotw"; e_proxy="AcMWBqrlyOopLKiSRp5HkqU7n6eaTeb6s8Al8sdmh-K7bxyJ0fqW3G9DGbGZDFbI0pDxRHAEriMLTIE"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=48, rtx=0, c=10, mss=1380, tbw=3729, tp=-1, tpl=-1, uplat=499, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '187'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Additional inventory options:"},"action":{"button":"More Options","sections":[{"title":"Reports & Analytics","rows":[{"id":"inventory_balance","title":"📊 Stock Balance","description":"View current stock levels"},{"id":"day_to_day","title":"📅 Daily Reports","description":"Daily transaction log"},{"id":"setup_comprehensive_inventory","title":"🚀 Setup Complete Inventory","description":"Add all category items with 0 stock"},{"id":"create_sample_data","title":"🧪 Create Sample Data","description":"Add sample items with stock for testing"}]}]}}}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '674',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 674\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/652783161256584/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
2025-06-16T14:41:49.508Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTk4NDIyOUQwMzI4OEM2MTVGNgA=',
  timestamp: '1750084908'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJEQkI2REEwMzIwNjFGNDIzQTAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTk4NDIyOUQwMzI4OEM2MTVGNgA=",
  "timestamp": "1750084908",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'item_in', title: '📦 Item In' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Handling main menu selection: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Starting Item In flow with category selection
📦 [INVENTORY] Showing category selection for action: item_in user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending category selection list with action text: add stock to
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Select Inventory Category*\n\nWhich type of inventory do you want to add stock to?"
    },
    "action": {
      "button": "Select Category",
      "sections": [
        {
          "title": "Inventory Categories",
          "rows": [
            {
              "id": "building_material",
              "title": "🏗️ Building Material",
              "description": "Cement, Steel, Bricks, Sand, etc."
            },
            {
              "id": "contractor_materials",
              "title": "🛠️ Contractor Materials",
              "description": "Scaffolding, Props, Tools, etc."
            },
            {
              "id": "electrical_materials",
              "title": "⚡ Electrical Materials",
              "description": "Wires, Switches, MCBs, etc."
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMjk5NUZCMTA1RjNFRkJDNjIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:41:52.193Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:52.452Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:52.572Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:41:58.312Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTYwMzcwRUZBNTJDN0FGREI0MgA=',
  timestamp: '1750084917'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMjk5NUZCMTA1RjNFRkJDNjIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTYwMzcwRUZBNTJDN0FGREI0MgA=",
  "timestamp": "1750084917",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "contractor_materials",
      "title": "🛠️ Contractor Materials",
      "description": "Scaffolding, Props, Tools, etc."
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "contractor_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: category_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'contractor_materials',
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'contractor_materials',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'contractor_materials',
      title: '🛠️ Contractor Materials',
      description: 'Scaffolding, Props, Tools, etc.'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  sessionData: {
    action: 'item_in',
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd'
  }
}
📦 [INVENTORY] Processing step: category_select with message: contractor_materials interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'contractor_materials',
    title: '🛠️ Contractor Materials',
    description: 'Scaffolding, Props, Tools, etc.'
  }
}
📦 [INVENTORY] Category selected: contractor_materials for action: item_in
📦 [INVENTORY] Starting Item In flow for category: contractor_materials
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "❌ *No Contractor Materials items found*\n\nTo use Item In, you need to add items first.\n\n🔹 Use 'New Item' to add your first contractor materials item\n🔹 Then you can add stock using 'Item In'"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzODAzMzQzQjEwNEUyMUQ5OEEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:42:00.961Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:42:01.178Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:42:01.314Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFQkE4N0QzMENDQzNFMEIzMEIA'
    }
  ]
}
2025-06-16T14:42:03.702Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Complete Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:42:03.844Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:42:04.109Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Row title is too long. Max length is 24'
    },
    fbtrace_id: 'Aiq7xHh1QLWJy1COCk29PxP'
  }
}
Error message: Request failed with status code 400
Error sending list message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:200:30)
    at async WhatsAppService.sendListMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:82:13)
    at async Timeout._onTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:150:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '674',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
    data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Additional inventory options:"},"action":{"button":"More Options","sections":[{"title":"Reports & Analytics","rows":[{"id":"inventory_balance","title":"📊 Stock Balance","description":"View current stock levels"},{"id":"day_to_day","title":"📅 Daily Reports","description":"Daily transaction log"},{"id":"setup_comprehensive_inventory","title":"🚀 Setup Complete Inventory","description":"Add all category items with 0 stock"},{"id":"create_sample_data","title":"🧪 Create Sample Data","description":"Add sample items with stock for testing"}]}]}}}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '674',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 66270,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 876,
        [Symbol(triggerId)]: 874
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 674\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/652783161256584/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 674,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'Aiq7xHh1QLWJy1COCk29PxP',
      'x-fb-trace-id': 'GIuvuqTmmAV',
      'x-fb-rev': '1023869344',
      'x-fb-debug': '3+2AAwa1uGF4r6hFS6PFx11f7qDqcVoTHCf+JJEa0OuSaiNzm6kL5ipFi4XZEf9PmVu50yxgWCB08M44vy+ksg==',
      date: 'Mon, 16 Jun 2025 14:42:04 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcPn6QQU7PKzQw_lUgaJezAVQeMUEbCd8j72uEZwCLkz1XKIDoK_W1UIvH6GwadiS3Hvj9kP_GwG5m5VQD3d-0iisb8Kvxkd"; e_clientaddr="AcNoykj9atfwQb-CU9rWN9CZ6iSzIduHkaIAb8QyOGM8sG2fGtd9yXZw8014y0MbRJszKTHV-V6dYgjWVNQ6k72qPnOUJgp1_anohr4DCXpUv0vMkg"; e_upip="AcPLiSQV-tIwq1yN57s0mXx61oDYzc-OZe-MsKKrB48BaziZM5lhkLde1lYAw8acwqi5O4J0CFQci-NFl5BGIRE8GiVVqOZp5ZJW"; e_fb_zone="AcPVW0c7j2cmHTtOi9sSQUconYc28k_Rg6yw3oMLrN_FiqvhokeEl_RlbUQtFjrx"; e_fb_twtaskhandle="AcNZGuCkM6wKNw11g_qI0BcsACuUWsX6wiCWR8EVSkCVgCGXwMG48mq-jsbJJlKVq381gjdFn1H3sH4utho09QvGtNqv8pPS07CMJfuclu6lSVQ"; e_proxy="AcM-ZGUGO6Q2SdW7X_kn_K7PzGLFJY61wQJk750hUKkrFX_2zHOXKDVeJos2Y36rxE09MtMd5Dv-5dLHEm_9", http_request_error; e_fb_vipaddr="AcMdXqRZVDP6IcsWlnD3RJKNh7v9anpa3X2jmaUNMKwpdNLGYQ4V-bC41s23LYBpdEMZ-c4Q73rRNW-YhgCn60e4vvM70Sop"; e_clientaddr="AcOI8ONnTWw9scToTK37ok56-sUQS4whABhg3wAAipojg_WBNaQlZYKT7G6_QeHQvv6QgxoIu-0UjsDoYv89XJJe633B7r9B7hpUFUQukCeLlDumeXu-AQ"; e_upip="AcP3Kmz3T4wAuUfCZy2mnhVkefQ-Coq7UwkqeiQHG-rUewVQy9GzSp6qGDg_jLw18s6VHFiFNpH1EkflA3PIpcBh1-J7KqNU"; e_fb_zone="AcMY7ISyGE_tk5xYv6N6jAaidz_h3K1v8S4_uXTEub75UnaDJ16mPAHYI-46jg"; e_fb_twtaskhandle="AcNoJkNuiDqaslYfXonsZaeHtUsiupq-QsSZ3Kx9iwcYB_m3T-hnYMQgCe9CXKshpD1DUC4WS3AOHFuI9PaWsBCjbcZr5ScyMUE"; e_proxy="AcM1GSlrg0QDcAYopStbjNW5czCgLJQCIqntCxHx4l1AGl5CtfEa692OtjVORVNjU6aW-Np-3nXWJSs"',
      'x-fb-connection-quality': 'GOOD; q=0.7, rtt=54, rtx=0, c=10, mss=1380, tbw=3714, tp=-1, tpl=-1, uplat=407, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '187'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Additional inventory options:"},"action":{"button":"More Options","sections":[{"title":"Reports & Analytics","rows":[{"id":"inventory_balance","title":"📊 Stock Balance","description":"View current stock levels"},{"id":"day_to_day","title":"📅 Daily Reports","description":"Daily transaction log"},{"id":"setup_comprehensive_inventory","title":"🚀 Setup Complete Inventory","description":"Add all category items with 0 stock"},{"id":"create_sample_data","title":"🧪 Create Sample Data","description":"Add sample items with stock for testing"}]}]}}}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '674',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 674\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/652783161256584/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
2025-06-16T14:42:35.530Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJBNUIyQ0MyODYxNTIzMTMwQwA=',
  timestamp: '1750084954'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFQkE4N0QzMENDQzNFMEIzMEIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTJBNUIyQ0MyODYxNTIzMTMwQwA=",
  "timestamp": "1750084954",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "new_item",
      "title": "🆕 New Item"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "new_item"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'new_item',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'new_item',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'new_item', title: '🆕 New Item' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: new_item interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'new_item', title: '🆕 New Item' }
}
📦 [INVENTORY] Handling main menu selection: new_item interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'new_item', title: '🆕 New Item' }
}
📦 [INVENTORY] Starting New Item flow with category selection
📦 [INVENTORY] Showing category selection for action: new_item user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending category selection list with action text: create new item in
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Select Inventory Category*\n\nWhich type of inventory do you want to create new item in?"
    },
    "action": {
      "button": "Select Category",
      "sections": [
        {
          "title": "Inventory Categories",
          "rows": [
            {
              "id": "building_material",
              "title": "🏗️ Building Material",
              "description": "Cement, Steel, Bricks, Sand, etc."
            },
            {
              "id": "contractor_materials",
              "title": "🛠️ Contractor Materials",
              "description": "Scaffolding, Props, Tools, etc."
            },
            {
              "id": "electrical_materials",
              "title": "⚡ Electrical Materials",
              "description": "Wires, Switches, MCBs, etc."
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJERkVDRkI4RUM4Njc1Q0E0MUUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:42:38.653Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:42:38.935Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:42:39.093Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:42:47.030Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThERDIyNzBCQjYwREUzNTE3RQA=',
  timestamp: '1750084966'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJERkVDRkI4RUM4Njc1Q0E0MUUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThERDIyNzBCQjYwREUzNTE3RQA=",
  "timestamp": "1750084966",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "contractor_materials",
      "title": "🛠️ Contractor Materials",
      "description": "Scaffolding, Props, Tools, etc."
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "contractor_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: category_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'contractor_materials',
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'contractor_materials',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'contractor_materials',
      title: '🛠️ Contractor Materials',
      description: 'Scaffolding, Props, Tools, etc.'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  sessionData: {
    action: 'new_item',
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd'
  }
}
📦 [INVENTORY] Processing step: category_select with message: contractor_materials interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'contractor_materials',
    title: '🛠️ Contractor Materials',
    description: 'Scaffolding, Props, Tools, etc.'
  }
}
📦 [INVENTORY] Category selected: contractor_materials for action: new_item
📦 [INVENTORY] Starting New Item flow for category: contractor_materials
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🆕 *Add New Contractor Materials Item*\n\nEnter the name of the new contractor materials item:\n\n💡 *Contractor Materials Examples:*\n• Scaffolding Plates 3ft×2ft\n• Jack Prop 2.3m\n• Ring Machine 12mm\n• Cutter Machine 14inch\n• Sikanja 2ft\n• Bamboo 8ft\n\n*Type the item name:*"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NzNCNEQ0RDA1RENEMzM0RUMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:42:49.820Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:42:50.354Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:42:56.232Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:43:05.301Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFFOTA1REYwQTVFQzIwQ0Q2MAA=',
  timestamp: '1750084984'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTFFOTA1REYwQTVFQzIwQ0Q2MAA=",
  "timestamp": "1750084984",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: new_item_name
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  sessionIntent: 'inventory_management',
  sessionStep: 'new_item_name',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'new_item_name',
  sessionData: {
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd',
    category: 'contractor_materials'
  }
}
📦 [INVENTORY] Processing step: new_item_name with message: exit interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting inventory management..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxQTU3MTU2OTM2MDZGQzg1NkUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:43:07.904Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:43:08.450Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:43:08.499Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:43:19.377Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY1RkRCQjkzRDQ2NjBCRkMyRgA=',
  timestamp: '1750084998'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY1RkRCQjkzRDQ2NjBCRkMyRgA=",
  "timestamp": "1750084998",
  "text": {
    "body": "hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'hi',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFQTAzRDRCRDEyMjlENEI0RTEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:43:21.834Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:43:22.161Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:43:22.190Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NzlEQUMwRDQ0RDJCN0MxMkEA'
    }
  ]
}
2025-06-16T14:43:23.562Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:43:24.213Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:43:24.254Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:43:29.540Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThFQUIzOTdENjBBQjdBREQxMQA=',
  timestamp: '1750085008'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4NzlEQUMwRDQ0RDJCN0MxMkEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThFQUIzOTdENjBBQjdBREQxMQA=",
  "timestamp": "1750085008",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4MjMyMTA1ODgyRTA4NjRDM0UA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:43:32.011Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: null with message:  interactiveData: undefined
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T14:43:32.386Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:43:32.515Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4Njg5M0M5OTAxMzA5MDFCOTcA'
    }
  ]
}
2025-06-16T14:43:33.934Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Complete Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Create Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:43:34.421Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Row title is too long. Max length is 24'
    },
    fbtrace_id: 'Aw-v8iP3AYZEBJ0xFFW03Jk'
  }
}
Error message: Request failed with status code 400
Error sending list message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at IncomingMessage.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at IncomingMessage.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:200:30)
    at async WhatsAppService.sendListMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:82:13)
    at async Timeout._onTimeout (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:150:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '674',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
    data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Additional inventory options:"},"action":{"button":"More Options","sections":[{"title":"Reports & Analytics","rows":[{"id":"inventory_balance","title":"📊 Stock Balance","description":"View current stock levels"},{"id":"day_to_day","title":"📅 Daily Reports","description":"Daily transaction log"},{"id":"setup_comprehensive_inventory","title":"🚀 Setup Complete Inventory","description":"Add all category items with 0 stock"},{"id":"create_sample_data","title":"🧪 Create Sample Data","description":"Add sample items with stock for testing"}]}]}}}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '674',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 156623,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 1652,
        [Symbol(triggerId)]: 1650
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 674\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/652783161256584/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 44,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 674,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'Aw-v8iP3AYZEBJ0xFFW03Jk',
      'x-fb-trace-id': 'Cmm0VPkY8D3',
      'x-fb-rev': '1023869344',
      'x-fb-debug': '84LgRB36M66LIsLWv2wH16MCdzEgP7DakoUGRoC7qm1HLKutZ73zVAtX2Zf2P9aOiOVhEpkkk+EILaBFci7Xpw==',
      date: 'Mon, 16 Jun 2025 14:43:34 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcMYNojyeILjwsEsyCvaWi1--0jo83esK2gSHAVv_YhGD8E6LRnQ4WUs3Twte738xILDNnJrZ94mbcWe0b7neawSSl8G_ZH9"; e_clientaddr="AcMJ_CkmXL_iqrqjyJOt0SlbyqItaHJGEIq7qkT2qY0ABPWhl3QNckYsvBuE_Hz5l7cUAtY3Y0uld3YEuioOblTSiQlCvKeTHk3SU1vWdjapaP9RFg"; e_upip="AcM5LbdknGhMdbppIem0bcreRS5ooaOUkDS6oziBvSFbt6FGUfpDLrcO6C8KMY-6Gpl7d329-xY4Yv0PUA0q4MeRr0roIN0lwX0Z3sM"; e_fb_zone="AcN4fIg1MtICrhCXmVYOwOTkt4Blia00v2Ug-rp4xPOQWn-isUSNz_Rx2KhgveX9"; e_fb_twtaskhandle="AcNZvdwaSuIdWCdKWnjpPK83q5c5NkBjv-tUGlpqrbk0TiegL3dQxs8VGsGkbWQZ0MKvf01nKNbjkw1fOH3UHCrUDD2-CbOtPPmLbA-shW31kQ"; e_proxy="AcOF4F_hDwRgguyX5C4yBqeowpf2_HNPgarIalLdWkF_q0KMg8-ZRbU7Rbx2y91cgW41-Bgok0XijwJUFarC", http_request_error; e_fb_vipaddr="AcPL14HaxDlESYXBPxh75CSMYtitKlVwycT291azWJSt5S7UKk19d6WEJAycOFefCefDd0lbV30H7sbqY9kkdo3VhW4rYi2R"; e_clientaddr="AcP7__64kN-kAqLm7pFB-bKUFZY_S4_XGcH79SxlY6F5nwmnu63HzKyms_R0CdoDW3f0A1bHYtzZGCdcCTGmpQHDpAbBTVFmUkskQspkr4dwvpJoJDlljw"; e_upip="AcMazNyj5zeJK5oRdsZbWaVzrUEQJGcf8gihvEcervajRkSCu6-FKWZLIWgDBP9PcfWKug7mgTFacIWXwb1SI6jni-sKTRBy"; e_fb_zone="AcOfBZUt5g4l53_NYmBRgi05Qa_qkkVUQqWNfhNw9lLcpLP34D6XeyJb6i9Tnw"; e_fb_twtaskhandle="AcP1C5_jWwzUQsm9IKSw2y0xMrqANc9k0jUKajkVcBw8-ZkgtwMgqosL8yaSMNUpCPp42MfLIE2WbXtg0U-6YFlVYMiIFxirxnAs"; e_proxy="AcNjnNMhiMB4YHGaYwZM6fTuokCQnWzq68chpfLSVUt9dLKGVlwnKRTTIag-0MroiE_MC4xy8O5ZuRQ"',
      'x-fb-connection-quality': 'GOOD; q=0.7, rtt=51, rtx=0, c=10, mss=1380, tbw=3729, tp=-1, tpl=-1, uplat=431, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '237'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"Additional inventory options:"},"action":{"button":"More Options","sections":[{"title":"Reports & Analytics","rows":[{"id":"inventory_balance","title":"📊 Stock Balance","description":"View current stock levels"},{"id":"day_to_day","title":"📅 Daily Reports","description":"Daily transaction log"},{"id":"setup_comprehensive_inventory","title":"🚀 Setup Complete Inventory","description":"Add all category items with 0 stock"},{"id":"create_sample_data","title":"🧪 Create Sample Data","description":"Add sample items with stock for testing"}]}]}}}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '674',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 674\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/652783161256584/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
2025-06-16T14:43:34.684Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T14:46:41.980Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUUwMzNGODUyMDNBOUMwRUNGQwA=',
  timestamp: '1750085172'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUUwMzNGODUyMDNBOUMwRUNGQwA=",
  "timestamp": "1750085172",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: exit interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting inventory management..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzOTBDRDFBRTUyNjQyOUM3NTYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:46:45.560Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:46:45.808Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:46:45.815Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:46:51.246Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUEwMTA4MUFGQkNEMDE0OTEwNQA=',
  timestamp: '1750085210'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUEwMTA4MUFGQkNEMDE0OTEwNQA=",
  "timestamp": "1750085210",
  "text": {
    "body": "hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'hi',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDOTRBQjgyODczOTgxM0Y5RkQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:46:53.896Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:46:54.229Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:46:54.492Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMDAyOUQwMDU0MTE5MDIwQkMA'
    }
  ]
}
2025-06-16T14:46:55.362Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:46:55.931Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:46:56.187Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:01.015Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU4RDVBNDU2Q0FCQzBBMkQxNQA=',
  timestamp: '1750085220'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDMDAyOUQwMDU0MTE5MDIwQkMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUU4RDVBNDU2Q0FCQzBBMkQxNQA=",
  "timestamp": "1750085220",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCNUIxOTBBRDhGMUFGQjc1REMA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:47:03.456Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: null with message:  interactiveData: undefined
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
2025-06-16T14:47:03.838Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T14:47:04.045Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI1RDAwN0M4ODUwODk4QzkwQzMA'
    }
  ]
}
2025-06-16T14:47:05.406Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:47:05.714Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:05.760Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNDg2MjdEOEMzNzFCQTFCNUMA'
    }
  ]
}
2025-06-16T14:47:07.012Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:07.474Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:07.678Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:14.945Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTlDNUZFQzYxRTBDMzI1RThDQgA=',
  timestamp: '1750085234'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNDg2MjdEOEMzNzFCQTFCNUMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTlDNUZFQzYxRTBDMzI1RThDQgA=",
  "timestamp": "1750085234",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "setup_comprehensive_inventory",
      "title": "🚀 Setup Inventory",
      "description": "Add all category items with 0 stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "setup_comprehensive_inventory"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'setup_comprehensive_inventory',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'setup_comprehensive_inventory',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'setup_comprehensive_inventory',
      title: '🚀 Setup Inventory',
      description: 'Add all category items with 0 stock'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: setup_comprehensive_inventory interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'setup_comprehensive_inventory',
    title: '🚀 Setup Inventory',
    description: 'Add all category items with 0 stock'
  }
}
📦 [INVENTORY] Handling main menu selection: setup_comprehensive_inventory interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'setup_comprehensive_inventory',
    title: '🚀 Setup Inventory',
    description: 'Add all category items with 0 stock'
  }
}
📦 [INVENTORY] Setting up comprehensive inventory
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🚀 Creating comprehensive inventory with all categories...\n\n🛠️ Contractor Materials\n🏗️ Building Materials\n⚡ Electrical Materials\n\nPlease wait..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFQ0UyOEZDQTE1OUYyNDRFN0EA'
    }
  ]
}
2025-06-16T14:47:17.441Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:17.873Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:17.996Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ *Comprehensive Inventory Setup Complete!*\n\n📦 Created: 104 new items\n⏭️ Skipped: 0 existing items\n\n*Items by Category:*\n🛠️ Contractor Materials: 19 items\n🏗️ Building Materials: 33 items\n⚡ Electrical Materials: 52 items\n\n*Key Features:*\n• All items start with 0 stock\n• Properly categorized for easy selection\n• Ready for Item In/Out operations\n• Complete with appropriate units\n\n🎉 Your inventory system is now fully equipped!\n\n*Next Steps:*\n1️⃣ Use \"Item In\" to add stock\n2️⃣ Select category to see filtered items\n3️⃣ Choose item and enter quantity"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIzQjlFMkY5MjhGMTgyNzZCQjAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:47:30.582Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:30.925Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:31.104Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: undefined
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGQUVGNEE4NzY3QjVCM0Y4NjMA'
    }
  ]
}
2025-06-16T14:47:35.477Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:47:35.991Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:36.004Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5NkVEOUU1RjIwRjcyODc2RDUA'
    }
  ]
}
2025-06-16T14:47:37.703Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:37.922Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdBMzlFQkUyMjhBMkVBRkU2MgA=',
  timestamp: '1750085257'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGQUVGNEE4NzY3QjVCM0Y4NjMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdBMzlFQkUyMjhBMkVBRkU2MgA=",
  "timestamp": "1750085257",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
2025-06-16T14:47:37.976Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
2025-06-16T14:47:38.003Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'item_in', title: '📦 Item In' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Handling main menu selection: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Starting Item In flow with category selection
📦 [INVENTORY] Showing category selection for action: item_in user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending category selection list with action text: add stock to
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Select Inventory Category*\n\nWhich type of inventory do you want to add stock to?"
    },
    "action": {
      "button": "Select Category",
      "sections": [
        {
          "title": "Inventory Categories",
          "rows": [
            {
              "id": "building_material",
              "title": "🏗️ Building Material",
              "description": "Cement, Steel, Bricks, Sand, etc."
            },
            {
              "id": "contractor_materials",
              "title": "🛠️ Contractor Materials",
              "description": "Scaffolding, Props, Tools, etc."
            },
            {
              "id": "electrical_materials",
              "title": "⚡ Electrical Materials",
              "description": "Wires, Switches, MCBs, etc."
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGMzE3OUFBRDM1NUVBMkU5NDkA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:47:40.700Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:40.992Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:41.051Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:47:45.687Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTk5NzQyNkE5MzE4RjcxREFDQQA=',
  timestamp: '1750085264'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGMzE3OUFBRDM1NUVBMkU5NDkA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTk5NzQyNkE5MzE4RjcxREFDQQA=",
  "timestamp": "1750085264",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "contractor_materials",
      "title": "🛠️ Contractor Materials",
      "description": "Scaffolding, Props, Tools, etc."
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "contractor_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: category_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'contractor_materials',
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'contractor_materials',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'contractor_materials',
      title: '🛠️ Contractor Materials',
      description: 'Scaffolding, Props, Tools, etc.'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  sessionData: {
    action: 'item_in',
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd'
  }
}
📦 [INVENTORY] Processing step: category_select with message: contractor_materials interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'contractor_materials',
    title: '🛠️ Contractor Materials',
    description: 'Scaffolding, Props, Tools, etc.'
  }
}
📦 [INVENTORY] Category selected: contractor_materials for action: item_in
📦 [INVENTORY] Starting Item In flow for category: contractor_materials
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Contractor Materials - Item In*\n\nSelect item to add stock:"
    },
    "action": {
      "button": "Select Item",
      "sections": [
        {
          "title": "Contractor Materials Items",
          "rows": [
            {
              "id": "25184a1e-8844-4062-82f6-f58438ba4525",
              "title": "3×1.5 Patti",
              "description": "Current: 0 pieces"
            },
            {
              "id": "29e2b21c-dbc6-4413-a5ab-d3a1ce5bacbd",
              "title": "3×2 Patti",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1f1cd3da-c7ee-4872-916c-cab44da7506c",
              "title": "4×2 Wall Plate",
              "description": "Current: 0 pieces"
            },
            {
              "id": "94f16fe4-5312-4bd1-b174-2873ca88c4dc",
              "title": "Bamboo 10ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "2b1994ba-520c-486b-beee-1ff1d86e6434",
              "title": "Bamboo 8ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b",
              "title": "Cutter Machine 14inch",
              "description": "Current: 0 pieces"
            },
            {
              "id": "2b32a356-da26-4a2b-9910-9295dac0ab38",
              "title": "Jack Prop 2.2m",
              "description": "Current: 0 pieces"
            },
            {
              "id": "3ca71332-9823-4d78-952f-5cd369149cd0",
              "title": "Jack Prop 2.3m",
              "description": "Current: 0 pieces"
            },
            {
              "id": "8626aa37-0ab4-4b9d-8862-56bceb0749c1",
              "title": "Ply Cutter 5inch",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1829a2c5-856a-474e-9b51-7ace991cdfb5",
              "title": "Ply Cutter 7inch",
              "description": "Current: 0 pieces"
            },
            {
              "id": "4f7a4312-cc6b-4ad3-ad3e-2b781f6eb503",
              "title": "Ring Machine 12mm",
              "description": "Current: 0 pieces"
            },
            {
              "id": "095ad5b0-21b4-4c55-bd44-4731b7318b07",
              "title": "Ring Machine 8mm",
              "description": "Current: 0 pieces"
            },
            {
              "id": "88281be5-16fe-4daa-b7f8-100495da29ae",
              "title": "Scaffolding Plate 3ft...",
              "description": "Current: 0 pieces"
            },
            {
              "id": "0fc34ab9-6eaf-432f-a3aa-2fc318f9cdda",
              "title": "Scaffolding Plate 3ft...",
              "description": "Current: 0 pieces"
            },
            {
              "id": "a6b32973-d856-42b3-a5ca-84ba99f0e9f2",
              "title": "Scaffolding Plate 3ft...",
              "description": "Current: 0 pieces"
            },
            {
              "id": "290c6263-960e-41a2-b3d8-3902967a28e9",
              "title": "Scaffolding Plate 3ft...",
              "description": "Current: 0 pieces"
            },
            {
              "id": "2f0e1580-db4e-4be4-b8a3-325d39d13972",
              "title": "Sikanja 2.5ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "96f910fc-f0d5-4289-81df-6041626d8f2a",
              "title": "Sikanja 2ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "2a7d9518-503e-4860-87ad-a48849d8882c",
              "title": "Sikanja 3ft",
              "description": "Current: 0 pieces"
            }
          ]
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Total row count exceed max allowed count: 10'
    },
    fbtrace_id: 'Aj3E-jl2lxBGbxuw-AxBPg_'
  }
}
Error message: Request failed with status code 400
Error sending list message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:200:30)
    at async WhatsAppService.sendListMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:82:13)
    at async InventoryFlow.startItemInWithCategory (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:1242:13)
    at async InventoryFlow.handleCategorySelection (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:273:17)
    at async InventoryFlow.handleInventoryFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:94:13)
    at async InventoryFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:63:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:70:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:124:17) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '2315',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
    data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"📦 *Contractor Materials - Item In*\\n\\nSelect item to add stock:"},"action":{"button":"Select Item","sections":[{"title":"Contractor Materials Items","rows":[{"id":"25184a1e-8844-4062-82f6-f58438ba4525","title":"3×1.5 Patti","description":"Current: 0 pieces"},{"id":"29e2b21c-dbc6-4413-a5ab-d3a1ce5bacbd","title":"3×2 Patti","description":"Current: 0 pieces"},{"id":"1f1cd3da-c7ee-4872-916c-cab44da7506c","title":"4×2 Wall Plate","description":"Current: 0 pieces"},{"id":"94f16fe4-5312-4bd1-b174-2873ca88c4dc","title":"Bamboo 10ft","description":"Current: 0 pieces"},{"id":"2b1994ba-520c-486b-beee-1ff1d86e6434","title":"Bamboo 8ft","description":"Current: 0 pieces"},{"id":"1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b","title":"Cutter Machine 14inch","description":"Current: 0 pieces"},{"id":"2b32a356-da26-4a2b-9910-9295dac0ab38","title":"Jack Prop 2.2m","description":"Current: 0 pieces"},{"id":"3ca71332-9823-4d78-952f-5cd369149cd0","title":"Jack Prop 2.3m","description":"Current: 0 pieces"},{"id":"8626aa37-0ab4-4b9d-8862-56bceb0749c1","title":"Ply Cutter 5inch","description":"Current: 0 pieces"},{"id":"1829a2c5-856a-474e-9b51-7ace991cdfb5","title":"Ply Cutter 7inch","description":"Current: 0 pieces"},{"id":"4f7a4312-cc6b-4ad3-ad3e-2b781f6eb503","title":"Ring Machine 12mm","description":"Current: 0 pieces"},{"id":"095ad5b0-21b4-4c55-bd44-4731b7318b07","title":"Ring Machine 8mm","description":"Current: 0 pieces"},{"id":"88281be5-16fe-4daa-b7f8-100495da29ae","title":"Scaffolding Plate 3ft...","description":"Current: 0 pieces"},{"id":"0fc34ab9-6eaf-432f-a3aa-2fc318f9cdda","title":"Scaffolding Plate 3ft...","description":"Current: 0 pieces"},{"id":"a6b32973-d856-42b3-a5ca-84ba99f0e9f2","title":"Scaffolding Plate 3ft...","description":"Current: 0 pieces"},{"id":"290c6263-960e-41a2-b3d8-3902967a28e9","title":"Scaffolding Plate 3ft...","description":"Current: 0 pieces"},{"id":"2f0e1580-db4e-4be4-b8a3-325d39d13972","title":"Sikanja 2.5ft","description":"Current: 0 pieces"},{"id":"96f910fc-f0d5-4289-81df-6041626d8f2a","title":"Sikanja 2ft","description":"Current: 0 pieces"},{"id":"2a7d9518-503e-4860-87ad-a48849d8882c","title":"Sikanja 3ft","description":"Current: 0 pieces"}]}]}}}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '2315',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 103460,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 2130,
        [Symbol(triggerId)]: 2128
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 2315\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/652783161256584/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 2315,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'Aj3E-jl2lxBGbxuw-AxBPg_',
      'x-fb-trace-id': 'ADoeVbD0+NY',
      'x-fb-rev': '1023869344',
      'x-fb-debug': 'wPLuFNVO4KF+ibefqELtfQC5F/FRJilauBTGsv3Fgsx8qEk3rRBJtDeS4tEtJ8/GA5M7xuc/gcCdv/UbxRWljg==',
      date: 'Mon, 16 Jun 2025 14:47:47 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcPvw2C2N8CwPlI8EO4JaOH2EzOgKMM1KQS3sB9ZeCcTfSZVIQISWP_G_UB0qmc27n4_I9bC02HmaHGTPXgtFYanZpSXeDcr"; e_clientaddr="AcP58L2BtrEWBiQyls4zVgZdICp2_2Hn04Zf_WIDbZLNDGq1jxOQQrJtq-irOoKf_Gct2F0py5TqvM8ZrcLSiSyqGyk25X3DSGlUgz4kJiPj-fNTiw"; e_upip="AcOazGy_I79LRijn0os4M9oZ70sNxfm9CH_HJhLPuRXsDY1CoCPh90m3-iGV5h8xoxrDbZ6zK7QuY-VHYIN3xxSeenR8J1Tp0poq6R8"; e_fb_zone="AcPGmh-shtGM-0V8yonlqzUEsw_Rgg35QoUlaya3a4eptUajktl9geN8eSC8rLBa"; e_fb_twtaskhandle="AcNq3C9ROkfO4ijrBL99wIIGUVu-huz2RQ1deqqMiLmY8e85MQo9vW1UGhPeCr-T1zTArF6ECB6gcLrwso2GXUjIzMLJPgzL7or4namw7G7_iw"; e_proxy="AcNJFIbjZGKk57r9896eIrMdQtMJSYN9uOpthqqzrAC-ZfUebcKRfb5OagOmNPwl6l2Yxt_V3op27mKn_Il3", http_request_error; e_fb_vipaddr="AcOCv-tTIAsMUAo9UZ3XeCYr81SeRJJ6XzJ39JDhpiUvPYjH9umAHCsin2xBR_D4uXt5Z5YnWrKAKFnJrrSHrOjc3WmMOf1o"; e_clientaddr="AcPyzcuC1GDSJmYr_oVNss402Np5TsXU7CbayeS7jSmO-VPPYuKWKSmk8jrhV4YiQpIn1Rg-1qn7CkAnPgaTPC7vm3ahvPI5rMDEMcupTmd-Cex3bWNdnQ"; e_upip="AcN3fUfwoUg0ntPIJriGTsyBzyIOdCrQuRJOe7BFVIs-O57t-L0ZrIqvJxMRaJnI_IwGluprwfXkznBPinO6PE1X6x3qfnan"; e_fb_zone="AcPIg8O6loNFlhOGSn7yMXkaBuU2-lZ2DSXH3MdrdXaIzp7Doh-xBN6ARTF5rA"; e_fb_twtaskhandle="AcMbmOBcZ3QV3WIrF6rG_2t8waZl6uk2eQrsbiz6mniX9GEH8G952zQsKTo4M1tAMOmrFLGpktVYwCetVNOE_ouSKSvgfDKIh99F"; e_proxy="AcNgPIfG6rhBYhdyMF0jFkwO7A8LQuYZPGtQmncL89xbz40sQ7lUJou-1COig5atFFdgkU7j0YUxNQ0"',
      'x-fb-connection-quality': 'GOOD; q=0.7, rtt=98, rtx=0, c=10, mss=1380, tbw=1380, tp=-1, tpl=-1, uplat=394, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '186'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"📦 *Contractor Materials - Item In*\\n\\nSelect item to add stock:"},"action":{"button":"Select Item","sections":[{"title":"Contractor Materials Items","rows":[{"id":"25184a1e-8844-4062-82f6-f58438ba4525","title":"3×1.5 Patti","description":"Current: 0 pieces"},{"id":"29e2b21c-dbc6-4413-a5ab-d3a1ce5bacbd","title":"3×2 Patti","description":"Current: 0 pieces"},{"id":"1f1cd3da-c7ee-4872-916c-cab44da7506c","title":"4×2 Wall Plate","description":"Current: 0 pieces"},{"id":"94f16fe4-5312-4bd1-b174-2873ca88c4dc","title":"Bamboo 10ft","description":"Current: 0 pieces"},{"id":"2b1994ba-520c-486b-beee-1ff1d86e6434","title":"Bamboo 8ft","description":"Current: 0 pieces"},{"id":"1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b","title":"Cutter Machine 14inch","description":"Current: 0 pieces"},{"id":"2b32a356-da26-4a2b-9910-9295dac0ab38","title":"Jack Prop 2.2m","description":"Current: 0 pieces"},{"id":"3ca71332-9823-4d78-952f-5cd369149cd0","title":"Jack Prop 2.3m","description":"Current: 0 pieces"},{"id":"8626aa37-0ab4-4b9d-8862-56bceb0749c1","title":"Ply Cutter 5inch","description":"Current: 0 pieces"},{"id":"1829a2c5-856a-474e-9b51-7ace991cdfb5","title":"Ply Cutter 7inch","description":"Current: 0 pieces"},{"id":"4f7a4312-cc6b-4ad3-ad3e-2b781f6eb503","title":"Ring Machine 12mm","description":"Current: 0 pieces"},{"id":"095ad5b0-21b4-4c55-bd44-4731b7318b07","title":"Ring Machine 8mm","description":"Current: 0 pieces"},{"id":"88281be5-16fe-4daa-b7f8-100495da29ae","title":"Scaffolding Plate 3ft...","description":"Current: 0 pieces"},{"id":"0fc34ab9-6eaf-432f-a3aa-2fc318f9cdda","title":"Scaffolding Plate 3ft...","description":"Current: 0 pieces"},{"id":"a6b32973-d856-42b3-a5ca-84ba99f0e9f2","title":"Scaffolding Plate 3ft...","description":"Current: 0 pieces"},{"id":"290c6263-960e-41a2-b3d8-3902967a28e9","title":"Scaffolding Plate 3ft...","description":"Current: 0 pieces"},{"id":"2f0e1580-db4e-4be4-b8a3-325d39d13972","title":"Sikanja 2.5ft","description":"Current: 0 pieces"},{"id":"96f910fc-f0d5-4289-81df-6041626d8f2a","title":"Sikanja 2ft","description":"Current: 0 pieces"},{"id":"2a7d9518-503e-4860-87ad-a48849d8882c","title":"Sikanja 3ft","description":"Current: 0 pieces"}]}]}}}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '2315',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 2315\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/652783161256584/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T14:56:51.024Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdFMzU5NkE1MURERkNBQkRCNwA=',
  timestamp: '1750085809'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTdFMzU5NkE1MURERkNBQkRCNwA=",
  "timestamp": "1750085809",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: item_in_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  sessionData: {
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd',
    category: 'contractor_materials'
  }
}
📦 [INVENTORY] Processing step: item_in_select with message: exit interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting inventory management..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNDhDQjRFRTQ3ODRFQTFCOUIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:56:54.323Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:56:55.613Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:56:55.768Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:15.277Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThGN0MzMEE2Nzc5RTc0MjQ4RAA=',
  timestamp: '1750085834'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQThGN0MzMEE2Nzc5RTc0MjQ4RAA=",
  "timestamp": "1750085834",
  "text": {
    "body": "hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'hi',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5Q0ExQ0NFQjFGMEM1RTBBQTQA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:57:17.654Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:57:18.183Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:18.426Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MzA0QzkwODg0RTU4N0ZDMTYA'
    }
  ]
}
2025-06-16T14:57:19.786Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:20.184Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:20.208Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:25.516Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTU3M0NCNkJEQTc0QUZDNkE3OQA=',
  timestamp: '1750085844'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MzA0QzkwODg0RTU4N0ZDMTYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTU3M0NCNkJEQTc0QUZDNkE3OQA=",
  "timestamp": "1750085844",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0MzVBMDI2OTI0N0I2Qjk2NDYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:57:27.841Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: null with message:  interactiveData: undefined
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T14:57:28.323Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:28.422Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDNDRCMDk0OTk1QTJEMEREQjQA'
    }
  ]
}
2025-06-16T14:57:29.784Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGM0ExRjdFQ0UwQUZBNDU3REIA'
    }
  ]
}
2025-06-16T14:57:31.092Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:31.096Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:31.662Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:32.273Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:32.276Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:40.552Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUFGMTlFNjZBODMyREEwQzE3QQA=',
  timestamp: '1750085859'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGM0ExRjdFQ0UwQUZBNDU3REIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUFGMTlFNjZBODMyREEwQzE3QQA=",
  "timestamp": "1750085859",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "setup_comprehensive_inventory",
      "title": "🚀 Setup Inventory",
      "description": "Add all category items with 0 stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "setup_comprehensive_inventory"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'setup_comprehensive_inventory',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'setup_comprehensive_inventory',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'setup_comprehensive_inventory',
      title: '🚀 Setup Inventory',
      description: 'Add all category items with 0 stock'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: setup_comprehensive_inventory interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'setup_comprehensive_inventory',
    title: '🚀 Setup Inventory',
    description: 'Add all category items with 0 stock'
  }
}
📦 [INVENTORY] Handling main menu selection: setup_comprehensive_inventory interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'setup_comprehensive_inventory',
    title: '🚀 Setup Inventory',
    description: 'Add all category items with 0 stock'
  }
}
📦 [INVENTORY] Setting up comprehensive inventory
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🚀 Creating comprehensive inventory with all categories...\n\n🛠️ Contractor Materials\n🏗️ Building Materials\n⚡ Electrical Materials\n\nPlease wait..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MEUyREJCRTJEMzAzN0I5QUYA'
    }
  ]
}
2025-06-16T14:57:43.177Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:43.577Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:43.811Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ *Comprehensive Inventory Setup Complete!*\n\n📦 Created: 0 new items\n⏭️ Skipped: 104 existing items\n\n*Items by Category:*\n🛠️ Contractor Materials: 19 items\n🏗️ Building Materials: 33 items\n⚡ Electrical Materials: 52 items\n\n*Key Features:*\n• All items start with 0 stock\n• Properly categorized for easy selection\n• Ready for Item In/Out operations\n• Complete with appropriate units\n\n🎉 Your inventory system is now fully equipped!\n\n*Next Steps:*\n1️⃣ Use \"Item In\" to add stock\n2️⃣ Select category to see filtered items\n3️⃣ Choose item and enter quantity"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJDQzA5NzcyNjI2NUIyMzY0OTUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:57:51.035Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:51.430Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:51.523Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: undefined
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5NDFFMUQ0Q0I5NzkzQ0M0ODUA'
    }
  ]
}
2025-06-16T14:57:55.871Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T14:57:56.419Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:56.602Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBQjhCNzVCMjFDNDE4RTg3MEIA'
    }
  ]
}
2025-06-16T14:57:57.872Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:58.201Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:57:58.363Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:58:01.502Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg5NDFDNjg4MzMzQTEyRjgwMQA=',
  timestamp: '1750085880'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5NDFFMUQ0Q0I5NzkzQ0M0ODUA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg5NDFDNjg4MzMzQTEyRjgwMQA=",
  "timestamp": "1750085880",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'item_in', title: '📦 Item In' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Handling main menu selection: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Starting Item In flow with category selection
📦 [INVENTORY] Showing category selection for action: item_in user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending category selection list with action text: add stock to
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Select Inventory Category*\n\nWhich type of inventory do you want to add stock to?"
    },
    "action": {
      "button": "Select Category",
      "sections": [
        {
          "title": "Inventory Categories",
          "rows": [
            {
              "id": "building_material",
              "title": "🏗️ Building Material",
              "description": "Cement, Steel, Bricks, Sand, etc."
            },
            {
              "id": "contractor_materials",
              "title": "🛠️ Contractor Materials",
              "description": "Scaffolding, Props, Tools, etc."
            },
            {
              "id": "electrical_materials",
              "title": "⚡ Electrical Materials",
              "description": "Wires, Switches, MCBs, etc."
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0MzAwNEUwRTZEMkFDQkFFRTEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T14:58:03.915Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:58:04.325Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:58:04.404Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T14:58:11.513Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY0MkRGODg4MkM3QkQyNDJEMQA=',
  timestamp: '1750085890'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0MzAwNEUwRTZEMkFDQkFFRTEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUY0MkRGODg4MkM3QkQyNDJEMQA=",
  "timestamp": "1750085890",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "contractor_materials",
      "title": "🛠️ Contractor Materials",
      "description": "Scaffolding, Props, Tools, etc."
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "contractor_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: category_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'contractor_materials',
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'contractor_materials',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'contractor_materials',
      title: '🛠️ Contractor Materials',
      description: 'Scaffolding, Props, Tools, etc.'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  sessionData: {
    action: 'item_in',
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd'
  }
}
📦 [INVENTORY] Processing step: category_select with message: contractor_materials interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'contractor_materials',
    title: '🛠️ Contractor Materials',
    description: 'Scaffolding, Props, Tools, etc.'
  }
}
📦 [INVENTORY] Category selected: contractor_materials for action: item_in
📦 [INVENTORY] Starting Item In flow for category: contractor_materials
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Contractor Materials - Item In*\n\nSelect item to add stock:\n📄 Page 1 of 3 (19 total items)"
    },
    "action": {
      "button": "Select Item",
      "sections": [
        {
          "title": "Contractor Materials Items",
          "rows": [
            {
              "id": "25184a1e-8844-4062-82f6-f58438ba4525",
              "title": "3×1.5 Patti",
              "description": "Current: 0 pieces"
            },
            {
              "id": "29e2b21c-dbc6-4413-a5ab-d3a1ce5bacbd",
              "title": "3×2 Patti",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1f1cd3da-c7ee-4872-916c-cab44da7506c",
              "title": "4×2 Wall Plate",
              "description": "Current: 0 pieces"
            },
            {
              "id": "94f16fe4-5312-4bd1-b174-2873ca88c4dc",
              "title": "Bamboo 10ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "2b1994ba-520c-486b-beee-1ff1d86e6434",
              "title": "Bamboo 8ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b",
              "title": "Cutter Machine 14inch",
              "description": "Current: 0 pieces"
            },
            {
              "id": "2b32a356-da26-4a2b-9910-9295dac0ab38",
              "title": "Jack Prop 2.2m",
              "description": "Current: 0 pieces"
            },
            {
              "id": "3ca71332-9823-4d78-952f-5cd369149cd0",
              "title": "Jack Prop 2.3m",
              "description": "Current: 0 pieces"
            },
            {
              "id": "next_page_2",
              "title": "▶️ Next",
              "description": "Page 2 of 3"
            }
          ]
        }
      ]
    }
  }
}
❌ Failed to send message:
Status: 400
Error data: {
  error: {
    message: '(#131009) Parameter value is not valid',
    type: 'OAuthException',
    code: 131009,
    error_data: {
      messaging_product: 'whatsapp',
      details: 'Section title is too long. Max length is 24'
    },
    fbtrace_id: 'AlpBoHttlqSBcBhTKht77zv'
  }
}
Error message: Request failed with status code 400
Error sending list message: AxiosError: Request failed with status code 400
    at settle (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:2049:12)
    at BrotliDecompress.handleStreamEnd (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:3166:11)
    at BrotliDecompress.emit (node:events:531:35)
    at endReadableNT (node:internal/streams/readable:1696:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21)
    at Axios.request (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/axios/dist/node/axios.cjs:4276:41)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async WhatsAppService.sendMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:200:30)
    at async WhatsAppService.sendListMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/whatsapp.js:82:13)
    at async InventoryFlow.showItemListWithPagination (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:1344:9)
    at async InventoryFlow.startItemInWithCategory (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:1260:13)
    at async InventoryFlow.handleCategorySelection (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:273:17)
    at async InventoryFlow.handleInventoryFlow (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:94:13)
    at async InventoryFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/inventoryFlow.js:63:13)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:70:13) {
  code: 'ERR_BAD_REQUEST',
  config: {
    transitional: {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    },
    adapter: [ 'xhr', 'http', 'fetch' ],
    transformRequest: [ [Function: transformRequest] ],
    transformResponse: [ [Function: transformResponse] ],
    timeout: 0,
    xsrfCookieName: 'XSRF-TOKEN',
    xsrfHeaderName: 'X-XSRF-TOKEN',
    maxContentLength: -1,
    maxBodyLength: -1,
    env: { FormData: [Function [FormData]], Blob: [class Blob] },
    validateStatus: [Function: validateStatus],
    headers: Object [AxiosHeaders] {
      Accept: 'application/json, text/plain, */*',
      'Content-Type': 'application/json',
      Authorization: 'Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD',
      'User-Agent': 'axios/1.9.0',
      'Content-Length': '1224',
      'Accept-Encoding': 'gzip, compress, deflate, br'
    },
    method: 'post',
    url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
    data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"📦 *Contractor Materials - Item In*\\n\\nSelect item to add stock:\\n📄 Page 1 of 3 (19 total items)"},"action":{"button":"Select Item","sections":[{"title":"Contractor Materials Items","rows":[{"id":"25184a1e-8844-4062-82f6-f58438ba4525","title":"3×1.5 Patti","description":"Current: 0 pieces"},{"id":"29e2b21c-dbc6-4413-a5ab-d3a1ce5bacbd","title":"3×2 Patti","description":"Current: 0 pieces"},{"id":"1f1cd3da-c7ee-4872-916c-cab44da7506c","title":"4×2 Wall Plate","description":"Current: 0 pieces"},{"id":"94f16fe4-5312-4bd1-b174-2873ca88c4dc","title":"Bamboo 10ft","description":"Current: 0 pieces"},{"id":"2b1994ba-520c-486b-beee-1ff1d86e6434","title":"Bamboo 8ft","description":"Current: 0 pieces"},{"id":"1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b","title":"Cutter Machine 14inch","description":"Current: 0 pieces"},{"id":"2b32a356-da26-4a2b-9910-9295dac0ab38","title":"Jack Prop 2.2m","description":"Current: 0 pieces"},{"id":"3ca71332-9823-4d78-952f-5cd369149cd0","title":"Jack Prop 2.3m","description":"Current: 0 pieces"},{"id":"next_page_2","title":"▶️ Next","description":"Page 2 of 3"}]}]}}}',
    allowAbsoluteUrls: true
  },
  request: <ref *1> ClientRequest {
    _events: [Object: null prototype] {
      abort: [Function (anonymous)],
      aborted: [Function (anonymous)],
      connect: [Function (anonymous)],
      error: [Function (anonymous)],
      socket: [Function (anonymous)],
      timeout: [Function (anonymous)],
      finish: [Function: requestOnFinish]
    },
    _eventsCount: 7,
    _maxListeners: undefined,
    outputData: [],
    outputSize: 0,
    writable: true,
    destroyed: true,
    _last: false,
    chunkedEncoding: false,
    shouldKeepAlive: true,
    maxRequestsOnConnectionReached: false,
    _defaultKeepAlive: true,
    useChunkedEncodingByDefault: true,
    sendDate: false,
    _removedConnection: false,
    _removedContLen: false,
    _removedTE: false,
    strictContentLength: false,
    _contentLength: '1224',
    _hasBody: true,
    _trailer: '',
    finished: true,
    _headerSent: true,
    _closed: true,
    socket: TLSSocket {
      _tlsOptions: [Object],
      _secureEstablished: true,
      _securePending: false,
      _newSessionPending: false,
      _controlReleased: true,
      secureConnecting: false,
      _SNICallback: null,
      servername: 'graph.facebook.com',
      alpnProtocol: false,
      authorized: true,
      authorizationError: null,
      encrypted: true,
      _events: [Object: null prototype],
      _eventsCount: 9,
      connecting: false,
      _hadError: false,
      _parent: null,
      _host: 'graph.facebook.com',
      _closeAfterHandlingError: false,
      _readableState: [ReadableState],
      _writableState: [WritableState],
      allowHalfOpen: false,
      _maxListeners: undefined,
      _sockname: null,
      _pendingData: null,
      _pendingEncoding: '',
      server: undefined,
      _server: null,
      ssl: [TLSWrap],
      _requestCert: true,
      _rejectUnauthorized: true,
      timeout: 5000,
      parser: null,
      _httpMessage: null,
      autoSelectFamilyAttemptedAddresses: [Array],
      [Symbol(alpncallback)]: null,
      [Symbol(res)]: [TLSWrap],
      [Symbol(verified)]: true,
      [Symbol(pendingSession)]: null,
      [Symbol(async_id_symbol)]: -1,
      [Symbol(kHandle)]: [TLSWrap],
      [Symbol(lastWriteQueueSize)]: 0,
      [Symbol(timeout)]: Timeout {
        _idleTimeout: 5000,
        _idlePrev: [TimersList],
        _idleNext: [Timeout],
        _idleStart: 291618,
        _onTimeout: [Function: bound ],
        _timerArgs: undefined,
        _repeat: null,
        _destroyed: false,
        [Symbol(refed)]: false,
        [Symbol(kHasPrimitive)]: false,
        [Symbol(asyncId)]: 1617,
        [Symbol(triggerId)]: 1615
      },
      [Symbol(kBuffer)]: null,
      [Symbol(kBufferCb)]: null,
      [Symbol(kBufferGen)]: null,
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kSetNoDelay)]: false,
      [Symbol(kSetKeepAlive)]: true,
      [Symbol(kSetKeepAliveInitialDelay)]: 1,
      [Symbol(kBytesRead)]: 0,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(connect-options)]: [Object]
    },
    _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
      'Accept: application/json, text/plain, */*\r\n' +
      'Content-Type: application/json\r\n' +
      'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
      'User-Agent: axios/1.9.0\r\n' +
      'Content-Length: 1224\r\n' +
      'Accept-Encoding: gzip, compress, deflate, br\r\n' +
      'Host: graph.facebook.com\r\n' +
      'Connection: keep-alive\r\n' +
      '\r\n',
    _keepAliveTimeout: 0,
    _onPendingData: [Function: nop],
    agent: Agent {
      _events: [Object: null prototype],
      _eventsCount: 2,
      _maxListeners: undefined,
      defaultPort: 443,
      protocol: 'https:',
      options: [Object: null prototype],
      requests: [Object: null prototype] {},
      sockets: [Object: null prototype] {},
      freeSockets: [Object: null prototype],
      keepAliveMsecs: 1000,
      keepAlive: true,
      maxSockets: Infinity,
      maxFreeSockets: 256,
      scheduling: 'lifo',
      maxTotalSockets: Infinity,
      totalSocketCount: 1,
      maxCachedSessions: 100,
      _sessionCache: [Object],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false
    },
    socketPath: undefined,
    method: 'POST',
    maxHeaderSize: undefined,
    insecureHTTPParser: undefined,
    joinDuplicateHeaders: undefined,
    path: '/v18.0/652783161256584/messages',
    _ended: true,
    res: IncomingMessage {
      _events: [Object],
      _readableState: [ReadableState],
      _maxListeners: undefined,
      socket: null,
      httpVersionMajor: 1,
      httpVersionMinor: 1,
      httpVersion: '1.1',
      complete: true,
      rawHeaders: [Array],
      rawTrailers: [],
      joinDuplicateHeaders: undefined,
      aborted: false,
      upgrade: false,
      url: '',
      method: null,
      statusCode: 400,
      statusMessage: 'Bad Request',
      client: [TLSSocket],
      _consuming: false,
      _dumped: false,
      req: [Circular *1],
      _eventsCount: 4,
      responseUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      redirects: [],
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false,
      [Symbol(kHeaders)]: [Object],
      [Symbol(kHeadersCount)]: 48,
      [Symbol(kTrailers)]: null,
      [Symbol(kTrailersCount)]: 0
    },
    aborted: false,
    timeoutCb: null,
    upgradeOrConnect: false,
    parser: null,
    maxHeadersCount: null,
    reusedSocket: true,
    host: 'graph.facebook.com',
    protocol: 'https:',
    _redirectable: Writable {
      _events: [Object],
      _writableState: [WritableState],
      _maxListeners: undefined,
      _options: [Object],
      _ended: true,
      _ending: true,
      _redirectCount: 0,
      _redirects: [],
      _requestBodyLength: 1224,
      _requestBodyBuffers: [],
      _eventsCount: 3,
      _onNativeResponse: [Function (anonymous)],
      _currentRequest: [Circular *1],
      _currentUrl: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      [Symbol(shapeMode)]: true,
      [Symbol(kCapture)]: false
    },
    [Symbol(shapeMode)]: false,
    [Symbol(kCapture)]: false,
    [Symbol(kBytesWritten)]: 0,
    [Symbol(kNeedDrain)]: false,
    [Symbol(corked)]: 0,
    [Symbol(kOutHeaders)]: [Object: null prototype] {
      accept: [Array],
      'content-type': [Array],
      authorization: [Array],
      'user-agent': [Array],
      'content-length': [Array],
      'accept-encoding': [Array],
      host: [Array]
    },
    [Symbol(errored)]: null,
    [Symbol(kHighWaterMark)]: 16384,
    [Symbol(kRejectNonStandardBodyWrites)]: false,
    [Symbol(kUniqueHeaders)]: null
  },
  response: {
    status: 400,
    statusText: 'Bad Request',
    headers: Object [AxiosHeaders] {
      'error-mid': '671bbc46a9f7157bb91fc2d9ba1f3251',
      vary: 'Origin, Accept-Encoding',
      'x-ad-api-version-warning': 'The call has been auto-upgraded to v23.0 as v18.0 has been deprecated.',
      'x-business-use-case-usage': '{"1224110766092562":[{"type":"whatsapp","call_count":1,"total_cputime":1,"total_time":1,"estimated_time_to_regain_access":0}]}',
      'content-type': 'application/json',
      'www-authenticate': 'OAuth "Facebook Platform" "invalid_request" "(#131009) Parameter value is not valid"',
      'access-control-allow-origin': '*',
      'facebook-api-version': 'v23.0',
      'strict-transport-security': 'max-age=15552000; preload',
      pragma: 'no-cache',
      'cache-control': 'no-store',
      expires: 'Sat, 01 Jan 2000 00:00:00 GMT',
      'x-fb-request-id': 'AlpBoHttlqSBcBhTKht77zv',
      'x-fb-trace-id': 'GuGOxnwNuvV',
      'x-fb-rev': '1023869344',
      'x-fb-debug': 'NlBdp2KfdwUozH9fZGNdxYtIQlLqojpMHTq7ue9vjoWB9FbY9NSkG/kxh7JJftTPKggUgGbPtSUffzHb0c4bSw==',
      date: 'Mon, 16 Jun 2025 14:58:13 GMT',
      'proxy-status': 'http_request_error; e_fb_vipaddr="AcOAmdcpSB_d746w4_pvwKsh_Xqe8HDTnJI8RFYHzVG4KxFrtm4_n_LZJ7IgaDXxFTZdYqdeUblgfgi-HOMTwVPIHpmPetfh"; e_clientaddr="AcPJSRJ7TxlIRjtKqCyGcBN-ESTT6OTAXMUfr7cEWMkKnzgIiicfVofkEF1T8zLBqk31x1bU9Azs8a96GukgNt-44EdxXhfgwO42ziMqj28FmQ5JJA"; e_upip="AcPwq4sQKG-44J268eR7IhhC_Mp7qz8SxQChrjlm2R-vo3edhd9BLsdZ52tFidI51XGoqy-Y_X6GNtCxXsIA4G9L_87LS180qWYxfm4"; e_fb_zone="AcMG1lRVyS_fG2bBp9sHok1SFKe7CQhHhhn1cLKIpl-GcPUZqKN7zNnStjbqeS0J"; e_fb_twtaskhandle="AcPGpmuggI8hGp_CUMy2O6acvn0wXva2RPlb598nGfOQk4Qb_05j5Zsa4cF6SaRsHxTBCxYrKtziPpVMFaO04CN5VVpMKDAn5EF0bFIL5JzeN7Q"; e_proxy="AcOswr2qSdNeMXA5fHT43mHahw5uR7mQrOqhcR-ZEVMe_00rBCoHXCBoV1B1VS4EYliz5ToFpfPPPLrLX86Y", http_request_error; e_fb_vipaddr="AcMPUXnihGrZk3ezF8gFkFaiSpo07BzklS3_8PJVtJLqJh8Lm3WpTCdfOZncy1Gn3r3gTh9Nzopz4esTGFtYcs3TMoRHIFnD"; e_clientaddr="AcPijN6YKrsD9N3LuyQToiNNeNv7ifZWGkrO_pVS_XhDyLrScywjSD39giRfn41C9Io2UEjDFnSulDPcdslvV-uLGolocfrRTpsvg7vWRsCuip-peacJbQ"; e_upip="AcOQZldYf94_eFYe0v-Xib48EYA2-JblZjKZXhe-swR8gbwWpsvBS8Ps-s23_xAG5W_zdgtmfg86i8W1FZpf4E5rqZw0c9lu"; e_fb_zone="AcPE_etk77i1bGf0wwMxud0xTOIIZh_6DxPzhsyyZ0NGgYZiwqWEXCZq-kkfBQ"; e_fb_twtaskhandle="AcPZ9B7d25moU_OJcY5fUuczRbZuWXQYX4BA837YWF5Bb2npBWqH8j2XT1LDsn5WN4N4jg75X9RQamxX9ZPhN12gWdPBt1nsQr4"; e_proxy="AcMu2w27ImHZiaUIPRB39PY8E-xg9l7_eWT5qc7XkUmKl1mRQw5itr56s7Kppo0DzQ_pWjlr4SAOGfw"',
      'x-fb-connection-quality': 'EXCELLENT; q=0.9, rtt=46, rtx=0, c=10, mss=1380, tbw=1385, tp=-1, tpl=-1, uplat=405, ullat=0',
      'alt-svc': 'h3=":443"; ma=86400',
      connection: 'keep-alive',
      'content-length': '186'
    },
    config: {
      transitional: [Object],
      adapter: [Array],
      transformRequest: [Array],
      transformResponse: [Array],
      timeout: 0,
      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',
      maxContentLength: -1,
      maxBodyLength: -1,
      env: [Object],
      validateStatus: [Function: validateStatus],
      headers: [Object [AxiosHeaders]],
      method: 'post',
      url: 'https://graph.facebook.com/v18.0/652783161256584/messages',
      data: '{"messaging_product":"whatsapp","to":"+19088483575","type":"interactive","interactive":{"type":"list","body":{"text":"📦 *Contractor Materials - Item In*\\n\\nSelect item to add stock:\\n📄 Page 1 of 3 (19 total items)"},"action":{"button":"Select Item","sections":[{"title":"Contractor Materials Items","rows":[{"id":"25184a1e-8844-4062-82f6-f58438ba4525","title":"3×1.5 Patti","description":"Current: 0 pieces"},{"id":"29e2b21c-dbc6-4413-a5ab-d3a1ce5bacbd","title":"3×2 Patti","description":"Current: 0 pieces"},{"id":"1f1cd3da-c7ee-4872-916c-cab44da7506c","title":"4×2 Wall Plate","description":"Current: 0 pieces"},{"id":"94f16fe4-5312-4bd1-b174-2873ca88c4dc","title":"Bamboo 10ft","description":"Current: 0 pieces"},{"id":"2b1994ba-520c-486b-beee-1ff1d86e6434","title":"Bamboo 8ft","description":"Current: 0 pieces"},{"id":"1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b","title":"Cutter Machine 14inch","description":"Current: 0 pieces"},{"id":"2b32a356-da26-4a2b-9910-9295dac0ab38","title":"Jack Prop 2.2m","description":"Current: 0 pieces"},{"id":"3ca71332-9823-4d78-952f-5cd369149cd0","title":"Jack Prop 2.3m","description":"Current: 0 pieces"},{"id":"next_page_2","title":"▶️ Next","description":"Page 2 of 3"}]}]}}}',
      allowAbsoluteUrls: true
    },
    request: <ref *1> ClientRequest {
      _events: [Object: null prototype],
      _eventsCount: 7,
      _maxListeners: undefined,
      outputData: [],
      outputSize: 0,
      writable: true,
      destroyed: true,
      _last: false,
      chunkedEncoding: false,
      shouldKeepAlive: true,
      maxRequestsOnConnectionReached: false,
      _defaultKeepAlive: true,
      useChunkedEncodingByDefault: true,
      sendDate: false,
      _removedConnection: false,
      _removedContLen: false,
      _removedTE: false,
      strictContentLength: false,
      _contentLength: '1224',
      _hasBody: true,
      _trailer: '',
      finished: true,
      _headerSent: true,
      _closed: true,
      socket: [TLSSocket],
      _header: 'POST /v18.0/652783161256584/messages HTTP/1.1\r\n' +
        'Accept: application/json, text/plain, */*\r\n' +
        'Content-Type: application/json\r\n' +
        'Authorization: Bearer EAASY8LmFhiYBOZBkadeNtMv31jy9y69dORGLI4cuZAZBTcUYIaZChNbZAQZB62ZA0aS9oEcOkKalnTYMljv1w5VYNzk5wEAdoKMMXvk4lFcdUpnBSfijJ7URe4GcqhtxIX2yg6y03JLU7tIL4zmNVUi9CPBG5zqkruiTmbzKshf9oHZCyJz3CzIXDA4lDQH9ygZDZD\r\n' +
        'User-Agent: axios/1.9.0\r\n' +
        'Content-Length: 1224\r\n' +
        'Accept-Encoding: gzip, compress, deflate, br\r\n' +
        'Host: graph.facebook.com\r\n' +
        'Connection: keep-alive\r\n' +
        '\r\n',
      _keepAliveTimeout: 0,
      _onPendingData: [Function: nop],
      agent: [Agent],
      socketPath: undefined,
      method: 'POST',
      maxHeaderSize: undefined,
      insecureHTTPParser: undefined,
      joinDuplicateHeaders: undefined,
      path: '/v18.0/652783161256584/messages',
      _ended: true,
      res: [IncomingMessage],
      aborted: false,
      timeoutCb: null,
      upgradeOrConnect: false,
      parser: null,
      maxHeadersCount: null,
      reusedSocket: true,
      host: 'graph.facebook.com',
      protocol: 'https:',
      _redirectable: [Writable],
      [Symbol(shapeMode)]: false,
      [Symbol(kCapture)]: false,
      [Symbol(kBytesWritten)]: 0,
      [Symbol(kNeedDrain)]: false,
      [Symbol(corked)]: 0,
      [Symbol(kOutHeaders)]: [Object: null prototype],
      [Symbol(errored)]: null,
      [Symbol(kHighWaterMark)]: 16384,
      [Symbol(kRejectNonStandardBodyWrites)]: false,
      [Symbol(kUniqueHeaders)]: null
    },
    data: { error: [Object] }
  },
  status: 400
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 407 packages in 4s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T15:00:50.801Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUEwNTkyMzdDMDBCQUIyMkI0QwA=',
  timestamp: '1750086049'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUEwNTkyMzdDMDBCQUIyMkI0QwA=",
  "timestamp": "1750086049",
  "text": {
    "body": "exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: item_in_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'exit',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  sessionData: {
    page: 1,
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd',
    category: 'contractor_materials',
    total_items: 19
  }
}
📦 [INVENTORY] Processing step: item_in_select with message: exit interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "🔙 Exiting inventory management..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJFM0Q0NUQzNkIwNkFDNDMzRjEA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T15:00:54.472Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:00:54.550Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:00:54.740Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:17.576Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUzNzA0RDQ0MUM5NUQxNzQwRAA=',
  timestamp: '1750086076'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTUzNzA0RDQ0MUM5NUQxNzQwRAA=",
  "timestamp": "1750086076",
  "text": {
    "body": "hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'hi',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI5RDExMzE4OURERkVEMUI2RDgA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T15:01:20.012Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T15:01:20.424Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:20.590Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyMjdGODVERDEwRTlEOUQ1NkEA'
    }
  ]
}
2025-06-16T15:01:21.833Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:22.347Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:22.380Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:35.445Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ0NUE1MjdCNDQ5Q0MwNUVENgA=',
  timestamp: '1750086094'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIyMjdGODVERDEwRTlEOUQ1NkEA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUQ0NUE1MjdCNDQ5Q0MwNUVENgA=",
  "timestamp": "1750086094",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxNzIyQzBGQzJENjAzMjlCMEUA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T15:01:38.573Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: null with message:  interactiveData: undefined
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T15:01:38.793Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:38.935Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCNDlGNUMyM0U5QjI4NjBFOEMA'
    }
  ]
}
2025-06-16T15:01:40.343Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T15:01:40.770Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:41.266Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJBODQ0QzQxMEFCQTQ1OEFBNkUA'
    }
  ]
}
2025-06-16T15:01:42.429Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:42.741Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:42.939Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:45.763Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUVFNkVBQjI5NzY3NzMxMkMwNQA=',
  timestamp: '1750086105'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBJCNDlGNUMyM0U5QjI4NjBFOEMA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUVFNkVBQjI5NzY3NzMxMkMwNQA=",
  "timestamp": "1750086105",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'item_in',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'item_in', title: '📦 Item In' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
}
📦 [INVENTORY] Processing step: main_menu with message: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Handling main menu selection: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Starting Item In flow with category selection
📦 [INVENTORY] Showing category selection for action: item_in user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
📦 [INVENTORY] Sending category selection list with action text: add stock to
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Select Inventory Category*\n\nWhich type of inventory do you want to add stock to?"
    },
    "action": {
      "button": "Select Category",
      "sections": [
        {
          "title": "Inventory Categories",
          "rows": [
            {
              "id": "building_material",
              "title": "🏗️ Building Material",
              "description": "Cement, Steel, Bricks, Sand, etc."
            },
            {
              "id": "contractor_materials",
              "title": "🛠️ Contractor Materials",
              "description": "Scaffolding, Props, Tools, etc."
            },
            {
              "id": "electrical_materials",
              "title": "⚡ Electrical Materials",
              "description": "Wires, Switches, MCBs, etc."
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwQjJDRkQ2RjYwRTM4NENCMjAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T15:01:48.220Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:48.805Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:48.843Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:54.215Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUUwM0NCNEVFNDk5NkU1RjQwOAA=',
  timestamp: '1750086113'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIwQjJDRkQ2RjYwRTM4NENCMjAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUUwM0NCNEVFNDk5NkU1RjQwOAA=",
  "timestamp": "1750086113",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "contractor_materials",
      "title": "🛠️ Contractor Materials",
      "description": "Scaffolding, Props, Tools, etc."
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "contractor_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: category_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'contractor_materials',
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'contractor_materials',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'contractor_materials',
      title: '🛠️ Contractor Materials',
      description: 'Scaffolding, Props, Tools, etc.'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  sessionData: {
    action: 'item_in',
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd'
  }
}
📦 [INVENTORY] Processing step: category_select with message: contractor_materials interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'contractor_materials',
    title: '🛠️ Contractor Materials',
    description: 'Scaffolding, Props, Tools, etc.'
  }
}
📦 [INVENTORY] Category selected: contractor_materials for action: item_in
📦 [INVENTORY] Starting Item In flow for category: contractor_materials
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Contractor Materials - Item In*\n\nSelect item to add stock:\n📄 Page 1 of 3 (19 total items)"
    },
    "action": {
      "button": "Select Item",
      "sections": [
        {
          "title": "Contractor Items",
          "rows": [
            {
              "id": "25184a1e-8844-4062-82f6-f58438ba4525",
              "title": "3×1.5 Patti",
              "description": "Current: 0 pieces"
            },
            {
              "id": "29e2b21c-dbc6-4413-a5ab-d3a1ce5bacbd",
              "title": "3×2 Patti",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1f1cd3da-c7ee-4872-916c-cab44da7506c",
              "title": "4×2 Wall Plate",
              "description": "Current: 0 pieces"
            },
            {
              "id": "94f16fe4-5312-4bd1-b174-2873ca88c4dc",
              "title": "Bamboo 10ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "2b1994ba-520c-486b-beee-1ff1d86e6434",
              "title": "Bamboo 8ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b",
              "title": "Cutter Machine 14inch",
              "description": "Current: 0 pieces"
            },
            {
              "id": "2b32a356-da26-4a2b-9910-9295dac0ab38",
              "title": "Jack Prop 2.2m",
              "description": "Current: 0 pieces"
            },
            {
              "id": "3ca71332-9823-4d78-952f-5cd369149cd0",
              "title": "Jack Prop 2.3m",
              "description": "Current: 0 pieces"
            },
            {
              "id": "next_page_2",
              "title": "▶️ Next",
              "description": "Page 2 of 3"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4MEI2RkM4NjlDNjUxRTNEOEYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T15:01:56.977Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:57.428Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:01:57.484Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:02:59.037Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg2OUZEN0Y0Qzk5QTNFQzM2QwA=',
  timestamp: '1750086178'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI4MEI2RkM4NjlDNjUxRTNEOEYA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTg2OUZEN0Y0Qzk5QTNFQzM2QwA=",
  "timestamp": "1750086178",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "next_page_2",
      "title": "▶️ Next",
      "description": "Page 2 of 3"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "next_page_2"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: item_in_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'next_page_2',
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'next_page_2',
  interactiveData: {
    type: 'list_reply',
    list_reply: { id: 'next_page_2', title: '▶️ Next', description: 'Page 2 of 3' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  sessionData: {
    page: 1,
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd',
    category: 'contractor_materials',
    total_items: 19
  }
}
📦 [INVENTORY] Processing step: item_in_select with message: next_page_2 interactiveData: {
  type: 'list_reply',
  list_reply: { id: 'next_page_2', title: '▶️ Next', description: 'Page 2 of 3' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Contractor Materials - Item In*\n\nSelect item to add stock:\n📄 Page 2 of 3 (19 total items)"
    },
    "action": {
      "button": "Select Item",
      "sections": [
        {
          "title": "Contractor Items",
          "rows": [
            {
              "id": "8626aa37-0ab4-4b9d-8862-56bceb0749c1",
              "title": "Ply Cutter 5inch",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1829a2c5-856a-474e-9b51-7ace991cdfb5",
              "title": "Ply Cutter 7inch",
              "description": "Current: 0 pieces"
            },
            {
              "id": "4f7a4312-cc6b-4ad3-ad3e-2b781f6eb503",
              "title": "Ring Machine 12mm",
              "description": "Current: 0 pieces"
            },
            {
              "id": "095ad5b0-21b4-4c55-bd44-4731b7318b07",
              "title": "Ring Machine 8mm",
              "description": "Current: 0 pieces"
            },
            {
              "id": "88281be5-16fe-4daa-b7f8-100495da29ae",
              "title": "Scaffolding Plate 3ft...",
              "description": "Current: 0 pieces"
            },
            {
              "id": "0fc34ab9-6eaf-432f-a3aa-2fc318f9cdda",
              "title": "Scaffolding Plate 3ft...",
              "description": "Current: 0 pieces"
            },
            {
              "id": "a6b32973-d856-42b3-a5ca-84ba99f0e9f2",
              "title": "Scaffolding Plate 3ft...",
              "description": "Current: 0 pieces"
            },
            {
              "id": "290c6263-960e-41a2-b3d8-3902967a28e9",
              "title": "Scaffolding Plate 3ft...",
              "description": "Current: 0 pieces"
            },
            {
              "id": "prev_page_1",
              "title": "◀️ Previous",
              "description": "Page 1 of 3"
            },
            {
              "id": "next_page_3",
              "title": "▶️ Next",
              "description": "Page 3 of 3"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxRDgzNDc5NDE2NTlEOTBBMzAA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T15:03:02.085Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:02.450Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:02.492Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:08.558Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY5N0U5Qzk5QzJFRkMwRjM4RAA=',
  timestamp: '1750086187'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBIxRDgzNDc5NDE2NTlEOTBBMzAA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTY5N0U5Qzk5QzJFRkMwRjM4RAA=",
  "timestamp": "1750086187",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "next_page_3",
      "title": "▶️ Next",
      "description": "Page 3 of 3"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "next_page_3"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: item_in_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'next_page_3',
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: 'next_page_3',
  interactiveData: {
    type: 'list_reply',
    list_reply: { id: 'next_page_3', title: '▶️ Next', description: 'Page 3 of 3' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  sessionData: {
    page: 2,
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd',
    category: 'contractor_materials',
    total_items: 19
  }
}
📦 [INVENTORY] Processing step: item_in_select with message: next_page_3 interactiveData: {
  type: 'list_reply',
  list_reply: { id: 'next_page_3', title: '▶️ Next', description: 'Page 3 of 3' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Contractor Materials - Item In*\n\nSelect item to add stock:\n📄 Page 3 of 3 (19 total items)"
    },
    "action": {
      "button": "Select Item",
      "sections": [
        {
          "title": "Contractor Items",
          "rows": [
            {
              "id": "2f0e1580-db4e-4be4-b8a3-325d39d13972",
              "title": "Sikanja 2.5ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "96f910fc-f0d5-4289-81df-6041626d8f2a",
              "title": "Sikanja 2ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "2a7d9518-503e-4860-87ad-a48849d8882c",
              "title": "Sikanja 3ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "prev_page_2",
              "title": "◀️ Previous",
              "description": "Page 2 of 3"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NzNFNTc2MkFFMDREM0M5RkIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T15:03:11.222Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:11.443Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:11.545Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:20.246Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'interactive',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUUyMkM2RDIyNzdFRjkzMkFEMQA=',
  timestamp: '1750086199'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3NzNFNTc2MkFFMDREM0M5RkIA"
  },
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUUyMkM2RDIyNzdFRjkzMkFEMQA=",
  "timestamp": "1750086199",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "2a7d9518-503e-4860-87ad-a48849d8882c",
      "title": "Sikanja 3ft",
      "description": "Current: 0 pieces"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "2a7d9518-503e-4860-87ad-a48849d8882c"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: item_in_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '2a7d9518-503e-4860-87ad-a48849d8882c',
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '2a7d9518-503e-4860-87ad-a48849d8882c',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: '2a7d9518-503e-4860-87ad-a48849d8882c',
      title: 'Sikanja 3ft',
      description: 'Current: 0 pieces'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  sessionData: {
    page: 3,
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd',
    category: 'contractor_materials',
    total_items: 19
  }
}
📦 [INVENTORY] Processing step: item_in_select with message: 2a7d9518-503e-4860-87ad-a48849d8882c interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: '2a7d9518-503e-4860-87ad-a48849d8882c',
    title: 'Sikanja 3ft',
    description: 'Current: 0 pieces'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "📦 *Adding stock for: Sikanja 3ft*\n\nCurrent Stock: 0 pieces\n\nEnter the quantity to add:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJERDBBNkRGQkE2Q0JGQ0M1MDIA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T15:03:22.925Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:23.311Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:23.677Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:32.213Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +19088483575: {
  type: 'text',
  id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUUyQkJFMUI2MkQ1RDY3NjVCMwA=',
  timestamp: '1750086211'
}
[WEBHOOK] Message content: {
  "from": "19088483575",
  "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQUUyQkJFMUI2MkQ1RDY3NjVCMwA=",
  "timestamp": "1750086211",
  "text": {
    "body": "10"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +19088483575
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +19088483575
💬 [HANDLER] Message: "10"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: item_in_quantity
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '10',
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_quantity',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+19088483575',
  messageText: '10',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_quantity',
  sessionData: {
    user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd',
    category: 'contractor_materials',
    selected_item: {
      id: '2a7d9518-503e-4860-87ad-a48849d8882c',
      name: 'Sikanja 3ft',
      unit: 'pieces',
      status: 'active',
      site_id: null,
      category: 'contractor_materials',
      created_at: '2025-06-16T14:47:18.651Z',
      created_by: null,
      updated_at: '2025-06-16T14:47:18.651Z',
      current_stock: 0
    }
  }
}
📦 [INVENTORY] Processing step: item_in_quantity with message: 10 interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "text",
  "text": {
    "body": "✅ *Stock Added Successfully!*\n\nItem: Sikanja 3ft\nAdded: 10 pieces\nPrevious Stock: 0 pieces\nNew Stock: 10 pieces\n\nTransaction recorded at 6/16/2025, 10:03:33 AM"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3MENGNzUzNjY1RjEyQzgyQUYA'
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T15:03:34.839Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:35.415Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:35.674Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: undefined
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0REMzREZCODk4QUJGNjUxMEIA'
    }
  ]
}
2025-06-16T15:03:37.872Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+19088483575",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T15:03:38.204Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:38.299Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
  messages: [
    {
      id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0REEwMzMzMjI3MjJEQ0YwMzQA'
    }
  ]
}
2025-06-16T15:03:39.616Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:40.406Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T15:03:40.413Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:11:45.031Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRjhENDQzMDVBRjIwMTgzMjlFMzdGMDAxMkJFRjA0RDUA',
  timestamp: '1750090302'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRjhENDQzMDVBRjIwMTgzMjlFMzdGMDAxMkJFRjA0RDUA",
  "timestamp": "1750090302",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: test_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'Hi',
  sessionIntent: 'test_customer',
  sessionStep: 'active',
  isAdminImpersonation: undefined
}
Handling message for +917383489516: { messageText: 'Hi', intent: 'inquiry', step: 'collect_space_use' }
Session updated for +917383489516: {
  step: 'collect_price_range',
  data: {
    email: 'pateljk5216@gmail.com',
    full_name: 'Jay patel',
    occupation: 'Business',
    office_space_requirement: '1000',
    office_space_use: 'Hi'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "Excellent! \nWhat is your *expected price range/budget*? (e.g., ₹50-75 Lakhs, ₹1-2 Crores, etc.)"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMDIyNzdENUExQTczMDhBMjBBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:11:48.630Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:11:49.852Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:11:58.778Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggM0U0Qzc1QTA4MTdEOUVCN0QzNjQxODNDOTY0RDZBRjAA',
  timestamp: '1750090317'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggM0U0Qzc1QTA4MTdEOUVCN0QzNjQxODNDOTY0RDZBRjAA",
  "timestamp": "1750090317",
  "text": {
    "body": "Exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_customer, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'Exit',
  sessionIntent: 'impersonate_customer',
  sessionStep: 'active',
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "🔙 Exiting customer impersonation. Returning to admin panel..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQTMxODkxNkZBMzAzM0RBRTkyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:12:01.420Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
2025-06-16T16:12:01.883Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNzg4NUUxQjgzMDNBNkRGOTFEAA=='
    }
  ]
}
2025-06-16T16:12:03.300Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T16:12:03.908Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMkM4OUUxRjBEQzc3MTNDMDVFAA=='
    }
  ]
}
2025-06-16T16:12:05.153Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:12:05.620Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:12:15.748Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMEI5RDM3MkFGRjQzMzREOTNDRUE4Q0U0Qjk4QjZBQTIA',
  timestamp: '1750090334'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMkM4OUUxRjBEQzc3MTNDMDVFAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMEI5RDM3MkFGRjQzMzREOTNDRUE4Q0U0Qjk4QjZBQTIA",
  "timestamp": "1750090334",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_management",
      "title": "📦 Inventory Management",
      "description": "Manage inventory items and stock"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "inventory_management"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'inventory_management',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting inventory management
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "📦 *Inventory Management*\n\nStarting inventory management system...\nType *exit* anytime to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMkZFRERCRDRFNzM4RTJENEIyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:12:18.889Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: '',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: null,
  sessionData: { user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0' }
}
📦 [INVENTORY] Processing step: null with message:  interactiveData: undefined
📦 [INVENTORY] Showing main menu for phone: +917383489516 user_id: 1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T16:12:19.150Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQ0U5NUVFM0RDN0RBODBDNUJEAA=='
    }
  ]
}
2025-06-16T16:12:20.633Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T16:12:20.968Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSREZCMUVERTFDRDFCREFCRUI1AA=='
    }
  ]
}
2025-06-16T16:12:23.042Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:12:23.387Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:12:31.576Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMDNCNUJFNTYxMDE0QkM1QkI1REE1RkVERjZCNjI4RDEA',
  timestamp: '1750090350'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQ0U5NUVFM0RDN0RBODBDNUJEAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMDNCNUJFNTYxMDE0QkM1QkI1REE1RkVERjZCNjI4RDEA",
  "timestamp": "1750090350",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'item_in',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'item_in', title: '📦 Item In' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0' }
}
📦 [INVENTORY] Processing step: main_menu with message: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Handling main menu selection: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Starting Item In flow with category selection
📦 [INVENTORY] Showing category selection for action: item_in user_id: 1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0
📦 [INVENTORY] Sending category selection list with action text: add stock to
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Select Inventory Category*\n\nWhich type of inventory do you want to add stock to?"
    },
    "action": {
      "button": "Select Category",
      "sections": [
        {
          "title": "Inventory Categories",
          "rows": [
            {
              "id": "building_material",
              "title": "🏗️ Building Material",
              "description": "Cement, Steel, Bricks, Sand, etc."
            },
            {
              "id": "contractor_materials",
              "title": "🛠️ Contractor Materials",
              "description": "Scaffolding, Props, Tools, etc."
            },
            {
              "id": "electrical_materials",
              "title": "⚡ Electrical Materials",
              "description": "Wires, Switches, MCBs, etc."
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQkUzQ0VCRTdEMTQ4Qjk3RDQ4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:12:34.076Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:12:34.495Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:12:34.517Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:12:42.925Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRDYxOURBRDJCN0YwNDQ5OTE4RDkxOTMwQjI2NTU2MkUA',
  timestamp: '1750090362'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQkUzQ0VCRTdEMTQ4Qjk3RDQ4AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRDYxOURBRDJCN0YwNDQ5OTE4RDkxOTMwQjI2NTU2MkUA",
  "timestamp": "1750090362",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "contractor_materials",
      "title": "🛠️ Contractor Materials",
      "description": "Scaffolding, Props, Tools, etc."
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "contractor_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: category_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'contractor_materials',
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'contractor_materials',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'contractor_materials',
      title: '🛠️ Contractor Materials',
      description: 'Scaffolding, Props, Tools, etc.'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  sessionData: {
    action: 'item_in',
    user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0'
  }
}
📦 [INVENTORY] Processing step: category_select with message: contractor_materials interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'contractor_materials',
    title: '🛠️ Contractor Materials',
    description: 'Scaffolding, Props, Tools, etc.'
  }
}
📦 [INVENTORY] Category selected: contractor_materials for action: item_in
📦 [INVENTORY] Starting Item In flow for category: contractor_materials
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Contractor Materials - Item In*\n\nSelect item to add stock:\n📄 Page 1 of 3 (19 total items)"
    },
    "action": {
      "button": "Select Item",
      "sections": [
        {
          "title": "Contractor Items",
          "rows": [
            {
              "id": "25184a1e-8844-4062-82f6-f58438ba4525",
              "title": "3×1.5 Patti",
              "description": "Current: 0 pieces"
            },
            {
              "id": "29e2b21c-dbc6-4413-a5ab-d3a1ce5bacbd",
              "title": "3×2 Patti",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1f1cd3da-c7ee-4872-916c-cab44da7506c",
              "title": "4×2 Wall Plate",
              "description": "Current: 0 pieces"
            },
            {
              "id": "94f16fe4-5312-4bd1-b174-2873ca88c4dc",
              "title": "Bamboo 10ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "2b1994ba-520c-486b-beee-1ff1d86e6434",
              "title": "Bamboo 8ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b",
              "title": "Cutter Machine 14inch",
              "description": "Current: 0 pieces"
            },
            {
              "id": "2b32a356-da26-4a2b-9910-9295dac0ab38",
              "title": "Jack Prop 2.2m",
              "description": "Current: 0 pieces"
            },
            {
              "id": "3ca71332-9823-4d78-952f-5cd369149cd0",
              "title": "Jack Prop 2.3m",
              "description": "Current: 0 pieces"
            },
            {
              "id": "next_page_2",
              "title": "▶️ Next",
              "description": "Page 2 of 3"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNEMzQ0VDMjJDN0VDQjA5NDg0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:12:45.777Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:12:46.231Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:13:02.989Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggOTVFNTc2MTIyQjY4QzUzNkJDMzRCRDk3MTNGNERCRUUA',
  timestamp: '1750090382'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNEMzQ0VDMjJDN0VDQjA5NDg0AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggOTVFNTc2MTIyQjY4QzUzNkJDMzRCRDk3MTNGNERCRUUA",
  "timestamp": "1750090382",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b",
      "title": "Cutter Machine 14inch",
      "description": "Current: 0 pieces"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: item_in_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: '1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b',
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: '1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: '1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b',
      title: 'Cutter Machine 14inch',
      description: 'Current: 0 pieces'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  sessionData: {
    page: 1,
    user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0',
    category: 'contractor_materials',
    total_items: 19
  }
}
📦 [INVENTORY] Processing step: item_in_select with message: 1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: '1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b',
    title: 'Cutter Machine 14inch',
    description: 'Current: 0 pieces'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "📦 *Adding stock for: Cutter Machine 14inch*\n\nCurrent Stock: 0 pieces\n\nEnter the quantity to add:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNDM5QjgxQzBGMkQ4Rjc3Q0QyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:13:05.876Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:13:06.341Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:13:10.090Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMDg5RDk1NDZGQUM1NURGMEUwRTg0REJBQUI1M0ZEMjYA',
  timestamp: '1750090389'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMDg5RDk1NDZGQUM1NURGMEUwRTg0REJBQUI1M0ZEMjYA",
  "timestamp": "1750090389",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: item_in_quantity
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: '1',
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_quantity',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: '1',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_quantity',
  sessionData: {
    user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0',
    category: 'contractor_materials',
    selected_item: {
      id: '1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b',
      name: 'Cutter Machine 14inch',
      unit: 'pieces',
      status: 'active',
      site_id: null,
      category: 'contractor_materials',
      created_at: '2025-06-16T14:47:17.839Z',
      created_by: null,
      updated_at: '2025-06-16T14:47:17.839Z',
      current_stock: 0
    }
  }
}
📦 [INVENTORY] Processing step: item_in_quantity with message: 1 interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "✅ *Stock Added Successfully!*\n\nItem: Cutter Machine 14inch\nAdded: 1 pieces\nPrevious Stock: 0 pieces\nNew Stock: 1 pieces\n\nTransaction recorded at 6/16/2025, 11:13:11 AM"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNDdDQjdEQzJEQzg0M0IyNjgyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:13:12.815Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:13:13.325Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Showing main menu for phone: +917383489516 user_id: undefined
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRDVEOTVCQThCRjY5QzQ3RTQwAA=='
    }
  ]
}
2025-06-16T16:13:15.734Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T16:13:16.218Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRTQ2MEM5RkNFMDAzNTdCOUNBAA=='
    }
  ]
}
2025-06-16T16:13:17.392Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:13:18.066Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:13:21.192Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMDE0QjIxMTc2OTlFM0JCMEE1MkEzN0FFRThFMTUyNDgA',
  timestamp: '1750090400'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRDVEOTVCQThCRjY5QzQ3RTQwAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMDE0QjIxMTc2OTlFM0JCMEE1MkEzN0FFRThFMTUyNDgA",
  "timestamp": "1750090400",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "new_item",
      "title": "🆕 New Item"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "new_item"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'new_item',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'new_item',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'new_item', title: '🆕 New Item' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: new_item interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'new_item', title: '🆕 New Item' }
}
📦 [INVENTORY] Handling main menu selection: new_item interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'new_item', title: '🆕 New Item' }
}
📦 [INVENTORY] Starting New Item flow with category selection
📦 [INVENTORY] Showing category selection for action: new_item user_id: 1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0
📦 [INVENTORY] Sending category selection list with action text: create new item in
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Select Inventory Category*\n\nWhich type of inventory do you want to create new item in?"
    },
    "action": {
      "button": "Select Category",
      "sections": [
        {
          "title": "Inventory Categories",
          "rows": [
            {
              "id": "building_material",
              "title": "🏗️ Building Material",
              "description": "Cement, Steel, Bricks, Sand, etc."
            },
            {
              "id": "contractor_materials",
              "title": "🛠️ Contractor Materials",
              "description": "Scaffolding, Props, Tools, etc."
            },
            {
              "id": "electrical_materials",
              "title": "⚡ Electrical Materials",
              "description": "Wires, Switches, MCBs, etc."
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMEE1OUJERDE3Q0M5NjVDQkREAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:13:23.812Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:13:24.362Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:13:28.824Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRTFGNkRBQTI4MTg0NEI3NDFGNTI4M0FFNTE0RjNDNkYA',
  timestamp: '1750090408'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMEE1OUJERDE3Q0M5NjVDQkREAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRTFGNkRBQTI4MTg0NEI3NDFGNTI4M0FFNTE0RjNDNkYA",
  "timestamp": "1750090408",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "contractor_materials",
      "title": "🛠️ Contractor Materials",
      "description": "Scaffolding, Props, Tools, etc."
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "contractor_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: category_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'contractor_materials',
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'contractor_materials',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'contractor_materials',
      title: '🛠️ Contractor Materials',
      description: 'Scaffolding, Props, Tools, etc.'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  sessionData: {
    action: 'new_item',
    user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0'
  }
}
📦 [INVENTORY] Processing step: category_select with message: contractor_materials interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'contractor_materials',
    title: '🛠️ Contractor Materials',
    description: 'Scaffolding, Props, Tools, etc.'
  }
}
📦 [INVENTORY] Category selected: contractor_materials for action: new_item
📦 [INVENTORY] Starting New Item flow for category: contractor_materials
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "🆕 *Add New Contractor Materials Item*\n\nEnter the name of the new contractor materials item:\n\n💡 *Contractor Materials Examples:*\n• Scaffolding Plates 3ft×2ft\n• Jack Prop 2.3m\n• Ring Machine 12mm\n• Cutter Machine 14inch\n• Sikanja 2ft\n• Bamboo 8ft\n\n*Type the item name:*"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRDk3NTU4ODVEMEJEQzQ0Q0ZDAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:13:31.935Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:13:32.227Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:13:53.028Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggOUI5QzJGOUQwMDg2RjUyNkJDQTA4NDE3MTEwRDhEN0UA',
  timestamp: '1750090432'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggOUI5QzJGOUQwMDg2RjUyNkJDQTA4NDE3MTEwRDhEN0UA",
  "timestamp": "1750090432",
  "text": {
    "body": "Jack teka 10 ft"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Jack teka 10 ft"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: new_item_name
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'Jack teka 10 ft',
  sessionIntent: 'inventory_management',
  sessionStep: 'new_item_name',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'Jack teka 10 ft',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'new_item_name',
  sessionData: {
    user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0',
    category: 'contractor_materials'
  }
}
📦 [INVENTORY] Processing step: new_item_name with message: Jack teka 10 ft interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "✅ Item name: \"Jack teka 10 ft\"\n📂 Category: Contractor Materials\n\nNow enter the unit of measurement:\n\n💡 *Common units:*\n• kg (kilograms)\n• pieces\n• bags\n• liters\n• meters\n• cubic_ft\n• sq_ft\n• sheets\n\n*Type the unit:*"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMzZBN0VBOUM4Nzk3ODMwNTk3AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:13:55.716Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:13:56.202Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:14:03.936Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRjVCMjU3NkQyNEE1NUZBOThCNkJENDU1RUFENEU2QzQA',
  timestamp: '1750090443'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRjVCMjU3NkQyNEE1NUZBOThCNkJENDU1RUFENEU2QzQA",
  "timestamp": "1750090443",
  "text": {
    "body": "No"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "No"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: new_item_unit
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'No',
  sessionIntent: 'inventory_management',
  sessionStep: 'new_item_unit',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'No',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'new_item_unit',
  sessionData: {
    user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0',
    category: 'contractor_materials',
    item_name: 'Jack teka 10 ft'
  }
}
📦 [INVENTORY] Processing step: new_item_unit with message: No interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "✅ *New Contractor Materials Item Added Successfully!*\n\n📦 Item Name: Jack teka 10 ft\n📂 Category: Contractor Materials\n📏 Unit: no\n📊 Initial Stock: 0 no\n✅ Status: Active\n\n🕒 Created at 6/16/2025, 11:14:04 AM\n\n🎉 You can now add stock using the \"Item In\" option!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRUQzNkY3NEY4MkJEQjIzMEVFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:14:06.513Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:14:07.271Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Showing main menu for phone: +917383489516 user_id: undefined
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMzBGQzZFNjVCQkFFODk1NEZEAA=='
    }
  ]
}
2025-06-16T16:14:10.648Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T16:14:10.879Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNTA1NkYyMzVFRTYyMjdDREM1AA=='
    }
  ]
}
2025-06-16T16:14:12.357Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:14:12.815Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNUM0MzM1OUY5OUQzRjYyQTE2QzZCMkZFN0MzRjkxMzQA',
  timestamp: '1750090451'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMzBGQzZFNjVCQkFFODk1NEZEAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNUM0MzM1OUY5OUQzRjYyQTE2QzZCMkZFN0MzRjkxMzQA",
  "timestamp": "1750090451",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "item_in",
      "title": "📦 Item In"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
2025-06-16T16:14:12.842Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "item_in"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'item_in',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'item_in',
  interactiveData: {
    type: 'button_reply',
    button_reply: { id: 'item_in', title: '📦 Item In' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Handling main menu selection: item_in interactiveData: {
  type: 'button_reply',
  button_reply: { id: 'item_in', title: '📦 Item In' }
}
📦 [INVENTORY] Starting Item In flow with category selection
📦 [INVENTORY] Showing category selection for action: item_in user_id: 1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0
📦 [INVENTORY] Sending category selection list with action text: add stock to
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Select Inventory Category*\n\nWhich type of inventory do you want to add stock to?"
    },
    "action": {
      "button": "Select Category",
      "sections": [
        {
          "title": "Inventory Categories",
          "rows": [
            {
              "id": "building_material",
              "title": "🏗️ Building Material",
              "description": "Cement, Steel, Bricks, Sand, etc."
            },
            {
              "id": "contractor_materials",
              "title": "🛠️ Contractor Materials",
              "description": "Scaffolding, Props, Tools, etc."
            },
            {
              "id": "electrical_materials",
              "title": "⚡ Electrical Materials",
              "description": "Wires, Switches, MCBs, etc."
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMDREOEJEREFGNTFFNEYzOTNCAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:14:15.945Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:14:16.415Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:14:21.968Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMDgxMjJGMzIxNUFBNjMxMDQwMjcyRDQwQzU2NTY5NzcA',
  timestamp: '1750090461'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMDREOEJEREFGNTFFNEYzOTNCAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMDgxMjJGMzIxNUFBNjMxMDQwMjcyRDQwQzU2NTY5NzcA",
  "timestamp": "1750090461",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "contractor_materials",
      "title": "🛠️ Contractor Materials",
      "description": "Scaffolding, Props, Tools, etc."
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "contractor_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: category_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'contractor_materials',
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'contractor_materials',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'contractor_materials',
      title: '🛠️ Contractor Materials',
      description: 'Scaffolding, Props, Tools, etc.'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'category_select',
  sessionData: {
    action: 'item_in',
    user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0'
  }
}
📦 [INVENTORY] Processing step: category_select with message: contractor_materials interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'contractor_materials',
    title: '🛠️ Contractor Materials',
    description: 'Scaffolding, Props, Tools, etc.'
  }
}
📦 [INVENTORY] Category selected: contractor_materials for action: item_in
📦 [INVENTORY] Starting Item In flow for category: contractor_materials
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Contractor Materials - Item In*\n\nSelect item to add stock:\n📄 Page 1 of 3 (20 total items)"
    },
    "action": {
      "button": "Select Item",
      "sections": [
        {
          "title": "Contractor Items",
          "rows": [
            {
              "id": "25184a1e-8844-4062-82f6-f58438ba4525",
              "title": "3×1.5 Patti",
              "description": "Current: 0 pieces"
            },
            {
              "id": "29e2b21c-dbc6-4413-a5ab-d3a1ce5bacbd",
              "title": "3×2 Patti",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1f1cd3da-c7ee-4872-916c-cab44da7506c",
              "title": "4×2 Wall Plate",
              "description": "Current: 0 pieces"
            },
            {
              "id": "94f16fe4-5312-4bd1-b174-2873ca88c4dc",
              "title": "Bamboo 10ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "2b1994ba-520c-486b-beee-1ff1d86e6434",
              "title": "Bamboo 8ft",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1b23d8ed-ce72-48b9-bd0c-1c25c22dec7b",
              "title": "Cutter Machine 14inch",
              "description": "Current: 1 pieces"
            },
            {
              "id": "2b32a356-da26-4a2b-9910-9295dac0ab38",
              "title": "Jack Prop 2.2m",
              "description": "Current: 0 pieces"
            },
            {
              "id": "3ca71332-9823-4d78-952f-5cd369149cd0",
              "title": "Jack Prop 2.3m",
              "description": "Current: 0 pieces"
            },
            {
              "id": "next_page_2",
              "title": "▶️ Next",
              "description": "Page 2 of 3"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQTgwQkQ3NzRBNkI4MDVCNkQ0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:14:25.099Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:14:25.482Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:14:57.296Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggN0RGNDg4QTkyRTFGQUMwN0M2NTNEQkU4QjBFRjQzOEYA',
  timestamp: '1750090496'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQTgwQkQ3NzRBNkI4MDVCNkQ0AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggN0RGNDg4QTkyRTFGQUMwN0M2NTNEQkU4QjBFRjQzOEYA",
  "timestamp": "1750090496",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "next_page_2",
      "title": "▶️ Next",
      "description": "Page 2 of 3"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "next_page_2"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: item_in_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'next_page_2',
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'next_page_2',
  interactiveData: {
    type: 'list_reply',
    list_reply: { id: 'next_page_2', title: '▶️ Next', description: 'Page 2 of 3' }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  sessionData: {
    page: 1,
    user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0',
    category: 'contractor_materials',
    total_items: 20
  }
}
📦 [INVENTORY] Processing step: item_in_select with message: next_page_2 interactiveData: {
  type: 'list_reply',
  list_reply: { id: 'next_page_2', title: '▶️ Next', description: 'Page 2 of 3' }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "📦 *Contractor Materials - Item In*\n\nSelect item to add stock:\n📄 Page 2 of 3 (20 total items)"
    },
    "action": {
      "button": "Select Item",
      "sections": [
        {
          "title": "Contractor Items",
          "rows": [
            {
              "id": "763524a5-d268-4a79-bab6-c507e736635e",
              "title": "Jack teka 10 ft",
              "description": "Current: 0 no"
            },
            {
              "id": "8626aa37-0ab4-4b9d-8862-56bceb0749c1",
              "title": "Ply Cutter 5inch",
              "description": "Current: 0 pieces"
            },
            {
              "id": "1829a2c5-856a-474e-9b51-7ace991cdfb5",
              "title": "Ply Cutter 7inch",
              "description": "Current: 0 pieces"
            },
            {
              "id": "4f7a4312-cc6b-4ad3-ad3e-2b781f6eb503",
              "title": "Ring Machine 12mm",
              "description": "Current: 0 pieces"
            },
            {
              "id": "095ad5b0-21b4-4c55-bd44-4731b7318b07",
              "title": "Ring Machine 8mm",
              "description": "Current: 0 pieces"
            },
            {
              "id": "88281be5-16fe-4daa-b7f8-100495da29ae",
              "title": "Scaffolding Plate 3ft...",
              "description": "Current: 0 pieces"
            },
            {
              "id": "0fc34ab9-6eaf-432f-a3aa-2fc318f9cdda",
              "title": "Scaffolding Plate 3ft...",
              "description": "Current: 0 pieces"
            },
            {
              "id": "a6b32973-d856-42b3-a5ca-84ba99f0e9f2",
              "title": "Scaffolding Plate 3ft...",
              "description": "Current: 0 pieces"
            },
            {
              "id": "prev_page_1",
              "title": "◀️ Previous",
              "description": "Page 1 of 3"
            },
            {
              "id": "next_page_3",
              "title": "▶️ Next",
              "description": "Page 3 of 3"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQUYzMDhFNTQxN0ZDOEE3RkM4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:15:00.404Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:15:00.825Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:15:07.792Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggOEIwNTEyMTQ1MDI5QTZGRDQ4N0Q2MUQxODU4NTdFNUEA',
  timestamp: '1750090507'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQUYzMDhFNTQxN0ZDOEE3RkM4AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggOEIwNTEyMTQ1MDI5QTZGRDQ4N0Q2MUQxODU4NTdFNUEA",
  "timestamp": "1750090507",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "763524a5-d268-4a79-bab6-c507e736635e",
      "title": "Jack teka 10 ft",
      "description": "Current: 0 no"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "763524a5-d268-4a79-bab6-c507e736635e"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: item_in_select
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: '763524a5-d268-4a79-bab6-c507e736635e',
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: '763524a5-d268-4a79-bab6-c507e736635e',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: '763524a5-d268-4a79-bab6-c507e736635e',
      title: 'Jack teka 10 ft',
      description: 'Current: 0 no'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_select',
  sessionData: {
    page: 2,
    user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0',
    category: 'contractor_materials',
    total_items: 20
  }
}
📦 [INVENTORY] Processing step: item_in_select with message: 763524a5-d268-4a79-bab6-c507e736635e interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: '763524a5-d268-4a79-bab6-c507e736635e',
    title: 'Jack teka 10 ft',
    description: 'Current: 0 no'
  }
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "📦 *Adding stock for: Jack teka 10 ft*\n\nCurrent Stock: 0 no\n\nEnter the quantity to add:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQUNBQTRFRTZENjRFMTM1QTU4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:15:10.747Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:15:11.044Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:15:16.966Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQUE2RDBGRDA0MzA4OEU1MDJDMUZDNUU5QTdFOTM0OTgA',
  timestamp: '1750090516'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQUE2RDBGRDA0MzA4OEU1MDJDMUZDNUU5QTdFOTM0OTgA",
  "timestamp": "1750090516",
  "text": {
    "body": "200"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "200"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: item_in_quantity
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: '200',
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_quantity',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: '200',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'item_in_quantity',
  sessionData: {
    user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0',
    category: 'contractor_materials',
    selected_item: {
      id: '763524a5-d268-4a79-bab6-c507e736635e',
      name: 'Jack teka 10 ft',
      unit: 'no',
      status: 'active',
      site_id: null,
      category: 'contractor_materials',
      created_at: '2025-06-16T16:14:04.880Z',
      created_by: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0',
      updated_at: '2025-06-16T16:14:04.880Z',
      current_stock: 0
    }
  }
}
📦 [INVENTORY] Processing step: item_in_quantity with message: 200 interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "✅ *Stock Added Successfully!*\n\nItem: Jack teka 10 ft\nAdded: 200 no\nPrevious Stock: 0 no\nNew Stock: 200 no\n\nTransaction recorded at 6/16/2025, 11:15:18 AM"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMjU1QTM5NEZGNUU2MDdFNTA0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:15:19.772Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:15:20.105Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Showing main menu for phone: +917383489516 user_id: undefined
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOTc1RERFRDk4Mzg2RDg1QkZEAA=='
    }
  ]
}
2025-06-16T16:15:22.732Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T16:15:23.318Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNjc2QjA3M0FGRUE5MkNDRDRDAA=='
    }
  ]
}
2025-06-16T16:15:24.533Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:15:24.896Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:15:32.057Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRDVCRDdFQTU3MjJDNzUxRUI4QkU2Q0UzNkQwQUMxNzcA',
  timestamp: '1750090531'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNjc2QjA3M0FGRUE5MkNDRDRDAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRDVCRDdFQTU3MjJDNzUxRUI4QkU2Q0UzNkQwQUMxNzcA",
  "timestamp": "1750090531",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inventory_balance",
      "title": "📊 Stock Balance",
      "description": "View current stock levels"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "inventory_balance"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'inventory_balance',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'inventory_balance',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'inventory_balance',
      title: '📊 Stock Balance',
      description: 'View current stock levels'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: inventory_balance interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'inventory_balance',
    title: '📊 Stock Balance',
    description: 'View current stock levels'
  }
}
📦 [INVENTORY] Handling main menu selection: inventory_balance interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'inventory_balance',
    title: '📊 Stock Balance',
    description: 'View current stock levels'
  }
}
📦 [INVENTORY] Generating inventory balance report
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "📊 Generating inventory balance report... Please wait."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOTMzQ0VFRUY3N0U2QzYwNUU3AA=='
    }
  ]
}
2025-06-16T16:15:34.578Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:15:35.291Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: inventory-reports/c296e596-c762-4f6f-9d6b-ce8b51a13511.pdf
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/inventory-reports/c296e596-c762-4f6f-9d6b-ce8b51a13511.pdf
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "document",
  "document": {
    "link": "https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/inventory-reports/c296e596-c762-4f6f-9d6b-ce8b51a13511.pdf",
    "filename": "inventory-balance-2025-06-16.pdf",
    "caption": "📊 *Inventory Balance Report*\n\nGenerated on: 6/16/2025, 11:15:35 AM\nTotal Items: 105"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSRDBEQkY4RDg1MDREMzEwOEMzAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:15:38.181Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Showing main menu for phone: +917383489516 user_id: undefined
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T16:15:38.855Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQ0M2MTU1NTVCRDRFNzY0MzU5AA=='
    }
  ]
}
2025-06-16T16:15:39.804Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T16:15:40.352Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNDRFNUE2QjgzNThDRUM4M0I3AA=='
    }
  ]
}
2025-06-16T16:15:41.851Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:15:42.230Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:16:16.508Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:16:20.694Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQkU1MkVFMDY5MDA3NTA4MTg5N0Q3NDcxMUZDRjk1QzAA',
  timestamp: '1750090580'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNDRFNUE2QjgzNThDRUM4M0I3AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQkU1MkVFMDY5MDA3NTA4MTg5N0Q3NDcxMUZDRjk1QzAA",
  "timestamp": "1750090580",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "day_to_day",
      "title": "📅 Daily Reports",
      "description": "Daily transaction log"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "day_to_day"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'day_to_day',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'day_to_day',
  interactiveData: {
    type: 'list_reply',
    list_reply: {
      id: 'day_to_day',
      title: '📅 Daily Reports',
      description: 'Daily transaction log'
    }
  },
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: day_to_day interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'day_to_day',
    title: '📅 Daily Reports',
    description: 'Daily transaction log'
  }
}
📦 [INVENTORY] Handling main menu selection: day_to_day interactiveData: {
  type: 'list_reply',
  list_reply: {
    id: 'day_to_day',
    title: '📅 Daily Reports',
    description: 'Daily transaction log'
  }
}
📦 [INVENTORY] Generating day-to-day report
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "📅 Generating day-to-day transactions report... Please wait."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNjU2RkE0NEU0RkI3MUY0QjI2AA=='
    }
  ]
}
✅ File uploaded successfully:
🔑 Key: inventory-reports/de452bfb-0c70-4d22-807a-3cea50e8d4cc.pdf
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/inventory-reports/de452bfb-0c70-4d22-807a-3cea50e8d4cc.pdf
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "document",
  "document": {
    "link": "https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/inventory-reports/de452bfb-0c70-4d22-807a-3cea50e8d4cc.pdf",
    "filename": "inventory-transactions-2025-06-16.pdf",
    "caption": "📅 *Day-to-Day Transactions Report*\n\nGenerated on: 6/16/2025, 11:16:24 AM\nTotal Transactions: 3"
  }
}
2025-06-16T16:16:24.079Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:16:24.340Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNDc5MjA3QjkwNUFDN0YwOTVFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T16:16:26.829Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Showing main menu for phone: +917383489516 user_id: undefined
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
2025-06-16T16:16:27.416Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNERCQjFDOUFBQUNGNjkzNzE1AA=='
    }
  ]
}
2025-06-16T16:16:28.678Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T16:16:28.937Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMjQ5ODAwM0Y4RDc5RjI5MEFEAA=='
    }
  ]
}
2025-06-16T16:16:30.213Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:16:30.707Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:16:46.466Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T16:52:59.733Z - GET /
2025-06-16T16:52:59.992Z - GET /
2025-06-16T16:53:01.251Z - GET /
2025-06-16T16:53:52.365Z - GET /
2025-06-16T16:53:52.673Z - GET /
2025-06-16T16:54:01.654Z - GET /
2025-06-16T17:02:31.571Z - GET /health
2025-06-16T17:02:36.445Z - GET /zoho/oauth
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T17:03:36.566Z - GET /
2025-06-16T17:03:37.191Z - GET /favicon.ico
2025-06-16T17:03:45.367Z - GET /zoho/oauth
2025-06-16T17:05:00.351Z - GET /zoho/oauth
2025-06-16T17:05:05.856Z - GET /zoho/callback
Error sending email: Error: Invalid login: 501 Could not do Unknown Authentication
    at SMTPConnection._formatError (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:809:19)
    at SMTPConnection._actionAUTHComplete (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1588:34)
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1781:22)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20)
    at SMTPConnection._onData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:774:14)
    at SMTPConnection._onSocketData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:195:44)
    at TLSSocket.emit (node:events:519:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at Readable.push (node:internal/streams/readable:390:5) {
  code: 'EAUTH',
  response: '501 Could not do Unknown Authentication',
  responseCode: 501,
  command: 'AUTH XOAUTH2'
}
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T17:07:46.358Z - GET /zoho/oauth
2025-06-16T17:07:54.405Z - GET /zoho/callback
Error sending email: Error: Invalid login: 501 Could not do Unknown Authentication
    at SMTPConnection._formatError (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:809:19)
    at SMTPConnection._actionAUTHComplete (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1588:34)
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1781:22)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20)
    at SMTPConnection._onData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:774:14)
    at SMTPConnection._onSocketData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:195:44)
    at TLSSocket.emit (node:events:519:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at Readable.push (node:internal/streams/readable:390:5) {
  code: 'EAUTH',
  response: '501 Could not do Unknown Authentication',
  responseCode: 501,
  command: 'AUTH XOAUTH2'
}
2025-06-16T17:08:03.310Z - GET /
2025-06-16T17:08:12.528Z - GET /zoho/oauth
2025-06-16T17:08:18.185Z - GET /zoho/callback
Error sending email: Error: Invalid login: 501 Could not do Unknown Authentication
    at SMTPConnection._formatError (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:809:19)
    at SMTPConnection._actionAUTHComplete (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1588:34)
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1781:22)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20)
    at SMTPConnection._onData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:774:14)
    at SMTPConnection._onSocketData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:195:44)
    at TLSSocket.emit (node:events:519:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at Readable.push (node:internal/streams/readable:390:5) {
  code: 'EAUTH',
  response: '501 Could not do Unknown Authentication',
  responseCode: 501,
  command: 'AUTH XOAUTH2'
}
2025-06-16T17:08:55.637Z - GET /zoho/callback
Error sending email: Error: Invalid login: 501 Could not do Unknown Authentication
    at SMTPConnection._formatError (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:809:19)
    at SMTPConnection._actionAUTHComplete (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1588:34)
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1781:22)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20)
    at SMTPConnection._onData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:774:14)
    at SMTPConnection._onSocketData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:195:44)
    at TLSSocket.emit (node:events:519:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at Readable.push (node:internal/streams/readable:390:5) {
  code: 'EAUTH',
  response: '501 Could not do Unknown Authentication',
  responseCode: 501,
  command: 'AUTH XOAUTH2'
}
2025-06-16T17:09:00.961Z - GET /zoho/callback
Error sending email: Error: Can't create new access token for user
    at XOAuth2.generateToken (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/xoauth2/index.js:184:33)
    at XOAuth2.getToken (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/xoauth2/index.js:123:18)
    at SMTPConnection._handleXOauth2Token (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1766:27)
    at SMTPConnection.login (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:546:22)
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-transport/index.js:272:32
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:215:17)
    at Object.onceWrapper (node:events:633:28)
    at SMTPConnection.emit (node:events:519:28)
    at SMTPConnection._actionEHLO (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1371:14)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20) {
  code: 'EAUTH',
  command: 'AUTH XOAUTH2'
}
2025-06-16T17:14:13.574Z - GET /
2025-06-16T17:14:23.343Z - GET /zoho/oauth
2025-06-16T17:14:26.401Z - GET /zoho/callback
Error sending email: Error: Invalid login: 501 Could not do Unknown Authentication
    at SMTPConnection._formatError (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:809:19)
    at SMTPConnection._actionAUTHComplete (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1588:34)
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1781:22)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20)
    at SMTPConnection._onData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:774:14)
    at SMTPConnection._onSocketData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:195:44)
    at TLSSocket.emit (node:events:519:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at Readable.push (node:internal/streams/readable:390:5) {
  code: 'EAUTH',
  response: '501 Could not do Unknown Authentication',
  responseCode: 501,
  command: 'AUTH XOAUTH2'
}
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T17:16:15.110Z - GET /zoho/oauth
2025-06-16T17:16:19.721Z - GET /zoho/callback
Error sending email: Error: Invalid login: 501 Could not do Unknown Authentication
    at SMTPConnection._formatError (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:809:19)
    at SMTPConnection._actionAUTHComplete (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1588:34)
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1781:22)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20)
    at SMTPConnection._onData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:774:14)
    at SMTPConnection._onSocketData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:195:44)
    at TLSSocket.emit (node:events:519:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at Readable.push (node:internal/streams/readable:390:5) {
  code: 'EAUTH',
  response: '501 Could not do Unknown Authentication',
  responseCode: 501,
  command: 'AUTH XOAUTH2'
}
2025-06-16T17:16:40.804Z - GET /zoho/callback
Error sending email: Error: Can't create new access token for user
    at XOAuth2.generateToken (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/xoauth2/index.js:184:33)
    at XOAuth2.getToken (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/xoauth2/index.js:123:18)
    at SMTPConnection._handleXOauth2Token (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1766:27)
    at SMTPConnection.login (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:546:22)
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-transport/index.js:272:32
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:215:17)
    at Object.onceWrapper (node:events:633:28)
    at SMTPConnection.emit (node:events:519:28)
    at SMTPConnection._actionEHLO (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1371:14)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20) {
  code: 'EAUTH',
  command: 'AUTH XOAUTH2'
}
2025-06-16T17:17:03.574Z - GET /zoho/callback
Error sending email: Error: Invalid login: 501 Could not do Unknown Authentication
    at SMTPConnection._formatError (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:809:19)
    at SMTPConnection._actionAUTHComplete (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1588:34)
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1781:22)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20)
    at SMTPConnection._onData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:774:14)
    at SMTPConnection._onSocketData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:195:44)
    at TLSSocket.emit (node:events:519:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at Readable.push (node:internal/streams/readable:390:5) {
  code: 'EAUTH',
  response: '501 Could not do Unknown Authentication',
  responseCode: 501,
  command: 'AUTH XOAUTH2'
}
2025-06-16T17:20:32.925Z - GET /test-direct
2025-06-16T17:20:43.264Z - GET /zoho/oauth
2025-06-16T17:20:46.607Z - GET /zoho/callback
Error sending email: Error: Invalid login: 501 Could not do Unknown Authentication
    at SMTPConnection._formatError (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:809:19)
    at SMTPConnection._actionAUTHComplete (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1588:34)
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1781:22)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20)
    at SMTPConnection._onData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:774:14)
    at SMTPConnection._onSocketData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:195:44)
    at TLSSocket.emit (node:events:519:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at Readable.push (node:internal/streams/readable:390:5) {
  code: 'EAUTH',
  response: '501 Could not do Unknown Authentication',
  responseCode: 501,
  command: 'AUTH XOAUTH2'
}
2025-06-16T17:25:39.476Z - GET /zoho/callback
Error sending email: Error: Invalid login: 501 Could not do Unknown Authentication
    at SMTPConnection._formatError (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:809:19)
    at SMTPConnection._actionAUTHComplete (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1588:34)
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1781:22)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20)
    at SMTPConnection._onData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:774:14)
    at SMTPConnection._onSocketData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:195:44)
    at TLSSocket.emit (node:events:519:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at Readable.push (node:internal/streams/readable:390:5) {
  code: 'EAUTH',
  response: '501 Could not do Unknown Authentication',
  responseCode: 501,
  command: 'AUTH XOAUTH2'
}
2025-06-16T17:26:04.023Z - GET /zoho/callback
Error sending email: Error: Can't create new access token for user
    at XOAuth2.generateToken (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/xoauth2/index.js:184:33)
    at XOAuth2.getToken (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/xoauth2/index.js:123:18)
    at SMTPConnection._handleXOauth2Token (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1766:27)
    at SMTPConnection.login (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:546:22)
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-transport/index.js:272:32
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:215:17)
    at Object.onceWrapper (node:events:633:28)
    at SMTPConnection.emit (node:events:519:28)
    at SMTPConnection._actionEHLO (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1371:14)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20) {
  code: 'EAUTH',
  command: 'AUTH XOAUTH2'
}
2025-06-16T17:26:12.466Z - GET /zoho/callback
Error sending email: Error: Invalid login: 501 Could not do Unknown Authentication
    at SMTPConnection._formatError (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:809:19)
    at SMTPConnection._actionAUTHComplete (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1588:34)
    at SMTPConnection.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:1781:22)
    at SMTPConnection._processResponse (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:993:20)
    at SMTPConnection._onData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:774:14)
    at SMTPConnection._onSocketData (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/nodemailer/lib/smtp-connection/index.js:195:44)
    at TLSSocket.emit (node:events:519:28)
    at addChunk (node:internal/streams/readable:559:12)
    at readableAddChunkPushByteMode (node:internal/streams/readable:510:3)
    at Readable.push (node:internal/streams/readable:390:5) {
  code: 'EAUTH',
  response: '501 Could not do Unknown Authentication',
  responseCode: 501,
  command: 'AUTH XOAUTH2'
}
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T18:05:56.344Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQzIwNTY0RUM2QkM3N0E1Q0M5M0I4OTA3NTg2OEIzNDEA',
  timestamp: '1750097155'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQzIwNTY0RUM2QkM3N0E1Q0M5M0I4OTA3NTg2OEIzNDEA",
  "timestamp": "1750097155",
  "text": {
    "body": "Hii"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Hii"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'Hii',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'Hii',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: {}
}
📦 [INVENTORY] Processing step: main_menu with message: Hii interactiveData: undefined
📦 [INVENTORY] Showing main menu for phone: +917383489516 user_id: 1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0
📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "item_in",
            "title": "📦 Item In"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "item_out",
            "title": "📤 Item Out"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "new_item",
            "title": "🆕 New Item"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMTNBRTExOTc2QTgzMTlDQTM0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📦 [INVENTORY] Sending additional options list
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional inventory options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Reports & Analytics",
          "rows": [
            {
              "id": "inventory_balance",
              "title": "📊 Stock Balance",
              "description": "View current stock levels"
            },
            {
              "id": "day_to_day",
              "title": "📅 Daily Reports",
              "description": "Daily transaction log"
            },
            {
              "id": "setup_comprehensive_inventory",
              "title": "🚀 Setup Inventory",
              "description": "Add all category items with 0 stock"
            },
            {
              "id": "create_sample_data",
              "title": "🧪 Sample Data",
              "description": "Add sample items with stock for testing"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T18:06:00.411Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:01.244Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMkIxM0I1Q0VBOEFBM0JEQzQ5AA=='
    }
  ]
}
2025-06-16T18:06:02.427Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:02.865Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:06.578Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRUY3QjQ5ODA5QjhFOEFERDUzQzMxNEFEOUIwOUQyMTcA',
  timestamp: '1750097165'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRUY3QjQ5ODA5QjhFOEFERDUzQzMxNEFEOUIwOUQyMTcA",
  "timestamp": "1750097165",
  "text": {
    "body": "Exit"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Exit"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: inventory_management, Step: main_menu
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'Exit',
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  isAdminImpersonation: undefined
}
📦 [INVENTORY] InventoryFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'Exit',
  interactiveData: undefined,
  sessionIntent: 'inventory_management',
  sessionStep: 'main_menu',
  sessionData: { user_id: '1dc34ab3-31bd-4023-bbf1-02ddeea0d6e0' }
}
📦 [INVENTORY] Processing step: main_menu with message: Exit interactiveData: undefined
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "🔙 Exiting inventory management..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNkIwMjEzMjYyRDRFQTAwMDFDAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T18:06:10.101Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:10.629Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:11.844Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNTBCQTgzNUZGNzg0OTQyM0RFREEzOTk4RDFFMzI0RjgA',
  timestamp: '1750097144'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNTBCQTgzNUZGNzg0OTQyM0RFREEzOTk4RDFFMzI0RjgA",
  "timestamp": "1750097144",
  "text": {
    "body": "Hii"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Hii"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'Hii',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "🔧 *Admin Control Panel*\n\nWelcome to the admin interface! Here you can manage all aspects of the system.\n\nSelect what you'd like to do:"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "customer_flow",
            "title": "👥 Customer Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "employee_flow",
            "title": "👷‍♂️ Employee Flow"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "📋 Track Invoices"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNTlGNkNDMTM1RURDOTMxREU1AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T18:06:14.207Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Additional admin options:"
    },
    "action": {
      "button": "More Options",
      "sections": [
        {
          "title": "Management Tools",
          "rows": [
            {
              "id": "inventory_management",
              "title": "📦 Inventory Management",
              "description": "Manage inventory items and stock"
            },
            {
              "id": "dashboard",
              "title": "📊 Admin Dashboard",
              "description": "View system statistics and status"
            },
            {
              "id": "reset_session",
              "title": "🔄 Reset Session",
              "description": "Clear current session state"
            },
            {
              "id": "help",
              "title": "❓ Help",
              "description": "Admin help and commands"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T18:06:14.881Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMjI5QUNBMzFBNzM4MjU2NDM2AA=='
    }
  ]
}
2025-06-16T18:06:16.079Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:16.664Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:17.858Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNEUzNzI0ODBGOTlCMDAxNDQ5QjY1QkZGODJBRDg0MzgA',
  timestamp: '1750097177'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNTlGNkNDMTM1RURDOTMxREU1AA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNEUzNzI0ODBGOTlCMDAxNDQ5QjY1QkZGODJBRDg0MzgA",
  "timestamp": "1750097177",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "employee_flow",
      "title": "👷‍♂️ Employee Flow"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "employee_flow"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'employee_flow',
  sessionIntent: null,
  sessionStep: null,
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Starting employee impersonation - showing site selection first
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "🧑‍💼 *Impersonating Employee*\n\nYou are now acting as an employee. All actions will be recorded as real employee records.\n\nFirst, select which site you want to work on:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNDBDMzFBM0RDNDkxOThCRjU1AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T18:06:20.430Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
🔧 [ADMIN] Showing site selection
🔧 [ADMIN] Found sites in DB: 3
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "Select the site where you are working:"
    },
    "action": {
      "button": "Select Site",
      "sections": [
        {
          "title": "Active Sites",
          "rows": [
            {
              "id": "11111111-1111-1111-1111-111111111111",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "22222222-2222-2222-2222-222222222222",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "33333333-3333-3333-3333-333333333333",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T18:06:21.061Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOEQ0RTAzRURDNjYxNEZFQjEzAA=='
    }
  ]
}
2025-06-16T18:06:22.402Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:23.016Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:32.418Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggREM5NEU0ODkzNEVCODFDQjBDOTNFRDUwQzZBNTRCQzIA',
  timestamp: '1750097191'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOEQ0RTAzRURDNjYxNEZFQjEzAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggREM5NEU0ODkzNEVCODFDQjBDOTNFRDUwQzZBNTRCQzIA",
  "timestamp": "1750097191",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "11111111-1111-1111-1111-111111111111",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "11111111-1111-1111-1111-111111111111"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: select_site
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: '11111111-1111-1111-1111-111111111111',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'select_site',
  isAdminImpersonation: undefined
}
🔧 [ADMIN] Employee impersonation step: select_site message: 11111111-1111-1111-1111-111111111111
🔧 [ADMIN] Validating site selection: 11111111-1111-1111-1111-111111111111
🔧 [ADMIN] Valid site selected: Suvasam Group
🔧 [ADMIN] Site selected: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "✅ Site selected: Suvasam Group\n\nNow you can use all employee functions. Type *exit* to return to admin panel."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNDU4QUY5NjFDQTVGMjNFOTREAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T18:06:35.525Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+917383489516',
  messageText: 'menu',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* Suvasam Group\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-16T18:06:36.184Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQzVFNTMxQ0Q4OUZGQkFBREYwAA=='
    }
  ]
}
2025-06-16T18:06:37.501Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T18:06:37.964Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSM0UxNEMzNUMyMjFEMUEzQkQ3AA=='
    }
  ]
}
2025-06-16T18:06:39.320Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:39.850Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:43.086Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQjA2N0IxQkU0RDdCODYzODhCNkQ4QjI1NzJERTcxMzUA',
  timestamp: '1750097202'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQzVFNTMxQ0Q4OUZGQkFBREYwAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggQjA2N0IxQkU0RDdCODYzODhCNkQ4QjI1NzJERTcxMzUA",
  "timestamp": "1750097202",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "request_materials",
      "title": "📦 સામગ્રીની માંગ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "request_materials"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'request_materials',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: active message: request_materials
🔧 [ADMIN] Extracted session data for employee: {
  selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: '11111111-1111-1111-1111-111111111111',
  final_selected_site: '11111111-1111-1111-1111-111111111111'
}
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+917383489516",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T18:06:44.206Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+917383489516',
  messageText: 'request_materials',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
👷‍♂️ [EMPLOYEE] Starting material request with site: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "તમને કઈ સામગ્રીની જરૂર છે? (જેમ કે, સિમેન્ટ, સ્ટીલ, રેતી વગેરે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMUY4NDg4MURERkYxNjg0NkQ2AA=='
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'request_materials', step: 'enter_material' }
🔧 [ADMIN] Session data before update: {
  original_selected_site: '11111111-1111-1111-1111-111111111111',
  updated_selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: '11111111-1111-1111-1111-111111111111'
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T18:06:45.930Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:46.486Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:52.700Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRkVBMjk0MUM4RjVDRUUwQzgwNDc4Mzk3RENGQUI5RTcA',
  timestamp: '1750097212'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRkVBMjk0MUM4RjVDRUUwQzgwNDc4Mzk3RENGQUI5RTcA",
  "timestamp": "1750097212",
  "text": {
    "body": "Steel"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Steel"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: request_materials, Step: enter_material
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'Steel',
  sessionIntent: 'request_materials',
  sessionStep: 'enter_material',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: enter_material message: Steel
🔧 [ADMIN] Extracted session data for employee: {
  selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: '11111111-1111-1111-1111-111111111111',
  final_selected_site: '11111111-1111-1111-1111-111111111111'
}
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+917383489516",
  "intent": "request_materials",
  "step": "enter_material",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T18:06:53.916Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+917383489516',
  messageText: 'Steel',
  sessionIntent: 'request_materials',
  sessionStep: 'enter_material',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "કેટલી માત્રામાં જોઈએ છે? (જેમ કે, 10 બેગ, 5 ટન, 100 પીસ):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSMzRBMzA0NDFEQ0YzNTJGNjQzAA=='
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'request_materials', step: 'enter_quantity' }
🔧 [ADMIN] Session data before update: {
  original_selected_site: '11111111-1111-1111-1111-111111111111',
  updated_selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T18:06:55.828Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:06:56.292Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:07:12.391Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNjlBMjE3RUE5MTY3QUNCNjNBNzg2RjI0QTY4MEYyRDkA',
  timestamp: '1750097231'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNjlBMjE3RUE5MTY3QUNCNjNBNzg2RjI0QTY4MEYyRDkA",
  "timestamp": "1750097231",
  "text": {
    "body": "8 mm 10 no"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "8 mm 10 no"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: request_materials, Step: enter_quantity
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: '8 mm 10 no',
  sessionIntent: 'request_materials',
  sessionStep: 'enter_quantity',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: enter_quantity message: 8 mm 10 no
🔧 [ADMIN] Extracted session data for employee: {
  selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined,
  final_selected_site: '11111111-1111-1111-1111-111111111111'
}
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+917383489516",
  "intent": "request_materials",
  "step": "enter_quantity",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T18:07:13.558Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+917383489516',
  messageText: '8 mm 10 no',
  sessionIntent: 'request_materials',
  sessionStep: 'enter_quantity',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "આ વિનંતી કેટલી તાત્કાલિક છે?"
    },
    "action": {
      "button": "તાત્કાલિકતા પસંદ કરો",
      "sections": [
        {
          "title": "તાત્કાલિકતાના સ્તરો",
          "rows": [
            {
              "id": "low",
              "title": "🟢 ઓછી પ્રાથમિકતા",
              "description": "એક અઠવાડિયામાં જોઈએ છે"
            },
            {
              "id": "medium",
              "title": "🟡 મધ્યમ પ્રાથમિકતા",
              "description": "2-3 દિવસમાં જોઈએ છે"
            },
            {
              "id": "high",
              "title": "🔴 ઉચ્ચ પ્રાથમિકતા",
              "description": "તાત્કાલિક જોઈએ છે (આજ/આવતીકાલે)"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSODc3NEQ2QzUzREFENENGRTdDAA=='
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'request_materials', step: 'select_urgency' }
🔧 [ADMIN] Session data before update: {
  original_selected_site: '11111111-1111-1111-1111-111111111111',
  updated_selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T18:07:15.314Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:07:15.840Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:07:21.489Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'interactive',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMTFCNURCQjA2NDQ3REQ4RjU1QUE5QUNGMkZEOTA2ODMA',
  timestamp: '1750097240'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSODc3NEQ2QzUzREFENENGRTdDAA=="
  },
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggMTFCNURCQjA2NDQ3REQ4RjU1QUE5QUNGMkZEOTA2ODMA",
  "timestamp": "1750097240",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "high",
      "title": "🔴 ઉચ્ચ પ્રાથમિકતા",
      "description": "તાત્કાલિક જોઈએ છે (આજ/આવતીકાલે)"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "high"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: request_materials, Step: select_urgency
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'high',
  sessionIntent: 'request_materials',
  sessionStep: 'select_urgency',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: select_urgency message: high
🔧 [ADMIN] Extracted session data for employee: {
  selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined,
  final_selected_site: '11111111-1111-1111-1111-111111111111'
}
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+917383489516",
  "intent": "request_materials",
  "step": "select_urgency",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T18:07:22.793Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+917383489516',
  messageText: 'high',
  sessionIntent: 'request_materials',
  sessionStep: 'select_urgency',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને સામગ્રીનો ફોટો અપલોડ કરો:\n\n• જરૂરી સામગ્રીનો ફોટો\n• હાલની સામગ્રીની સ્થિતિનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSNjMwQjFGQTVCNEJCQTBEMDVBAA=='
    }
  ]
}
🔧 [ADMIN] Preserving employee flow state: { intent: 'request_materials', step: 'upload_material_image' }
🔧 [ADMIN] Session data before update: {
  original_selected_site: '11111111-1111-1111-1111-111111111111',
  updated_selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T18:07:24.375Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:07:25.076Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:07:45.246Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRkYyOURGQzc4MTU4RDZCMTMzRUIxMEVDOEI2NTM1MzAA',
  timestamp: '1750097264'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggRkYyOURGQzc4MTU4RDZCMTMzRUIxMEVDOEI2NTM1MzAA",
  "timestamp": "1750097264",
  "text": {
    "body": "skip"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "skip"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: request_materials, Step: upload_material_image
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'skip',
  sessionIntent: 'request_materials',
  sessionStep: 'upload_material_image',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: upload_material_image message: skip
🔧 [ADMIN] Extracted session data for employee: {
  selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined,
  final_selected_site: '11111111-1111-1111-1111-111111111111'
}
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+917383489516",
  "intent": "request_materials",
  "step": "upload_material_image",
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T18:07:46.331Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+917383489516',
  messageText: 'skip',
  sessionIntent: 'request_materials',
  sessionStep: 'upload_material_image',
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
⚠️ [EMPLOYEE] No site ID provided to getSiteUUID
Error submitting material request: Error: Site ID is required for activity logging
    at EmployeeFlow.getSiteUUID (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:897:19)
    at EmployeeFlow.completeMaterialRequest (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:1080:31)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async EmployeeFlow.handleImageUpload (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:984:17)
    at async EmployeeFlow.handleMaterialRequest (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:1048:17)
    at async EmployeeFlow.handleFlowStep (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:450:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:43:13)
    at async AdminFlow.handleImpersonateEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:474:9)
    at async AdminFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/adminFlow.js:76:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:124:17)
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "text",
  "text": {
    "body": "માફ કરશો, તમારી વિનંતી મોકલવામાં ભૂલ થઈ. કૃપા કરીને ફરીથી પ્રયાસ કરો."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSQjgxQTMyMUY4MzgyMjk4MTQ0AA=='
    }
  ]
}
🔧 [ADMIN] Employee flow completed, admin context preserved
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-16T18:07:48.064Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:07:48.420Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:12:18.528Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +917383489516: {
  type: 'text',
  id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNzUzMzZBNDMxRkM3NTdBMTc2RERERTEwNzc1NzIwQTkA',
  timestamp: '1750097097'
}
[WEBHOOK] Message content: {
  "from": "917383489516",
  "id": "wamid.HBgMOTE3MzgzNDg5NTE2FQIAEhggNzUzMzZBNDMxRkM3NTdBMTc2RERERTEwNzc1NzIwQTkA",
  "timestamp": "1750097097",
  "text": {
    "body": "Hii"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +917383489516
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: admin
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: admin, Phone: +917383489516
💬 [HANDLER] Message: "Hii"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: impersonate_employee, Step: active
🚦 [HANDLER] Routing to admin flow...
🔧 [ADMIN] AdminFlow.handleMessage called with: {
  phone: '+917383489516',
  messageText: 'Hii',
  sessionIntent: 'impersonate_employee',
  sessionStep: 'active',
  isAdminImpersonation: true
}
🔧 [ADMIN] Employee impersonation step: active message: Hii
🔧 [ADMIN] Extracted session data for employee: {
  selected_site: '11111111-1111-1111-1111-111111111111',
  site_id: undefined,
  final_selected_site: '11111111-1111-1111-1111-111111111111'
}
🔧 [ADMIN] Delegating to employee flow with session: {
  "phone": "+917383489516",
  "intent": null,
  "step": null,
  "data": {
    "selected_site": "11111111-1111-1111-1111-111111111111",
    "site_selection_shown": true,
    "is_admin_impersonation": true
  },
  "updated_at": "2025-06-16T18:12:20.435Z"
}
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+917383489516',
  messageText: 'Hii',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: '11111111-1111-1111-1111-111111111111',
  isAdminImpersonation: true
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* Suvasam Group\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSN0VEOUI1RUFGOTlBOTk4NURDAA=='
    }
  ]
}
🔧 [ADMIN] Employee flow completed, admin context preserved
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+917383489516",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-16T18:12:22.335Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+917383489516', wa_id: '917383489516' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE3MzgzNDg5NTE2FQIAERgSOTA0OUMyMjQ0NTQ5QjIwMzZBAA=='
    }
  ]
}
2025-06-16T18:12:23.450Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:12:23.910Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:12:24.218Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(321,34): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(339,23): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(339,30): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(405,40): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(405,47): error TS7006: Parameter 'info' implicitly has an 'any' type.
src/routes/zoho.ts(452,36): error TS2551: Property 'createTransporter' does not exist on type 'typeof import("/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/@types/nodemailer/index")'. Did you mean 'createTransport'?
src/routes/zoho.ts(475,25): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(475,32): error TS7006: Parameter 'success' implicitly has an 'any' type.
src/routes/zoho.ts(520,42): error TS7006: Parameter 'error' implicitly has an 'any' type.
src/routes/zoho.ts(520,49): error TS7006: Parameter 'info' implicitly has an 'any' type.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(453,7): error TS2769: No overload matches this call.
  The last overload gave the following error.
    Object literal may only specify known properties, and 'host' does not exist in type 'TransportOptions | Transport<unknown, TransportOptions>'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(453,7): error TS2769: No overload matches this call.
  The last overload gave the following error.
    Object literal may only specify known properties, and 'host' does not exist in type 'TransportOptions | Transport<unknown, TransportOptions>'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(453,7): error TS2769: No overload matches this call.
  The last overload gave the following error.
    Object literal may only specify known properties, and 'host' does not exist in type 'TransportOptions | Transport<unknown, TransportOptions>'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(453,7): error TS2769: No overload matches this call.
  The last overload gave the following error.
    Object literal may only specify known properties, and 'host' does not exist in type 'TransportOptions | Transport<unknown, TransportOptions>'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(453,7): error TS2769: No overload matches this call.
  The last overload gave the following error.
    Object literal may only specify known properties, and 'host' does not exist in type 'TransportOptions | Transport<unknown, TransportOptions>'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(453,7): error TS2769: No overload matches this call.
  The last overload gave the following error.
    Object literal may only specify known properties, and 'service' does not exist in type 'TransportOptions | Transport<unknown, TransportOptions>'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(453,7): error TS2769: No overload matches this call.
  The last overload gave the following error.
    Object literal may only specify known properties, and 'service' does not exist in type 'TransportOptions | Transport<unknown, TransportOptions>'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(453,7): error TS2769: No overload matches this call.
  The last overload gave the following error.
    Object literal may only specify known properties, and 'service' does not exist in type 'TransportOptions | Transport<unknown, TransportOptions>'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

src/routes/zoho.ts(453,7): error TS2769: No overload matches this call.
  The last overload gave the following error.
    Object literal may only specify known properties, and 'service' does not exist in type 'TransportOptions | Transport<unknown, TransportOptions>'.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 2s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-16T18:19:26.493Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": false,
    "hasAccessToken": false,
    "hasRefreshToken": false,
    "isExpired": true,
    "expiresAt": null,
    "scope": null,
    "createdAt": null
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T18:20:55.204Z - GET /health
2025-06-16T18:21:05.514Z - GET /zoho/dashboard
2025-06-16T18:21:08.493Z - GET /zoho/oauth
[36m[2025-06-16T18:21:08.494Z] INFO: OAuth authorization URL requested[0m
2025-06-16T18:21:16.075Z - GET /zoho/callback
[36m[2025-06-16T18:21:16.075Z] INFO: OAuth callback received[0m
[36mData:[0m {
  "code": "Present"
}
[32m[2025-06-16T18:21:16.075Z] SUCCESS: Tokens saved to storage[0m
[32m[2025-06-16T18:21:16.075Z] SUCCESS: Authorization code stored[0m
[32mData:[0m {
  "code": "1000.9a7cd..."
}
[36m[2025-06-16T18:21:16.075Z] INFO: Exchanging authorization code for tokens[0m
[32m[2025-06-16T18:21:17.263Z] SUCCESS: Tokens saved to storage[0m
[32m[2025-06-16T18:21:17.263Z] SUCCESS: OAuth tokens stored[0m
[32mData:[0m {
  "expires_in": 3600,
  "expires_at": "2025-06-16T19:21:17.263Z",
  "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ"
}
[32m[2025-06-16T18:21:17.263Z] SUCCESS: OAuth flow completed successfully[0m
[32mData:[0m {
  "access_token": "Present",
  "refresh_token": "Present",
  "expires_in": 3600
}
2025-06-16T18:21:17.940Z - GET /favicon.ico
2025-06-16T18:21:23.958Z - GET /zoho/send-oauth-email
[36m[2025-06-16T18:21:23.959Z] INFO: OAuth email send requested[0m
[36m[2025-06-16T18:21:23.959Z] INFO: Using existing valid tokens[0m
[36m[2025-06-16T18:21:23.959Z] INFO: Creating OAuth2 SMTP transporter[0m
[36m[2025-06-16T18:21:23.960Z] INFO: Verifying OAuth SMTP connection[0m
[31m[2025-06-16T18:21:26.406Z] ERROR: OAuth SMTP verification failed[0m
[31mData:[0m {
  "error": "Invalid login: 501 Could not do Unknown Authentication",
  "code": "EAUTH",
  "response": "501 Could not do Unknown Authentication"
}
2025-06-16T18:24:28.411Z - GET /zoho/refresh-tokens
[36m[2025-06-16T18:24:28.412Z] INFO: Refreshing OAuth tokens[0m
[32m[2025-06-16T18:24:29.436Z] SUCCESS: Tokens saved to storage[0m
[32m[2025-06-16T18:24:29.436Z] SUCCESS: OAuth tokens stored[0m
[32mData:[0m {
  "expires_in": 3600,
  "expires_at": "2025-06-16T19:24:29.436Z",
  "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ"
}
[32m[2025-06-16T18:24:29.436Z] SUCCESS: Tokens refreshed successfully[0m
2025-06-16T18:24:47.547Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:24:49.680Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-16T18:24:53.747Z - GET /zoho/dashboard
2025-06-16T18:25:03.149Z - GET /zoho/dashboard
2025-06-16T18:25:14.154Z - GET /zoho/dashboard
2025-06-16T18:25:25.213Z - GET /zoho/dashboard
2025-06-16T18:25:54.399Z - GET /zoho/dashboard
2025-06-16T18:25:57.974Z - GET /zoho/send-oauth-email
[36m[2025-06-16T18:25:57.978Z] INFO: OAuth email send requested[0m
[36m[2025-06-16T18:25:57.978Z] INFO: Using existing valid tokens[0m
[36m[2025-06-16T18:25:57.978Z] INFO: Creating OAuth2 SMTP transporter[0m
[36m[2025-06-16T18:25:57.978Z] INFO: Verifying OAuth SMTP connection[0m
[31m[2025-06-16T18:26:00.395Z] ERROR: OAuth SMTP verification failed[0m
[31mData:[0m {
  "error": "Invalid login: 501 Could not do Unknown Authentication",
  "code": "EAUTH",
  "response": "501 Could not do Unknown Authentication"
}
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-16T18:28:18.714Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": true,
    "hasAccessToken": true,
    "hasRefreshToken": true,
    "isExpired": false,
    "expiresAt": "2025-06-16T19:24:29.436Z",
    "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
    "createdAt": "2025-06-16T18:21:16.075Z"
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T18:28:43.667Z - GET /zoho/dashboard
2025-06-16T18:28:48.024Z - GET /zoho/send-oauth-email
[36m[2025-06-16T18:28:48.026Z] INFO: OAuth email send requested[0m
[36m[2025-06-16T18:28:48.026Z] INFO: Using existing valid tokens[0m
[36m[2025-06-16T18:28:48.027Z] INFO: Creating OAuth2 SMTP transporter[0m
[36m[2025-06-16T18:28:48.032Z] INFO: Verifying SMTP connection[0m
[31m[2025-06-16T18:28:50.587Z] ERROR: SMTP verification failed[0m
[31mData:[0m {
  "error": "Invalid login: 501 Could not do Unknown Authentication",
  "code": "EAUTH",
  "response": "501 Could not do Unknown Authentication"
}
2025-06-16T18:29:25.752Z - GET /zoho/test-direct
[36m[2025-06-16T18:29:25.752Z] INFO: Direct email test initiated[0m
[90m[2025-06-16T18:29:25.752Z] DEBUG: Environment diagnostic check[0m
[90mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_present": "Yes",
  "ZOHO_APP_PASSWORD_length": 12,
  "ZOHO_APP_PASSWORD_masked": "fzbc***CCda"
}
[33m[2025-06-16T18:29:25.752Z] WARN: App password format may be incorrect[0m
[33mData:[0m {
  "length": 12,
  "hasSpaces": false
}
[36m[2025-06-16T18:29:25.752Z] INFO: Creating SMTP transporter with app password[0m
[36m[2025-06-16T18:29:25.753Z] INFO: Verifying SMTP connection[0m
[31m[2025-06-16T18:29:27.900Z] ERROR: SMTP connection verification failed[0m
[31mData:[0m {
  "error": "Invalid login: 535 Authentication Failed",
  "code": "EAUTH",
  "response": "535 Authentication Failed"
}
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 409 packages in 3s

41 packages are looking for funding
  run `npm fund` for details

5 vulnerabilities (1 low, 4 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-16T18:35:38.853Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": true,
    "hasAccessToken": true,
    "hasRefreshToken": true,
    "isExpired": false,
    "expiresAt": "2025-06-16T19:24:29.436Z",
    "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
    "createdAt": "2025-06-16T18:21:16.075Z"
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
2025-06-16T18:36:08.903Z - GET /zoho/dashboard
2025-06-16T18:36:20.672Z - GET /zoho/dashboard
2025-06-16T18:36:25.522Z - GET /zoho/send-oauth-email
[36m[2025-06-16T18:36:25.522Z] INFO: OAuth email send requested[0m
[36m[2025-06-16T18:36:25.522Z] INFO: Using existing valid tokens[0m
[36m[2025-06-16T18:36:25.523Z] INFO: Creating OAuth2 SMTP transporter[0m
[36m[2025-06-16T18:36:25.524Z] INFO: Verifying SMTP connection[0m
[31m[2025-06-16T18:36:28.489Z] ERROR: SMTP verification failed[0m
[31mData:[0m {
  "error": "Invalid login: 501 Could not do Unknown Authentication",
  "code": "EAUTH",
  "response": "501 Could not do Unknown Authentication"
}
2025-06-16T18:36:38.290Z - GET /zoho/send-oauth-email
[36m[2025-06-16T18:36:38.291Z] INFO: OAuth email send requested[0m
[36m[2025-06-16T18:36:38.291Z] INFO: Using existing valid tokens[0m
[36m[2025-06-16T18:36:38.291Z] INFO: Creating OAuth2 SMTP transporter[0m
[36m[2025-06-16T18:36:38.292Z] INFO: Verifying SMTP connection[0m
[31m[2025-06-16T18:36:40.438Z] ERROR: SMTP verification failed[0m
[31mData:[0m {
  "error": "Invalid login: 501 Could not do Unknown Authentication",
  "code": "EAUTH",
  "response": "501 Could not do Unknown Authentication"
}
2025-06-16T18:36:42.655Z - GET /zoho/dashboard
2025-06-16T18:36:48.939Z - GET /zoho/send-oauth-email
[36m[2025-06-16T18:36:48.939Z] INFO: OAuth email send requested[0m
[36m[2025-06-16T18:36:48.939Z] INFO: Using existing valid tokens[0m
[36m[2025-06-16T18:36:48.939Z] INFO: Creating OAuth2 SMTP transporter[0m
[36m[2025-06-16T18:36:48.940Z] INFO: Verifying SMTP connection[0m
[31m[2025-06-16T18:36:51.088Z] ERROR: SMTP verification failed[0m
[31mData:[0m {
  "error": "Invalid login: 501 Could not do Unknown Authentication",
  "code": "EAUTH",
  "response": "501 Could not do Unknown Authentication"
}
2025-06-16T18:36:53.638Z - GET /zoho/refresh-tokens
[36m[2025-06-16T18:36:53.638Z] INFO: Refreshing OAuth tokens[0m
[32m[2025-06-16T18:36:54.781Z] SUCCESS: Tokens saved to storage[0m
[32m[2025-06-16T18:36:54.781Z] SUCCESS: OAuth tokens stored[0m
[32mData:[0m {
  "expires_in": 3600,
  "expires_at": "2025-06-16T19:36:54.780Z",
  "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ"
}
[32m[2025-06-16T18:36:54.781Z] SUCCESS: Tokens refreshed successfully[0m
2025-06-17T08:32:48.505Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDBFN0U4RTAyQUFDQjlFNUFDREFCRDBDODQ3MjNEQzYA',
  timestamp: '1750149166'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDBFN0U4RTAyQUFDQjlFNUFDREFCRDBDODQ3MjNEQzYA",
  "timestamp": "1750149166",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "કૃપા કરીને યાદીમાંથી યોગ્ય સાઈટ પસંદ કરો:"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQjJCQjBENkFFNzg0REI5QTMzAA=='
    }
  ]
}
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
2025-06-17T08:32:52.799Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOEU1MkU1QUUyNjc3MUI4NTQ4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:32:54.040Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:32:54.099Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:32:54.846Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:33:06.723Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggREI1QzNCM0JFRUIyOTRGRDExMDI1NEMwNzNBQTVBMjcA',
  timestamp: '1750149185'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOEU1MkU1QUUyNjc3MUI4NTQ4AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggREI1QzNCM0JFRUIyOTRGRDExMDI1NEMwNzNBQTVBMjcA",
  "timestamp": "1750149185",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'site_1',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Real employee selected site: site_1
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:312:30)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRENBMEEyMzEzMTA0MzQ0MTY5AA=='
    }
  ]
}
✅ [DB] New client connected
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:359:41)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:317:9)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-17T08:33:09.605Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMDU5OEExREZBQ0RFRDJBOTU5AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:33:10.450Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-17T08:33:11.508Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:33:11.822Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNDRCODNFOTU0QkUyMUJBMUVEAA=='
    }
  ]
}
2025-06-17T08:33:13.150Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:33:13.736Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:33:16.564Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRjg2OEEwMDU2OUM5NjJEM0UwRUU1MEVEMTkzNTBDOTQA',
  timestamp: '1750149195'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMDU5OEExREZBQ0RFRDJBOTU5AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRjg2OEEwMDU2OUM5NjJEM0UwRUU1MEVEMTkzNTBDOTQA",
  "timestamp": "1750149195",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_1',
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNUMzREFFNUU1NzJDMTdCNkJEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:33:20.249Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:33:20.786Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:33:32.916Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNkZBNDI5REM1RTU4QkE5MjMwNTVFQkU1NEY0MDQ4NTcA',
  timestamp: '1750149212'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNUMzREFFNUU1NzJDMTdCNkJEAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNkZBNDI5REM1RTU4QkE5MjMwNTVFQkU1NEY0MDQ4NTcA",
  "timestamp": "1750149212",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNjUwOENFQjYzRjRGN0NBOEM2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:33:35.651Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:33:36.211Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:33:42.769Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDA5NzBEQ0YyOEQxQ0Y3NEMwMDFDOTFFODIyQTMxMTcA',
  timestamp: '1750149221'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDA5NzBEQ0YyOEQxQ0Y3NEMwMDFDOTFFODIyQTMxMTcA",
  "timestamp": "1750149221",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQkRBNEM0ODdFOEQ1OEJEMDhBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:33:45.637Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:33:46.250Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:34:22.007Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMDZBRUUzNzM4QjFBRTZFQTBDMERCMDVGMTgwRjhEM0MA',
  timestamp: '1750149261'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMDZBRUUzNzM4QjFBRTZFQTBDMERCMDVGMTgwRjhEM0MA",
  "timestamp": "1750149261",
  "text": {
    "body": "Farma"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Farma"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Farma',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRkRGQTIwQTk1NENENkE1RUYxAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:34:25.367Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:34:25.982Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:36:57.367Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNjk5NzA5MzEwNTMyNjU1NTgzQ0Y3MDVGQ0MzMzY0NkQA',
  timestamp: '1750149414'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNjk5NzA5MzEwNTMyNjU1NTgzQ0Y3MDVGQ0MzMzY0NkQA",
  "timestamp": "1750149414",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "sb3M1fWazCUfA2xtCW2i2ta0fs/zzSgx+Jk/884L+ZY=",
    "id": "1454192575737567"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjZDRDA3NjlBOUNDN0E5MDhBAA=='
    }
  ]
}
2025-06-17T08:37:01.115Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:37:01.363Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/ce9b4509-1e1f-413c-89d9-80c1bbaf360b.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/ce9b4509-1e1f-413c-89d9-80c1bbaf360b.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQTI5NjNBNjZBODA3MzU0NEY2AA=='
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: 'site_1',
  selected_site: 'site_1',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: false
}
🔧 [EMPLOYEE] Converting site ID: site_1
🔧 [EMPLOYEE] Using legacy site mapping: site_1 → 11111111-1111-1111-1111-111111111111
🔧 [EMPLOYEE] Site UUID after conversion: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: Suvasam Group\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Farma\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* 969d7f85\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
2025-06-17T08:37:04.737Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOEU1Mzk1MjFENzk2QjRERTA2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:37:05.323Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:37:06.496Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:37:06.847Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:38:52.867Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMkQ1RjIxMDBGMkJGODg1NjE3MjE1MEM5RTU0N0REQjAA',
  timestamp: '1750149531'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMkQ1RjIxMDBGMkJGODg1NjE3MjE1MEM5RTU0N0REQjAA",
  "timestamp": "1750149531",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjgwRENGNkRCOTIyRjIyMjdCAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:38:56.554Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:38:57.132Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:39:10.648Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMDkwOEZENzY0RTg2RDA3OTFFMkEwRTBFNjQyOERGODAA',
  timestamp: '1750149549'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRjgwRENGNkRCOTIyRjIyMjdCAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMDkwOEZENzY0RTg2RDA3OTFFMkEwRTBFNjQyOERGODAA",
  "timestamp": "1750149549",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'site_1',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Real employee selected site: site_1
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:312:30)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQzAyMzY3NDVEMzUyOEZCREQ2AA=='
    }
  ]
}
✅ [DB] New client connected
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:359:41)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:317:9)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-17T08:39:13.510Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzg4QUVCOUQ4MEVFNThBQjQ5AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:39:14.180Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:39:14.950Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-17T08:39:15.767Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQjlCOEI0NEY1QUU1QTJEQ0JGAA=='
    }
  ]
}
2025-06-17T08:39:16.791Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:39:17.610Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:39:20.474Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQzQ3Qzg4NjNBNkMwNDZCRDBCNjBEQzNBODhDMzAzQzAA',
  timestamp: '1750149559'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzg4QUVCOUQ4MEVFNThBQjQ5AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQzQ3Qzg4NjNBNkMwNDZCRDBCNjBEQzNBODhDMzAzQzAA",
  "timestamp": "1750149559",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_1',
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzU4ODM1NDNDOTlGQjMxMDNBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:39:23.652Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:39:24.382Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:39:57.933Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDU5N0JFNzA4MjI2QTAyQkIyNEE1RjlFNzRFNzczMDUA',
  timestamp: '1750149596'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzU4ODM1NDNDOTlGQjMxMDNBAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRDU5N0JFNzA4MjI2QTAyQkIyNEE1RjlFNzRFNzczMDUA",
  "timestamp": "1750149596",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMjYwQ0VEMzhDMzIxQjA0NzEyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:40:02.053Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:40:02.973Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:40:16.163Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMkU3MkZFRTU3MUU0MDlFNjc3MDdCNDk3RUY3RjNBQzIA',
  timestamp: '1750149615'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMkU3MkZFRTU3MUU0MDlFNjc3MDdCNDk3RUY3RjNBQzIA",
  "timestamp": "1750149615",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNkEyNjY2MTVFRTQ2NjE2RkM4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:40:19.086Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:40:20.075Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:40:49.464Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNTU4MDA1QzJDMkM2OTc2QzgwQkVENkEyMUZDOTlFOTYA',
  timestamp: '1750149648'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNTU4MDA1QzJDMkM2OTc2QzgwQkVENkEyMUZDOTlFOTYA",
  "timestamp": "1750149648",
  "text": {
    "body": "Senching"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Senching"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Senching',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRTU3M0YxQzEyQTNEOThDOTdBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:40:53.784Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:40:54.069Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:41:19.945Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRjZDNDJCMjdEQUFFNkFBM0JBN0FGREYwMkNCMDJFNzgA',
  timestamp: '1750149676'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRjZDNDJCMjdEQUFFNkFBM0JBN0FGREYwMkNCMDJFNzgA",
  "timestamp": "1750149676",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "4c3wcFzkolW582i7mwPDnyIHUkM1Epjg0fDjknO61WM=",
    "id": "24313265784932632"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRDlCQjQzRDVBNDkyRTVDMTc3AA=='
    }
  ]
}
2025-06-17T08:41:22.847Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:41:23.186Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/c08d7e95-fb5a-408f-bef0-fbe365f719f6.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/c08d7e95-fb5a-408f-bef0-fbe365f719f6.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSM0Q0RjlCNDI2RTQzQTVGMUE5AA=='
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: 'site_1',
  selected_site: 'site_1',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: false
}
🔧 [EMPLOYEE] Converting site ID: site_1
🔧 [EMPLOYEE] Using legacy site mapping: site_1 → 11111111-1111-1111-1111-111111111111
🔧 [EMPLOYEE] Site UUID after conversion: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: Suvasam Group\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Senching\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* 721d8772\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
2025-06-17T08:41:29.209Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:41:29.839Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRUJBMDhERjI5M0RBQjFEQjM3AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:41:30.982Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:41:31.607Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:41:33.352Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:41:33.406Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:47:37.012Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggREQxRDY4ODMzRjhCMEM3N0RFREVDQjNBNzlCNjc1RkQA',
  timestamp: '1750150055'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggREQxRDY4ODMzRjhCMEM3N0RFREVDQjNBNzlCNjc1RkQA",
  "timestamp": "1750150055",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQ0NDNUI0NUFBMTgyODlFQzc4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:47:40.288Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:47:52.778Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRTY1NTQ5ODlCQzJDOEIyQjVFMDJDMTM2RTg5NDRBQTkA',
  timestamp: '1750150071'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQ0NDNUI0NUFBMTgyODlFQzc4AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRTY1NTQ5ODlCQzJDOEIyQjVFMDJDMTM2RTg5NDRBQTkA",
  "timestamp": "1750150071",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'site_1',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Real employee selected site: site_1
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:312:30)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQjA5RURENzE4NUU4RTMxN0VGAA=='
    }
  ]
}
✅ [DB] New client connected
2025-06-17T08:47:55.614Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:359:41)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:317:9)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-17T08:47:55.950Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:47:56.466Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQkU3NzUyMkQ3N0FFMTkwQTA2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:47:57.343Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-17T08:47:57.794Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQUQzRThBRjlFQTc5QkZCOTJGAA=='
    }
  ]
}
2025-06-17T08:47:59.539Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:47:59.644Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUMwMkU4OEY2NTk2OUU3MTk5NEYzNjVFM0E1QjAxQTIA',
  timestamp: '1750150078'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQkU3NzUyMkQ3N0FFMTkwQTA2AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMUMwMkU4OEY2NTk2OUU3MTk5NEYzNjVFM0E1QjAxQTIA",
  "timestamp": "1750150078",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
2025-06-17T08:47:59.989Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_1',
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMjBBOTQzNEUzOUFDNDdCMjVFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:48:03.737Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:48:03.782Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:48:12.563Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTVDNzI1RjM4QzI0QjczQkY5RjcwQ0EyQjEwOUI2REMA',
  timestamp: '1750150091'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMjBBOTQzNEUzOUFDNDdCMjVFAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTVDNzI1RjM4QzI0QjczQkY5RjcwQ0EyQjEwOUI2REMA",
  "timestamp": "1750150091",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMDQ2QkIzMDMyQzZGQkUyMzQxAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:48:15.926Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:48:16.446Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:48:19.945Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTI3OTJEMDc1MjMwMDhCQjNCM0YwQjg5MUM3RjJDOUQA',
  timestamp: '1750150099'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTI3OTJEMDc1MjMwMDhCQjNCM0YwQjg5MUM3RjJDOUQA",
  "timestamp": "1750150099",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNjVDRDc2NTlCQzc1Q0VBQTZEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:48:22.887Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:48:23.136Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:48:50.927Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQzZBNzIyRkIzQUI3MzA0RkM1NkI2MTQyODg0QkZDRUQA',
  timestamp: '1750150130'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQzZBNzIyRkIzQUI3MzA0RkM1NkI2MTQyODg0QkZDRUQA",
  "timestamp": "1750150130",
  "text": {
    "body": "Wooden strip"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Wooden strip"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Wooden strip',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNDMxM0FBQjYxNURFNDAyMjJGAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:48:53.970Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:48:54.165Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:49:39.276Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMDRGRTJCNDgyNzhEMTk1RjhBMkJCNkZCQUNDQ0NCNzIA',
  timestamp: '1750150176'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMDRGRTJCNDgyNzhEMTk1RjhBMkJCNkZCQUNDQ0NCNzIA",
  "timestamp": "1750150176",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "IgbWoStiotYSWiyTp0zcDq9KwLabBZ4gnWSKrMObK1s=",
    "id": "1103554408257564"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMzM4QzRFRkNDNUE3OTQ3OEIyAA=='
    }
  ]
}
2025-06-17T08:49:42.671Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:49:43.048Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/e18d4bad-0932-41fe-8cab-9bed78bebc8d.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/e18d4bad-0932-41fe-8cab-9bed78bebc8d.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSN0EwQjI3MEIyNkI2QzMzNkFGAA=='
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: 'site_1',
  selected_site: 'site_1',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: false
}
🔧 [EMPLOYEE] Converting site ID: site_1
🔧 [EMPLOYEE] Using legacy site mapping: site_1 → 11111111-1111-1111-1111-111111111111
🔧 [EMPLOYEE] Site UUID after conversion: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: Suvasam Group\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Wooden strip\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* 8990c9ee\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
2025-06-17T08:49:47.019Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:49:47.023Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRTQ3MDI4MzE2OUVERkNCQTg1AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T08:49:47.888Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T08:49:48.184Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:41:34.121Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTdFQTc0OTM4RTI0NTQ3MzBFNEI3QjlCRTZEQjZCNTQA',
  timestamp: '1750160492'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTdFQTc0OTM4RTI0NTQ3MzBFNEI3QjlCRTZEQjZCNTQA",
  "timestamp": "1750160492",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQjg4QkZCOEM0Q0I1MjAxNDhEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T11:41:38.333Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:41:38.728Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:42:45.084Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMTRGOEQxQzJEOTk1NThFNEE5NUM3RjI0NEQxRTFEMzAA',
  timestamp: '1750160563'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQjg4QkZCOEM0Q0I1MjAxNDhEAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMTRGOEQxQzJEOTk1NThFNEE5NUM3RjI0NEQxRTFEMzAA",
  "timestamp": "1750160563",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'site_1',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Real employee selected site: site_1
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:312:30)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzlBREY5QjNGMjc5OTc3M0RDAA=='
    }
  ]
}
✅ [DB] New client connected
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:359:41)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:317:9)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-17T11:42:48.574Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:42:48.739Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQkU1NTRCMzExRTE4MEI4RTc2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-17T11:42:50.084Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:42:50.408Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSODQwNTJEQUM5MzA4NzFGMENBAA=='
    }
  ]
}
2025-06-17T11:42:51.843Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:42:52.105Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:42:52.115Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNTAyNEI2Q0EzQkYzQjQzQUJBNjU0QTc2QjAyQjU4QTUA',
  timestamp: '1750160571'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQkU1NTRCMzExRTE4MEI4RTc2AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNTAyNEI2Q0EzQkYzQjQzQUJBNjU0QTc2QjAyQjU4QTUA",
  "timestamp": "1750160571",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_1',
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRDk0RDBDNEU2MzIxMkJBQkM0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T11:42:55.628Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:43:09.607Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:43:09.625Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:43:20.565Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMDg4QUQwMkYxNkNCN0QxNDFCQ0VENjVCRDk3NTVFN0MA',
  timestamp: '1750160599'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRDk0RDBDNEU2MzIxMkJBQkM0AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMDg4QUQwMkYxNkNCN0QxNDFCQ0VENjVCRDk3NTVFN0MA",
  "timestamp": "1750160599",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNEJFQ0E2QzMyQUZCNTg2RkExAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T11:43:23.790Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:43:24.446Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:43:35.884Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMTcwMjkzNjgzNkNDMkUwMTFGRDE4Mjc3Nzk4QjcyN0MA',
  timestamp: '1750160614'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMTcwMjkzNjgzNkNDMkUwMTFGRDE4Mjc3Nzk4QjcyN0MA",
  "timestamp": "1750160614",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNjYyQzBEMThDMDEzNEU2MDVCAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T11:43:38.845Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:43:39.080Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:43:47.137Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQjJEN0VBQjc4OURGQkI1NzU5MEYwMzA3RDE1RUU3MEEA',
  timestamp: '1750160626'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQjJEN0VBQjc4OURGQkI1NzU5MEYwMzA3RDE1RUU3MEEA",
  "timestamp": "1750160626",
  "text": {
    "body": "Steel"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Steel"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Steel',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQTNGNUFGQUQxQkZEMzA3QTEwAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T11:43:49.981Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:43:50.717Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:44:27.701Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQjQxQTEyRjNGOEZDMjA1RUI1Rjc0QUNFODY4MjFGQzAA',
  timestamp: '1750160665'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQjQxQTEyRjNGOEZDMjA1RUI1Rjc0QUNFODY4MjFGQzAA",
  "timestamp": "1750160665",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "mV8c96uGDyV5LbfJBqS5HN/Sd3Wtun9pzOyKV8hwYXc=",
    "id": "1791026291838693"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMUJEOUQ0N0MzNkM4NDdBRENEAA=='
    }
  ]
}
2025-06-17T11:44:30.813Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:44:31.016Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/50bcd515-66ca-4fe0-af7b-27b4268d82a4.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/50bcd515-66ca-4fe0-af7b-27b4268d82a4.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQzdBNTFDNDcyRUQxRTQ3MkE4AA=='
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: 'site_1',
  selected_site: 'site_1',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: false
}
🔧 [EMPLOYEE] Converting site ID: site_1
🔧 [EMPLOYEE] Using legacy site mapping: site_1 → 11111111-1111-1111-1111-111111111111
🔧 [EMPLOYEE] Site UUID after conversion: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: Suvasam Group\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Steel\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* 16d756cc\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
2025-06-17T11:44:36.079Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMEZGOEI3RkVGOUQzODI3NDlCAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T11:44:36.387Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:44:37.082Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:44:37.446Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:45:00.576Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTg1MjA2QzI4NTVERkY4ODM2NzdDRkYyMjhENDcwNDcA',
  timestamp: '1750160700'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTg1MjA2QzI4NTVERkY4ODM2NzdDRkYyMjhENDcwNDcA",
  "timestamp": "1750160700",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTYwN0VCRTc2QURBNzIzNkFDAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T11:45:03.523Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:45:03.768Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:45:08.498Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNUIzNTVFRTIzQ0U2MDM2Mzg0QzUxMDlFMENGMERBNDUA',
  timestamp: '1750160707'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTYwN0VCRTc2QURBNzIzNkFDAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNUIzNTVFRTIzQ0U2MDM2Mzg0QzUxMDlFMENGMERBNDUA",
  "timestamp": "1750160707",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'site_1',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Real employee selected site: site_1
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:312:30)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRDQ5NDg5NDhDN0VBOTAwMjg0AA=='
    }
  ]
}
✅ [DB] New client connected
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:359:41)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:317:9)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-17T11:45:11.527Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOUI4OTQ2NjkxQTZBOEE2NjdEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-17T11:45:13.057Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:45:13.345Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:45:13.346Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNTJGQzM4MjY1MTVCQzM0MTM1AA=='
    }
  ]
}
2025-06-17T11:45:14.833Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:45:15.045Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRjA3MDJGNTQwMjA4QUNDOEVCODVBNkM3MDlCQzY4RTMA',
  timestamp: '1750160713'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOUI4OTQ2NjkxQTZBOEE2NjdEAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRjA3MDJGNTQwMjA4QUNDOEVCODVBNkM3MDlCQzY4RTMA",
  "timestamp": "1750160713",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
2025-06-17T11:45:15.154Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_1',
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMEYzRTc3NDgwRDA1MkYyRUM1AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T11:45:18.558Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:45:18.955Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:45:26.191Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggREVDQTVDODg0NkJFRTczODg4MkNGQjNFMkJENjE4MzUA',
  timestamp: '1750160725'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMEYzRTc3NDgwRDA1MkYyRUM1AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggREVDQTVDODg0NkJFRTczODg4MkNGQjNFMkJENjE4MzUA",
  "timestamp": "1750160725",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNDhFQkMyMUU3MzJFQTYyMjc4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T11:45:28.817Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:45:29.635Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:45:32.407Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMzI3NUQ5N0MzQkMyOUZGMEI5RjM4NzU3Q0Q1M0NGNDkA',
  timestamp: '1750160731'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMzI3NUQ5N0MzQkMyOUZGMEI5RjM4NzU3Q0Q1M0NGNDkA",
  "timestamp": "1750160731",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQzAxNzVCRTdGQ0QzNkQ0NTRFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T11:45:35.027Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:45:35.345Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:46:25.954Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMzQ2NTVFMDZDNzA3RDFDODlEQTlCMTNCQjQxMUZGRDQA',
  timestamp: '1750160785'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMzQ2NTVFMDZDNzA3RDFDODlEQTlCMTNCQjQxMUZGRDQA",
  "timestamp": "1750160785",
  "text": {
    "body": "Jack"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Jack"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Jack',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSODNFQjJENEQ4QjM1NDE0ODM0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T11:46:29.221Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:46:29.491Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:47:05.195Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTI0MkM3M0Y1MjQ1OUM0NzBBQzVEM0QxNDQ5RDU2QTcA',
  timestamp: '1750160822'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTI0MkM3M0Y1MjQ1OUM0NzBBQzVEM0QxNDQ5RDU2QTcA",
  "timestamp": "1750160822",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "aONgHgAxA2E3HtjZnXJ/dXelf/gzuxVuZbaJXGxtC80=",
    "id": "724253540157868"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTBEMkVBMjZDMERDOUE5RkVFAA=='
    }
  ]
}
2025-06-17T11:47:08.345Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:47:08.730Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/512189f9-fc71-4358-8fa0-e426146dcc4d.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/512189f9-fc71-4358-8fa0-e426146dcc4d.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
2025-06-17T11:47:11.203Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOUQ0QzMwM0VFRDU2MjBBQ0Y5AA=='
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: 'site_1',
  selected_site: 'site_1',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: false
}
🔧 [EMPLOYEE] Converting site ID: site_1
🔧 [EMPLOYEE] Using legacy site mapping: site_1 → 11111111-1111-1111-1111-111111111111
🔧 [EMPLOYEE] Site UUID after conversion: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: Suvasam Group\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Jack\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* d19697ab\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
2025-06-17T11:47:12.112Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMUZEMDlFNEU4OEZCRkI2RjlBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-17T11:47:12.471Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:47:13.361Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-17T11:47:14.660Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:31:51.821Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMjdERDNGNjlDRDdFQzNFRUFEMjExRDdCNzA5MzQ5NjEA',
  timestamp: '1750221109'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMjdERDNGNjlDRDdFQzNFRUFEMjExRDdCNzA5MzQ5NjEA",
  "timestamp": "1750221109",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNUQ2OUY3RTdCQ0YxNjc3OTJBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T04:31:56.835Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:31:57.754Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:32:04.489Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTk4NDVGQzZEMjlGMzEwNUY4QjE0NDUyMDI2MTBDREMA',
  timestamp: '1750221123'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNUQ2OUY3RTdCQ0YxNjc3OTJBAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTk4NDVGQzZEMjlGMzEwNUY4QjE0NDUyMDI2MTBDREMA",
  "timestamp": "1750221123",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'site_1',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Real employee selected site: site_1
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:312:30)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQTgxNUYyOEM0MDk1NTIwODA5AA=='
    }
  ]
}
✅ [DB] New client connected
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:359:41)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:317:9)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-18T04:32:07.092Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:32:07.450Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSN0U2RTAwRjg3NTZBNUM4QkEzAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T04:32:08.303Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:32:08.580Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQzA0MTZDMTg1Qzk1OEZDMkYyAA=='
    }
  ]
}
2025-06-18T04:32:10.266Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:32:10.585Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:32:12.774Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRTFFNTM1NTREQzA4Q0Y4OTUzMThGMjExOTk4ODlBMzUA',
  timestamp: '1750221132'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSN0U2RTAwRjg3NTZBNUM4QkEzAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRTFFNTM1NTREQzA4Q0Y4OTUzMThGMjExOTk4ODlBMzUA",
  "timestamp": "1750221132",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_1',
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRDM4NjA5Nzg5NkEyNzg5MjBEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T04:32:15.674Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:32:16.059Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:32:29.407Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRkZERDlBMDQyNDhFRjU0QzVCMzE2NjI1RTE1ODZCMkEA',
  timestamp: '1750221148'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRDM4NjA5Nzg5NkEyNzg5MjBEAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRkZERDlBMDQyNDhFRjU0QzVCMzE2NjI1RTE1ODZCMkEA",
  "timestamp": "1750221148",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQTkxMUZCQTM5OEMyNEM4NEU2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T04:32:31.958Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:32:32.220Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:32:36.115Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMEYxRkZCNzdGQzY2RkVFNjlBNTg0MTA2NEVGMENBMjYA',
  timestamp: '1750221155'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMEYxRkZCNzdGQzY2RkVFNjlBNTg0MTA2NEVGMENBMjYA",
  "timestamp": "1750221155",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMEQ2QkE1RjI3ODk2NTk2QkQ2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T04:32:38.262Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:32:38.586Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:39:04.254Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRkQ5N0MwNjhBMzlCRDRCOURCODU4RERFMDk3M0U2RjQA',
  timestamp: '1750221543'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRkQ5N0MwNjhBMzlCRDRCOURCODU4RERFMDk3M0U2RjQA",
  "timestamp": "1750221543",
  "text": {
    "body": "Pump machine"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Pump machine"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Pump machine',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQjNENkJGNDU5QjI2QTM1MjlFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T04:39:07.214Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:39:07.599Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:39:40.672Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQkUwRDY2MDc4QTZBNUZCQTQyQzhBMUVDQjQ4QzIwNkYA',
  timestamp: '1750221578'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQkUwRDY2MDc4QTZBNUZCQTQyQzhBMUVDQjQ4QzIwNkYA",
  "timestamp": "1750221578",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "+DG9jFhykXJbFZ3D+N8ItwIlope1XUaVt0rhS2/dpy0=",
    "id": "9646556768782256"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQTQ1NkRGMzVGMDIzM0FFQzI2AA=='
    }
  ]
}
2025-06-18T04:39:43.358Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:39:43.772Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/9fbe1872-9b90-4491-8236-66b462c6b4c7.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/9fbe1872-9b90-4491-8236-66b462c6b4c7.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQkRBNENBMzc1RDU4QkE3NkIyAA=='
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: 'site_1',
  selected_site: 'site_1',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: false
}
🔧 [EMPLOYEE] Converting site ID: site_1
🔧 [EMPLOYEE] Using legacy site mapping: site_1 → 11111111-1111-1111-1111-111111111111
🔧 [EMPLOYEE] Site UUID after conversion: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: Suvasam Group\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Pump machine\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* 0d5c796c\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
2025-06-18T04:39:47.749Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMzVFQkE4MjU5MTI5MzlFREQwAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T04:39:48.787Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:39:49.145Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T04:39:50.200Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:02:35.551Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTAxNUZBMTE2Mzg2MDlBNUUyOTdCMTA1QkRBOTgwRUQA',
  timestamp: '1750222954'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTAxNUZBMTE2Mzg2MDlBNUUyOTdCMTA1QkRBOTgwRUQA",
  "timestamp": "1750222954",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNkZDNkZBNEQzNEE1NkVFRDEwAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:02:39.238Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:02:39.288Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:02:46.713Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNzZCNTRCM0I0NkNCMjQ2NkQ4MjA2MkMyNTQxOUU2Q0IA',
  timestamp: '1750222965'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNkZDNkZBNEQzNEE1NkVFRDEwAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNzZCNTRCM0I0NkNCMjQ2NkQ4MjA2MkMyNTQxOUU2Q0IA",
  "timestamp": "1750222965",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'site_1',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Real employee selected site: site_1
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:312:30)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMUVBMEUyNTY3RkUzOEE1ODA4AA=='
    }
  ]
}
2025-06-18T05:02:49.196Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [DB] New client connected
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:359:41)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:317:9)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-18T05:02:49.439Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNEZFM0NBQkFGREYzRjM5Mjg0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:02:50.611Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:02:50.957Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMEI3ODMxMUE5Mzg2NUYyMUI4AA=='
    }
  ]
}
2025-06-18T05:02:52.273Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:02:52.633Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggN0Y4OTEwQzM1OTUyNzg4NTJEQ0NCQUY3ODU4Nzc4M0QA',
  timestamp: '1750222971'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNEZFM0NBQkFGREYzRjM5Mjg0AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggN0Y4OTEwQzM1OTUyNzg4NTJEQ0NCQUY3ODU4Nzc4M0QA",
  "timestamp": "1750222971",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
2025-06-18T05:02:52.639Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_1',
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNjI3MkQzODM5MUNDRkEwN0FFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:02:55.272Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:02:55.637Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:03:02.570Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTVGMzZFN0Y0NEZENkIyQ0I1MUY4OTczRDRGQzI2OUIA',
  timestamp: '1750222981'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNjI3MkQzODM5MUNDRkEwN0FFAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTVGMzZFN0Y0NEZENkIyQ0I1MUY4OTczRDRGQzI2OUIA",
  "timestamp": "1750222981",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSN0MyNzRGOTk2RkQ1OEVBQzk4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:03:05.351Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:03:05.376Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:03:09.960Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTk1QTczMUM5RkUxRDEzMEQwQzIxNjhGNzhCOEQ1QTEA',
  timestamp: '1750222989'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTk1QTczMUM5RkUxRDEzMEQwQzIxNjhGNzhCOEQ1QTEA",
  "timestamp": "1750222989",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQ0M2ODMxOTI5NTlDOThFRUJEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:03:12.280Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:03:12.725Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:04:15.655Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRTBCQjlFQzZGOEM5MDE2OTNGQUE5RDA0OEVEMjI3MDUA',
  timestamp: '1750223054'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRTBCQjlFQzZGOEM5MDE2OTNGQUE5RDA0OEVEMjI3MDUA",
  "timestamp": "1750223054",
  "text": {
    "body": "Comparing"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Comparing"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Comparing',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSM0MxMjNCQjA3MjBEREY5MkQzAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:04:18.672Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:04:18.793Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:05:09.873Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQzZBQTI3OEQyODdEN0QzNjM2QUY5RjUyRDQ3MjZCRDcA',
  timestamp: '1750223107'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQzZBQTI3OEQyODdEN0QzNjM2QUY5RjUyRDQ3MjZCRDcA",
  "timestamp": "1750223107",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "p74oyy7NXmb8jIdum2Oa0eRHxRf2FgNhmELw/uM33ZM=",
    "id": "1233423661664898"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMkUzMDU3REE3OTlFNTVEOTUzAA=='
    }
  ]
}
2025-06-18T05:05:12.474Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:05:13.355Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/6cfbbb89-51f9-48cb-9978-913f9fd02bec.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/6cfbbb89-51f9-48cb-9978-913f9fd02bec.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNkNENkJFRjc3RkFDRkZBQjMxAA=='
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: 'site_1',
  selected_site: 'site_1',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: false
}
🔧 [EMPLOYEE] Converting site ID: site_1
🔧 [EMPLOYEE] Using legacy site mapping: site_1 → 11111111-1111-1111-1111-111111111111
🔧 [EMPLOYEE] Site UUID after conversion: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: Suvasam Group\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Comparing\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* de02cdd3\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
2025-06-18T05:05:17.136Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:05:17.451Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTlCQTcxMEJGQzUwMkYxQUE4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:05:18.154Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:05:18.671Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:06:43.907Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRjUyMUE1OEY1NDNBNTIwNjcwNDRDQ0MxMkI2OTE0RDcA',
  timestamp: '1750223203'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRjUyMUE1OEY1NDNBNTIwNjcwNDRDQ0MxMkI2OTE0RDcA",
  "timestamp": "1750223203",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRTRERDBFOUU4MzNGNkM3QTBDAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:06:46.925Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:06:47.446Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:07:23.457Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRTc4QzAwMEQyNDNDODA3OTM1MUJEQjVFQzg5MDI5QTkA',
  timestamp: '1750223242'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRTRERDBFOUU4MzNGNkM3QTBDAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRTc4QzAwMEQyNDNDODA3OTM1MUJEQjVFQzg5MDI5QTkA",
  "timestamp": "1750223242",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'site_1',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Real employee selected site: site_1
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:312:30)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNUI2ODMyODFDMEMyNzRFNjFCAA=='
    }
  ]
}
2025-06-18T05:07:27.280Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:07:27.495Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [DB] New client connected
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:359:41)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:317:9)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMUUxOTQ5Qzk0QzhEQjIyRjFEAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:07:28.885Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:07:29.305Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQTdDMDI3RTMxNTAzOUFGQUQ2AA=='
    }
  ]
}
2025-06-18T05:07:30.775Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:07:31.183Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:07:33.479Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQzUzQzdGQzQyNzY1NTY4RkFGODQ1NTJERTRGOEJCOTgA',
  timestamp: '1750223252'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMUUxOTQ5Qzk0QzhEQjIyRjFEAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQzUzQzdGQzQyNzY1NTY4RkFGODQ1NTJERTRGOEJCOTgA",
  "timestamp": "1750223252",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
❌ [TIMEOUT] Database connection test failed: Error: Database connection test timed out after 3000ms
    at Timeout.<anonymous> (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:18:20)
    at listOnTimeout (node:internal/timers:581:17)
    at process.processTimers (node:internal/timers:519:7)
⚠️ [HANDLER] Database not available, continuing without DB features
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
⚠️ [HANDLER] Using temporary session (DB unavailable)
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSREI1MzBFNzA3NjhGODI2MEI4AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:07:39.997Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:07:40.374Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:07:53.798Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRUREMTdENkE5MUMzNEEyOTE4QThGMEI4MUI5OTI2MDQA',
  timestamp: '1750223272'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSREI1MzBFNzA3NjhGODI2MEI4AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRUREMTdENkE5MUMzNEEyOTE4QThGMEI4MUI5OTI2MDQA",
  "timestamp": "1750223272",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'site_1',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Real employee selected site: site_1
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:312:30)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQ0U5Q0JFMTkzMDhEMDQ1MjA5AA=='
    }
  ]
}
✅ [DB] New client connected
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:359:41)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:317:9)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-18T05:07:56.366Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:07:56.695Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzY4MUJFQjZEMzY4NTAxRjlCAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:07:57.713Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:07:57.964Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMUQxNUExRTBDQjcwNUVEN0U1AA=='
    }
  ]
}
2025-06-18T05:07:59.352Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:07:59.760Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:08:01.885Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDI4Q0E1NEVFREY1QTUxQ0ZDMDY2QTUyNkY3NUREMDMA',
  timestamp: '1750223280'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzY4MUJFQjZEMzY4NTAxRjlCAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDI4Q0E1NEVFREY1QTUxQ0ZDMDY2QTUyNkY3NUREMDMA",
  "timestamp": "1750223280",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_1',
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMTEzMTU3RkYxMDUwN0M5NDZFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:08:04.819Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:08:04.938Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:08:18.526Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQkMwN0Q1RUE5M0RCQjJCOUE5RUJBREYwRDg4QjIyNUYA',
  timestamp: '1750223297'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMTEzMTU3RkYxMDUwN0M5NDZFAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQkMwN0Q1RUE5M0RCQjJCOUE5RUJBREYwRDg4QjIyNUYA",
  "timestamp": "1750223297",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRDMyQkVDMjNDQUI1NzAzQ0VBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:08:21.826Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:08:22.107Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:08:26.884Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQ0M3NURDODU3MkUyRUZGNUM1NTVBMzc3RDg2NjdDQzEA',
  timestamp: '1750223306'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQ0M3NURDODU3MkUyRUZGNUM1NTVBMzc3RDg2NjdDQzEA",
  "timestamp": "1750223306",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRkRCRkNCOTQyNUI5Q0JGOUZBAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:08:29.029Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:08:29.511Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:08:51.473Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggM0Q2MEJCQjZGRUQ0QkIyQTVGNjJFRkUzRTNDNjcwNkMA',
  timestamp: '1750223330'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggM0Q2MEJCQjZGRUQ0QkIyQTVGNjJFRkUzRTNDNjcwNkMA",
  "timestamp": "1750223330",
  "text": {
    "body": "Fabrication kam"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Fabrication kam"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Fabrication kam',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRDc1QTM4NDU0NTNCQkVCMkU0AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:08:53.931Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:08:54.241Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:09:39.909Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTUyOTM3ODcwODU4RjkxNzVCOUEzQTNENTUwODBDOUYA',
  timestamp: '1750223377'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQTUyOTM3ODcwODU4RjkxNzVCOUEzQTNENTUwODBDOUYA",
  "timestamp": "1750223377",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "+NEc7DHLLc7+o2w1b0otRSMtu5ubDg64L5buygiEhQY=",
    "id": "1119857333300511"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMkFDQURCMUU2NjJFNUU2MDQ1AA=='
    }
  ]
}
2025-06-18T05:09:42.771Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:09:43.391Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/aa5c44f9-6f43-4819-b357-d253e296fd43.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/aa5c44f9-6f43-4819-b357-d253e296fd43.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMDkwQ0EwMTVENUQzNTQ4MUFGAA=='
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: 'site_1',
  selected_site: 'site_1',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: false
}
🔧 [EMPLOYEE] Converting site ID: site_1
🔧 [EMPLOYEE] Using legacy site mapping: site_1 → 11111111-1111-1111-1111-111111111111
🔧 [EMPLOYEE] Site UUID after conversion: 11111111-1111-1111-1111-111111111111
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: Suvasam Group\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Fabrication kam\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* b9d8e385\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
2025-06-18T05:09:47.807Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMDYwOEEyOTZFMEQxNDcxNTY2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T05:09:48.259Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:09:48.793Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T05:09:49.126Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:17:13.892Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMDlGMTlDNkJBNTI3OTQzOTFERkFCNDdGQTYxMzU2QkUA',
  timestamp: '1750227432'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMDlGMTlDNkJBNTI3OTQzOTFERkFCNDdGQTYxMzU2QkUA",
  "timestamp": "1750227432",
  "text": {
    "body": "Hi"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Hi"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Hi',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
    },
    "action": {
      "button": "સાઈટ પસંદ કરો",
      "sections": [
        {
          "title": "ઉપલબ્ધ સાઈટ્સ",
          "rows": [
            {
              "id": "site_1",
              "title": "🏗️ Suvasam Group",
              "description": "Commerical, Gota\n"
            },
            {
              "id": "site_2",
              "title": "🏗️ Samyak",
              "description": "Residential, Gota"
            },
            {
              "id": "site_3",
              "title": "🏗️ Stark Torre",
              "description": "Residential, Science City"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRDRGMDE2MjI5RUQ5NjJCMkQyAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T06:17:17.359Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:17:17.610Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:17:42.754Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNkIzM0QwRjkyRkVBOEVCNTEzQTA5MTI1NDM0QTQ4OTYA',
  timestamp: '1750227461'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRDRGMDE2MjI5RUQ5NjJCMkQyAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNkIzM0QwRjkyRkVBOEVCNTEzQTA5MTI1NDM0QTQ4OTYA",
  "timestamp": "1750227461",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "site_1",
      "title": "🏗️ Suvasam Group",
      "description": "Commerical, Gota\n"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "site_1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: select_site
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'site_1',
  sessionIntent: null,
  sessionStep: 'select_site',
  selectedSite: undefined,
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Handling site selection for real employee
👷‍♂️ [EMPLOYEE] Real employee selected site: site_1
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:312:30)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQjE4RUIzMEI3NEU0MDRFRTAyAA=='
    }
  ]
}
✅ [DB] New client connected
Error fetching site name: error: invalid input syntax for type uuid: "site_1"
    at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
    at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:878:26)
    at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:359:41)
    at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:317:9)
    at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:73:13)
    at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/flows/employeeFlow.js:38:13)
    at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/services/messageHandler.js:118:17)
    at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/routes/webhook.js:61:13 {
  length: 138,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'uuid.c',
  line: '133',
  routine: 'string_to_uuid'
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "log_activity",
            "title": "📝 કામની નોંધ કરો"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "request_materials",
            "title": "📦 સામગ્રીની માંગ"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "track_invoices",
            "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
          }
        }
      ]
    }
  }
}
2025-06-18T06:17:45.862Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:17:45.926Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMzRENkFFQjM1NDlDNzBGQTU3AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T06:17:46.544Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "વધારાના વિકલ્પો:"
    },
    "action": {
      "button": "વધુ વિકલ્પો",
      "sections": [
        {
          "title": "વધુ વિકલ્પો",
          "rows": [
            {
              "id": "view_dashboard",
              "title": "📊 ડેશબોર્ડ જુઓ",
              "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
            },
            {
              "id": "help",
              "title": "❓ મદદ",
              "description": "મદદ અને સહાય મેળવો"
            },
            {
              "id": "contact_admin",
              "title": "📞 એડમિનનો સંપર્ક",
              "description": "વહીવટીતંત્રનો સંપર્ક કરો"
            }
          ]
        }
      ]
    }
  }
}
2025-06-18T06:17:47.000Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQTg5MjVEQTgwOTJCMURGQ0U2AA=='
    }
  ]
}
2025-06-18T06:17:48.092Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:17:48.329Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNTMzMjE1MkY4QzZGRTk2QzgyQTdGNjUxNjkwM0Q3QzcA',
  timestamp: '1750227467'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMzRENkFFQjM1NDlDNzBGQTU3AA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNTMzMjE1MkY4QzZGRTk2QzgyQTdGNjUxNjkwM0Q3QzcA",
  "timestamp": "1750227467",
  "type": "interactive",
  "interactive": {
    "type": "button_reply",
    "button_reply": {
      "id": "log_activity",
      "title": "📝 કામની નોંધ કરો"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
2025-06-18T06:17:48.537Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "log_activity"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: none, Step: none
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'log_activity',
  sessionIntent: null,
  sessionStep: null,
  selectedSite: 'site_1',
  isAdminImpersonation: undefined
}
👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_1
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "interactive",
  "interactive": {
    "type": "list",
    "body": {
      "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
    },
    "action": {
      "button": "પ્રવૃત્તિ પસંદ કરો",
      "sections": [
        {
          "title": "પ્રવૃત્તિના પ્રકારો",
          "rows": [
            {
              "id": "construction",
              "title": "🔨 બાંધકામ કાર્ય",
              "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
            },
            {
              "id": "inspection",
              "title": "🔍 તપાસ",
              "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
            },
            {
              "id": "maintenance",
              "title": "🔧 જાળવણી",
              "description": "સાધનો અને સાઈટની જાળવણી"
            },
            {
              "id": "planning",
              "title": "📋 આયોજન",
              "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
            },
            {
              "id": "other",
              "title": "📝 અન્ય",
              "description": "અન્ય કામની પ્રવૃત્તિઓ"
            }
          ]
        }
      ]
    }
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRkNBMjQ3NzA4RjBDOEY5M0ZFAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T06:17:51.157Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:17:51.445Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:17:57.497Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'interactive',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggM0ZDQjc3QkRBRDQxM0M2MDA1NDkxQUQ1NEY2MkNCMTEA',
  timestamp: '1750227476'
}
[WEBHOOK] Message content: {
  "context": {
    "from": "917383489532",
    "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRkNBMjQ3NzA4RjBDOEY5M0ZFAA=="
  },
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggM0ZDQjc3QkRBRDQxM0M2MDA1NDkxQUQ1NEY2MkNCMTEA",
  "timestamp": "1750227476",
  "type": "interactive",
  "interactive": {
    "type": "list_reply",
    "list_reply": {
      "id": "inspection",
      "title": "🔍 તપાસ",
      "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
    }
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "inspection"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: select_activity_type
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'inspection',
  sessionIntent: 'log_activity',
  sessionStep: 'select_activity_type',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMDZEMzUzQkVCODFEQjgxRkM2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T06:18:00.061Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:18:00.266Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:18:06.140Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQ0I0MTMwOEJCNEQ3Qzg4RkZFMkRBRjJBM0E1NDI5M0MA',
  timestamp: '1750227485'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQ0I0MTMwOEJCNEQ3Qzg4RkZFMkRBRjJBM0E1NDI5M0MA",
  "timestamp": "1750227485",
  "text": {
    "body": "1"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "1"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_hours
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '1',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_hours',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzJDQjY3ODQ0RkI1MjdCRjE2AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T06:18:08.456Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:18:08.982Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:21:56.814Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'text',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQkU2NUY3OTA1REEzOUVERjA5Nzg2RkY0OEIzRTk0MkYA',
  timestamp: '1750227715'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggQkU2NUY3OTA1REEzOUVERjA5Nzg2RkY0OEIzRTk0MkYA",
  "timestamp": "1750227715",
  "text": {
    "body": "Comering kam"
  },
  "type": "text"
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: "Comering kam"
📸 [HANDLER] Has Image: false
🎯 [HANDLER] Session: log_activity, Step: enter_description
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: 'Comering kam',
  sessionIntent: 'log_activity',
  sessionStep: 'enter_description',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTU0Mjc5MjYzNTRDODAzMEQ1AA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T06:22:00.081Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:22:00.213Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:22:45.353Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📨 [WEBHOOK] Received message from +919723132143: {
  type: 'image',
  id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMjlGRTZCNDhGNThBMzY3QTA1RDREMzBGQzYwNzVFQ0YA',
  timestamp: '1750227763'
}
[WEBHOOK] Message content: {
  "from": "919723132143",
  "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMjlGRTZCNDhGNThBMzY3QTA1RDREMzBGQzYwNzVFQ0YA",
  "timestamp": "1750227763",
  "type": "image",
  "image": {
    "mime_type": "image/jpeg",
    "sha256": "n63PDTx8Lf4pcWqy34JW3aYrrbIeOiprtZqQzb84vL0=",
    "id": "950571390431366"
  }
}
📤 [WEBHOOK] Calling messageHandler.handleMessage...
🎯 [HANDLER] Starting handleMessage...
📱 [HANDLER] Normalized phone: +919723132143
🗄️ [HANDLER] Testing database connection...
✅ [DB] New client connected
📝 [HANDLER] Logging message...
👁️ [HANDLER] Marking message as read...
👤 [HANDLER] Getting/creating user...
✅ [HANDLER] User obtained: employee
🔄 [HANDLER] Getting/creating session...
✅ [HANDLER] Session obtained
👤 [HANDLER] User: employee, Phone: +919723132143
💬 [HANDLER] Message: ""
📸 [HANDLER] Has Image: true
🎯 [HANDLER] Session: log_activity, Step: upload_image
🚦 [HANDLER] Routing to employee flow...
👷‍♂️ [EMPLOYEE] Employee flow called with: {
  phone: '+919723132143',
  messageText: '',
  sessionIntent: 'log_activity',
  sessionStep: 'upload_image',
  selectedSite: 'site_1',
  isAdminImpersonation: false
}
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNERBQkJENjhENTk3RTA5QzFCAA=='
    }
  ]
}
2025-06-18T06:22:47.906Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:22:48.732Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
✅ File uploaded successfully:
🔑 Key: activities/f2f46e00-bf4f-45ab-8c16-5eec6b51e075.jpg
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/f2f46e00-bf4f-45ab-8c16-5eec6b51e075.jpg
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNUQ0NUVBMTZFRkI3MTgzODk1AA=='
    }
  ]
}
🔧 [EMPLOYEE] Completing activity log with data: {
  site_id: 'site_1',
  selected_site: 'site_1',
  activity_type: 'inspection',
  hours: 1,
  is_admin_impersonation: false
}
🔧 [EMPLOYEE] Converting site ID: site_1
🔧 [EMPLOYEE] Using legacy site mapping: site_1 → 11111111-1111-1111-1111-111111111111
🔧 [EMPLOYEE] Site UUID after conversion: 11111111-1111-1111-1111-111111111111
2025-06-18T06:22:52.111Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
📤 Sending message to WhatsApp API...
🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
📱 Phone Number ID: 652783161256584
🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
📦 Payload: {
  "messaging_product": "whatsapp",
  "to": "+919723132143",
  "type": "text",
  "text": {
    "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: Suvasam Group\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Comering kam\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* 161071cf\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
  }
}
✅ Message sent successfully: {
  messaging_product: 'whatsapp',
  contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
  messages: [
    {
      id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNTUxMDUxQzVENTA5QjNDNEYxAA=='
    }
  ]
}
✅ [HANDLER] Flow handling completed
✅ [WEBHOOK] Message handled successfully
2025-06-18T06:22:53.336Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:23:00.189Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
2025-06-18T06:23:00.451Z - POST /webhook
🚀 [WEBHOOK] Starting webhook processing...
🔍 [WEBHOOK] Environment check: {
  NODE_ENV: 'development',
  HAS_WHATSAPP_TOKEN: true,
  HAS_PHONE_ID: true,
  HAS_DB_URL: true,
  DB_URL_LENGTH: 110
}
📭 [WEBHOOK] No messages in webhook payload
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 5s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 6s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 32s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 5s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 5s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 5s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 4s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

node:internal/modules/cjs/loader:1148
  throw err;
  ^

Error: Cannot find module '/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist/index.js'
    at Module._resolveFilename (node:internal/modules/cjs/loader:1145:15)
    at Module._load (node:internal/modules/cjs/loader:986:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-18T08:27:56.382Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": true,
    "hasAccessToken": true,
    "hasRefreshToken": true,
    "isExpired": true,
    "expiresAt": "2025-06-16T19:36:54.780Z",
    "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
    "createdAt": "2025-06-16T18:21:16.075Z"
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
🚀 Server running on port 3011
📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
🔍 Health check: http://localhost:3011/health
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 5s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist-backend/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-18T08:30:47.579Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": true,
    "hasAccessToken": true,
    "hasRefreshToken": true,
    "isExpired": true,
    "expiresAt": "2025-06-16T19:36:54.780Z",
    "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
    "createdAt": "2025-06-16T18:21:16.075Z"
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/index.js:56:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist-backend/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-18T08:31:09.503Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": true,
    "hasAccessToken": true,
    "hasRefreshToken": true,
    "isExpired": true,
    "expiresAt": "2025-06-16T19:36:54.780Z",
    "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
    "createdAt": "2025-06-16T18:21:16.075Z"
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/index.js:56:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 6s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist-backend/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-18T08:31:36.346Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": true,
    "hasAccessToken": true,
    "hasRefreshToken": true,
    "isExpired": true,
    "expiresAt": "2025-06-16T19:36:54.780Z",
    "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
    "createdAt": "2025-06-16T18:21:16.075Z"
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/index.js:56:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist-backend/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-18T08:31:59.278Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": true,
    "hasAccessToken": true,
    "hasRefreshToken": true,
    "isExpired": true,
    "expiresAt": "2025-06-16T19:36:54.780Z",
    "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
    "createdAt": "2025-06-16T18:21:16.075Z"
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/index.js:56:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist-backend/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-18T08:32:19.974Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": true,
    "hasAccessToken": true,
    "hasRefreshToken": true,
    "isExpired": true,
    "expiresAt": "2025-06-16T19:36:54.780Z",
    "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
    "createdAt": "2025-06-16T18:21:16.075Z"
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/index.js:56:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist-backend/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-18T08:32:46.382Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": true,
    "hasAccessToken": true,
    "hasRefreshToken": true,
    "isExpired": true,
    "expiresAt": "2025-06-16T19:36:54.780Z",
    "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
    "createdAt": "2025-06-16T18:21:16.075Z"
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/index.js:56:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist-backend/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-18T08:33:09.126Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": true,
    "hasAccessToken": true,
    "hasRefreshToken": true,
    "isExpired": true,
    "expiresAt": "2025-06-16T19:36:54.780Z",
    "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
    "createdAt": "2025-06-16T18:21:16.075Z"
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/index.js:56:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 5s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist-backend/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-18T08:33:32.463Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": true,
    "hasAccessToken": true,
    "hasRefreshToken": true,
    "isExpired": true,
    "expiresAt": "2025-06-16T19:36:54.780Z",
    "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
    "createdAt": "2025-06-16T18:21:16.075Z"
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/index.js:56:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start
> node dist-backend/index.js

🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
🔧 R2 Service initialized:
📦 Bucket: reeva-erp
🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
🏗️ [HANDLER] Initializing MessageHandler...
🔧 WhatsApp Service initialized:
📱 Phone Number ID: 652783161256584
🔐 Token exists: true
🔐 Token length: 199
🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[36m[2025-06-18T08:33:54.952Z] INFO: Zoho routes initialized[0m
[36mData:[0m {
  "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
  "ZOHO_APP_PASSWORD_LENGTH": 12,
  "ZOHO_CLIENT_ID": "Present",
  "tokenStatus": {
    "hasAuthCode": true,
    "hasAccessToken": true,
    "hasRefreshToken": true,
    "isExpired": true,
    "expiresAt": "2025-06-16T19:36:54.780Z",
    "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
    "createdAt": "2025-06-16T18:21:16.075Z"
  }
}
🔄 [DB] Testing connection...
🔄 [DB] Creating new database pool...
✅ [DB] Database pool created
✅ [DB] New client connected
✅ [DB] Client acquired, testing query...
✅ [DB] Database connection and query successful
🔄 [DB] Releasing client...
node:events:497
      throw er; // Unhandled 'error' event
      ^

Error: listen EADDRINUSE: address already in use :::3011
    at Server.setupListenHandle [as _listen2] (node:net:1904:16)
    at listenInCluster (node:net:1961:12)
    at Server.listen (node:net:2063:7)
    at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
    at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/index.js:56:13)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
Emitted 'error' event on Server instance at:
    at emitErrorNT (node:net:1940:8)
    at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
  code: 'EADDRINUSE',
  errno: -98,
  syscall: 'listen',
  address: '::',
  port: 3011
}

Node.js v20.16.0
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build:all
> npm run build && npm run frontend:build

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 frontend:build
> vite build

[33mThe CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.[39m
vite v5.4.10 building for production...
transforming...
Browserslist: browsers data (caniuse-lite) is 9 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 1820 modules transformed.
rendering chunks...
computing gzip size...
dist/index.html                    1.17 kB │ gzip:   0.53 kB
dist/assets/index-C5MwRBDM.css    62.59 kB │ gzip:  11.02 kB
dist/assets/browser-V56HFMpC.js    0.30 kB │ gzip:   0.25 kB
dist/assets/index-C3R84W5S.js    942.28 kB │ gzip: 246.44 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 9.48s
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start:all
> concurrently "npm run start" "npm run frontend:preview"

[0] npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
[1] npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
[0] 
[0] > site-bot@1.0.0 start
[0] > node dist-backend/index.js
[0] 
[1] 
[1] > site-bot@1.0.0 frontend:preview
[1] > vite preview
[1] 
[1] [33mThe CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.[39m
[1] Port 4173 is in use, trying another one...
[1]   ➜  Local:   http://localhost:4174/
[1]   ➜  Network: http://192.168.1.44:4174/
[1]   ➜  Network: http://100.107.145.14:4174/
[1]   ➜  Network: http://172.20.0.1:4174/
[1]   ➜  Network: http://172.18.0.1:4174/
[0] 🔧 WhatsApp Service initialized:
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token exists: true
[0] 🔐 Token length: 199
[0] 🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[0] 🔧 R2 Service initialized:
[0] 📦 Bucket: reeva-erp
[0] 🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
[0] 🏗️ [HANDLER] Initializing MessageHandler...
[0] 🔧 WhatsApp Service initialized:
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token exists: true
[0] 🔐 Token length: 199
[0] 🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[0] [36m[2025-06-18T08:34:28.446Z] INFO: Zoho routes initialized[0m
[0] [36mData:[0m {
[0]   "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
[0]   "ZOHO_APP_PASSWORD_LENGTH": 12,
[0]   "ZOHO_CLIENT_ID": "Present",
[0]   "tokenStatus": {
[0]     "hasAuthCode": true,
[0]     "hasAccessToken": true,
[0]     "hasRefreshToken": true,
[0]     "isExpired": true,
[0]     "expiresAt": "2025-06-16T19:36:54.780Z",
[0]     "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
[0]     "createdAt": "2025-06-16T18:21:16.075Z"
[0]   }
[0] }
[0] 🔄 [DB] Testing connection...
[0] 🔄 [DB] Creating new database pool...
[0] ✅ [DB] Database pool created
[0] ✅ [DB] New client connected
[0] ✅ [DB] Client acquired, testing query...
[0] ✅ [DB] Database connection and query successful
[0] 🔄 [DB] Releasing client...
[0] node:events:497
[0]       throw er; // Unhandled 'error' event
[0]       ^
[0] 
[0] Error: listen EADDRINUSE: address already in use :::3011
[0]     at Server.setupListenHandle [as _listen2] (node:net:1904:16)
[0]     at listenInCluster (node:net:1961:12)
[0]     at Server.listen (node:net:2063:7)
[0]     at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
[0]     at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/index.js:56:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0] Emitted 'error' event on Server instance at:
[0]     at emitErrorNT (node:net:1940:8)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
[0]   code: 'EADDRINUSE',
[0]   errno: -98,
[0]   syscall: 'listen',
[0]   address: '::',
[0]   port: 3011
[0] }
[0] 
[0] Node.js v20.16.0
[0] npm run start exited with code 1
[1] npm run frontend:preview exited with code SIGTERM
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 11s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build:all
> npm run build && npm run frontend:build

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 frontend:build
> vite build

[33mThe CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.[39m
vite v5.4.10 building for production...
transforming...
Browserslist: browsers data (caniuse-lite) is 9 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 1820 modules transformed.
rendering chunks...
computing gzip size...
dist/index.html                    1.17 kB │ gzip:   0.53 kB
dist/assets/index-C5MwRBDM.css    62.59 kB │ gzip:  11.02 kB
dist/assets/browser-V56HFMpC.js    0.30 kB │ gzip:   0.25 kB
dist/assets/index-C3R84W5S.js    942.28 kB │ gzip: 246.44 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 9.54s
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start:all
> concurrently "npm run start" "npm run frontend:preview"

[0] npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
[1] npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
[0] 
[0] > site-bot@1.0.0 start
[0] > node dist-backend/index.js
[0] 
[1] 
[1] > site-bot@1.0.0 frontend:preview
[1] > vite preview
[1] 
[1] [33mThe CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.[39m
[0] 🔧 WhatsApp Service initialized:
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token exists: true
[0] 🔐 Token length: 199
[0] 🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[1] Port 4173 is in use, trying another one...
[1]   ➜  Local:   http://localhost:4174/
[1]   ➜  Network: http://192.168.1.44:4174/
[1]   ➜  Network: http://100.107.145.14:4174/
[1]   ➜  Network: http://172.20.0.1:4174/
[1]   ➜  Network: http://172.18.0.1:4174/
[0] 🔧 R2 Service initialized:
[0] 📦 Bucket: reeva-erp
[0] 🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
[0] 🏗️ [HANDLER] Initializing MessageHandler...
[0] 🔧 WhatsApp Service initialized:
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token exists: true
[0] 🔐 Token length: 199
[0] 🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[0] [36m[2025-06-18T09:09:10.482Z] INFO: Zoho routes initialized[0m
[0] [36mData:[0m {
[0]   "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
[0]   "ZOHO_APP_PASSWORD_LENGTH": 12,
[0]   "ZOHO_CLIENT_ID": "Present",
[0]   "tokenStatus": {
[0]     "hasAuthCode": true,
[0]     "hasAccessToken": true,
[0]     "hasRefreshToken": true,
[0]     "isExpired": true,
[0]     "expiresAt": "2025-06-16T19:36:54.780Z",
[0]     "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
[0]     "createdAt": "2025-06-16T18:21:16.075Z"
[0]   }
[0] }
[0] 🔄 [DB] Testing connection...
[0] 🔄 [DB] Creating new database pool...
[0] ✅ [DB] Database pool created
[0] ✅ [DB] New client connected
[0] ✅ [DB] Client acquired, testing query...
[0] ✅ [DB] Database connection and query successful
[0] 🔄 [DB] Releasing client...
[0] node:events:497
[0]       throw er; // Unhandled 'error' event
[0]       ^
[0] 
[0] Error: listen EADDRINUSE: address already in use :::3011
[0]     at Server.setupListenHandle [as _listen2] (node:net:1904:16)
[0]     at listenInCluster (node:net:1961:12)
[0]     at Server.listen (node:net:2063:7)
[0]     at Function.listen (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/express/lib/application.js:635:24)
[0]     at startServer (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/index.js:56:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0] Emitted 'error' event on Server instance at:
[0]     at emitErrorNT (node:net:1940:8)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
[0]   code: 'EADDRINUSE',
[0]   errno: -98,
[0]   syscall: 'listen',
[0]   address: '::',
[0]   port: 3011
[0] }
[0] 
[0] Node.js v20.16.0
[0] npm run start exited with code 1
[1] npm run frontend:preview exited with code SIGTERM
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 3s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build:all
> npm run build && npm run frontend:build

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 frontend:build
> vite build

[33mThe CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.[39m
vite v5.4.10 building for production...
transforming...
Browserslist: browsers data (caniuse-lite) is 9 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 1820 modules transformed.
rendering chunks...
computing gzip size...
dist/index.html                    1.17 kB │ gzip:   0.53 kB
dist/assets/index-C5MwRBDM.css    62.59 kB │ gzip:  11.02 kB
dist/assets/browser-V56HFMpC.js    0.30 kB │ gzip:   0.25 kB
dist/assets/index-C3R84W5S.js    942.28 kB │ gzip: 246.44 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 9.66s
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start:all
> concurrently "npm run start" "npm run frontend:preview"

[0] npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
[1] npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
[0] 
[0] > site-bot@1.0.0 start
[0] > node dist-backend/index.js
[0] 
[1] 
[1] > site-bot@1.0.0 frontend:preview
[1] > vite preview
[1] 
[1] [33mThe CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.[39m
[1]   ➜  Local:   http://localhost:4173/
[1]   ➜  Network: http://192.168.1.44:4173/
[1]   ➜  Network: http://100.107.145.14:4173/
[1]   ➜  Network: http://172.20.0.1:4173/
[1]   ➜  Network: http://172.18.0.1:4173/
[0] 🔧 WhatsApp Service initialized:
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token exists: true
[0] 🔐 Token length: 199
[0] 🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[0] 🔧 R2 Service initialized:
[0] 📦 Bucket: reeva-erp
[0] 🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
[0] 🏗️ [HANDLER] Initializing MessageHandler...
[0] 🔧 WhatsApp Service initialized:
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token exists: true
[0] 🔐 Token length: 199
[0] 🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[0] [36m[2025-06-18T09:12:14.191Z] INFO: Zoho routes initialized[0m
[0] [36mData:[0m {
[0]   "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
[0]   "ZOHO_APP_PASSWORD_LENGTH": 12,
[0]   "ZOHO_CLIENT_ID": "Present",
[0]   "tokenStatus": {
[0]     "hasAuthCode": true,
[0]     "hasAccessToken": true,
[0]     "hasRefreshToken": true,
[0]     "isExpired": true,
[0]     "expiresAt": "2025-06-16T19:36:54.780Z",
[0]     "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
[0]     "createdAt": "2025-06-16T18:21:16.075Z"
[0]   }
[0] }
[0] 🔄 [DB] Testing connection...
[0] 🔄 [DB] Creating new database pool...
[0] ✅ [DB] Database pool created
[0] ✅ [DB] New client connected
[0] ✅ [DB] Client acquired, testing query...
[0] ✅ [DB] Database connection and query successful
[0] 🔄 [DB] Releasing client...
[0] 🚀 Server running on port 3011
[0] 📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
[0] 🔍 Health check: http://localhost:3011/health
[0] 2025-06-18T09:13:07.978Z - GET /
[0] 2025-06-18T09:13:08.484Z - GET /favicon.ico
[0] 2025-06-18T09:13:13.585Z - GET /health
[0] 2025-06-18T09:13:43.812Z - GET /webhook
[0] 🔐 Webhook verification request: { mode: undefined, token: undefined }
[0] ❌ Webhook verification failed
[1] npm run frontend:preview exited with code SIGTERM
[0] npm run start exited with code SIGTERM
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

up to date, audited 780 packages in 5s

109 packages are looking for funding
  run `npm fund` for details

8 vulnerabilities (1 low, 7 moderate)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --force

Run `npm audit` for details.
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build:all
> npm run build && npm run frontend:build

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 build
> tsc --project tsconfig.backend.json

npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 frontend:build
> vite build

[33mThe CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.[39m
vite v5.4.10 building for production...
transforming...
Browserslist: browsers data (caniuse-lite) is 9 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
✓ 1820 modules transformed.
rendering chunks...
computing gzip size...
dist/index.html                    1.17 kB │ gzip:   0.53 kB
dist/assets/index-C5MwRBDM.css    62.59 kB │ gzip:  11.02 kB
dist/assets/browser-V56HFMpC.js    0.30 kB │ gzip:   0.25 kB
dist/assets/index-C3R84W5S.js    942.28 kB │ gzip: 246.44 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
✓ built in 9.21s
npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.

> site-bot@1.0.0 start:all
> concurrently "npm run start" "npm run frontend:preview"

[0] npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
[1] npm warn cli npm v11.1.0 does not support Node.js v20.16.0. This version of npm supports the following node versions: `^20.17.0 || >=22.9.0`. You can find the latest version at https://nodejs.org/.
[0] 
[0] > site-bot@1.0.0 start
[0] > node dist-backend/index.js
[0] 
[1] 
[1] > site-bot@1.0.0 frontend:preview
[1] > vite preview
[1] 
[1] [33mThe CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.[39m
[0] 🔧 WhatsApp Service initialized:
[1]   ➜  Local:   http://localhost:4173/
[1]   ➜  Network: http://192.168.1.44:4173/
[1]   ➜  Network: http://100.107.145.14:4173/
[1]   ➜  Network: http://172.20.0.1:4173/
[1]   ➜  Network: http://172.18.0.1:4173/
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token exists: true
[0] 🔐 Token length: 199
[0] 🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[0] 🔧 R2 Service initialized:
[0] 📦 Bucket: reeva-erp
[0] 🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev
[0] 🏗️ [HANDLER] Initializing MessageHandler...
[0] 🔧 WhatsApp Service initialized:
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token exists: true
[0] 🔐 Token length: 199
[0] 🔐 Token first 20 chars: EAASY8LmFhiYBOZBkade...
[0] [36m[2025-06-18T09:17:08.714Z] INFO: Zoho routes initialized[0m
[0] [36mData:[0m {
[0]   "ZOHO_SENDER_EMAIL": "info@reevaempire.com",
[0]   "ZOHO_APP_PASSWORD_LENGTH": 12,
[0]   "ZOHO_CLIENT_ID": "Present",
[0]   "tokenStatus": {
[0]     "hasAuthCode": true,
[0]     "hasAccessToken": true,
[0]     "hasRefreshToken": true,
[0]     "isExpired": true,
[0]     "expiresAt": "2025-06-16T19:36:54.780Z",
[0]     "scope": "ZohoMail.messages.ALL ZohoMail.accounts.READ",
[0]     "createdAt": "2025-06-16T18:21:16.075Z"
[0]   }
[0] }
[0] 🔄 [DB] Testing connection...
[0] 🔄 [DB] Creating new database pool...
[0] ✅ [DB] Database pool created
[0] ✅ [DB] New client connected
[0] ✅ [DB] Client acquired, testing query...
[0] ✅ [DB] Database connection and query successful
[0] 🔄 [DB] Releasing client...
[0] 🚀 Server running on port 3011
[0] 📱 WhatsApp webhook endpoint: http://localhost:3011/webhook
[0] 🔍 Health check: http://localhost:3011/health
[0] 2025-06-18T09:18:50.279Z - GET /health
[0] 2025-06-18T09:18:57.881Z - GET /health
[0] 2025-06-18T09:20:47.558Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📨 [WEBHOOK] Received message from +19088483575: {
[0]   type: 'text',
[0]   id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTZFRDQ5QjI2OTBGNjg0RjVDNQA=',
[0]   timestamp: '1750238001'
[0] }
[0] [WEBHOOK] Message content: {
[0]   "from": "19088483575",
[0]   "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTZFRDQ5QjI2OTBGNjg0RjVDNQA=",
[0]   "timestamp": "1750238001",
[0]   "text": {
[0]     "body": "Hi"
[0]   },
[0]   "type": "text"
[0] }
[0] 📤 [WEBHOOK] Calling messageHandler.handleMessage...
[0] 🎯 [HANDLER] Starting handleMessage...
[0] 📱 [HANDLER] Normalized phone: +19088483575
[0] 🗄️ [HANDLER] Testing database connection...
[0] ✅ [DB] New client connected
[0] 📝 [HANDLER] Logging message...
[0] 👁️ [HANDLER] Marking message as read...
[0] 👤 [HANDLER] Getting/creating user...
[0] ✅ [HANDLER] User obtained: admin
[0] 🔄 [HANDLER] Getting/creating session...
[0] ✅ [HANDLER] Session obtained
[0] 👤 [HANDLER] User: admin, Phone: +19088483575
[0] 💬 [HANDLER] Message: "Hi"
[0] 📸 [HANDLER] Has Image: false
[0] 🎯 [HANDLER] Session: inventory_management, Step: main_menu
[0] 🚦 [HANDLER] Routing to admin flow...
[0] 🔧 [ADMIN] AdminFlow.handleMessage called with: {
[0]   phone: '+19088483575',
[0]   messageText: 'Hi',
[0]   sessionIntent: 'inventory_management',
[0]   sessionStep: 'main_menu',
[0]   isAdminImpersonation: undefined
[0] }
[0] 📦 [INVENTORY] InventoryFlow.handleMessage called with: {
[0]   phone: '+19088483575',
[0]   messageText: 'Hi',
[0]   interactiveData: undefined,
[0]   sessionIntent: 'inventory_management',
[0]   sessionStep: 'main_menu',
[0]   sessionData: {}
[0] }
[0] 📦 [INVENTORY] Processing step: main_menu with message: Hi interactiveData: undefined
[0] 📦 [INVENTORY] Showing main menu for phone: +19088483575 user_id: 2a155060-c282-4560-bf1e-6502ee5b10dd
[0] 📦 [INVENTORY] Sending button message with buttons: [ 'item_in', 'item_out', 'new_item' ]
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+19088483575",
[0]   "type": "interactive",
[0]   "interactive": {
[0]     "type": "button",
[0]     "body": {
[0]       "text": "📦 *Inventory Management System*\n\nWelcome to the inventory management system! \n\nSelect what you'd like to do:"
[0]     },
[0]     "action": {
[0]       "buttons": [
[0]         {
[0]           "type": "reply",
[0]           "reply": {
[0]             "id": "item_in",
[0]             "title": "📦 Item In"
[0]           }
[0]         },
[0]         {
[0]           "type": "reply",
[0]           "reply": {
[0]             "id": "item_out",
[0]             "title": "📤 Item Out"
[0]           }
[0]         },
[0]         {
[0]           "type": "reply",
[0]           "reply": {
[0]             "id": "new_item",
[0]             "title": "🆕 New Item"
[0]           }
[0]         }
[0]       ]
[0]     }
[0]   }
[0] }
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBJGOTc0NjNGOUMyMDIyQzY4RTQA'
[0]     }
[0]   ]
[0] }
[0] ✅ [HANDLER] Flow handling completed
[0] ✅ [WEBHOOK] Message handled successfully
[0] 📦 [INVENTORY] Sending additional options list
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+19088483575",
[0]   "type": "interactive",
[0]   "interactive": {
[0]     "type": "list",
[0]     "body": {
[0]       "text": "Additional inventory options:"
[0]     },
[0]     "action": {
[0]       "button": "More Options",
[0]       "sections": [
[0]         {
[0]           "title": "Reports & Analytics",
[0]           "rows": [
[0]             {
[0]               "id": "inventory_balance",
[0]               "title": "📊 Stock Balance",
[0]               "description": "View current stock levels"
[0]             },
[0]             {
[0]               "id": "day_to_day",
[0]               "title": "📅 Daily Reports",
[0]               "description": "Daily transaction log"
[0]             },
[0]             {
[0]               "id": "setup_comprehensive_inventory",
[0]               "title": "🚀 Setup Inventory",
[0]               "description": "Add all category items with 0 stock"
[0]             },
[0]             {
[0]               "id": "create_sample_data",
[0]               "title": "🧪 Sample Data",
[0]               "description": "Add sample items with stock for testing"
[0]             }
[0]           ]
[0]         }
[0]       ]
[0]     }
[0]   }
[0] }
[0] 2025-06-18T09:20:51.786Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI3RUZCNzlFQTkyN0YzQzVEODcA'
[0]     }
[0]   ]
[0] }
[0] 2025-06-18T09:20:53.142Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:20:53.496Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:20:53.883Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:21:28.423Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:21:28.535Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:21:34.482Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📨 [WEBHOOK] Received message from +19088483575: {
[0]   type: 'text',
[0]   id: 'wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc1OTdENThBNzZDODEzOUZBNwA=',
[0]   timestamp: '1750238493'
[0] }
[0] [WEBHOOK] Message content: {
[0]   "from": "19088483575",
[0]   "id": "wamid.HBgLMTkwODg0ODM1NzUVAgASGBQzQTc1OTdENThBNzZDODEzOUZBNwA=",
[0]   "timestamp": "1750238493",
[0]   "text": {
[0]     "body": "Exit"
[0]   },
[0]   "type": "text"
[0] }
[0] 📤 [WEBHOOK] Calling messageHandler.handleMessage...
[0] 🎯 [HANDLER] Starting handleMessage...
[0] 📱 [HANDLER] Normalized phone: +19088483575
[0] 🗄️ [HANDLER] Testing database connection...
[0] ✅ [DB] New client connected
[0] 📝 [HANDLER] Logging message...
[0] 👁️ [HANDLER] Marking message as read...
[0] 👤 [HANDLER] Getting/creating user...
[0] ✅ [HANDLER] User obtained: admin
[0] 🔄 [HANDLER] Getting/creating session...
[0] ✅ [HANDLER] Session obtained
[0] 👤 [HANDLER] User: admin, Phone: +19088483575
[0] 💬 [HANDLER] Message: "Exit"
[0] 📸 [HANDLER] Has Image: false
[0] 🎯 [HANDLER] Session: inventory_management, Step: main_menu
[0] 🚦 [HANDLER] Routing to admin flow...
[0] 🔧 [ADMIN] AdminFlow.handleMessage called with: {
[0]   phone: '+19088483575',
[0]   messageText: 'Exit',
[0]   sessionIntent: 'inventory_management',
[0]   sessionStep: 'main_menu',
[0]   isAdminImpersonation: undefined
[0] }
[0] 📦 [INVENTORY] InventoryFlow.handleMessage called with: {
[0]   phone: '+19088483575',
[0]   messageText: 'Exit',
[0]   interactiveData: undefined,
[0]   sessionIntent: 'inventory_management',
[0]   sessionStep: 'main_menu',
[0]   sessionData: { user_id: '2a155060-c282-4560-bf1e-6502ee5b10dd' }
[0] }
[0] 📦 [INVENTORY] Processing step: main_menu with message: Exit interactiveData: undefined
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+19088483575",
[0]   "type": "text",
[0]   "text": {
[0]     "body": "🔙 Exiting inventory management..."
[0]   }
[0] }
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+19088483575', wa_id: '19088483575' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgLMTkwODg0ODM1NzUVAgARGBI0NjdFNjlDOUFFRUJENEYxREMA'
[0]     }
[0]   ]
[0] }
[0] ✅ [HANDLER] Flow handling completed
[0] ✅ [WEBHOOK] Message handled successfully
[0] 2025-06-18T09:21:37.290Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:21:37.844Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:21:37.885Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:24:32.021Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📨 [WEBHOOK] Received message from +919723132143: {
[0]   type: 'text',
[0]   id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNEM3RDMzRDIxRjBCMjY1NTgxNzczRDY4MUY0NUM2OTEA',
[0]   timestamp: '1750238670'
[0] }
[0] [WEBHOOK] Message content: {
[0]   "from": "919723132143",
[0]   "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNEM3RDMzRDIxRjBCMjY1NTgxNzczRDY4MUY0NUM2OTEA",
[0]   "timestamp": "1750238670",
[0]   "text": {
[0]     "body": "Hi"
[0]   },
[0]   "type": "text"
[0] }
[0] 📤 [WEBHOOK] Calling messageHandler.handleMessage...
[0] 🎯 [HANDLER] Starting handleMessage...
[0] 📱 [HANDLER] Normalized phone: +919723132143
[0] 🗄️ [HANDLER] Testing database connection...
[0] ✅ [DB] New client connected
[0] 📝 [HANDLER] Logging message...
[0] 👁️ [HANDLER] Marking message as read...
[0] 👤 [HANDLER] Getting/creating user...
[0] ✅ [HANDLER] User obtained: employee
[0] 🔄 [HANDLER] Getting/creating session...
[0] ✅ [HANDLER] Session obtained
[0] 👤 [HANDLER] User: employee, Phone: +919723132143
[0] 💬 [HANDLER] Message: "Hi"
[0] 📸 [HANDLER] Has Image: false
[0] 🎯 [HANDLER] Session: none, Step: none
[0] 🚦 [HANDLER] Routing to employee flow...
[0] 👷‍♂️ [EMPLOYEE] Employee flow called with: {
[0]   phone: '+919723132143',
[0]   messageText: 'Hi',
[0]   sessionIntent: null,
[0]   sessionStep: null,
[0]   selectedSite: undefined,
[0]   isAdminImpersonation: undefined
[0] }
[0] 👷‍♂️ [EMPLOYEE] Handling site selection for real employee
[0] 👷‍♂️ [EMPLOYEE] Showing site selection for employee: ebad32e3-ca8f-4efb-8784-e1f32324aeb0
[0] 👷‍♂️ [EMPLOYEE] No assigned sites, showing all active sites
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+919723132143",
[0]   "type": "interactive",
[0]   "interactive": {
[0]     "type": "list",
[0]     "body": {
[0]       "text": "કયા સાઈટ પર કામ કરવા માંગો છો?"
[0]     },
[0]     "action": {
[0]       "button": "સાઈટ પસંદ કરો",
[0]       "sections": [
[0]         {
[0]           "title": "ઉપલબ્ધ સાઈટ્સ",
[0]           "rows": [
[0]             {
[0]               "id": "site_1",
[0]               "title": "🏗️ Suvasam Group",
[0]               "description": "Commerical, Gota\n"
[0]             },
[0]             {
[0]               "id": "site_2",
[0]               "title": "🏗️ Samyak",
[0]               "description": "Residential, Gota"
[0]             },
[0]             {
[0]               "id": "site_3",
[0]               "title": "🏗️ Stark Torre",
[0]               "description": "Residential, Science City"
[0]             }
[0]           ]
[0]         }
[0]       ]
[0]     }
[0]   }
[0] }
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzk3Qzg1RkI3QjI4Nzc5NkYwAA=='
[0]     }
[0]   ]
[0] }
[0] ✅ [HANDLER] Flow handling completed
[0] ✅ [WEBHOOK] Message handled successfully
[0] 2025-06-18T09:24:35.268Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:24:35.322Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:24:42.449Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📨 [WEBHOOK] Received message from +919723132143: {
[0]   type: 'interactive',
[0]   id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRTg4MjkzRjVFMTUzNTY2NTFERTM1QTY5NDkzODFBMzYA',
[0]   timestamp: '1750238681'
[0] }
[0] [WEBHOOK] Message content: {
[0]   "context": {
[0]     "from": "917383489532",
[0]     "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSNzk3Qzg1RkI3QjI4Nzc5NkYwAA=="
[0]   },
[0]   "from": "919723132143",
[0]   "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRTg4MjkzRjVFMTUzNTY2NTFERTM1QTY5NDkzODFBMzYA",
[0]   "timestamp": "1750238681",
[0]   "type": "interactive",
[0]   "interactive": {
[0]     "type": "list_reply",
[0]     "list_reply": {
[0]       "id": "site_1",
[0]       "title": "🏗️ Suvasam Group",
[0]       "description": "Commerical, Gota\n"
[0]     }
[0]   }
[0] }
[0] 📤 [WEBHOOK] Calling messageHandler.handleMessage...
[0] 🎯 [HANDLER] Starting handleMessage...
[0] 📱 [HANDLER] Normalized phone: +919723132143
[0] 🗄️ [HANDLER] Testing database connection...
[0] 📝 [HANDLER] Logging message...
[0] 👁️ [HANDLER] Marking message as read...
[0] 👤 [HANDLER] Getting/creating user...
[0] ✅ [HANDLER] User obtained: employee
[0] 🔄 [HANDLER] Getting/creating session...
[0] ✅ [HANDLER] Session obtained
[0] 👤 [HANDLER] User: employee, Phone: +919723132143
[0] 💬 [HANDLER] Message: "site_1"
[0] 📸 [HANDLER] Has Image: false
[0] 🎯 [HANDLER] Session: none, Step: select_site
[0] 🚦 [HANDLER] Routing to employee flow...
[0] 👷‍♂️ [EMPLOYEE] Employee flow called with: {
[0]   phone: '+919723132143',
[0]   messageText: 'site_1',
[0]   sessionIntent: null,
[0]   sessionStep: 'select_site',
[0]   selectedSite: undefined,
[0]   isAdminImpersonation: undefined
[0] }
[0] 👷‍♂️ [EMPLOYEE] Handling site selection for real employee
[0] 👷‍♂️ [EMPLOYEE] Real employee selected site: site_1
[0] Error fetching site name: error: invalid input syntax for type uuid: "site_1"
[0]     at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
[0]     at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/services/flows/employeeFlow.js:878:26)
[0]     at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/services/flows/employeeFlow.js:312:30)
[0]     at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/services/flows/employeeFlow.js:73:13)
[0]     at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/services/flows/employeeFlow.js:38:13)
[0]     at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/services/messageHandler.js:118:17)
[0]     at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/routes/webhook.js:61:13 {
[0]   length: 138,
[0]   severity: 'ERROR',
[0]   code: '22P02',
[0]   detail: undefined,
[0]   hint: undefined,
[0]   position: undefined,
[0]   internalPosition: undefined,
[0]   internalQuery: undefined,
[0]   where: "unnamed portal parameter $1 = '...'",
[0]   schema: undefined,
[0]   table: undefined,
[0]   column: undefined,
[0]   dataType: undefined,
[0]   constraint: undefined,
[0]   file: 'uuid.c',
[0]   line: '133',
[0]   routine: 'string_to_uuid'
[0] }
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+919723132143",
[0]   "type": "text",
[0]   "text": {
[0]     "body": "🎉 *કર્મચારી પોર્ટલમાં આપનું સ્વાગત છે!*\n\nતમે હવે અજ્ઞાત સાઈટ માટે વેરિફાઈ થઈ ગયા છો.\n\nઆજે તમે શું કરવા માંગો છો?"
[0]   }
[0] }
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTg4NkU4NDA5RjgyREVGMUI3AA=='
[0]     }
[0]   ]
[0] }
[0] ✅ [DB] New client connected
[0] Error fetching site name: error: invalid input syntax for type uuid: "site_1"
[0]     at /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/pg-pool/index.js:45:11
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/node_modules/drizzle-orm/node-postgres/session.cjs:81:22
[0]     at async EmployeeFlow.getSiteName (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/services/flows/employeeFlow.js:878:26)
[0]     at async EmployeeFlow.showMainMenu (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/services/flows/employeeFlow.js:359:41)
[0]     at async EmployeeFlow.showWelcomeMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/services/flows/employeeFlow.js:317:9)
[0]     at async EmployeeFlow.handleSiteSelectionForEmployee (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/services/flows/employeeFlow.js:73:13)
[0]     at async EmployeeFlow.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/services/flows/employeeFlow.js:38:13)
[0]     at async MessageHandler.handleMessage (/home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/services/messageHandler.js:118:17)
[0]     at async /home/bojrick/reeva-whatsapp-crm-erp/site-bot/dist-backend/routes/webhook.js:61:13 {
[0]   length: 138,
[0]   severity: 'ERROR',
[0]   code: '22P02',
[0]   detail: undefined,
[0]   hint: undefined,
[0]   position: undefined,
[0]   internalPosition: undefined,
[0]   internalQuery: undefined,
[0]   where: "unnamed portal parameter $1 = '...'",
[0]   schema: undefined,
[0]   table: undefined,
[0]   column: undefined,
[0]   dataType: undefined,
[0]   constraint: undefined,
[0]   file: 'uuid.c',
[0]   line: '133',
[0]   routine: 'string_to_uuid'
[0] }
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+919723132143",
[0]   "type": "interactive",
[0]   "interactive": {
[0]     "type": "button",
[0]     "body": {
[0]       "text": "👷‍♂️ *કર્મચારી પોર્ટલ*\n🏗️ *સાઈટ:* અજ્ઞાત સાઈટ\n\nઆજે હું તમારી કેવી મદદ કરી શકું?"
[0]     },
[0]     "action": {
[0]       "buttons": [
[0]         {
[0]           "type": "reply",
[0]           "reply": {
[0]             "id": "log_activity",
[0]             "title": "📝 કામની નોંધ કરો"
[0]           }
[0]         },
[0]         {
[0]           "type": "reply",
[0]           "reply": {
[0]             "id": "request_materials",
[0]             "title": "📦 સામગ્રીની માંગ"
[0]           }
[0]         },
[0]         {
[0]           "type": "reply",
[0]           "reply": {
[0]             "id": "track_invoices",
[0]             "title": "🧾 ઇન્વૉઇસ ટ્રેકિંગ"
[0]           }
[0]         }
[0]       ]
[0]     }
[0]   }
[0] }
[0] 2025-06-18T09:24:44.696Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:24:45.337Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOERCNzNFNDU2ODkxN0IxNkFEAA=='
[0]     }
[0]   ]
[0] }
[0] ✅ [HANDLER] Flow handling completed
[0] ✅ [WEBHOOK] Message handled successfully
[0] 2025-06-18T09:24:46.457Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+919723132143",
[0]   "type": "interactive",
[0]   "interactive": {
[0]     "type": "list",
[0]     "body": {
[0]       "text": "વધારાના વિકલ્પો:"
[0]     },
[0]     "action": {
[0]       "button": "વધુ વિકલ્પો",
[0]       "sections": [
[0]         {
[0]           "title": "વધુ વિકલ્પો",
[0]           "rows": [
[0]             {
[0]               "id": "view_dashboard",
[0]               "title": "📊 ડેશબોર્ડ જુઓ",
[0]               "description": "તમારી પ્રવૃત્તિઓનું ડેશબોર્ડ"
[0]             },
[0]             {
[0]               "id": "help",
[0]               "title": "❓ મદદ",
[0]               "description": "મદદ અને સહાય મેળવો"
[0]             },
[0]             {
[0]               "id": "contact_admin",
[0]               "title": "📞 એડમિનનો સંપર્ક",
[0]               "description": "વહીવટીતંત્રનો સંપર્ક કરો"
[0]             }
[0]           ]
[0]         }
[0]       ]
[0]     }
[0]   }
[0] }
[0] 2025-06-18T09:24:46.715Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMjRERDZCODgwMkM0NDgzMUIyAA=='
[0]     }
[0]   ]
[0] }
[0] 2025-06-18T09:24:48.005Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:24:48.505Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:24:50.975Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📨 [WEBHOOK] Received message from +919723132143: {
[0]   type: 'interactive',
[0]   id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMjBEMEExQzg1NUNGRDA2Q0NFNDY4RjU0MzJBOUVBNEYA',
[0]   timestamp: '1750238690'
[0] }
[0] [WEBHOOK] Message content: {
[0]   "context": {
[0]     "from": "917383489532",
[0]     "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOERCNzNFNDU2ODkxN0IxNkFEAA=="
[0]   },
[0]   "from": "919723132143",
[0]   "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMjBEMEExQzg1NUNGRDA2Q0NFNDY4RjU0MzJBOUVBNEYA",
[0]   "timestamp": "1750238690",
[0]   "type": "interactive",
[0]   "interactive": {
[0]     "type": "button_reply",
[0]     "button_reply": {
[0]       "id": "log_activity",
[0]       "title": "📝 કામની નોંધ કરો"
[0]     }
[0]   }
[0] }
[0] 📤 [WEBHOOK] Calling messageHandler.handleMessage...
[0] 🎯 [HANDLER] Starting handleMessage...
[0] 📱 [HANDLER] Normalized phone: +919723132143
[0] 🗄️ [HANDLER] Testing database connection...
[0] ✅ [DB] New client connected
[0] 📝 [HANDLER] Logging message...
[0] 👁️ [HANDLER] Marking message as read...
[0] 👤 [HANDLER] Getting/creating user...
[0] ✅ [HANDLER] User obtained: employee
[0] 🔄 [HANDLER] Getting/creating session...
[0] ✅ [HANDLER] Session obtained
[0] 👤 [HANDLER] User: employee, Phone: +919723132143
[0] 💬 [HANDLER] Message: "log_activity"
[0] 📸 [HANDLER] Has Image: false
[0] 🎯 [HANDLER] Session: none, Step: none
[0] 🚦 [HANDLER] Routing to employee flow...
[0] 👷‍♂️ [EMPLOYEE] Employee flow called with: {
[0]   phone: '+919723132143',
[0]   messageText: 'log_activity',
[0]   sessionIntent: null,
[0]   sessionStep: null,
[0]   selectedSite: 'site_1',
[0]   isAdminImpersonation: undefined
[0] }
[0] 👷‍♂️ [EMPLOYEE] Starting activity logging with site: site_1
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+919723132143",
[0]   "type": "interactive",
[0]   "interactive": {
[0]     "type": "list",
[0]     "body": {
[0]       "text": "તમે કયા પ્રકારની પ્રવૃત્તિ કરી?"
[0]     },
[0]     "action": {
[0]       "button": "પ્રવૃત્તિ પસંદ કરો",
[0]       "sections": [
[0]         {
[0]           "title": "પ્રવૃત્તિના પ્રકારો",
[0]           "rows": [
[0]             {
[0]               "id": "construction",
[0]               "title": "🔨 બાંધકામ કાર્ય",
[0]               "description": "બિલ્ડિંગ અને બાંધકામના કાર્યો"
[0]             },
[0]             {
[0]               "id": "inspection",
[0]               "title": "🔍 તપાસ",
[0]               "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
[0]             },
[0]             {
[0]               "id": "maintenance",
[0]               "title": "🔧 જાળવણી",
[0]               "description": "સાધનો અને સાઈટની જાળવણી"
[0]             },
[0]             {
[0]               "id": "planning",
[0]               "title": "📋 આયોજન",
[0]               "description": "પ્રોજેક્ટ આયોજન અને સંકલન"
[0]             },
[0]             {
[0]               "id": "other",
[0]               "title": "📝 અન્ય",
[0]               "description": "અન્ય કામની પ્રવૃત્તિઓ"
[0]             }
[0]           ]
[0]         }
[0]       ]
[0]     }
[0]   }
[0] }
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQTQyQTIwMTIyQjI3QzBGMkQwAA=='
[0]     }
[0]   ]
[0] }
[0] ✅ [HANDLER] Flow handling completed
[0] ✅ [WEBHOOK] Message handled successfully
[0] 2025-06-18T09:24:53.418Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:24:53.838Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:25:02.727Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📨 [WEBHOOK] Received message from +919723132143: {
[0]   type: 'interactive',
[0]   id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDk5MkE0QzFEMkEzMTIwM0NDQUY5OUE4RUJERkVFRUYA',
[0]   timestamp: '1750238701'
[0] }
[0] [WEBHOOK] Message content: {
[0]   "context": {
[0]     "from": "917383489532",
[0]     "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSQTQyQTIwMTIyQjI3QzBGMkQwAA=="
[0]   },
[0]   "from": "919723132143",
[0]   "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggNDk5MkE0QzFEMkEzMTIwM0NDQUY5OUE4RUJERkVFRUYA",
[0]   "timestamp": "1750238701",
[0]   "type": "interactive",
[0]   "interactive": {
[0]     "type": "list_reply",
[0]     "list_reply": {
[0]       "id": "inspection",
[0]       "title": "🔍 તપાસ",
[0]       "description": "ગુણવત્તા તપાસ અને નિરીક્ષણ"
[0]     }
[0]   }
[0] }
[0] 📤 [WEBHOOK] Calling messageHandler.handleMessage...
[0] 🎯 [HANDLER] Starting handleMessage...
[0] 📱 [HANDLER] Normalized phone: +919723132143
[0] 🗄️ [HANDLER] Testing database connection...
[0] 📝 [HANDLER] Logging message...
[0] 👁️ [HANDLER] Marking message as read...
[0] 👤 [HANDLER] Getting/creating user...
[0] ✅ [HANDLER] User obtained: employee
[0] 🔄 [HANDLER] Getting/creating session...
[0] ✅ [HANDLER] Session obtained
[0] 👤 [HANDLER] User: employee, Phone: +919723132143
[0] 💬 [HANDLER] Message: "inspection"
[0] 📸 [HANDLER] Has Image: false
[0] 🎯 [HANDLER] Session: log_activity, Step: select_activity_type
[0] 🚦 [HANDLER] Routing to employee flow...
[0] 👷‍♂️ [EMPLOYEE] Employee flow called with: {
[0]   phone: '+919723132143',
[0]   messageText: 'inspection',
[0]   sessionIntent: 'log_activity',
[0]   sessionStep: 'select_activity_type',
[0]   selectedSite: 'site_1',
[0]   isAdminImpersonation: false
[0] }
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+919723132143",
[0]   "type": "text",
[0]   "text": {
[0]     "body": "તમે કેટલા કલાક કામ કર્યું? (નંબર દાખલ કરો):"
[0]   }
[0] }
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSN0UxRUQ1NTEwREQxNkRFMzZFAA=='
[0]     }
[0]   ]
[0] }
[0] ✅ [HANDLER] Flow handling completed
[0] ✅ [WEBHOOK] Message handled successfully
[0] 2025-06-18T09:25:05.042Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:25:05.287Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:25:09.322Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📨 [WEBHOOK] Received message from +919723132143: {
[0]   type: 'text',
[0]   id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMjMwNUIzNjRGQUFERDUxQjhDRkRFMjJCOTQ5MjI1OTQA',
[0]   timestamp: '1750238708'
[0] }
[0] [WEBHOOK] Message content: {
[0]   "from": "919723132143",
[0]   "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggMjMwNUIzNjRGQUFERDUxQjhDRkRFMjJCOTQ5MjI1OTQA",
[0]   "timestamp": "1750238708",
[0]   "text": {
[0]     "body": "1"
[0]   },
[0]   "type": "text"
[0] }
[0] 📤 [WEBHOOK] Calling messageHandler.handleMessage...
[0] 🎯 [HANDLER] Starting handleMessage...
[0] 📱 [HANDLER] Normalized phone: +919723132143
[0] 🗄️ [HANDLER] Testing database connection...
[0] 📝 [HANDLER] Logging message...
[0] 👁️ [HANDLER] Marking message as read...
[0] 👤 [HANDLER] Getting/creating user...
[0] ✅ [HANDLER] User obtained: employee
[0] 🔄 [HANDLER] Getting/creating session...
[0] ✅ [HANDLER] Session obtained
[0] 👤 [HANDLER] User: employee, Phone: +919723132143
[0] 💬 [HANDLER] Message: "1"
[0] 📸 [HANDLER] Has Image: false
[0] 🎯 [HANDLER] Session: log_activity, Step: enter_hours
[0] 🚦 [HANDLER] Routing to employee flow...
[0] 👷‍♂️ [EMPLOYEE] Employee flow called with: {
[0]   phone: '+919723132143',
[0]   messageText: '1',
[0]   sessionIntent: 'log_activity',
[0]   sessionStep: 'enter_hours',
[0]   selectedSite: 'site_1',
[0]   isAdminImpersonation: false
[0] }
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+919723132143",
[0]   "type": "text",
[0]   "text": {
[0]     "body": "તમે શું કામ કર્યું તેનું વર્ણન કરો (વૈકલ્પિક - 'skip' ટાઈપ કરો છોડવા માટે):"
[0]   }
[0] }
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRDBCNUYwN0UyQkEzNUJDNzZDAA=='
[0]     }
[0]   ]
[0] }
[0] ✅ [HANDLER] Flow handling completed
[0] ✅ [WEBHOOK] Message handled successfully
[0] 2025-06-18T09:25:11.752Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:25:12.346Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:26:38.594Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📨 [WEBHOOK] Received message from +919723132143: {
[0]   type: 'text',
[0]   id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRUE3MzQwQzM0MzA4MkE3NzVFQzVBNTc0RUI4RTJCQTQA',
[0]   timestamp: '1750238797'
[0] }
[0] [WEBHOOK] Message content: {
[0]   "from": "919723132143",
[0]   "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggRUE3MzQwQzM0MzA4MkE3NzVFQzVBNTc0RUI4RTJCQTQA",
[0]   "timestamp": "1750238797",
[0]   "text": {
[0]     "body": "Salia Walwa"
[0]   },
[0]   "type": "text"
[0] }
[0] 📤 [WEBHOOK] Calling messageHandler.handleMessage...
[0] 🎯 [HANDLER] Starting handleMessage...
[0] 📱 [HANDLER] Normalized phone: +919723132143
[0] 🗄️ [HANDLER] Testing database connection...
[0] ✅ [DB] New client connected
[0] 📝 [HANDLER] Logging message...
[0] 👁️ [HANDLER] Marking message as read...
[0] 👤 [HANDLER] Getting/creating user...
[0] ✅ [HANDLER] User obtained: employee
[0] 🔄 [HANDLER] Getting/creating session...
[0] ✅ [HANDLER] Session obtained
[0] 👤 [HANDLER] User: employee, Phone: +919723132143
[0] 💬 [HANDLER] Message: "Salia Walwa"
[0] 📸 [HANDLER] Has Image: false
[0] 🎯 [HANDLER] Session: log_activity, Step: enter_description
[0] 🚦 [HANDLER] Routing to employee flow...
[0] 👷‍♂️ [EMPLOYEE] Employee flow called with: {
[0]   phone: '+919723132143',
[0]   messageText: 'Salia Walwa',
[0]   sessionIntent: 'log_activity',
[0]   sessionStep: 'enter_description',
[0]   selectedSite: 'site_1',
[0]   isAdminImpersonation: false
[0] }
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+919723132143",
[0]   "type": "text",
[0]   "text": {
[0]     "body": "📸 કૃપા કરીને કામનો ફોટો અપલોડ કરો:\n\n• કામની સાઈટનો ફોટો\n• પૂર્ણ થયેલા કામનો ફોટો\n• કોઈ ફોટો ન હોય તો 'skip' ટાઈપ કરો"
[0]   }
[0] }
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSOTQzRjA0QjhEMjMzNDRBMDVBAA=='
[0]     }
[0]   ]
[0] }
[0] ✅ [HANDLER] Flow handling completed
[0] ✅ [WEBHOOK] Message handled successfully
[0] 2025-06-18T09:26:41.165Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:26:41.795Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:27:12.720Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📨 [WEBHOOK] Received message from +919723132143: {
[0]   type: 'image',
[0]   id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTcwNDZEN0U1RkM3MDMyQjk5MzQzRDRENjA2RTIyN0MA',
[0]   timestamp: '1750238830'
[0] }
[0] [WEBHOOK] Message content: {
[0]   "from": "919723132143",
[0]   "id": "wamid.HBgMOTE5NzIzMTMyMTQzFQIAEhggOTcwNDZEN0U1RkM3MDMyQjk5MzQzRDRENjA2RTIyN0MA",
[0]   "timestamp": "1750238830",
[0]   "type": "image",
[0]   "image": {
[0]     "mime_type": "image/jpeg",
[0]     "sha256": "MnZQpbyZVXuhui8+E8s9qNYt3zBaZsnQ/2rcbu9M/x4=",
[0]     "id": "642078718997034"
[0]   }
[0] }
[0] 📤 [WEBHOOK] Calling messageHandler.handleMessage...
[0] 🎯 [HANDLER] Starting handleMessage...
[0] 📱 [HANDLER] Normalized phone: +919723132143
[0] 🗄️ [HANDLER] Testing database connection...
[0] ✅ [DB] New client connected
[0] 📝 [HANDLER] Logging message...
[0] 👁️ [HANDLER] Marking message as read...
[0] 👤 [HANDLER] Getting/creating user...
[0] ✅ [HANDLER] User obtained: employee
[0] 🔄 [HANDLER] Getting/creating session...
[0] ✅ [HANDLER] Session obtained
[0] 👤 [HANDLER] User: employee, Phone: +919723132143
[0] 💬 [HANDLER] Message: ""
[0] 📸 [HANDLER] Has Image: true
[0] 🎯 [HANDLER] Session: log_activity, Step: upload_image
[0] 🚦 [HANDLER] Routing to employee flow...
[0] 👷‍♂️ [EMPLOYEE] Employee flow called with: {
[0]   phone: '+919723132143',
[0]   messageText: '',
[0]   sessionIntent: 'log_activity',
[0]   sessionStep: 'upload_image',
[0]   selectedSite: 'site_1',
[0]   isAdminImpersonation: false
[0] }
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+919723132143",
[0]   "type": "text",
[0]   "text": {
[0]     "body": "📤 કામનો ફોટો અપલોડ કરી રહ્યા છીએ..."
[0]   }
[0] }
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMTBEMjg1QjQwMUZBNjU2RjAzAA=='
[0]     }
[0]   ]
[0] }
[0] 2025-06-18T09:27:15.418Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:27:15.880Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] ✅ File uploaded successfully:
[0] 🔑 Key: activities/bca7b326-6232-49ae-931d-f7daff03fc39.jpg
[0] 🌐 Public URL: https://pub-480de15262b346c8b5ebf5e8141b43f9.r2.dev/activities/bca7b326-6232-49ae-931d-f7daff03fc39.jpg
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+919723132143",
[0]   "type": "text",
[0]   "text": {
[0]     "body": "✅ ફોટો સફળતાપૂર્વક અપલોડ થયો!"
[0]   }
[0] }
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSRUY5NEZBOEU2MUE2MUVFQjZEAA=='
[0]     }
[0]   ]
[0] }
[0] 🔧 [EMPLOYEE] Completing activity log with data: {
[0]   site_id: 'site_1',
[0]   selected_site: 'site_1',
[0]   activity_type: 'inspection',
[0]   hours: 1,
[0]   is_admin_impersonation: false
[0] }
[0] 🔧 [EMPLOYEE] Converting site ID: site_1
[0] 🔧 [EMPLOYEE] Using legacy site mapping: site_1 → 11111111-1111-1111-1111-111111111111
[0] 🔧 [EMPLOYEE] Site UUID after conversion: 11111111-1111-1111-1111-111111111111
[0] 📤 Sending message to WhatsApp API...
[0] 🔗 URL: https://graph.facebook.com/v18.0/652783161256584/messages
[0] 📱 Phone Number ID: 652783161256584
[0] 🔐 Token (first 20): EAASY8LmFhiYBOZBkade...
[0] 📦 Payload: {
[0]   "messaging_product": "whatsapp",
[0]   "to": "+919723132143",
[0]   "type": "text",
[0]   "text": {
[0]     "body": "✅ *પ્રવૃત્તિ સફળતાપૂર્વક નોંધાઈ!*\n\n📋 *વિગતો:*\n• સાઈટ: Suvasam Group\n• પ્રવૃત્તિ: 🔍 તપાસ\n• કલાકો: 1\n• વર્ણન: Salia Walwa\n• 📸 ફોટો સહિત\n\n*પ્રવૃત્તિ ID:* b1ae1c47\n\nમુખ્ય મેનુ પર જવા માટે *મેનુ* ટાઈપ કરો."
[0]   }
[0] }
[0] 2025-06-18T09:27:20.480Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:27:20.482Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] ✅ Message sent successfully: {
[0]   messaging_product: 'whatsapp',
[0]   contacts: [ { input: '+919723132143', wa_id: '919723132143' } ],
[0]   messages: [
[0]     {
[0]       id: 'wamid.HBgMOTE5NzIzMTMyMTQzFQIAERgSMzM3MTRBQzlBRThEREYwMEQzAA=='
[0]     }
[0]   ]
[0] }
[0] ✅ [HANDLER] Flow handling completed
[0] ✅ [WEBHOOK] Message handled successfully
[0] 2025-06-18T09:27:21.086Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
[0] 2025-06-18T09:27:21.507Z - POST /webhook
[0] 🚀 [WEBHOOK] Starting webhook processing...
[0] 🔍 [WEBHOOK] Environment check: {
[0]   NODE_ENV: 'development',
[0]   HAS_WHATSAPP_TOKEN: true,
[0]   HAS_PHONE_ID: true,
[0]   HAS_DB_URL: true,
[0]   DB_URL_LENGTH: 110
[0] }
[0] 📭 [WEBHOOK] No messages in webhook payload
